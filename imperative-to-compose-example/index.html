<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Imperative to compose example | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="While happily coding my ggit project I wrote the following function
that returns a list of filenames that have been changed (according to Git version control).
1234567891011121314151617181920212223242">
<meta property="og:type" content="article">
<meta property="og:title" content="Imperative to compose example">
<meta property="og:url" content="http://glebbahmutov.com/blog/imperative-to-compose-example/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="While happily coding my ggit project I wrote the following function
that returns a list of filenames that have been changed (according to Git version control).
1234567891011121314151617181920212223242">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Imperative to compose example">
<meta name="twitter:description" content="While happily coding my ggit project I wrote the following function
that returns a list of filenames that have been changed (according to Git version control).
1234567891011121314151617181920212223242">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="..//" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="..//" id="subtitle">Software advice from Dr. Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">Software advice from <a id="subtitle" href="http://glebbahmutov.com">Dr. Gleb Bahmutov PhD</a></span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="..//">Home</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-imperative-to-compose-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2015-08-26T04:00:00.000Z" itemprop="datePublished">Aug 26 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Imperative to compose example
    </h1>

    <h2 class="article-title" itemprop="name">
      Changing a piece of imperative code to be purely functional
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>While happily coding my <a href="https://github.com/bahmutov/ggit" target="_blank" rel="external">ggit</a> project I wrote the following function
that returns a list of filenames that have been changed (according to Git version control).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/changed-files.js</span></span><br><span class="line"><span class="keyword">var</span> log = <span class="built_in">require</span>(<span class="string">&apos;debug&apos;</span>)(<span class="string">&apos;ggit&apos;</span>);</span><br><span class="line"><span class="comment">// exec is promise-returning shell command runner</span></span><br><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">&apos;./exec&apos;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseLine</span>(<span class="params">line</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> parts = line.split(<span class="string">&apos;\t&apos;</span>);</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        diff: parts[<span class="number">0</span>],</span><br><span class="line">        name: parts[<span class="number">1</span>]</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">groupByModification</span>(<span class="params">parsedLines</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> _.groupBy(parsedLines, <span class="string">&apos;diff&apos;</span>);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changedFiles</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="string">&apos;git diff --name-status --diff-filter=ACDM&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;filter letters Added (A), Copied (C), Deleted (D), Modified (M)&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;changed files command&apos;</span>, cmd);</span><br><span class="line">    <span class="keyword">return</span> exec(cmd)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>{</span><br><span class="line">            data = data.trim();</span><br><span class="line">            <span class="keyword">var</span> files = data.split(<span class="string">&apos;\n&apos;</span>);</span><br><span class="line">            files = files.filter(<span class="function"><span class="keyword">function</span> (<span class="params">filename</span>) </span>{</span><br><span class="line">                <span class="keyword">return</span> filename.length;</span><br><span class="line">            }).map(parseLine);</span><br><span class="line"></span><br><span class="line">            log(<span class="string">&apos;found changed files&apos;</span>);</span><br><span class="line">            log(files);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> grouped = groupByModification(files);</span><br><span class="line">            log(<span class="string">&apos;grouped by modification&apos;</span>);</span><br><span class="line">            log(grouped);</span><br><span class="line">            <span class="keyword">return</span> grouped;</span><br><span class="line">        });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The code is running a git command <code>git diff --name-status --diff-filter=ACDM</code> that returns
a list of filenames and their modification letters. The output from the command is something like
this for a case if you modified source file <code>src/foo.js</code> and added file <code>README.md</code></p>
<pre><code>M<span class="string">\tsrc/foo.js</span>
A<span class="string">\tREADME.md</span>
</code></pre><p>The output was a single object like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    A: [...], <span class="comment">// list of added files</span></span><br><span class="line">    C: [...], <span class="comment">// list of copied files</span></span><br><span class="line">    M: [...], <span class="comment">// list of modified files</span></span><br><span class="line">    D: [...]  <span class="comment">// list of deleted files</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// each item in the list is</span></span><br><span class="line">{</span><br><span class="line">    diff: <span class="string">&apos;A&apos;</span> <span class="comment">// or C, M, D</span></span><br><span class="line">    name: <span class="string">&apos;src/something.js&apos;</span> <span class="comment">// relative to the repo root</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>This code essentially ran the following 4 steps</p>
<pre><code><span class="number">1</span>: parse git <span class="keyword">stdout</span> output
<span class="number">2</span>: run <span class="operator">the</span> debug <span class="built_in">log</span> <span class="command"><span class="keyword">command</span></span>
<span class="number">3</span>: group <span class="operator">the</span> <span class="built_in">files</span> <span class="keyword">by</span> modification
<span class="number">4</span>: debug print <span class="operator">the</span> group
</code></pre><p>The final group is returned by the function. That is it. Yet this code is very error-prone.
We need to keep track of the local variables (<code>files</code>), input arguments (<code>data</code>), return variable (<code>grouped</code>).</p>
<p>When there are 4 steps and 3 variables, they can all interact, causing the number of possible effects
to go up to 12 (= 4 * 3). This is too complex for the human mind to keep track of; short term memory
can only &quot;cache&quot; from 4 to 7 things at once.</p>
<p>Can we refactor this code to eliminate the variables? Yes! We are going to use functional <em>composition</em>
to eliminate local variables and make the data flow stricter. We are also going to factor out
individual <em>pure</em> functions that only work on the input arguments, making reasoning about them much simpler.</p>
<h2 id="step-1">step 1</h2><blockquote>
<p>Factor every little data processing into its own function</p>
</blockquote>
<p>We have 4 steps in this computation. Let us split it into 4 functions</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseLine</span>(<span class="params">line</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> parts = line.split(<span class="string">&apos;\t&apos;</span>);</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        diff: parts[<span class="number">0</span>],</span><br><span class="line">        name: parts[<span class="number">1</span>]</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseOutput</span>(<span class="params">data</span>) </span>{</span><br><span class="line">    data = data.trim();</span><br><span class="line">    <span class="keyword">var</span> files = data.split(<span class="string">&apos;\n&apos;</span>);</span><br><span class="line">    files = files.filter(<span class="function"><span class="keyword">function</span> (<span class="params">filename</span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> filename.length;</span><br><span class="line">    }).map(parseLine);</span><br><span class="line">    <span class="keyword">return</span> files;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">groupByModification</span>(<span class="params">parsedLines</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> _.groupBy(parsedLines, <span class="string">&apos;diff&apos;</span>);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logFoundFiles</span>(<span class="params">files</span>) </span>{</span><br><span class="line">    log(<span class="string">&apos;found changed files&apos;</span>);</span><br><span class="line">    log(files);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logGroupedFiles</span>(<span class="params">grouped</span>) </span>{</span><br><span class="line">    log(<span class="string">&apos;grouped by modification&apos;</span>);</span><br><span class="line">    log(grouped);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changedFiles</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="string">&apos;git diff --name-status --diff-filter=ACDM&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;filter letters Added (A), Copied (C), Deleted (D), Modified (M)&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;changed files command&apos;</span>, cmd);</span><br><span class="line">    <span class="keyword">return</span> exec(cmd)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> <span class="title">outputToGroup</span>(<span class="params">data</span>) </span>{</span><br><span class="line">            <span class="keyword">var</span> files = parseOutput(data);</span><br><span class="line">            logFoundFiles(files);</span><br><span class="line">            <span class="keyword">var</span> grouped = groupByModification(files);</span><br><span class="line">            logGroupedFiles(grouped);</span><br><span class="line">            <span class="keyword">return</span> grouped;</span><br><span class="line">        });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Excellent, each small function is easy to reason about in isolation. Also, we could move them
into a separate file and quickly unit test. The main block of code we are going to refactor
is now very clear. I like giving functions names; makes debugging crashes much simpler</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outputToGroup</span>(<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> files = parseOutput(data);</span><br><span class="line">    logFoundFiles(files);</span><br><span class="line">    <span class="keyword">var</span> grouped = groupByModification(files);</span><br><span class="line">    logGroupedFiles(grouped);</span><br><span class="line">    <span class="keyword">return</span> grouped;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="step-2">step 2</h2><blockquote>
<p>Replace imperative steps with composition</p>
</blockquote>
<p>The output of each function call in <code>outputToGroup</code> is fed into the next function (except for log messages).
Imagine for a second that functions <code>logFoundFiles</code> and <code>logGroupedFiles</code> returned whatever the first argument 
passed to them. Then the function <code>outputToGroup</code> could be written like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outputToGroup</span>(<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> logGroupedFiles(groupByModification(logFoundFiles(parseOutput(data))));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>We don&apos;t even need an actual function <code>outputToGroup</code> - we could make this &quot;caterpillar&quot; on the fly
using an utility from any functional library: <a href="https://lodash.com/docs#flowRight" target="_blank" rel="external">lodash.compose</a>, or 
<a href="http://ramdajs.com/docs/#compose" target="_blank" rel="external">ramda.compose</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> R = <span class="built_in">require</span>(<span class="string">&apos;ramda&apos;</span>);</span><br><span class="line"><span class="keyword">var</span> outputToGroup = R.compose(logGroupedFiles, groupByModification, logFoundFiles, parseOutput);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changedFiles</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="string">&apos;git diff --name-status --diff-filter=ACDM&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;filter letters Added (A), Copied (C), Deleted (D), Modified (M)&apos;</span>);</span><br><span class="line">    log(<span class="string">&apos;changed files command&apos;</span>, cmd);</span><br><span class="line">    <span class="keyword">return</span> exec(cmd)</span><br><span class="line">        .then(outputToGroup);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>That is very cool and literally eliminates any place in the code for an error to hide.
We only have a single problem: functions <code>logGroupedFiles</code> and <code>logFoundFiles</code> do NOT return the 
first argument, thus we cannot use them inside compose: they stop the flow of data!</p>
<p>Luckily, it is simple to work around this problem. We can <em>adapt</em> the function on the fly
by creating a new function that DOES return its arguments, but calls the original function. 
It is called <code>tap</code> and one can either implement <code>tap</code> or use a 3rd party utility, like
<a href="http://ramdajs.com/docs/#tap" target="_blank" rel="external">ramda.tap</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logFoundFiles(<span class="string">&apos;foo&apos;</span>); <span class="comment">// prints &quot;foo&quot;, returns undefined</span></span><br><span class="line">R.tap(logFoundFiles)(<span class="string">&apos;foo&apos;</span>); <span class="comment">// prints &quot;foo&quot;, returns &apos;foo&apos;</span></span><br></pre></td></tr></table></figure>
<p>We just need to add taps around any function in our composition that should be &quot;ignored&quot;, 
and whose original arguments should be just passed to the next step</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> R = <span class="built_in">require</span>(<span class="string">&apos;ramda&apos;</span>);</span><br><span class="line"><span class="keyword">var</span> outputToGroup = R.compose(</span><br><span class="line">    R.tap(logGroupedFiles), groupByModification, R.tap(logFoundFiles), parseOutput</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>I indented the code a little bit differently for clarity. Even better in my personal opinion
to use <a href="http://ramdajs.com/docs/#pipe" target="_blank" rel="external">ramda.pipe</a> which is equivalent to <code>R.compose</code> except the functions are in
reverse order. To me the <code>R.pipe</code> goes from left to right, which is very natural because the
code it replaces (imperative) goes from top to bottom.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// original imperative code from top to bottom</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outputToGroup</span>(<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> files = parseOutput(data);</span><br><span class="line">    logFoundFiles(files);</span><br><span class="line">    <span class="keyword">var</span> grouped = groupByModification(files);</span><br><span class="line">    logGroupedFiles(grouped);</span><br><span class="line">    <span class="keyword">return</span> grouped;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// equivalent functional code using R.pipe</span></span><br><span class="line"><span class="keyword">var</span> R = <span class="built_in">require</span>(<span class="string">&apos;ramda&apos;</span>);</span><br><span class="line"><span class="keyword">var</span> outputToGroup = R.pipe(</span><br><span class="line">    parseOutput,</span><br><span class="line">    R.tap(logFoundFiles),</span><br><span class="line">    groupByModification,</span><br><span class="line">    R.tap(logGroupedFiles)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>The functional code is in the same order as original, except we literally listed what
functions to run in the same order, but the flow of data is managed for us. The output
of <code>parseOutput</code> will be fed to both <code>logFoundFiles</code> and <code>groupByModification</code>. The output
of <code>logFoundFiles</code> is ignored via <code>R.tap</code>. The output from <code>groupByModification</code> which runs
after <code>logFoundFiles</code> finishes will be fed to <code>logGroupedFiles</code>. The output of 
<code>logGroupedFiles</code> is ignored due to <code>R.tap</code>. The pipe will instead return the output
of <code>groupByModification</code> call.</p>
<h2 id="bonus-unit-testing-outputtogroup">Bonus - unit testing outputToGroup</h2><p>We have refactored individual steps into separate functions, and composed the final logic into
a function stored in a private variable <code>var outputToGroup = ...</code>. Can we unit test the individual
functions or the <code>outputToGroup</code> function? Usually one needs to export a function from a module
to be able to unit test it. Too much trouble, we can do better. Using <a href="https://github.com/bahmutov/describe-it" target="_blank" rel="external">describe-it</a>
we can get access to pretty much anything inside a module without exporting it.</p>
<figure class="highlight js"><figcaption><span>changed-files.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseOutput</span>(<span class="params">stdout</span>) </span>{ ... }</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logFoundFiles</span>(<span class="params">...</span>) </span>{ ... }</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> outputToGroup = R.pipe(</span><br><span class="line">    parseOutput,</span><br><span class="line">    R.tap(logFoundFiles),</span><br><span class="line">    groupByModification,</span><br><span class="line">    R.tap(logGroupedFiles)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>spec/changed-files-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> describeIt = <span class="built_in">require</span>(<span class="string">&apos;describe-it&apos;</span>);</span><br><span class="line">describeIt(<span class="string">&apos;../src/changed-files&apos;</span>, <span class="string">&apos;function parseOutput(stdout)&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">getParseOutput</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;works&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="comment">// get access to the private parseOutput function!</span></span><br><span class="line">        <span class="keyword">var</span> parseOutput = getParseOutput();</span><br><span class="line">        <span class="keyword">var</span> parsed = parseOutput(<span class="string">&apos;M\tfoo.js&apos;</span>);</span><br><span class="line">        <span class="comment">// verify parsed</span></span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Pretty cool - we got access to <code>parseOutput</code> in our unit tests without modifying any code 
inside the <code>changed-files.js</code> source file. To see the complete unit test, including tests
that access the <code>outputToGroup</code> function, take a look at the <a href="https://github.com/bahmutov/ggit/blob/master/spec/changed-files-spec.js" target="_blank" rel="external">changed-files-spec.js</a>.</p>
<h2 id="additional-reading">Additional reading</h2><ul>
<li><a href="../my-favorite-functional-adaptors/">My favorite functional adapters</a> - there is more than <code>tap</code></li>
<li><a href="../journey-from-procedural-to-reactive-javascript-with-stops/">Journey from procedural to functional reactive with stops</a>.</li>
<li>If you ever used promises (like in the above example), you have used functional programming,
because <a href="../when-in-doubt-return-a-promise/">Promises are functors</a>.</li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>

    

    <footer class="article-footer">
      <a data-url="http://glebbahmutov.com/blog/imperative-to-compose-example/" data-id="cii9q39f200kvlourzfhgo6sm" class="article-share-link">Share</a>
      
        <a href="http://glebbahmutov.com/blog/imperative-to-compose-example/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/functional/">functional</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../unit-testing-angular-from-node-like-a-boss/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Unit testing Angular from Node like a boss
        
      </div>
    </a>
  
  
    <a href="../angular-model-intro/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Angular Model intro</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">190</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">82</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">142</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">44</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 12.86px;">QUnit</a><a href="../tags/advice/" style="font-size: 19.29px;">advice</a><a href="../tags/angular/" style="font-size: 10px;">angular</a><a href="../tags/angularjs/" style="font-size: 18.57px;">angularjs</a><a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a><a href="../tags/assertions/" style="font-size: 13.57px;">assertions</a><a href="../tags/boilerplate/" style="font-size: 15.71px;">boilerplate</a><a href="../tags/browser/" style="font-size: 14.29px;">browser</a><a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a><a href="../tags/d3/" style="font-size: 11.43px;">d3</a><a href="../tags/database/" style="font-size: 10px;">database</a><a href="../tags/db/" style="font-size: 12.86px;">db</a><a href="../tags/es6/" style="font-size: 14.29px;">es6</a><a href="../tags/es7/" style="font-size: 10px;">es7</a><a href="../tags/functional/" style="font-size: 17.14px;">functional</a><a href="../tags/generators/" style="font-size: 12.86px;">generators</a><a href="../tags/git/" style="font-size: 13.57px;">git</a><a href="../tags/grunt/" style="font-size: 13.57px;">grunt</a><a href="../tags/gulp/" style="font-size: 11.43px;">gulp</a><a href="../tags/immutable/" style="font-size: 10px;">immutable</a><a href="../tags/interview/" style="font-size: 11.43px;">interview</a><a href="../tags/jade/" style="font-size: 12.14px;">jade</a><a href="../tags/javascript/" style="font-size: 20px;">javascript</a><a href="../tags/jshint/" style="font-size: 11.43px;">jshint</a><a href="../tags/modular-development/" style="font-size: 15.71px;">modular development</a><a href="../tags/nodejs/" style="font-size: 18.57px;">nodejs</a><a href="../tags/performance/" style="font-size: 15px;">performance</a><a href="../tags/promises/" style="font-size: 16.43px;">promises</a><a href="../tags/proposal/" style="font-size: 10.71px;">proposal</a><a href="../tags/reactive/" style="font-size: 10.71px;">reactive</a><a href="../tags/reactjs/" style="font-size: 10.71px;">reactjs</a><a href="../tags/security/" style="font-size: 12.14px;">security</a><a href="../tags/sentry/" style="font-size: 13.57px;">sentry</a><a href="../tags/testing/" style="font-size: 17.86px;">testing</a><a href="../tags/tutorial/" style="font-size: 12.86px;">tutorial</a><a href="../tags/ui/" style="font-size: 10px;">ui</a><a href="../tags/web-workers/" style="font-size: 12.86px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../hydrate-your-apps/">Hydrate your apps</a>
          </li>
        
          <li>
            <a href="../my-node-tools/">My Node tools</a>
          </li>
        
          <li>
            <a href="../pass-the-logic/">Pass the logic</a>
          </li>
        
          <li>
            <a href="../use-some-es6-in-cli-apps/">Use some ES6 in CLI apps</a>
          </li>
        
          <li>
            <a href="../1-2-3-linted/">1, 2, 3, linted</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="..//" class="mobile-nav-link">Home</a>
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'http://glebbahmutov.com/blog/imperative-to-compose-example/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css" type="text/css">
  <script src="../fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="../js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>