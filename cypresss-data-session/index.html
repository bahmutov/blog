<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Flexible Cypress Data Setup And Validation | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="This post will introduce you to a very powerful way of creating and re-using data in your Cypress tests. By re-using the expensive to create objects like users, projects, etc. you will make your tests">
<meta property="og:type" content="article">
<meta property="og:title" content="Flexible Cypress Data Setup And Validation">
<meta property="og:url" content="https://glebbahmutov.com/blog/cypresss-data-session/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="This post will introduce you to a very powerful way of creating and re-using data in your Cypress tests. By re-using the expensive to create objects like users, projects, etc. you will make your tests">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/register-user.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/cannot-register-twice.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/clear-users.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/find-user.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/data1.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/recompute.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/still-valid.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/register-using-request.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/register-using-task.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/stored-data.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/store-object.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/validate-id.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/alias.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/log-in.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/sid.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/setup-cookie.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/not-logged-in.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/recreate.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/sessions.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/clear1.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/data-session/depends.png">
<meta property="article:published_time" content="2021-10-20T04:00:00.000Z">
<meta property="article:modified_time" content="2021-12-15T15:18:09.928Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="cypress">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/data-session/register-user.gif">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-cypresss-data-session" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2021-10-20T04:00:00.000Z" itemprop="datePublished">Oct 20 2021</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Flexible Cypress Data Setup And Validation
    </h1>

    <h2 class="article-title" itemprop="name">
      Setting up, caching, and re-creating the test data using cypress-data-session plugin.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>This post will introduce you to a very powerful way of creating and re-using data in your Cypress tests. By re-using the expensive to create objects like users, projects, etc. you will make your tests much much faster, and potentially the tests will be easier to read and maintain.</p>
<!-- toc -->

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#creating-the-user">Creating the user</a></li>
<li><a href="#separate-creation-from-logging-in">Separate creation from logging in</a></li>
<li><a href="#data-session">Data session</a></li>
<li><a href="#register-the-user-via-api-call">Register the user via API call</a></li>
<li><a href="#register-the-user-via-task-command">Register the user via task command</a></li>
<li><a href="#caching-data">Caching data</a></li>
<li><a href="#logging-using-api-call">Logging using API call</a></li>
<li><a href="#caching-the-session-cookie">Caching the session cookie</a></li>
<li><a href="#data-session-methods">Data session methods</a></li>
<li><a href="#dependent-sessions">Dependent sessions</a></li>
<li><a href="#more-info">More info</a></li>
</ul>
<!-- tocstop -->

<h2><span id="introduction">Introduction</span></h2><p>Imagine your Cypress test needs to create a user before logging in. Is creating a user an instant step? No, it probably takes time, especially if you go through the app&#39;s user interface without using API calls or <a target="_blank" rel="noopener" href="https://www.cypress.io/blog/2019/01/03/stop-using-page-objects-and-start-using-app-actions/">App Actions</a>. So you want to create a user and keep it around, to avoid re-creating it for each test. Sometimes you do want to check if the user object or some other piece of data is still valid; maybe another test has cleared the database, removing all the users. So you need a mechanism for validating the user before the test proceeds.</p>
<p>These actions: creating a piece of test data, storing it for other tests to use, validating, and re-creating if the validation has failed, are very common. Thus I have written a plugin called <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cypress-data-session">cypress-data-session</a> to avoid re-implementing the same boilerplate in my code. This plugin gives an introduction to the plugin&#39;s use in the real-world scenarios.</p>
<h2><span id="creating-the-user">Creating the user</span></h2><p>Let&#39;s create an user for our application - which is required to log in, and create a chat room. A typical test would do something like this:</p>
<figure class="highlight js"><figcaption><span>cypress/integration/register-user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;registers user&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#create-account&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.register-form&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=username]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(username)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.value&#x27;</span>, username)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=password]&#x27;</span>).<span class="title function_">type</span>(password)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;create&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.login-form&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=username]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(username)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.value&#x27;</span>, username)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=password]&#x27;</span>).<span class="title function_">type</span>(password)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;login&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user has been created and could log in</span></span><br><span class="line">  <span class="comment">// we should be redirected to the home page with the rooms</span></span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote class="pullquote"><p>üéÅ You can find the source code examples used in this blog post in the repo <a target="_blank" rel="noopener" href="https://github.com/bahmutov/chat.io">bahmutov&#x2F;chat.io</a>.</p>
</blockquote>

<p>The first time this test runs, everything goes well. The user is created and can log in.</p>
<p><img src="../images/data-session/register-user.gif" alt="The user is created successfully"></p>
<p>But when we rerun the test, it fails, since the user with the same username already exists.</p>
<p><img src="../images/data-session/cannot-register-twice.gif" alt="Cannot register the same user twice"></p>
<p>Sure, the failure is expected. We have four choices:</p>
<ul>
<li>delete all users before each test so we can create the user <code>Test</code> with the password <code>MySecreT</code>.</li>
<li>delete just the user <code>Test</code> if it exists.</li>
<li>create a user with unique random name just for this test.</li>
<li>cache the created user and reuse it.</li>
</ul>
<p>The last option is the hardest to implement, but can offer substantial speed savings, since create a user (or some complicated piece of test data) can be slow.</p>
<h2><span id="separate-creation-from-logging-in">Separate creation from logging in</span></h2><p>Before we proceed, I want to point out that the test above mixes creating the user object and using it. We probably want to keep the act of creating the user really clear, thus I will rewrite the test a little bit.</p>
<figure class="highlight js"><figcaption><span>cypress/integration/register-user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerUser</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#create-account&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.register-form&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=username]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(username)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.value&#x27;</span>, username)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=password]&#x27;</span>).<span class="title function_">type</span>(password)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;create&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loginUser</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.login-form&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=username]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(username)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.value&#x27;</span>, username)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[placeholder=password]&#x27;</span>).<span class="title function_">type</span>(password)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;login&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">// if everything goes well</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.success&#x27;</span>, <span class="string">&#x27;Your account has been created&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;registers user&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">  <span class="title function_">loginUser</span>(username, password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user has been created and could log in</span></span><br><span class="line">  <span class="comment">// we should be redirected to the home page with the rooms</span></span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>The above test fails if we re-run it, so let&#39;s take care of that. Let&#39;s delete the user before each test. I have registered a task in the plugin file to connect to the database and clear all users. Just for kicks I also added a task to find a user by username.</p>
<figure class="highlight js"><figcaption><span>cypress/plugin/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> database = <span class="built_in">require</span>(<span class="string">&#x27;../../app/database&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">clearUsers</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;clear users&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> database.<span class="property">models</span>.<span class="property">user</span>.<span class="title function_">deleteMany</span>(&#123;&#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findUser</span>(<span class="params">username</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find user&#x27;</span>, username)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;username must be a string&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> database.<span class="property">models</span>.<span class="property">user</span>.<span class="title function_">findOne</span>(&#123; username &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">on</span>(<span class="string">&#x27;task&#x27;</span>, &#123;</span><br><span class="line">    clearUsers,</span><br><span class="line">    findUser,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At the start of the test, we can delete all users in the database (which is fine, we are running one test at a time).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;registers user&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">task</span>(<span class="string">&#x27;clearUsers&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">  <span class="title function_">loginUser</span>(username, password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user has been created and could log in</span></span><br><span class="line">  <span class="comment">// we should be redirected to the home page with the rooms</span></span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="../images/data-session/clear-users.gif" alt="Clear all existing users before creating the test user"></p>
<p>Nice, the test can be re-run multiple times. But we can do better - let us avoid deleting all users. We can quickly check if the already created user is still valid.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;registers user&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="title function_">loginUser</span>(username, password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user has been created and could log in</span></span><br><span class="line">  <span class="comment">// we should be redirected to the home page with the rooms</span></span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>The above test is much much faster - since it reuses the previously created user, and avoids recreating unnecessarily.</p>
<p><img src="../images/data-session/find-user.gif" alt="Finds the previously created user"></p>
<h2><span id="data-session">Data session</span></h2><p>Now let us rewrite the above test using <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cypress-data-session">cypress-data-session</a> plugin. We will import the plugin from the support file, which gives us the <code>cy.dataSession</code> command. First, let&#39;s recreate the original &quot;naive&quot; create and log in behavior:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;registers user using data session&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="title function_">loginUser</span>(username, password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user has been created and could log in</span></span><br><span class="line">  <span class="comment">// we should be redirected to the home page with the rooms</span></span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>The test passes on the first attempt if there are no users in the database.</p>
<p><img src="../images/data-session/data1.png" alt="The user was created using the setup method"></p>
<p>Great, we created the data item (the user) using the <code>setup</code> method, and gave the data session an alias &quot;user&quot;. We can pass some data from that alias later; it can be used to access the object created by the <code>setup</code> method.</p>
<p>Notice, if we re-run the test, it fails when it tries to run the <code>setup</code> method again.</p>
<p><img src="../images/data-session/recompute.png" alt="The data session tries to recompute the item"></p>
<p>The data session does not know that the user object is still valid, and should not be recomputed. Let&#39;s tell the data session how to check. We will add the <code>validate</code> method that can run Cypress commands and resolves with a boolean value. If we yield true, the data session will skip recomputing the user again.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">loginUser</span>(username, password)</span><br></pre></td></tr></table></figure>

<p>The test now immediately logs in - because the user is still valid.</p>
<p><img src="../images/data-session/still-valid.png" alt="The user is validated, not recomputing necessary"></p>
<h2><span id="register-the-user-via-api-call">Register the user via API call</span></h2><p>We can optimize how we create the user. Instead of filling the form fields and submitting the form, we could simply post it using the <a target="_blank" rel="noopener" href="https://on.cypress.io/request">cy.request</a> command.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerApi</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">    <span class="attr">form</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">body</span>: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">registerApi</span>(username, password)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">loginUser</span>(username, password)</span><br></pre></td></tr></table></figure>

<p>The test passes and is faster.</p>
<p><img src="../images/data-session/register-using-request.png" alt="Register the user with cy.request command"></p>
<h2><span id="register-the-user-via-task-command">Register the user via task command</span></h2><p>We can bypass the API and directly create the user in the database (of course, we can use the application database model layer to avoid creating an invalid entity) by calling the plugin code via <a target="_blank" rel="noopener" href="https://on.cypress.io/task">cy.task</a> command.</p>
<figure class="highlight js"><figcaption><span>cypress/plugins/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> database = <span class="built_in">require</span>(<span class="string">&#x27;../../app/database&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; registerUser &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../app/models/user&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findUser</span>(<span class="params">username</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find user&#x27;</span>, username)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;username must be a string&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> database.<span class="property">models</span>.<span class="property">user</span>.<span class="title function_">findOne</span>(&#123; username &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUser</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;get user with id %s&#x27;</span>, id)</span><br><span class="line">  <span class="keyword">return</span> database.<span class="property">models</span>.<span class="property">user</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">_id</span>: id &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">makeUser</span>(<span class="params">credentials</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;makeUser&#x27;</span>, credentials?.<span class="property">username</span>)</span><br><span class="line">  <span class="keyword">const</span> errorMessageOrUser = <span class="keyword">await</span> <span class="title function_">registerUser</span>(credentials)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> errorMessageOrUser === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errorMessageOrUser)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="string">&#x27;made user %s id %s&#x27;</span>,</span><br><span class="line">    credentials.<span class="property">username</span>,</span><br><span class="line">    errorMessageOrUser.<span class="property">_id</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> errorMessageOrUser.<span class="property">_id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">on, config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">on</span>(<span class="string">&#x27;task&#x27;</span>, &#123;</span><br><span class="line">    findUser,</span><br><span class="line">    getUser,</span><br><span class="line">    makeUser,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote class="pullquote"><p>üìù For more examples on how to connect to the MongoDB database from Cypress tests, read the blog post <a href="/blog/testing-mongo-with-cypress/" title="Testing Mongo with Cypress">Testing Mongo with Cypress</a> or <a href="/blog/verify-phone-part-two/" title="How To Verify Phone Number During Tests Part 2">How To Verify Phone Number During Tests Part 2</a>.</p>
</blockquote>

<p>We can now register a user really quickly.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="../images/data-session/register-using-task.png" alt="Register the user with cy.task command"></p>
<h2><span id="caching-data">Caching data</span></h2><p>The <code>cy.dataSession</code> command above helped us organize the user creation a little bit, but its power is in caching a piece of created data. For example, why do we need the <code>username</code> to check if the user is still valid? A user object should be checked by its ID! The user ID is returned by the <code>cy.task(&#39;makeUser&#39;)</code>, so let&#39;s store it somewhere. That is precisely what <code>cy.dataSession</code> can do internally, so you do not have to do it! It can even store it across the specs, so it survives hard reloads and opening a different spec.</p>
<p>In fact, the user ID has already been stored - because that is what the Cypress command chain inside the <code>setup</code> method yields. That ID is stored in the session, and we can see what the session stores using a static method <code>Cypress.getDataSession</code> added to the global Cypress object by the plugin.</p>
<p><img src="../images/data-session/stored-data.png" alt="The user ID was stored inside the data session &quot;user&quot;"></p>
<p>We can store any object there, let&#39;s keep the user ID, the username, and the password together.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="../images/data-session/store-object.png" alt="We can store an entire object inside the data session"></p>
<p>What about validating the data? Does it need to rely on the external closure variable <code>username</code>? No - the data session code automatically passes the stored data to the <code>validate</code> method! We can rewrite the <code>validate</code> method to use the parameter instead of the external variable:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params">&#123; username &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;findUser&#x27;</span>, username).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Even better, we can grab the ID property and use the task <code>getUser</code> to validate the user quicker</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Notice how the Command Log shows the <code>cy.task</code> checking the user ID now</p>
<p><img src="../images/data-session/validate-id.png" alt="Validating the user by the stored ID"></p>
<p>The stored user object is automatically available under a Cypress alias and under the test context property.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line"><span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@user&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.property&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, username)</span><br><span class="line">  <span class="comment">// or access the alias using the test context property</span></span><br><span class="line">  <span class="comment">// after it has been set</span></span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">expect</span>(<span class="variable language_">this</span>.<span class="property">user</span>).<span class="property">to</span>.<span class="property">have</span>.<span class="title function_">keys</span>(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>The name we gave the data session &quot;user&quot; became a Cypress alias, reachable using the <code>cy.get</code> command or via the text context property.</p>
<p><img src="../images/data-session/alias.png" alt="Accessing the computed cached data via an alias &quot;user&quot;"></p>
<p><strong>Tip:</strong> the plugin adds static methods to the global <code>Cypress</code> object that allow you inspecting individual sessions, clearing them, or disabling the plugin completely, all from the browser&#39;s DevTools console. See the <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cypress-data-session#global-methods">README</a>.</p>
<h2><span id="logging-using-api-call">Logging using API call</span></h2><p>In our code, we are using the <code>cy.task</code> to create the user if necessary, but we still log in using the page form. To log in faster, we can use <a target="_blank" rel="noopener" href="https://on.cypress.io/request">cy.request</a> command. This command can submit the <code>/login</code> form and set any returned cookies, like the <code>connect.sid</code> session cookie the application is using.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">loginViaApi</span> = (<span class="params">username, password</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`log in user **<span class="subst">$&#123;username&#125;</span>**`</span>)</span><br><span class="line">  cy.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">form</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">body</span>: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> cy.<span class="title function_">wrap</span>(&#123; username, password &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;register and log in using cy.request&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@user&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.property&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, username)</span><br><span class="line">    <span class="comment">// or access the alias using the test context property</span></span><br><span class="line">    <span class="comment">// after it has been set</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">expect</span>(<span class="variable language_">this</span>.<span class="property">user</span>).<span class="property">to</span>.<span class="property">have</span>.<span class="title function_">keys</span>(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loginViaApi</span>(username, password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user is logged in correctly,</span></span><br><span class="line">  <span class="comment">// the session cookie is set, and when we visit the page</span></span><br><span class="line">  <span class="comment">// we are automatically redirected to the list of chat rooms</span></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Look good, and it is faster too, since we avoid visiting the page and typing into the form, and then submitting it.</p>
<p><img src="../images/data-session/log-in.gif" alt="Logging in using cy.request command"></p>
<h2><span id="caching-the-session-cookie">Caching the session cookie</span></h2><p>When we log in using the form or via <code>cy.request</code> call, the browser receives the session cookie from the backend. This cookie is associated with the user we have created. If this cookie is removed, the server redirects the page back to the log in.</p>
<p><img src="../images/data-session/sid.png" alt="The session cookie used to authenticate the user"></p>
<p>If we log in once, and save this cookie in a variable, we could log in instantly the second time by setting it before <code>cy.visit</code>. This sounds a lot like ... <code>cy.dataSession</code> command. Let&#39;s &quot;build&quot; it by first just using the setup method and storing the cookie inside the data session. Change the <code>loginViaApi</code> function to yield the cookie value, and call this method from the <code>setup</code> method - this will store the cookie in the data session cache.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">loginViaApi</span> = (<span class="params">username, password</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`log in user **<span class="subst">$&#123;username&#125;</span>**`</span>)</span><br><span class="line">  cy.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">form</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">body</span>: &#123;</span><br><span class="line">      username,</span><br><span class="line">      password,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// after cy.request, the cookie should exist in the browser</span></span><br><span class="line">  <span class="keyword">return</span> cy.<span class="title function_">getCookie</span>(<span class="string">&#x27;connect.sid&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;register and log in using data sessions&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> password = <span class="string">&#x27;MySecreT&#x27;</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;logged in user&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// yields the connect.sid cookie</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">loginViaApi</span>(username, password)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the user is logged in correctly,</span></span><br><span class="line">  <span class="comment">// the session cookie is set, and when we visit the page</span></span><br><span class="line">  <span class="comment">// we are automatically redirected to the list of chat rooms</span></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>The second <code>cy.dataSession</code> always recreates the cookie as the captured movie below shows - because we do not have the <code>validate</code> method yet.</p>
<p><img src="../images/data-session/setup-cookie.gif" alt="The cookie is recomputed for every test"></p>
<p>Let&#39;s think when the cookie is valid - when it has <em>any</em> value. Of course, we could validate the cookie fully by making an authorized request and checking if it fails. But for now, let&#39;s assume that IF we have a cookie, then it is ok to use it again. We can tell the data session that <em>any</em> previous value is ok to reuse by using <code>validate: true</code> value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;logged in user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// yields the connect.sid cookie</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loginViaApi</span>(username, password)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// any non-null cookie value is valid</span></span><br><span class="line">  <span class="attr">validate</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Hmm, the test has failed - the user was not logged in when the test visited the page.</p>
<p><img src="../images/data-session/not-logged-in.png" alt="The user was redirected back to the login page"></p>
<p>Cypress clears all cookies before each test. Thus the data storage has a cookie from the previous session BUT it is still in memory. We told the <code>cy.dataStorage</code> that the cookie is valid, but we also need to tell it how to <em>restore</em> the cookie and set it in the browser before proceeding. We have the method <code>recreate</code> for this; it receives the value from the data session storage (just like the method <code>validate</code> does).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;logged in user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// yields the connect.sid cookie</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loginViaApi</span>(username, password)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// any non-null cookie value is valid</span></span><br><span class="line">  <span class="attr">validate</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// if we have the previous valid cookie</span></span><br><span class="line">  <span class="comment">// set it in the browser before any cy.visit</span></span><br><span class="line">  <span class="title function_">recreate</span>(<span class="params">cookie</span>) &#123;</span><br><span class="line">    cy.<span class="title function_">setCookie</span>(<span class="string">&#x27;connect.sid&#x27;</span>, cookie.<span class="property">value</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// if the user is logged in correctly,</span></span><br><span class="line"><span class="comment">// the session cookie is set, and when we visit the page</span></span><br><span class="line"><span class="comment">// we are automatically redirected to the list of chat rooms</span></span><br><span class="line">cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/rooms&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="../images/data-session/recreate.png" alt="Recreate the browser session by setting the cookie from the data session"></p>
<p>Reusing the previous session cookie is <em>very very fast</em>, even compared to logging in using the <code>cy.request</code> command.</p>
<h2><span id="data-session-methods">Data session methods</span></h2><p>The <code>cy.dataSession</code> allows you to create the initial item using <code>setup</code>, stores it, validates if the previous item is still valid using <code>validate</code>, and if it is still valid, set it back into the browser using any Cypress commands using the <code>recreate</code> method. One could summarize the logic using the following list:</p>
<ul>
<li>if there is no previous item for the session named X<ul>
<li>run the <code>setup</code> and store the item under name X</li>
</ul>
</li>
<li>else<ul>
<li>there is a previous item</li>
<li>check if it is still valid using <code>validate</code><ul>
<li>if still valid, call <code>recreate</code> if provided</li>
<li>otherwise call the <code>setup</code> again</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>There are a few other lifecycle methods in <code>cy.dataSession</code> to make dealing with the item more explicit, see the README for details.</p>
<h2><span id="dependent-sessions">Dependent sessions</span></h2><p>Multiple sessions store their data separately. We can check what the session stores from the DevTools console.</p>
<p><img src="../images/data-session/sessions.png" alt="Printing the saved data from each data session"></p>
<p>The two data sessions have a dependency; if the user object is recreated, then the previously stored cookie becomes invalid. One cannot log in using a session for a user that does not exist! Thus we need to invalidate the data session &quot;logged in user&quot; when running the &quot;user&quot; session setup. We can do it explicitly from the &quot;user&quot; data session. When running the <code>setup</code> function, call <code>Cypress.clearDataSession(&#39;logged in user&#39;)</code> and it is deleted.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Cypress</span>.<span class="title function_">clearDataSession</span>(<span class="string">&#x27;logged in user&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>In the recording below all data sessions are set, but I clear the users from the database table and clear the &quot;user&quot; data session, forcing the <code>cy.dataSession</code> to recreate the user. The <code>setup</code> runs and clears the &quot;logged in user&quot; data session. That&#39;s why you see the message &quot;first time for session logged in user&quot; in the Cypress Command Log.</p>
<p><img src="../images/data-session/clear1.gif" alt="The second session is recomputed because the user session clears it"></p>
<p>There is an alternative way to re-compute the data session which I prefer. Instead of the &quot;user&quot; data session clearing every session that might need to be recomputed, why don&#39;t we tell the &quot;logged in user&quot; that it depends on the &quot;user&quot; session? There is a parameter that specifies it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">task</span>(<span class="string">&#x27;makeUser&#x27;</span>, &#123; username, password &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; id, username, password &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">validate</span>(<span class="params">&#123; id &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">task</span>(<span class="string">&#x27;getUser&#x27;</span>, id).<span class="title function_">then</span>(<span class="title class_">Boolean</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;logged in user&#x27;</span>,</span><br><span class="line">  <span class="attr">dependsOn</span>: [<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// yields the connect.sid cookie</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loginViaApi</span>(username, password)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// any non-null cookie value is valid</span></span><br><span class="line">  <span class="attr">validate</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// if we have the previous valid cookie</span></span><br><span class="line">  <span class="comment">// set it in the browser before any cy.visit</span></span><br><span class="line">  <span class="title function_">recreate</span>(<span class="params">cookie</span>) &#123;</span><br><span class="line">    cy.<span class="title function_">setCookie</span>(<span class="string">&#x27;connect.sid&#x27;</span>, cookie.<span class="property">value</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Notice how the second data session declares all sessions it depends on using <code>dependsOn: [&#39;user&#39;]</code> parameter. Under the hood, each data session generates a new random UUID when it is computed using the <code>setup</code> call. Every session with dependencies keeps a list of UUIDs for the sessions it depends on. During the <code>validate</code> step, if any of the upstream data sessions have a different UUID from its list, then it must have been recomputed, and thus the current data session is no longer valid. Clean and simple!</p>
<p><img src="../images/data-session/depends.png" alt="The second session is recomputed when the dependent session is recomputed"></p>
<h2><span id="more-info">More info</span></h2><p>I believe the <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cypress-data-session">cypress-data-session</a> plugin provides a very flexible and powerful way for creating and re-using any data during Cypress tests. It can do all the things I have shown in this blog post and more. For example, it can share the data across specs! For more information, see the plugin&#39;s README, and the example application <a target="_blank" rel="noopener" href="https://github.com/bahmutov/chat.io">bahmutov&#x2F;chat.io</a>. You can also find lots of example videos, some of them linked here:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://youtu.be/As5yqkoZOx8">Introduction to cypress-data-session package</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/VQtjDGCuRzI">Use Data Alias Created Automatically By cypress-data-session</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/P-sb5OHSNsM">Create User Using cypress-data-session Command</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/SyDz6l_EFoc">Invalidate cy.session From cypress-data-session</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/ws4TitQJ7fQ">Share Data Across Specs Using cypress-data-session Plugin</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/PTlcRBgFJaM">Use cy.dataSession To Create A User And Log In</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=0KTGc83wSoA">Quickly Create A User And Log in Using Dependent Data Sessions</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/7ipCvJQixI0">Introduction To cypress-data-session Plugin</a></li>
</ul>
<p>See the <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cypress-data-session#videos">cypress-data-session README Videos section</a> for the up-to-date list.</p>
<p>Read the blog post <a href="/blog/faster-user-creation/" title="Faster User Object Creation">Faster User Object Creation</a>.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
  <p>
    Have a Cypress question? Want me to answer it? Consider supporting me via <a target="_blank" rel="noopener" href="https://github.com/sponsors/bahmutov">GitHub Sponsors</a> or by purchasing my <a target="_blank" rel="noopener" href="https://cypress.tips/courses">Cypress courses</a>.
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/cypresss-data-session/" data-id="cl3d3uh0u004ig0vge2q6ezcd" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/cypresss-data-session/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/" rel="tag">cypress</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../cypress-grep-filters/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Faster test execution with cypress-grep
        
      </div>
    </a>
  
  
    <a href="../refactor-using-each/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Refactor Tests To Be Independent And Fast Using Cypress-Each Plugin</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">148</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">475</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">209</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">139</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.8px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.8px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.2px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16.8px;">ci</a> <a href="../tags/circle/" style="font-size: 14px;">circle</a> <a href="../tags/climate/" style="font-size: 14.8px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 15.2px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14.4px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.8px;">db</a> <a href="../tags/docker/" style="font-size: 14.4px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.8px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 15.2px;">git</a> <a href="../tags/github/" style="font-size: 16px;">github</a> <a href="../tags/graphql/" style="font-size: 11.6px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.2px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.6px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 14px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.4px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.2px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.4px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.4px;">ramda</a> <a href="../tags/react/" style="font-size: 12.4px;">react</a> <a href="../tags/react-native/" style="font-size: 11.2px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.4px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 14px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.2px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.6px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.4px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.6px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/05/">May 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/04/">April 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/03/">March 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../mobile-tests/">How We Run The Mobile Web Browser Tests at Mercari US</a>
          </li>
        
          <li>
            <a href="../pass-reference/">Pass The Reference</a>
          </li>
        
          <li>
            <a href="../check-more-things/">Check More Things Before Clicking</a>
          </li>
        
          <li>
            <a href="../secrets-to-env/">Set All Cypress Env Values Using A Single GitHub Actions Secret</a>
          </li>
        
          <li>
            <a href="../quick-click/">A Quick React Component Test</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/cypresss-data-session/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
