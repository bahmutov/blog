<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>1, 2, 3, tested | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Testing AngularJS requires too much boilerplate code. We were so fed up with
writing extra lines, looking up the syntax, etc. that we wrote a helper library
kensho/ng-describe with a single function.">
<meta property="og:type" content="article">
<meta property="og:title" content="1, 2, 3, tested">
<meta property="og:url" content="http://glebbahmutov.com/blog/1-2-3-tested/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Testing AngularJS requires too much boilerplate code. We were so fed up with
writing extra lines, looking up the syntax, etc. that we wrote a helper library
kensho/ng-describe with a single function.">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/coverage/code-coverage-add.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/coverage/code-coverage-missed-branch.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/unit-testing-angularjs-tutorial/master/images/controller.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="1, 2, 3, tested">
<meta name="twitter:description" content="Testing AngularJS requires too much boilerplate code. We were so fed up with
writing extra lines, looking up the syntax, etc. that we wrote a helper library
kensho/ng-describe with a single function.">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="..//" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="..//" id="subtitle">Software advice from Dr. Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">Software advice from <a id="subtitle" href="http://glebbahmutov.com">Dr. Gleb Bahmutov PhD</a></span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="..//">Home</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-1-2-3-tested" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2015-08-15T04:00:00.000Z" itemprop="datePublished">Aug 15 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      1, 2, 3, tested
    </h1>

    <h2 class="article-title" itemprop="name">
      Unit testing AngularJS code in record time using ng-describe.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Testing AngularJS requires too much boilerplate code. We were so fed up with
writing extra lines, looking up the syntax, etc. that we wrote a helper library
<a href="https://github.com/kensho/ng-describe" target="_blank" rel="external">kensho/ng-describe</a> with a single function. Yet that function can hide
all the gory AngularJS details, allowing you to write unit tests in record times.
In this tutorial I will show how to start unit testing an AngularJS code, how to
get code coverage, and how to test different Angular features using <em>ng-describe</em> library.</p>
<p>The code to go with this tutorial is available at <a href="https://github.com/bahmutov/unit-testing-angularjs-tutorial" target="_blank" rel="external">bahmutov/unit-testing-angularjs-tutorial</a>.
I advise to clone that repo to a local folder, checkout each tag as you read the tutorial,
try running the code and the unit tests.</p>
<pre><code>git clone git@github<span class="class">.com</span>:bahmutov/unit-testing-angularjs-tutorial<span class="class">.git</span>
cd unit-testing-angularjs-tutorial
npm install
</code></pre><h2 id="unit-testing-javascript-code">Unit testing JavaScript code</h2><h3 id="step-0">step-0</h3><p>You can find the source for the following section under tag <code>step-0</code>. If you checked out
the repository, run <code>git checkout step-0</code> to get to this commit.</p>
<p>Let us start with the simplest example to get a feel for Jasmine framework and Karma
test runner. First we need to write the simplest function one can test.</p>
<figure class="highlight js"><figcaption><span>add.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>There are no unit tests yet - we are not sure how the <code>add</code> function behaves when we pass numbers
or strings or undefined values. We need to unit test the code in <code>add.js</code>.</p>
<p>Let us create a <em>spec</em> file - in the Behavior Driven Development (BDD for short) testing language
we are going to use, the <em>spec</em> file <em>specifies</em> how the <code>add</code> function behaves. Typically, I 
give the <em>spec</em> file the same name as the source file plus <code>-spec.js</code> suffix.</p>
<figure class="highlight js"><figcaption><span>add-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  it(<span class="string">&apos;adds numbers&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect(add(<span class="number">2</span>, <span class="number">3</span>)).toEqual(<span class="number">5</span>);</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>File <code>add-spec.js</code> describes the <code>add</code> function, telling us that <code>it</code> (meaning <code>add</code>) <em>adds numbers</em>.
When we add number 2 to number 3 we expect to get back number 5.</p>
<p>Where do functions <code>describe</code> and <code>it</code> come from? From the Jasmine testing library we are going to use
to execute the unit tests. While we could get a stand alone Jasmine command line tool, a much better
solution is to use <a href="http://karma-runner.github.io/" target="_blank" rel="external">Karma</a> test runner. It has Jasmine adapter for executing Jasmine unit tests,
plus can do a lot more. It is easier to just start using it right away.</p>
<h3 id="step-1">step-1</h3><p>In the project folder, I added Karma configuration file. You can create one if you install
Karma globally (<code>npm install -g karma</code>) and then call <code>karma init</code>. Here is the file I generated</p>
<figure class="highlight js"><figcaption><span>karma.conf.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>{</span><br><span class="line">  config.set({</span><br><span class="line">    frameworks: [<span class="string">&apos;jasmine&apos;</span>],</span><br><span class="line">    files: [</span><br><span class="line">      <span class="string">&apos;*.js&apos;</span></span><br><span class="line">    ],</span><br><span class="line">    port: <span class="number">9876</span>,</span><br><span class="line">    browsers: [<span class="string">&apos;Chrome&apos;</span>],</span><br><span class="line">    singleRun: <span class="literal">true</span></span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>Then I installed Karma and the necessary plugins (like Jasmine, Chrome launcher) in the project&apos;s 
folder.</p>
<pre><code>npm install --<span class="built_in">save</span>-<span class="built_in">dev</span> karma karma-jasmine karma-chrome-launcher
</code></pre><p>Then I added the <code>karma start</code> command as the package test script.
Here is the <code>package.json</code></p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: {</span><br><span class="line">  &quot;test&quot;: &quot;karma start&quot;</span><br><span class="line">},</span><br><span class="line">&quot;devDependencies&quot;: {</span><br><span class="line">  &quot;jasmine-core&quot;: &quot;2.3.4&quot;,</span><br><span class="line">  &quot;karma&quot;: &quot;0.13.9&quot;,</span><br><span class="line">  &quot;karma-chrome-launcher&quot;: &quot;0.2.0&quot;,</span><br><span class="line">  &quot;karma-jasmine&quot;: &quot;0.3.6&quot;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>You can now execute <code>npm test</code> command, which will flash Chrome browser and will report a single
successfully passed unit test.</p>
<pre><code>$ npm test
&gt; unit-testing-angularjs-tutorial@<span class="number">1.0</span><span class="number">.0</span> test /Users/gleb/git/unit-testing-angularjs-tutorial
&gt; karma start
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">06.164</span>:INFO [karma]: Karma v0<span class="number">.13</span><span class="number">.9</span> server started at http:<span class="comment">//localhost:9876/</span>
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">06.169</span>:INFO [launcher]: Starting browser Chrome
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">28</span>:<span class="number">07.260</span>:INFO [Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>)]: 
    Connected on socket aU7IWF2FR43DDxjmAAAA with id <span class="number">6382992</span>
Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>): Executed <span class="number">1</span> of <span class="number">1</span> SUCCESS (<span class="number">0.006</span> secs / <span class="number">0.002</span> secs)
</code></pre><p>You can see the code and run the test command by using tag <code>step-1</code></p>
<h3 id="step-2">step-2</h3><p>Before we run each unit test, we might need to set things up. In the simple source example above,
let us verify that the <code>add</code> is an existing function. In Jasmine (and other BDD testing libraries)
one can perform actions before each unit test by registering a single or multiple callbacks</p>
<figure class="highlight js"><figcaption><span>add-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect(<span class="keyword">typeof</span> add).toEqual(<span class="string">&apos;function&apos;</span>);</span><br><span class="line">  });</span><br><span class="line">  it(<span class="string">&apos;adds numbers&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect(add(<span class="number">2</span>, <span class="number">3</span>)).toEqual(<span class="number">5</span>);</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Running <code>npm test</code> should still pass, but if we expected <code>add</code> to be an object instead of a function
we would get an error</p>
<figure class="highlight js"><figcaption><span>add-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect(<span class="keyword">typeof</span> add).toEqual(<span class="string">&apos;object&apos;</span>);</span><br><span class="line">  });</span><br><span class="line">  ...</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<pre><code>$ npm test
&gt; unit-testing-angularjs-tutorial@<span class="number">1.0</span><span class="number">.0</span> test /Users/gleb/git/unit-testing-angularjs-tutorial
&gt; karma <span class="built_in">start</span>
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">28.636</span>:INFO [karma]: Karma v0<span class="number">.13</span><span class="number">.9</span> server started <span class="keyword">at</span> <span class="keyword">http</span>://localhost:<span class="number">9876</span>/
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">28.641</span>:INFO [launcher]: Starting browser Chrome
<span class="number">15</span> <span class="number">08</span> <span class="number">2015</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">30.081</span>:INFO [Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>)]: 
    Connected <span class="command"><span class="keyword">on</span> <span class="title">socket</span> <span class="title">tjX2X1rAcWJHTSmJAAAA</span> <span class="title">with</span> <span class="title">id</span> <span class="title">38618292</span></span>
Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>) <span class="built_in">add</span> adds numbers FAILED
    Expected <span class="string">&apos;function&apos;</span> <span class="built_in">to</span> equal <span class="string">&apos;object&apos;</span>.
        <span class="keyword">at</span> Object.&lt;anonymous&gt; (/Users/gleb/git/unit-testing-angularjs-tutorial/<span class="built_in">add</span>-spec.js:<span class="number">3</span>:<span class="number">24</span>)
Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>): Executed <span class="number">1</span> <span class="operator">of</span> <span class="number">1</span> (<span class="number">1</span> FAILED) ERROR (<span class="number">0.009</span> <span class="built_in">secs</span> / <span class="number">0.004</span> <span class="built_in">secs</span>)
npm ERR! Test failed.  See above <span class="keyword">for</span> more details.
</code></pre><p>We will use <code>beforeEach</code> callbacks to initialize AngularJS state before running unit tests in the
future steps. Note, there is also <code>afterEach</code> callback, and you can register multiple <code>before</code> and
<code>after</code> functions to run.</p>
<h3 id="step-3">step-3</h3><p>It is important for the unit tests to execute most if not every line of the source code.
One can check if the unit tests do this by computing <em>code coverage</em> automatically every time
the unit tests run. This is very simple to do using another Karma plugin.</p>
<pre><code>npm install --<span class="built_in">save</span>-<span class="built_in">dev</span> karma-coverage
</code></pre><p>Add <code>coverage</code> preprocessor for the JavaScript files (typically I prefer to only instrument the source files,
not the specs), and add the <code>coverage</code> reporter to save the results</p>
<figure class="highlight"><figcaption><span>karma.conf.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(config) {</span><br><span class="line">  config.set({</span><br><span class="line">    ...</span><br><span class="line">    preprocessors: {</span><br><span class="line">      &apos;*.js&apos;: &apos;coverage&apos;</span><br><span class="line">    },</span><br><span class="line">    reporters: [&apos;progres&apos;, coverage&apos;]</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>Run the command <code>npm test</code> and then open the coverage report page in the browser</p>
<pre><code><span class="keyword">open</span> coverage/Chrome&lt;...&gt;/<span class="built_in">index</span>.html
</code></pre><p>It will show code coverage information line by line for both <code>add.js</code> and <code>add-spec.js</code>.
We can see that we have hit every line of the <code>add.js</code> source file</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/coverage/code-coverage-add.png" alt="code coverage"></p>
<p>If we add some other code to the <code>add.js</code>, we will see missed lines after executing the same tests</p>
<figure class="highlight js"><figcaption><span>add.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span>) {</span><br><span class="line">  add = <span class="literal">undefined</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The coverage shows missed line and missed branch <code>if (false)</code>.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/coverage/code-coverage-missed-branch.png" alt="missed line"></p>
<p>Code coverage will become invaluable when you want to target the unit tests to the specific areas
of the code before refactoring or fixing a bug.</p>
<h2 id="step-4">step-4</h2><p>Let us make a tiny Angular application that will add numbers. The simplest way to use our addition
function is to make it a value of an Angular module.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;Calc&apos;</span>, [])</span><br><span class="line">  .value(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>We now need AngularJS library and if we want to test it, <a href="https://docs.angularjs.org/api/ngMock" target="_blank" rel="external">angular-mocks</a> helper
library.</p>
<pre><code>npm <span class="operator"><span class="keyword">install</span> <span class="comment">--save angular</span>
npm <span class="keyword">install</span> <span class="comment">--save-dev angular-mocks</span></span>
</code></pre><p>We should add these two libraries to the Karma configuration file, loading them before
our source files.</p>
<figure class="highlight js"><figcaption><span>karma.conf.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>{</span><br><span class="line">  config.set({</span><br><span class="line">    files: [</span><br><span class="line">      <span class="string">&apos;node_modules/angular/angular.js&apos;</span>,</span><br><span class="line">      <span class="string">&apos;node_modules/angular-mocks/angular-mocks.js&apos;</span>,</span><br><span class="line">      <span class="string">&apos;*.js&apos;</span></span><br><span class="line">    ],</span><br><span class="line">    ...</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>This tutorial is mainly about using <a href="https://github.com/kensho/ng-describe" target="_blank" rel="external">ng-describe</a> to perform AngularJS unit
testing with minimum boilerplate code, but just for fun, let us first write a unit
test using just the <code>angular-mocks</code> library. Modify the <code>add-spec.js</code> to load the
<code>Calc</code> module and then inject <code>add</code> value.</p>
<figure class="highlight js"><figcaption><span>add-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> add;</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    angular.mock.module(<span class="string">&apos;Calc&apos;</span>);</span><br><span class="line">    angular.mock.inject(<span class="function"><span class="keyword">function</span> (<span class="params">_add_</span>) </span>{</span><br><span class="line">      add = _add_;</span><br><span class="line">      expect(<span class="keyword">typeof</span> add).toEqual(<span class="string">&apos;function&apos;</span>);</span><br><span class="line">    })</span><br><span class="line">  });</span><br><span class="line">  it(<span class="string">&apos;adds numbers&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect(add(<span class="number">2</span>, <span class="number">3</span>)).toEqual(<span class="number">5</span>);</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Notice the extra lines and calls to first load the module <code>Calc</code> to be available
during the testing, second to inject the function provided by the <code>value(&apos;add&apos;, function ...)</code>
We also had to surround normal name <code>add</code> with underscores in <code>inject(function (_add_) { ...</code>
to avoid clashing with the local variable <code>add</code>.</p>
<p>This is a common theme when unit testing AngularJS code - things hidden by the framework&apos;s
dependency injection and other &quot;magic&quot; code are suddenly exposed and require non-trivial
amount of code to be setup during unit testing. To get even better perspective, let us
write a controller that would use <code>add</code> function to perform additions.</p>
<h2 id="step-5">step-5</h2><p>I created simple page that adds user-entered two number. The markup:</p>
<figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">title</span>&gt;</span>Addition<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;node_modules/angular/angular.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;add.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;add-app.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span> <span class="attribute">ng-app</span>=<span class="value">&quot;AddApp&quot;</span> <span class="attribute">ng-controller</span>=<span class="value">&quot;AddController&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">&quot;number&quot;</span> <span class="attribute">ng-model</span>=<span class="value">&quot;a&quot;</span> /&gt;</span> + <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">&quot;number&quot;</span> <span class="attribute">ng-model</span>=<span class="value">&quot;b&quot;</span> /&gt;</span> =</span><br><span class="line">    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">&quot;number&quot;</span> <span class="attribute">ng-model</span>=<span class="value">&quot;sum&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The code for <code>AddApp</code> module will be in <code>add-app.js</code></p>
<figure class="highlight js"><figcaption><span>add-app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;AddApp&apos;</span>, [<span class="string">&apos;Calc&apos;</span>])</span><br><span class="line">  .controller(<span class="string">&apos;AddController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, add</span>) </span>{</span><br><span class="line">    $scope.a = $scope.b = $scope.sum = <span class="number">0</span>;</span><br><span class="line">    $scope.$watch(<span class="string">&apos;a&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      $scope.sum = add($scope.a, $scope.b);</span><br><span class="line">    });</span><br><span class="line">    $scope.$watch(<span class="string">&apos;b&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      $scope.sum = add($scope.a, $scope.b);</span><br><span class="line">    });</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>The result is simple to see, you can open the <code>index.html</code> file using any browser locally</p>
<pre><code><span class="keyword">open</span> <span class="keyword">index</span>.html
</code></pre><p>Enter two numbers and see their sum</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/unit-testing-angularjs-tutorial/master/images/controller.png" alt="AddApp"></p>
<p>We have already unit tested the <code>add</code> function using <code>angular-mocks</code> and have encountered
writing a little bit of boilerplate code. Let us unit test the controller <code>AddController</code> if
it is an easy thing to do using <code>angular-mocks</code>.</p>
<h2 id="step-6">step-6</h2><p>Let us test if the controller <code>AddController</code> initializes properties <code>a</code>, <code>b</code> and <code>sum</code> to
zeroes. It must be simple, right?</p>
<figure class="highlight js"><figcaption><span>add-controller-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&apos;add controller&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> $controller, $rootScope, $scope;</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    angular.mock.module(<span class="string">&apos;AddApp&apos;</span>);</span><br><span class="line">  });</span><br><span class="line">  beforeEach(angular.mock.inject(<span class="function"><span class="keyword">function</span> (<span class="params">_$controller_, _$rootScope_</span>) </span>{</span><br><span class="line">    $controller = _$controller_;</span><br><span class="line">    $rootScope = _$rootScope_;</span><br><span class="line">  }));</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    $scope = $rootScope.$<span class="keyword">new</span>();</span><br><span class="line">    $controller(<span class="string">&apos;AddController&apos;</span>, { $scope: $scope });</span><br><span class="line">  });</span><br><span class="line">  it(<span class="string">&apos;sets a, b and sum to zero&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    expect($scope.a).toEqual(<span class="number">0</span>);</span><br><span class="line">    expect($scope.b).toEqual(<span class="number">0</span>);</span><br><span class="line">    expect($scope.sum).toEqual(<span class="number">0</span>);</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>The unit test looks nothing like the simplet AngularJS application code. The same magic
that works so nicely behind the scenes now requires the <em>developer</em> to work to execute.
We had to use 3 <code>beforeEach</code> callbacks to set things up before our unit test</p>
<ul>
<li>Load the module under test <code>AddApp</code>, which is reasonable</li>
<li>Inject both <code>$controller</code> and <code>$rootScope</code> services - something we almost never do in the normal
AngularJS code</li>
<li>Create a new scope object using <code>$rootScope.$new</code> method and then create the controller instance.</li>
</ul>
<p>This is a lot of boilerplate code just to get the ball rolling.</p>
<h2 id="step-7">step-7</h2><p>Let us use the <a href="https://github.com/kensho/ng-describe" target="_blank" rel="external">kensho/ng-describe</a> to remove all the boilerplate code from the above
unit test. First install the library and add it to the <code>karma.conf.js</code> before your specs</p>
<pre><code>npm install --<span class="built_in">save</span>-<span class="built_in">dev</span> ng-describe
</code></pre><figure class="highlight js"><figcaption><span>karma.conf.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">files: [</span><br><span class="line">  <span class="string">&apos;node_modules/angular/angular.js&apos;</span>,</span><br><span class="line">  <span class="string">&apos;node_modules/angular-mocks/angular-mocks.js&apos;</span>,</span><br><span class="line">  <span class="string">&apos;node_modules/ng-describe/dist/ng-describe.js&apos;</span>,</span><br><span class="line">  <span class="string">&apos;*.js&apos;</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p><code>ng-describe</code> is a library with a minimal api. It is a single function that takes an object of options</p>
<pre><code><span class="tag">ngDescribe</span>({ ... });
</code></pre><p>That is it. You can think that <code>ngDescribe</code> replaces <code>describe</code> function calls used above to perform
Angular-specific initialization before each unit test. For example, to test <code>add</code> function from 
the <code>add-spec.js</code> change the code to do the following</p>
<figure class="highlight js"><figcaption><span>add-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;Calc&apos;</span>,</span><br><span class="line">  inject: <span class="string">&apos;add&apos;</span>,</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;adds numbers&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      expect(deps.add(<span class="number">2</span>, <span class="number">3</span>)).toEqual(<span class="number">5</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Unit test <code>adds numbers</code> needs function <code>add</code> provided by the module <code>Calc</code>. The module loading
and <code>add</code> injection happen because we specified the module and the list of services to inject</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;Calc&apos;</span>,</span><br><span class="line">  inject: <span class="string">&apos;add&apos;</span>,</span><br><span class="line">  ...</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>You can specify multiple modules and multiple values to inject. All injected values will be properties
of the first argument to the special <code>test</code> callback. In my code I usually name the first argument <code>deps</code>,
which is short for <code>dependencies</code>. Thus the unit test just calls <code>deps.add</code> inside:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  ...</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;adds numbers&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      expect(deps.add(<span class="number">2</span>, <span class="number">3</span>)).toEqual(<span class="number">5</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>This is how <code>ng-describe</code> works - it does a lot of Angular-specific work behind the scenes, placing
the result into the <code>deps</code> argument. The unit tests go inside the <code>test</code> callback, and have full access
to the <code>deps</code> object because it encloses them.</p>
<h2 id="step-8">step-8</h2><p>Let us look how much boilerplate <code>ng-describe</code> removes when testing the controller <code>AddController</code>.
We already saw that unit testing a controller using <code>angular-mocks</code> requires a lot of code just
a controller instance. Here is the same unit test switched to <code>ng-describe</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;AddApp&apos;</span>,</span><br><span class="line">  controller: <span class="string">&apos;AddController&apos;</span>,</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;sets a, b and sum to zero&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      expect(deps.AddController.a).toEqual(<span class="number">0</span>);</span><br><span class="line">      expect(deps.AddController.b).toEqual(<span class="number">0</span>);</span><br><span class="line">      expect(deps.AddController.sum).toEqual(<span class="number">0</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>That is it. We tell <code>ng-describe</code> that we need a controller <code>AddController</code> and it does the rest behind
the scenes. What is the object <code>deps.AddController</code> then? In most cases when creating a controller, 
we really need the <code>$scope</code> object. Thus the <code>ng-describe</code> when creating a controller, places 
<em>its created scope</em> into the object passed to the tests. The unit tests then interact with the scope
object</p>
<pre><code>expect<span class="comment">(deps.AddController.a)</span>.toEqual<span class="comment">(0)</span>;
<span class="comment">// logically same as</span>
expect<span class="comment">($scope.a)</span>.toEqual<span class="comment">(0)</span>;
</code></pre><h2 id="step-9">step-9</h2><p>We have only tested the initial values set inside the controller. 
Can we test the summation logic too? If we set the values of <code>a</code> and <code>b</code> in the controller&apos;s scope,
we should get the property <code>sum</code> updated too. Here is the second unit test we can add to 
the <code>add-controller-spec.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;AddApp&apos;</span>,</span><br><span class="line">  controller: <span class="string">&apos;AddController&apos;</span>,</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    <span class="comment">// first unit test as before</span></span><br><span class="line">    it(<span class="string">&apos;computes the sum&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      deps.AddController.a = <span class="number">10</span>;</span><br><span class="line">      deps.AddController.b = <span class="number">20</span>;</span><br><span class="line">      deps.step();</span><br><span class="line">      expect(deps.AddController.sum).toEqual(<span class="number">30</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>The <code>deps.step()</code> method is equivalent to <code>$rootScope.$digest()</code> or <code>deps.AddController.$apply();</code> 
but removes need to inject the  <code>$rootScope</code> dependency or remember the syntax. It is up to you which one you
prefer.</p>
<h2 id="step-10">step-10</h2><p>We will finish this tutorial with another powerful <code>ng-describe</code> feature: simple server response mocking.
Sometimes our application has to make requests to the server. For example, imagine that instead of computing
the sum on the client side, we send both numbers <code>a</code> and <code>b</code> to a server that performs the computation and
returns the sum.</p>
<figure class="highlight js"><figcaption><span>add.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;RemoteCalc&apos;</span>, [])</span><br><span class="line">  .service(<span class="string">&apos;add&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$http</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>{</span><br><span class="line">      <span class="keyword">return</span> $http.get(<span class="string">&apos;/add/&apos;</span>, {</span><br><span class="line">        params: {</span><br><span class="line">          a: a,</span><br><span class="line">          b: b</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    };</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>We will change our application code to use <code>RemoteCalc</code> instead of plain <code>Calc</code> to provide <code>add</code>,
and will use the resolved value instead of the returned result</p>
<figure class="highlight js"><figcaption><span>add-app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;AddApp&apos;</span>, [<span class="string">&apos;RemoteCalc&apos;</span>])</span><br><span class="line">  .controller(<span class="string">&apos;AddController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, add</span>) </span>{</span><br><span class="line">    $scope.a = $scope.b = $scope.sum = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">computeSum</span>(<span class="params"></span>) </span>{</span><br><span class="line">      add($scope.a, $scope.b)</span><br><span class="line">        .success(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>{</span><br><span class="line">          $scope.sum = response;</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    $scope.$watch(<span class="string">&apos;a&apos;</span>, computeSum);</span><br><span class="line">    $scope.$watch(<span class="string">&apos;b&apos;</span>, computeSum);</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>If we run the unit tests now, we get an error - an Ajax request!</p>
<pre><code>Chrome <span class="number">44.0</span><span class="number">.2403</span> (Mac OS X <span class="number">10.10</span><span class="number">.2</span>) <span class="keyword">default</span> tests computes the sum FAILED
    Error: Unexpected request: GET /add/?a=<span class="number">10</span>&amp;b=<span class="number">20</span>
</code></pre><p>Of course, our unit test sets values 10 and 20, the controller makes the request right away!</p>
<figure class="highlight js"><figcaption><span>add-controller-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;AddApp&apos;</span>,</span><br><span class="line">  controller: <span class="string">&apos;AddController&apos;</span>,</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;computes the sum&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      deps.AddController.a = <span class="number">10</span>;</span><br><span class="line">      deps.AddController.b = <span class="number">20</span>;</span><br><span class="line">      deps.step();</span><br><span class="line">      expect(deps.AddController.sum).toEqual(<span class="number">30</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>We need to return 30 in this case, luckily it is simple to do using <code>ngDescribe</code>. Just add another property
to the <code>ngDescribe</code> options with values to be returned for each expected HTTP request</p>
<figure class="highlight js"><figcaption><span>add-controller-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;AddApp&apos;</span>,</span><br><span class="line">  controller: <span class="string">&apos;AddController&apos;</span>,</span><br><span class="line">  http: {</span><br><span class="line">    get: {</span><br><span class="line">      <span class="string">&apos;/add/?a=10&amp;b=20&apos;</span>: <span class="number">30</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;computes the sum&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      deps.AddController.a = <span class="number">10</span>;</span><br><span class="line">      deps.AddController.b = <span class="number">20</span>;</span><br><span class="line">      deps.step();</span><br><span class="line">      expect(deps.AddController.sum).toEqual(<span class="number">30</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>When during the course of the unit test, the controller uses <code>RemoteCalc.add</code> service, which
calls <code>$http.get</code> and executes the <code>GET /add/?a=10&amp;b=20</code> - the mock backend will be ready to
return 30.</p>
<h2 id="step-11">step-11</h2><p>While mocking the responses to the expected <code>http</code> requests is powerful, I would argue that the unit
test gets way too deep to the implementation details. We are testing <code>AddController</code>, yet we looked
inside the <code>RemoteCalc</code> to find that it makes a GET request to the server. The unit test is mocking
an action very far from the code under the test itself. Can we do better?</p>
<p>Yes we can using <em>mocks</em>, which are pieces of fake code to be used instead of the real code during
unit tests. For example, the entire actual <code>RemoteCalc.add</code> service making the GET http request
can be replaced with a <em>mock</em> for the duration of the unit test. With <code>ng-describe</code> it is simple</p>
<figure class="highlight js"><figcaption><span>add-controller-spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ngDescribe({</span><br><span class="line">  <span class="built_in">module</span>: <span class="string">&apos;AddApp&apos;</span>,</span><br><span class="line">  controller: <span class="string">&apos;AddController&apos;</span>,</span><br><span class="line">  mock: {</span><br><span class="line">    AddApp: {</span><br><span class="line">      add: <span class="function"><span class="keyword">function</span> (<span class="params">$q, a, b</span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> $q.when(a + b);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;computes the sum&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      deps.AddController.a = <span class="number">10</span>;</span><br><span class="line">      deps.AddController.b = <span class="number">20</span>;</span><br><span class="line">      deps.step();</span><br><span class="line">      expect(deps.AddController.sum).toEqual(<span class="number">30</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Using the special property <code>mock</code> we are setting fake implementation to be injected by the
Angular dependency injection:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mock: {</span><br><span class="line">  AddApp: {</span><br><span class="line">    add: <span class="function"><span class="keyword">function</span> (<span class="params">$q, a, b</span>) </span>{</span><br><span class="line">      <span class="keyword">return</span> $q.when(a + b);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Whenever module <code>AddApp</code> injects service <code>add</code>, the environment will provide our fake function</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">$q, a, b</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $q.when(a + b);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Notice that <code>ng-describe</code> is smart enough to inject <em>other services</em> into the fake code. For example,
because <code>$http.get</code> returns a promise, we need to return a promise too from the fake code. We do this
by asking for the <code>$q</code> service and returning <code>$q.when(expression)</code>. This is every better code than
mocking <code>http</code> because it will return a correct computed sum <code>a+b</code> instead of hardcoded 30 for
a single expected request <code>/add/?a=10&amp;b=20</code>.</p>
<h2 id="conclusion">Conclusion</h2><p>I hope this tutorial set you on the path to effectively unit test your AngularJS application code.
You can now target a particular code with the tests and write a test with minimum boilerplate.</p>
<p>The <a href="https://github.com/kensho/ng-describe" target="_blank" rel="external">ng-describe/README.md</a> has lots of examples showing every supported test feature,
including testing directives, spying on services and other boilerplate-prone test cases. I would start
by reading the examples. If there is a question, or a particular testing feature missing, please
open a Github <a href="https://github.com/kensho/ng-describe/issues" target="_blank" rel="external">issue</a> with a detailed example; including
the code to be tested and the unit test that is not working.</p>
<h2 id="additional-information">Additional information</h2><ul>
<li><a href="http://slides.com/bahmutov/ng-describe/" target="_blank" rel="external">Unit testing AngularJS</a> - slides for the presentation I have delivered at AngularJS NYC 
meetup in August 2015</li>
<li><a href="../testing-angularjs-under-node/">Testing AngularJS under Node</a></li>
<li><a href="../testing-angular-async-stuff/">Testing Angular async stuff</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>

    

    <footer class="article-footer">
      <a data-url="http://glebbahmutov.com/blog/1-2-3-tested/" data-id="cii9q39pd00xalourjsmyy7nk" class="article-share-link">Share</a>
      
        <a href="http://glebbahmutov.com/blog/1-2-3-tested/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/angularjs/">angularjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/">testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/tutorial/">tutorial</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../express-sessions/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Express sessions
        
      </div>
    </a>
  
  
    <a href="../perfect-code-zero-effort/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Perfect code, zero effort</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">190</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">82</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">142</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">44</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 12.86px;">QUnit</a><a href="../tags/advice/" style="font-size: 19.29px;">advice</a><a href="../tags/angular/" style="font-size: 10px;">angular</a><a href="../tags/angularjs/" style="font-size: 18.57px;">angularjs</a><a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a><a href="../tags/assertions/" style="font-size: 13.57px;">assertions</a><a href="../tags/boilerplate/" style="font-size: 15.71px;">boilerplate</a><a href="../tags/browser/" style="font-size: 14.29px;">browser</a><a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a><a href="../tags/d3/" style="font-size: 11.43px;">d3</a><a href="../tags/database/" style="font-size: 10px;">database</a><a href="../tags/db/" style="font-size: 12.86px;">db</a><a href="../tags/es6/" style="font-size: 14.29px;">es6</a><a href="../tags/es7/" style="font-size: 10px;">es7</a><a href="../tags/functional/" style="font-size: 17.14px;">functional</a><a href="../tags/generators/" style="font-size: 12.86px;">generators</a><a href="../tags/git/" style="font-size: 13.57px;">git</a><a href="../tags/grunt/" style="font-size: 13.57px;">grunt</a><a href="../tags/gulp/" style="font-size: 11.43px;">gulp</a><a href="../tags/immutable/" style="font-size: 10px;">immutable</a><a href="../tags/interview/" style="font-size: 11.43px;">interview</a><a href="../tags/jade/" style="font-size: 12.14px;">jade</a><a href="../tags/javascript/" style="font-size: 20px;">javascript</a><a href="../tags/jshint/" style="font-size: 11.43px;">jshint</a><a href="../tags/modular-development/" style="font-size: 15.71px;">modular development</a><a href="../tags/nodejs/" style="font-size: 18.57px;">nodejs</a><a href="../tags/performance/" style="font-size: 15px;">performance</a><a href="../tags/promises/" style="font-size: 16.43px;">promises</a><a href="../tags/proposal/" style="font-size: 10.71px;">proposal</a><a href="../tags/reactive/" style="font-size: 10.71px;">reactive</a><a href="../tags/reactjs/" style="font-size: 10.71px;">reactjs</a><a href="../tags/security/" style="font-size: 12.14px;">security</a><a href="../tags/sentry/" style="font-size: 13.57px;">sentry</a><a href="../tags/testing/" style="font-size: 17.86px;">testing</a><a href="../tags/tutorial/" style="font-size: 12.86px;">tutorial</a><a href="../tags/ui/" style="font-size: 10px;">ui</a><a href="../tags/web-workers/" style="font-size: 12.86px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../hydrate-your-apps/">Hydrate your apps</a>
          </li>
        
          <li>
            <a href="../my-node-tools/">My Node tools</a>
          </li>
        
          <li>
            <a href="../pass-the-logic/">Pass the logic</a>
          </li>
        
          <li>
            <a href="../use-some-es6-in-cli-apps/">Use some ES6 in CLI apps</a>
          </li>
        
          <li>
            <a href="../1-2-3-linted/">1, 2, 3, linted</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="..//" class="mobile-nav-link">Home</a>
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'http://glebbahmutov.com/blog/1-2-3-tested/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css" type="text/css">
  <script src="../fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="../js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>