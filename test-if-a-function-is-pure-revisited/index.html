<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Test if a function is pure revisited | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="I have played with pure JavaScript functions in the previous blog post Test if a function is pure. I know that pure functions are simpler to test and use in my code, but telling if a particular given">
<meta property="og:type" content="article">
<meta property="og:title" content="Test if a function is pure revisited">
<meta property="og:url" content="https://glebbahmutov.com/blog/test-if-a-function-is-pure-revisited/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="I have played with pure JavaScript functions in the previous blog post Test if a function is pure. I know that pure functions are simpler to test and use in my code, but telling if a particular given">
<meta property="og:locale">
<meta property="article:published_time" content="2016-04-07T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.361Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="functional">
<meta property="article:tag" content="javascript">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-test-if-a-function-is-pure-revisited" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2016-04-07T04:00:00.000Z" itemprop="datePublished">Apr 7 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Test if a function is pure revisited
    </h1>

    <h2 class="article-title" itemprop="name">
      Test function for purity using isolated v8 execution context.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I have played with <a target="_blank" rel="noopener" href="https://medium.com/javascript-scene/master-the-javascript-interview-what-is-a-pure-function-d1c076bec976">pure</a> JavaScript functions in the previous blog post
<a href="../test-if-a-function-is-pure/">Test if a function is pure</a>. I know that pure functions are
simpler to test and use in my code, but telling if a particular given function is pure is NOT
easy. Let us look at a few examples where it is hard to tell if a function is pure or not,
and then I will show how to run a given function in a very controlled fashion,
completely isolation from its lexical (written) environment to test if it is practically pure.</p>
<h2><span id="definition-of-a-pure-function">Definition of a pure function</span></h2><p>Eric Elliott in <a target="_blank" rel="noopener" href="https://medium.com/javascript-scene/master-the-javascript-interview-what-is-a-pure-function-d1c076bec976">a blog post</a> gives the following definition of pure functions</p>
<ul>
<li>Given the same input, will always return the same output.</li>
<li>Produces no side effects.</li>
<li>Relies on no external state.</li>
</ul>
<p>I can explain each property by giving a counter example</p>
<p><strong>1:</strong> Pure function should return the same output given same inputs, unlike this function
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="built_in">Math</span>.random() &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>2:</strong> Pure function produces no side effects (leaves the environment unaffected), unlike this 
function
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">global</span>.something = <span class="string">&#x27;added&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Common side effects are changing properties on the <code>global</code> object, writing to the console,
changing the HTML of the page the script is executed on.</p>
<p><strong>3:</strong> Pure function should not rely on the external state, unlike this function
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add10</span>(<span class="params">a</span>) </span>&#123; <span class="keyword">return</span> a + K &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>update</strong> </p>
<p>After this blog post went live, a lot of people objected to the example above. Most people agree
that <code>var K = 10</code> makes <code>add10</code> impure, but the <code>const K</code> can be safely substituted into its use
inside <code>add10</code> and thus keeps the function pure. I agree with allowing using external constants
and pure functions.</p>
<p>We have these simple three properties, but applying them in practice is anything but simple. </p>
<h2><span id="pure-or-not">Pure or not?</span></h2><p>I have been adding more examples to <a target="_blank" rel="noopener" href="https://gist.github.com/bahmutov/1ec7a573ce5771caa9c7">the list</a> asking if each example is pure or not.
Seems even humans sometimes have trouble drawing a line. For example, everyone agrees
the following example is pure</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br></pre></td></tr></table></figure>
<p>and this example is NOT</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> k = <span class="number">2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addK</span>(<span class="params">a</span>) </span>&#123; <span class="keyword">return</span> a + k &#125;</span><br></pre></td></tr></table></figure>
<p>Yet, <em>practically</em> speaking, programmers consider a function <em>pure</em> if it only uses other <em>pure</em>
functions without passing them as arguments. In the code below, both <code>sum</code> and <code>sub</code> are pure
by the human consensus.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> sum(a, -b) &#125;</span><br></pre></td></tr></table></figure>
<p>If one considers <code>sub</code> NOT pure, because it is breaking rule #3, then a pure function is only
allowed to use functions passed inside via arguments. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b, summer</span>) </span>&#123; <span class="keyword">return</span> summer(a, -b) &#125;</span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, sum) <span class="comment">// 8</span></span><br></pre></td></tr></table></figure>
<p>The above example then shows several things</p>
<ul>
<li>Programming with pure functions is a pain because we loose lexical scope (all the source around
the function), and have to drag huge number of functions around.</li>
<li>A function can remain pure but use <em>impure</em> functions as arguments. </li>
</ul>
<p>More on the later point. We can mark each line to better see the &quot;purity&quot;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125; <span class="comment">// definitely pure</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b, summer</span>) </span>&#123; <span class="keyword">return</span> summer(a, -b) &#125; <span class="comment">// pure?</span></span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, sum) <span class="comment">// not pure</span></span><br></pre></td></tr></table></figure>
<p>The <code>sub(10, 2, sum)</code> source line is not pure because the result has to go somewhere, 
and in this case,
if we just execute it in the Node environment, it is printed in the console (which we cannot do,
breaks rule #2).</p>
<p>The above example shows that the same program can have parts that are pure and parts that have
side effects. One of our goals when refactoring is to increase the first part, shrinking the
second one. Some techniques help with this, for example using immutable data library or isolating
the environment (Hi <a target="_blank" rel="noopener" href="http://cycle.js.org/">Cycle.js</a>!)</p>
<p>If a pure function executes a function passed as the input argument, does the input function
have to be pure? Seems so, otherwise the &quot;pure&quot; function can break rule #1. Imagine</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, <span class="built_in">Math</span>.random) <span class="comment">// 8.59</span></span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, <span class="built_in">Math</span>.random) <span class="comment">// 8.01</span></span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, <span class="built_in">Math</span>.random) <span class="comment">// something else</span></span><br></pre></td></tr></table></figure>
<p>It is not enough to follow the above 3 rules then. A pure function better be passed pure functions
as arguments; the rule #1 (consistency) seems to be stronger requirement than rule #3 (only
using the input arguments)</p>
<h2><span id="breaking-the-rules">Breaking the rules?</span></h2><p>We can make the above example a little more contrived again. What about a pure function
returning <em>non-pure</em> function?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sumK</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b + K</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The function <code>inner</code> is not pure - it is breaking rule #3. Function <code>sumK</code> seems pure to me -
it is <em>always</em> producing the same effect, is not changing the environment and does not rely on
the external state.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sumK(<span class="number">2</span>, <span class="number">3</span>)() <span class="comment">// 15</span></span><br><span class="line">sumK(<span class="number">2</span>, <span class="number">3</span>)() <span class="comment">// 15</span></span><br><span class="line">sumK(<span class="number">2</span>, <span class="number">3</span>)() <span class="comment">// 15</span></span><br><span class="line"><span class="comment">// same result until the end of times</span></span><br></pre></td></tr></table></figure>
<p>Let us compare the two examples side by side. First, we have a function that only uses its
environment, but does NOT know if the function passed inside is pure or not.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b, summer</span>) </span>&#123; <span class="keyword">return</span> summer(a, -b) &#125; <span class="comment">// pure?</span></span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>, fn) <span class="comment">// hmm, is fn pure?</span></span><br></pre></td></tr></table></figure>
<p>Second, we have a function that uses outside state, yet ALWAYS produces the same output</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addK</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b + K</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a dilemma - do I rather code passing functions around to avoid any function relying on
the external state, making the decision about which particular function is pure, or do I use
a simple constant external state that always produces the same result?</p>
<p>In fact, I would argue that using <code>const</code> keyword is preferred, because we can replace each
use of a constant (unless it is an expression involving other variables) inside a function with
its value to get obviously pure function</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addK</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b + K</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// replace K inside addK with simple value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addK</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b + <span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The simple replacement goes back to functions using external functions (not functional 
expressions). Most programmers consider both functions pure when declared like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> sum(a, -b) &#125;</span><br></pre></td></tr></table></figure>
<p>but not when declared as functional expressions</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> sum(a, -b) &#125;</span><br></pre></td></tr></table></figure>
<p>The main problem with using functional expressions above is that we are NOT using a function,
instead we are using variable <code>sum</code> to call <code>function sum</code>. Thus we are breaking rule #3 - using
outside variable, and that variable is not constant.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> sum(a, -b) &#125;</span><br><span class="line">sum = <span class="comment">// some other function</span></span><br><span class="line">sub(<span class="number">10</span>, <span class="number">2</span>) <span class="comment">// who knows!</span></span><br></pre></td></tr></table></figure>
<p>The distinction between functions and the variables pointing at them is important. In JavaScript
functions can be passed around, which means unless two functions are declared in the same file,
they will be passed around, even via <code>require(&#39;./sum&#39;)</code> in which case all bets
on consistency are off! It is really hard to lock down loaded modules in Node to avoid someone
changing the code under your feet.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> calc = <span class="built_in">require</span>(<span class="string">&#x27;./common-calculations&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> calc.sum(a, b) <span class="comment">// seems pure and consistent</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// somewhere else</span></span><br><span class="line">calc.sum = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b + <span class="built_in">Math</span>.random() &#125;</span><br></pre></td></tr></table></figure>
<p>Is <code>myFunction</code> still pure? No, yet it was hard to foresee this due to the JavaScript&#39;s dynamic 
nature.</p>
<h2><span id="simple-purity-testing">Simple purity testing</span></h2><p>Let us leave the questions about consistency and functions using other functions aside and
just see how to test if a simple function is pure or not. I showed bunch of tests 
<a href="../test-if-a-function-is-pure/">before</a>, but those relied on refactoring the source to always export lists of functions
for simple replacement. Here is how to test a function in a slightly simpler way by just
rewriting its source to run in a very isolated context.</p>
<p>Let us take a simple purity test: a function should be isolated from its context (lexical), thus
not use any outside variable. We take the <code>add</code> function as the test subject:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;2 + 5 =&#x27;</span>, add(<span class="number">2</span>, <span class="number">5</span>))</span><br><span class="line"><span class="comment">// 2 + 5 = 7</span></span><br></pre></td></tr></table></figure>
<p>Let us see how we can confirm the properties 2 and 3 - function <code>add</code> does not leave any traces
in the environment, and it does not use any outside state. We need to isolate the function from
anything around it. Nodejs already has a pretty good isolation mechanism that we can use
to execute a piece of JavaScript without leaving traces: the 
<a target="_blank" rel="noopener" href="https://nodejs.org/api/vm.html">vm.runInContext</a> methods.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">vm.createContext(sandbox)</span><br><span class="line">vm.runInContext(add.toString(), sandbox)</span><br><span class="line"><span class="built_in">console</span>.log(sandbox)</span><br><span class="line"><span class="comment">// &#123; add: [Function: add] &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(sandbox.add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>In this example we took function <code>add</code> but instead of running it directly, we created a function
inside a new context &quot;sandbox&quot;. When function <code>sandbox.add</code> executes, it only has access to its
&quot;sandbox&quot; object (the &quot;sandbox&quot; becomes &quot;global&quot; while the function runs). For example, if the
function leaves traces, they become properties on the &quot;sandbox&quot; object</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">vm.createContext(sandbox)</span><br><span class="line">vm.runInContext(add.toString(), sandbox)</span><br><span class="line"><span class="keyword">var</span> K = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  K = -<span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(sandbox)</span><br><span class="line"><span class="comment">// &#123; add: [Function: add] &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(sandbox.add(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line"><span class="built_in">console</span>.log(K)</span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="built_in">console</span>.log(sandbox)</span><br><span class="line"><span class="comment">// &#123; add: [Function: add], K: -1 &#125;</span></span><br></pre></td></tr></table></figure>
<p>We can make one more step and limit even this already minimal access. Let us wrap the function
<code>add.toString()</code> in a closure with strict mode turned on. This will force &quot;this&quot; context to be
undefined, preventing leaving any traces even inside the &quot;sandbox&quot; context.</p>
<p>First, let us wrap a given function &#39;add&#39; in a closure in strict mode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="keyword">const</span> pre = <span class="string">&#x27;add = (function ()&#123;\n&quot;use strict&quot;\n&#x27;</span></span><br><span class="line"><span class="keyword">const</span> post = <span class="string">&#x27;\n&#125;())&#x27;</span></span><br><span class="line"><span class="keyword">const</span> limitedAdd = pre + <span class="string">&#x27;return &#x27;</span> + add.toString() + post</span><br><span class="line"><span class="built_in">console</span>.log(limitedAdd)</span><br></pre></td></tr></table></figure>
<p>If we run it, <code>limitedAdd</code> is a simple source string
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">&quot;use strict&quot;</span></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure></p>
<p>Next, we can call it inside the &quot;sandbox&quot;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">vm.createContext(sandbox)</span><br><span class="line"><span class="comment">// limitedAdd from above</span></span><br><span class="line">vm.runInContext(limitedAdd, sandbox)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="built_in">console</span>.log(sandbox.add(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<p>Now let us try using and polluting lexical / &quot;sandbox&quot; environment from inside <code>add</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> K = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  K = -<span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> pre = <span class="string">&#x27;add = (function ()&#123;\n&quot;use strict&quot;\n&#x27;</span></span><br><span class="line"><span class="keyword">const</span> post = <span class="string">&#x27;\n&#125;())&#x27;</span></span><br><span class="line"><span class="keyword">const</span> limitedAdd = pre + <span class="string">&#x27;return &#x27;</span> + add.toString() + post</span><br><span class="line"><span class="built_in">console</span>.log(limitedAdd)</span><br></pre></td></tr></table></figure>
<p>which prints
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">&quot;use strict&quot;</span></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  K = -<span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line">&#125;())</span><br></pre></td></tr></table></figure></p>
<p>and if we actually try to run it gives us an error</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">vm.createContext(sandbox)</span><br><span class="line"><span class="comment">// limitedAdd from above</span></span><br><span class="line">vm.runInContext(limitedAdd, sandbox)</span><br><span class="line"><span class="built_in">console</span>.log(sandbox.add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">evalmachine.&lt;anonymous&gt;:4</span><br><span class="line">  K = -1</span><br><span class="line">    ^</span><br><span class="line">ReferenceError: K is not defined</span><br><span class="line">    at Object.add (evalmachine.&lt;anonymous&gt;:4:5)</span><br></pre></td></tr></table></figure>
<p>Excellent! We have been able to take a function and separate it from its lexical (source)
environment. This proves that we can run the function and it cannot affect or use the 
global (outside) state. </p>
<p>Why not use the simple &#39;eval&#39; to achieve the same separation? Mostly because it is easier to
reuse the context and to pass additional properties. For example, we might want to use the standard
JavaScript facilities inside the &quot;sandbox&quot;, like &quot;console.log&quot;. By default this is impossible.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> K = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;adding&#x27;</span>, a, <span class="string">&#x27;and&#x27;</span>, b)</span><br><span class="line">  K = -<span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// the rest of the above example</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evalmachine.&lt;anonymous&gt;:4</span><br><span class="line">  console.log(<span class="string">&#x27;adding&#x27;</span>, a, <span class="string">&#x27;and&#x27;</span>, b)</span><br><span class="line">  ^</span><br><span class="line">ReferenceError: console is not defined</span><br></pre></td></tr></table></figure>
<p>But we can just pass reference to the <code>console</code> object to the &quot;sandbox&quot;!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sandbox = &#123;</span><br><span class="line">  <span class="built_in">console</span>: <span class="built_in">console</span></span><br><span class="line">&#125;</span><br><span class="line">vm.createContext(sandbox)</span><br><span class="line">vm.runInContext(limitedAdd, sandbox)</span><br><span class="line"><span class="built_in">console</span>.log(sandbox.add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adding 2 and 3</span><br><span class="line">evalmachine.&lt;anonymous&gt;:5</span><br><span class="line">  K = -1</span><br><span class="line">    ^</span><br><span class="line">ReferenceError: K is not defined</span><br></pre></td></tr></table></figure>
<p>Using the &quot;sandbox&quot; allows us to keep adding desired properties in a very controlled manner, much
safer and more convenient than using the <code>eval</code>.</p>
<h2><span id="rewrite-function39s-inner-code">Rewrite function&#39;s inner code</span></h2><p>Instead of replacing the entire function with a sandbox, let us replace the code block
<em>inside the function</em> and isolate it from the environment. This will limit the access to the
lexical scope</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b + K&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line"><span class="keyword">const</span> K = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// create sandbox vm context</span></span><br><span class="line">    <span class="comment">// evaluate &quot;return a + b + K&quot; inside the sandbox</span></span><br><span class="line">    <span class="comment">// return the evaluated result</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can easily rewrite the context using an abstract tree parser like 
<a target="_blank" rel="noopener" href="https://github.com/substack/node-falafel#readme">falafel</a>. Let us see it in action.
Given a filename, it can parse the source and then allows us to find every function declaration
and rewrite it. We need both the block inside the function and the names of the function&#39;s
arguments.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;adding&#x27;</span>, a, <span class="string">&#x27;and&#x27;</span>, b)</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = add</span><br><span class="line"><span class="comment">// rewrite.js</span></span><br><span class="line"><span class="keyword">const</span> falafel = <span class="built_in">require</span>(<span class="string">&#x27;falafel&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> source = fs.readFileSync(<span class="string">&#x27;./add.js&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> output = falafel(source, <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (node.type === <span class="string">&#x27;BlockStatement&#x27;</span> &amp;&amp; node.parent.type === <span class="string">&#x27;FunctionDeclaration&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(node.type, node.source())</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;parent vars&#x27;</span>, node.parent.params.map(<span class="function">(<span class="params">node</span>) =&gt;</span> node.name))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This prints the expected values</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ node rewrite.js </span><br><span class="line">BlockStatement &#123;</span><br><span class="line">  console.log(<span class="string">&#x27;adding&#x27;</span>, a, <span class="string">&#x27;and&#x27;</span>, b)</span><br><span class="line">  <span class="built_in">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line">parent vars [ <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span> ]</span><br></pre></td></tr></table></figure>
<p>Now let us put the block statement source inside an isolated &quot;sandbox&quot;, but adding &quot;a&quot; and &quot;b&quot;
too. Our goal is to replace the inside of the function with the following code. (I removed
the console statement, leaving only the <code>function add(a, b) &#123; return a + b &#125;</code> code)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">  vm.createContext(sandbox)</span><br><span class="line">  <span class="keyword">const</span> src = <span class="string">&#x27;(function ()&#123;\n&quot;use strict&quot;\nreturn (function ()&#123;\nreturn a + b\n&#125;())&#125;())&#x27;</span></span><br><span class="line">  sandbox.a = a</span><br><span class="line">  sandbox.b = b</span><br><span class="line">  <span class="keyword">return</span> vm.runInContext(src, sandbox)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = add</span><br></pre></td></tr></table></figure>
<p>Note the original function block is now a string <code>src</code> with &quot;use strict&quot; enabled. Only
the small portion <code>return a + b</code> is actually the original code from the &#39;add&#39; function.
Once we have wrapped the function&#39;s code, we need to create the sandbox, set the arguments
from the function&#39;s signature on the sandbox
and return the result of executing the <code>src</code> inside the sandbox. The entire rewrite
algorithm looks like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> falafel = <span class="built_in">require</span>(<span class="string">&#x27;falafel&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> source = fs.readFileSync(<span class="string">&#x27;./add.js&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> output = falafel(source, <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (node.type === <span class="string">&#x27;BlockStatement&#x27;</span> &amp;&amp; node.parent.type === <span class="string">&#x27;FunctionDeclaration&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> vars = node.parent.params.map(<span class="function">(<span class="params">node</span>) =&gt;</span> node.name)</span><br><span class="line">    <span class="comment">// wrap function in &#x27;use strict&#x27; closure</span></span><br><span class="line">    <span class="keyword">const</span> pre = <span class="string">&#x27;`(function ()&#123;\n&quot;use strict&quot;\nreturn (function () &#x27;</span></span><br><span class="line">    <span class="keyword">const</span> post = <span class="string">&#x27;\n())&#125;())`&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> limitedBlock = pre + node.source() + post</span><br><span class="line">    <span class="comment">// wrap in VM context</span></span><br><span class="line">    <span class="keyword">const</span> preVm = <span class="string">&#x27;const vm = require(&quot;vm&quot;)\nconst sandbox = &#123;&#125;\nvm.createContext(sandbox)\n const src = &#x27;</span></span><br><span class="line">    <span class="comment">// add all arguments to the sandbox</span></span><br><span class="line">    <span class="keyword">var</span> postVm = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    vars.forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      postVm += <span class="string">&#x27;\nsandbox.&#x27;</span> + name + <span class="string">&#x27; = &#x27;</span> + name</span><br><span class="line">    &#125;)</span><br><span class="line">    postVm += <span class="string">&#x27;\nreturn vm.runInContext(src, sandbox)\n&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> innerCode = preVm + limitedBlock + postVm</span><br><span class="line">    node.update(<span class="string">&#x27;&#123;\n&#x27;</span> + innerCode + <span class="string">&#x27;\n&#125;&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">fs.writeFileSync(<span class="string">&#x27;./add-test.js&#x27;</span>, output, <span class="string">&#x27;utf8&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>The source file <code>add.js</code> for example gets transformed into the following (reindented for clarity)</p>
<figure class="highlight js"><figcaption><span>add.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;adding&#x27;</span>, a, <span class="string">&#x27;and&#x27;</span>, b)</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = add</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>add-test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>)</span><br><span class="line">  <span class="keyword">const</span> sandbox = &#123;&#125;</span><br><span class="line">  vm.createContext(sandbox)</span><br><span class="line">  <span class="keyword">const</span> src = <span class="string">`(function ()&#123;</span></span><br><span class="line"><span class="string">    &quot;use strict&quot;</span></span><br><span class="line"><span class="string">    return (function () &#123;</span></span><br><span class="line"><span class="string">      console.log(&#x27;adding&#x27;, a, &#x27;and&#x27;, b)</span></span><br><span class="line"><span class="string">      return a + b</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ())&#125;())`</span></span><br><span class="line">  sandbox.a = a</span><br><span class="line">  sandbox.b = b</span><br><span class="line">  <span class="keyword">return</span> vm.runInContext(src, sandbox)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = add</span><br></pre></td></tr></table></figure>
<p>Note the multi line string literal for simplicity, assigned to the variable &quot;src&quot;. 
The <code>add-test.js</code> still works the same.
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ node</span><br><span class="line">&gt; var add = require(<span class="string">&#x27;./add-test.js&#x27;</span>)</span><br><span class="line">undefined</span><br><span class="line">&gt; add(2, 3)</span><br><span class="line">ReferenceError: console is not defined</span><br></pre></td></tr></table></figure></p>
<p>This is working <em>exactly as expected</em> - the <code>console</code> object is not in the &quot;sandbox&quot; context,
thus it cannot be used, just like any other variable NOT inside the original <code>add</code> function.
Thus the function <code>add</code> is not pure. Let us make it pure and try again.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = add</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ node rewrite.js </span><br><span class="line">$ node</span><br><span class="line">&gt; var add = require(<span class="string">&#x27;./add-test.js&#x27;</span>)</span><br><span class="line">undefined</span><br><span class="line">&gt; add(2, 3)</span><br><span class="line">5</span><br></pre></td></tr></table></figure>
<p>Great, the inside of the function has been isolated from anything outside. If the function is
pure, it will keep on working. If the function is not pure, it will raise an exception.</p>
<p>I have placed the rewriting code in the 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/pure-inside">bahmutov/pure-inside</a> with this example.</p>
<p>We can even automate the rewrite using a Node require hook, for example see projects 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/node-hook">node-hook</a> and 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/really-need">really-need</a>.</p>
<h2><span id="is-the-function-consistent">Is the function consistent?</span></h2><p>We know that by automated rewriting that the function follows rules #2 and #3 - no polluting the
environment and no reading from the environment. But what about the consistency? This is much
harder to test or prove. Consider a function that returns the current day of the month. It will 
return the same number for 23 hours, 59 minutes and 59 seconds. Then, all of the sudden, it will
return something else! In my opinion, trying to prove the same return value is equivalent to 
proving the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Halting_problem">Halting problem</a> - trying to prove
that the output changes is the same as trying to prove that the program finishes writing. Thus
it is theoretically undecidable. </p>
<p>What about <em>practically</em> decidable - meaning, can we test the function a few times and make a
decision? I think so. Previously, I have written <a target="_blank" rel="noopener" href="https://github.com/bahmutov/rocha">Rocha</a> -
a BDD test runner similar to <a target="_blank" rel="noopener" href="https://mochajs.org/">Mocha</a> but with test randomization on each run.
To test if a function is consistent, I would need to write &quot;RochaN&quot; where the order of tests is
randomized and then each test / function is run a random number N times and the result should be 
the same. Might not catch the &quot;day of month&quot; problem right away, but eventually it will appear
one midnight!</p>
<h2><span id="conclusion">Conclusion</span></h2><p>Testing if a function is pure is difficult in JavaScript, especially if we take the more relaxed
definition and allow functions to use other pure functions in its lexical scope. 
Notice that my source rewriting does NOT allow using other pure functions, since everything is isolated. The method
would need the extension to add functions that were covered by the unit tests and passed
to the &quot;sandbox&quot; environment of other functions and tests run again.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we can test add using the rewriting</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125;</span><br><span class="line"><span class="comment">// we do not import &quot;add&quot; to the sandbox,</span></span><br><span class="line"><span class="comment">// thus our rewriting will say &quot;sub&quot; is not pure</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> add(a, -b) &#125;</span><br></pre></td></tr></table></figure>
<p>In general, I think the rule #1 is the most important - the function returning the same result
given the same set of inputs is the most important property of pure functions. Relaxing the rules
and allowing accessing other pure functions or constant values is fine, as long as the function
is still consistent.</p>
<p>If a function is pure, then we can replace every call to the function with its body, slowly
unrolling the entire program. In the above example, once we have tested the code and determined
that <code>add</code> is pure, we can replace the reference to <code>add(a, -b)</code> with inside of <code>add</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b &#125; <span class="comment">// pure</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>)</span>&#123; <span class="keyword">return</span> a + b &#125;)(a, -b) &#125;</span><br></pre></td></tr></table></figure>
<p>If we run the purity test again, <code>sub</code> is now pure!</p>
<h2><span id="noteworthy">Noteworthy</span></h2><p>Other people are also really excited about (really) pure functions, for example
<a target="_blank" rel="noopener" href="https://twitter.com/mykola">Mykola Bilokonsky</a> wants to 
<a target="_blank" rel="noopener" href="https://gist.github.com/mbilokonsky/b268ec83373e1d1f49fb5930d9157364">mark them</a> 
in code as <code>isolated</code> to allow copy/paste of functions for testing.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/test-if-a-function-is-pure-revisited/" data-id="cl0mt984c01auj2vg4n18cmtv" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/test-if-a-function-is-pure-revisited/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/functional/" rel="tag">functional</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/javascript/" rel="tag">javascript</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../jade-pug-tips/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Jade (now Pug) nuggets
        
      </div>
    </a>
  
  
    <a href="../running-multiple-applications-in-dokku/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Running multiple applications in Dokku</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">146</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">456</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">188</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">138</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.8px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.8px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.2px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16.8px;">ci</a> <a href="../tags/circle/" style="font-size: 14px;">circle</a> <a href="../tags/climate/" style="font-size: 14.8px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 15.2px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.8px;">db</a> <a href="../tags/docker/" style="font-size: 14.4px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.8px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 15.2px;">git</a> <a href="../tags/github/" style="font-size: 16px;">github</a> <a href="../tags/graphql/" style="font-size: 11.6px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.2px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.6px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 14px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.8px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.2px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.4px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.4px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.8px;">ramda</a> <a href="../tags/react/" style="font-size: 12.4px;">react</a> <a href="../tags/react-native/" style="font-size: 11.2px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.4px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 14px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.2px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.6px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.4px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.6px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/03/">March 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../cypress-lighthouse/">Cypress Lighthouse Example</a>
          </li>
        
          <li>
            <a href="../code-coverage-for-nextjs-app/">Code Coverage For Nextjs Application</a>
          </li>
        
          <li>
            <a href="../cypress-and-launchdarkly/">Control LaunchDarkly From Cypress Tests</a>
          </li>
        
          <li>
            <a href="../visualize-cypress-command-queue/">Visualize Cypress Command Queue</a>
          </li>
        
          <li>
            <a href="../replace-and-remove-cy-then-command/">Replace The cy.then Command</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/test-if-a-function-is-pure-revisited/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
