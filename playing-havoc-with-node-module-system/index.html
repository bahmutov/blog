<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Playing havoc with Node module system | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="I was reading an interesting book &quot;Secure Your Node.js Web Application&quot; by Karl D√º√ºna and the page 44 in chapter 4 &quot;Avoid code injections&quot; caught my eye. In the example, the user p">
<meta property="og:type" content="article">
<meta property="og:title" content="Playing havoc with Node module system">
<meta property="og:url" content="https://glebbahmutov.com/blog/playing-havoc-with-node-module-system/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="I was reading an interesting book &quot;Secure Your Node.js Web Application&quot; by Karl D√º√ºna and the page 44 in chapter 4 &quot;Avoid code injections&quot; caught my eye. In the example, the user p">
<meta property="og:locale">
<meta property="article:published_time" content="2016-03-03T05:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.323Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-playing-havoc-with-node-module-system" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2016-03-03T05:00:00.000Z" itemprop="datePublished">Mar 3 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Playing havoc with Node module system
    </h1>

    <h2 class="article-title" itemprop="name">
      Node.js is really really really susceptible to code injection attacks.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I was reading an interesting book &quot;Secure Your Node.js Web Application&quot; by
Karl D√º√ºna and the page 44 in chapter 4 &quot;Avoid code injections&quot; caught my eye.
In the example, the user passes an arithmetic formula from the web page to be evaluated
on the server. For example, the user could enter &quot;2 + 4&quot; and the server would do
something like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/calc&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  <span class="built_in">eval</span>(<span class="string">&#x27;result = &#x27;</span> + req.<span class="property">body</span>.<span class="property">formula</span>);</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;the result is: &#x27;</span> + result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>The author goes on to show that a malicious user can send an input that will cause
problems. For example, entering <code>3; process.exit()</code> as the input formula would stop
the server!</p>
<p>The book goes on to show some solutions to this problem, like white listing the allowed
input types, etc.</p>
<h2><span id="the-danger">The danger</span></h2><p>The code passed to <code>eval</code> could be quite large and malicious. Or it could be loaded from
other modules deep down the dependency graph. It can do anything, really.</p>
<p>Imagine we execute malicious code that goes through the list of modules and finds all modules
that export any method with word <code>login</code> in them. The malicious code then can wrap these methods
easily and steal ALL logins</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="built_in">require</span>.<span class="property">cache</span>).<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">exports</span>).<span class="title function_">filter</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="keyword">typeof</span> e === <span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">  .<span class="title function_">forEach</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(e).<span class="title function_">filter</span>(<span class="function"><span class="params">name</span> =&gt;</span> <span class="regexp">/login/</span>.<span class="title function_">test</span>(name)).<span class="title function_">forEach</span>(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    e[method] = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// send arguments to remote server!</span></span><br><span class="line">      <span class="comment">// let the login work as usual</span></span><br><span class="line">      <span class="keyword">return</span> e[method].<span class="title function_">apply</span>(e, <span class="variable language_">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;))</span><br></pre></td></tr></table></figure>

<p>That&#39;s it, every login executed from now on will go through this code. Dangerous, because we never
suspected that other modules can spy on us, right?</p>
<blockquote>
<p>Aside from eval(req.body...), what are the other ways to inject malicious code into our application?</p>
</blockquote>
<p>Here are some possibilities I have found.</p>
<h2><span id="sneak-malicious-code-in-the-new-package-version">Sneak malicious code in the new package version</span></h2><p>If we declare a dependency on module using fuzzy version like <code>A@^X.X.X</code>, an attacker could
add malicious code and publish <code>A@X.X.X+1</code>. By automatically installing latest patch, our server
loads the malicous code - and then all bets are off.</p>
<p><strong>Solution:</strong> use the exact versions yourself and shrinkwrap dependencies to make sure the entire
tree of dependencies is locked.</p>
<h2><span id="overwrite-source-files">Overwrite source files</span></h2><p>Imagine a malicious dependency module that rewrites your JavaScript files (but in a very obfuscated manner).
If we load that malicious dependency first, it changes the source for files loaded next,
ensuring more malicious code is loaded by <code>require</code>.</p>
<p><strong>Solution:</strong> set the source folder to <strong>read-only</strong> and always use a separate folder 
for storing the data.</p>
<h2><span id="forcing-module-reload">Forcing module reload</span></h2><p>This attack seems harmless but shows that Node has a vulnerability that is unique to
the interpreted languages. When you execute a compiled program (like C++ binary),
all the machine code is loaded and stored in <em>read-only</em> memory space. Thus the program
cannot change itself at runtime.</p>
<p>Node programs can change themselves at any time. A basic way to change the running
code is by changing the loaded modules, all accessible using <code>require.cache</code> object.</p>
<p>Take a simple program that loads module <code>started.js</code>. The &quot;started&quot; module keeps the
timestamp when the application has started. Because Node modules are <em>cached</em>, we assume
that this value will never change, right?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// started.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> started = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = started</span><br><span class="line"><span class="comment">// when-started.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> when1 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: started program at&#x27;</span>, <span class="title class_">Number</span>(when1))</span><br><span class="line"><span class="comment">// uses cached loaded value</span></span><br><span class="line"><span class="keyword">const</span> when2 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: started program at&#x27;</span>, <span class="title class_">Number</span>(when2))</span><br><span class="line"><span class="keyword">const</span> startedPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="comment">// force reloading &#x27;./started&#x27; next time</span></span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">require</span>.<span class="property">cache</span>[startedPath]</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> when3 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3: started program at&#x27;</span>, <span class="title class_">Number</span>(when3))</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>Note that we use the strict mode and declare every variable constant in both modules.
Yet, the output shows the discrepancy: the third value is different from the first two.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ node when-started.js </span><br><span class="line">1: started program at 1457017164598</span><br><span class="line">2: started program at 1457017164598</span><br><span class="line">3: started program at 1457017164712</span><br></pre></td></tr></table></figure>

<p>While simple, this shows that giving the &quot;user&quot; code access to the list of loaded modules
can lead to unexpected results. </p>
<p><strong>Solution:</strong> once all necessary modules are loaded, you can use <code>Object.seal(require.cache)</code>
to prevent new module load or deleting modules already loaded.</p>
<h2><span id="unapply-style-attacks">Unapply style attacks</span></h2><p>Read how changing the prototype methods is dangerous in <a href="../unapply-attack/">Unapply attack</a> post.</p>
<h2><span id="feeding-new-code-to-the-next-require">Feeding new code to the next require</span></h2><p>Note: if you want to see debug log from the Node module load system, turn on the debug messages
with <code>NODE_DEBUG=module node ...</code> environment setting.</p>
<p>Note: before reading the rest of this blog post, you might want to read 
<a target="_blank" rel="noopener" href="http://fredkschott.com/post/2014/06/require-and-the-module-system/">How <code>require()</code> Actually Works</a></p>
<p>Changing the timestamp by breaking the cached module assumption is small potatoes. 
We can directly set &#x2F; change the module value to whatever we want! Using the same
<code>started.js</code> module, but instead of deleting the loaded module from cache, we can
set the exported value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set-started.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> when1 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: started program at&#x27;</span>, <span class="title class_">Number</span>(when1))</span><br><span class="line"><span class="comment">// uses cached loaded value</span></span><br><span class="line"><span class="keyword">const</span> when2 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: started program at&#x27;</span>, <span class="title class_">Number</span>(when2))</span><br><span class="line"><span class="keyword">const</span> startedPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="comment">// change the value directly</span></span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span>[startedPath].<span class="property">exports</span> = <span class="number">1337</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> when3 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3: started program at&#x27;</span>, <span class="title class_">Number</span>(when3))</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>The program&#39;s output</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ node set-started.js </span><br><span class="line">1: started program at 1457017716062</span><br><span class="line">2: started program at 1457017716062</span><br><span class="line">3: started program at 1337</span><br></pre></td></tr></table></figure>

<p>See the next section on how to prevent changing values inside the loaded modules.</p>
<h2><span id="changing-loaded-code-without-reload">Changing loaded code without reload</span></h2><p>Even more dangerous, we do not have to <code>require</code> a module to change its behavior.
Most modules do not load primitive values (like numbers or strings), but return objects.
For example, let us change the configuration value</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; <span class="attr">user</span>: <span class="string">&#x27;limited&#x27;</span> &#125;</span><br><span class="line"><span class="comment">// set-config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br></pre></td></tr></table></figure>

<p>This code shows a lot more dangerous behavior - the user account has been changed from
whatever the configured value was to <code>root</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ node set-config.js </span><br><span class="line">1: config.user limited</span><br><span class="line">2: config.user root</span><br></pre></td></tr></table></figure>

<p>Even worse, the <code>config.user</code> value changes in the first place too!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set-config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line">  <span class="comment">// config.user root</span></span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>Again, note that JavaScript <code>const</code> keyword only locks the reference <code>config</code> and not the
object itself.</p>
<p><strong>Solution 1:</strong> lock down sensitive objects inside the module itself using <em>deep freeze</em>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> freeze = <span class="built_in">require</span>(<span class="string">&#x27;deep-freeze&#x27;</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">freeze</span>(&#123; <span class="attr">user</span>: <span class="string">&#x27;limited&#x27;</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>The same <code>set-config.js</code> code now fails</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node set-config.js </span><br><span class="line">1: config.user limited</span><br><span class="line">/set-config.js:7</span><br><span class="line">require.cache[configPath].exports.user = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">                                       ^</span><br><span class="line">TypeError: Cannot assign to <span class="built_in">read</span> only property <span class="string">&#x27;user&#x27;</span> of <span class="comment">#&lt;Object&gt;</span></span><br><span class="line">    at Object.&lt;anonymous&gt; (/set-config.js:7:40)</span><br></pre></td></tr></table></figure>

<p><strong>Solution 2:</strong> use functions instead of objects to keep sensitive information private via a closure.</p>
<p>Instead of exporting a config object, return a config getter function. It will be much harder to change the
data inside the function&#39;s closure than to modify a property of an object.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">config</span>(<span class="params">field</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> settings = &#123; <span class="attr">user</span>: <span class="string">&#x27;limited&#x27;</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> settings[field]</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = config</span><br><span class="line"><span class="comment">// set-config.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, <span class="title function_">config</span>(<span class="string">&#x27;user&#x27;</span>))</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="comment">// cannot access &#x27;user&#x27; inside the closure</span></span><br><span class="line"><span class="comment">// require.cache[configPath].exports ...</span></span><br></pre></td></tr></table></figure>

<h2><span id="nuclear-option-control-the-requirecache">Nuclear option - control the require.cache</span></h2><p>In all previous cases, we were able to change the running code by modifying the <code>require.cache</code>
object. This object starts empty and keeps growing as more user code is loaded (native modules are
not stored there). If we want to make sure the loaded code stays original, we should make
the <code>require.cache</code> <em>add-only</em> object. </p>
<h3><span id="loading-code-protection-first">Loading code protection first</span></h3><p>In every prevention method, we rely on some of our trusted code to be loaded first or at
startup. The way to load a module before running a program is by using <code>-r</code> CLI argument.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preloaded&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./preload.js when-started.js </span><br><span class="line">preloaded</span><br><span class="line">1: started program at 1457030822826</span><br><span class="line">2: started program at 1457030822826</span><br><span class="line">3: started program at 1457030822931</span><br></pre></td></tr></table></figure>

<p>There is even a tool to preload code as plugins, see the module 
<a target="_blank" rel="noopener" href="https://github.com/continuationlabs/toolbag">toolbag</a>.</p>
<h3><span id="controlling-module-cache-via-proxies">Controlling module cache via proxies</span></h3><p>The only way reliable way of making <code>require.cache</code> add-only I could come up with was using
<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">ES6 Proxies</a>.</p>
<p>First, we can write a function that can make any object add-only.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeAddOnly</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> addOnly = &#123;</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> (<span class="params">target, property, value</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!target.<span class="title function_">hasOwnProperty</span>(property)) &#123;</span><br><span class="line">        target[property] = value</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Cannot change property &#x27;</span> + property)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">deleteProperty</span>: <span class="keyword">function</span> (<span class="params">target, property</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Cannot delete property &#x27;</span> + property)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, addOnly)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here is an example that makes a new object, allows adding and getting properties, but not
modifying them or deleting properties. It works today in Chrome (v49) and Chrome Canary (v51).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f = <span class="title function_">makeAddOnly</span>()</span><br><span class="line">f.<span class="property">foo</span>         <span class="comment">// undefined</span></span><br><span class="line">f.<span class="property">foo</span> = <span class="number">42</span>    <span class="comment">// 42</span></span><br><span class="line"><span class="keyword">delete</span> f.<span class="property">foo</span>  <span class="comment">// Uncaught Error: Cannot delete property foo</span></span><br><span class="line">f.<span class="property">foo</span> = -<span class="number">1</span>    <span class="comment">// Uncaught Error: Cannot change property foo</span></span><br><span class="line">f.<span class="property">bar</span> = <span class="string">&#x27;bar&#x27;</span> <span class="comment">// &#x27;bar&#x27;</span></span><br><span class="line">f             <span class="comment">// Object &#123;foo: 42, bar: &quot;bar&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>If we could use proxies from Node today, we could have made <code>require.cache</code> add-only and prevent
code modification attacks (assuming we can freeze the exports too).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">import</span> makeAddOnly <span class="keyword">from</span> <span class="string">&#x27;./add-only&#x27;</span></span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span> = <span class="title function_">makeAddOnly</span>(<span class="built_in">require</span>.<span class="property">cache</span>)</span><br><span class="line"><span class="comment">// no more cache shenanigans</span></span><br></pre></td></tr></table></figure>

<p>It would be great, but the proxies cannot be used from Node v5, or even transpiled or polyfilled yet.
Today we are limited to observing the cache using the deprecated (but available) <code>Object.observe</code>
method.</p>
<h3><span id="observing-cache-changes">Observing cache changes</span></h3><p>Instead of proxies, we can monitor the cache changes using the following approach.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> freeze = <span class="built_in">require</span>(<span class="string">&#x27;deep-freeze&#x27;</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addOnly</span>(<span class="params">changes</span>) &#123;</span><br><span class="line">  changes.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">change</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (change.<span class="property">type</span> === <span class="string">&#x27;add&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// property could have been deleted already!</span></span><br><span class="line">      <span class="keyword">if</span> (change.<span class="property">object</span>[change.<span class="property">name</span>]) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;freezing new property&#x27;</span>, change.<span class="property">name</span>)</span><br><span class="line">        change.<span class="property">object</span>[change.<span class="property">name</span>] = <span class="title function_">freeze</span>(change.<span class="property">object</span>[change.<span class="property">name</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// update or delete</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Cannot &#x27;</span> + change.<span class="property">type</span> +</span><br><span class="line">        <span class="string">&#x27; existing property &#x27;</span> + change.<span class="property">name</span>)</span><br><span class="line">      <span class="comment">// maybe even process.exit(-1)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">observe</span>(<span class="built_in">require</span>.<span class="property">cache</span>, addOnly, [<span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>We will be notified every time some one adds (loads) new module. When a new module is
loaded we will deep freeze it. If someone else tries to delete or alter an already loaded
module, we throw an error. We should probably even exit the process!</p>
<p>Let us try deleting a loaded module</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;deleting config module&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">require</span>.<span class="property">cache</span>[configPath]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ node observe-cache.js </span><br><span class="line">1: config.user limited</span><br><span class="line">deleting config module</span><br><span class="line">Error: Cannot delete existing property /config.js</span><br></pre></td></tr></table></figure>

<p><strong>Note</strong> because the <code>Object.observe</code> is asynchronous, we will get the changes only AFTER
they have happened. This makes our checks and errors <em>reactionary</em> - the change has already happened!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;first user is now&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;changing config.user&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br></pre></td></tr></table></figure>

<p>The above code runs without errors, because we loaded and modified the config <em>before</em> we had
a change to freeze it from <code>addOnly</code> change callback.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ node observe-cache.js </span><br><span class="line">1: config.user limited</span><br><span class="line">changing config.user</span><br><span class="line">2: config.user root</span><br><span class="line">freezing new property /config.js</span><br><span class="line">first user is now root</span><br></pre></td></tr></table></figure>

<p>but if we assume that the config module loads before trying to modifying it, then we do get an error.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;first user is now&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;changing config.user&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line">  <span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>Now we are getting errors</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1: config.user limited</span><br><span class="line">freezing new property /config.js</span><br><span class="line">changing config.user</span><br><span class="line">/observe-cache.js:40</span><br><span class="line">  require.cache[configPath].exports.user = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">                                         ^</span><br><span class="line">TypeError: Cannot assign to <span class="built_in">read</span> only property <span class="string">&#x27;user&#x27;</span> of <span class="comment">#&lt;Object&gt;</span></span><br></pre></td></tr></table></figure>

<p>Not the most reliable solution, but works if we assume the malicious code gets injected
later than the initial code is loaded, it works.</p>
<h2><span id="preload-all-modules-and-stop">Preload all modules and STOP</span></h2><p>We can generate a snapshot of all modules loaded during &quot;normal&quot; run of the server,
and then preload all modules ourselves and then seal the module cache.</p>
<p>For example, <a target="_blank" rel="noopener" href="https://github.com/bahmutov/cache-require-paths">cache-require-paths</a> monitors
the loaded modules and saves all resolved paths into a json file. We can similarly save 
loaded module paths or even load all modules from package json file and then disable loading
anything else.</p>
<p>In the below example let us have two files. <code>started.js</code> and <code>when-started.js</code>.
We will create another file that will bootstrap everything and then will lock down the cache.
We will run it as</p>
<pre><code>node -r preload.js when-started.js
</code></pre>
<p>We need to load <code>started.js</code> file - that is easy. But then we need to load <code>when-started.js</code> - without
compiling it (because this triggers immediately the code we want to protect from!) Instead we will
create a dummy object in the cache that will only allow us to set the module once.</p>
<p>In addition we will deep freeze every exported object for each module</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// preload.js</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="comment">// any other modules ...</span></span><br><span class="line"><span class="keyword">var</span> rootModule</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">require</span>.<span class="property">cache</span>,</span><br><span class="line">  <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./when-started&#x27;</span>),</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> rootModule &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> (<span class="params">val</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (rootModule) &#123;</span><br><span class="line">        <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;root module has been already set&#x27;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">message</span>)</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setting root value&#x27;</span>)</span><br><span class="line">      rootModule = val</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> freeze = <span class="built_in">require</span>(<span class="string">&#x27;deep-freeze&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preloaded all modules&#x27;</span>)</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">seal</span>(<span class="built_in">require</span>.<span class="property">cache</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;require cache sealed&#x27;</span>)</span><br><span class="line"><span class="comment">// freeze everything</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="built_in">require</span>.<span class="property">cache</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> m = <span class="built_in">require</span>.<span class="property">cache</span>[name]</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> m.<span class="property">exports</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;freezing&#x27;</span>, name)</span><br><span class="line">      m.<span class="property">exports</span> = <span class="title function_">freeze</span>(m.<span class="property">exports</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;exports frozen&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>The normal execution proceeds just fine. We can load <code>./started</code> several times.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when-started.js</span></span><br><span class="line"><span class="keyword">const</span> when1 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: started program at&#x27;</span>, <span class="title class_">Number</span>(when1))</span><br><span class="line"><span class="comment">// uses cached loaded value</span></span><br><span class="line"><span class="keyword">const</span> when2 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: started program at&#x27;</span>, <span class="title class_">Number</span>(when2))</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./preload.js when-started.js </span><br><span class="line">preloaded all modules</span><br><span class="line">require cache sealed</span><br><span class="line">exports frozen</span><br><span class="line">setting root value</span><br><span class="line">1: started program at 1457038848046</span><br><span class="line">2: started program at 1457038848046</span><br></pre></td></tr></table></figure>

<p>But if we try to load a new module - we cannot</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> when1 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: started program at&#x27;</span>, <span class="title class_">Number</span>(when1))</span><br><span class="line"><span class="comment">// try loading another module</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./foo&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./preload.js when-started.js </span><br><span class="line">preloaded all modules</span><br><span class="line">require cache sealed</span><br><span class="line">setting root value</span><br><span class="line">exports frozen</span><br><span class="line">1: started program at 1457038939506</span><br><span class="line">2: started program at 1457038939506</span><br><span class="line">module.js:318</span><br><span class="line">      delete Module._cache[filename];</span><br><span class="line">TypeError: Cannot delete property <span class="string">&#x27;/when-started.js&#x27;</span> of <span class="comment">#&lt;Object&gt;</span></span><br></pre></td></tr></table></figure>

<p>The error is a little cryptic, because it looks like it is trying to delete the root module,
but I think this is because it fails to internally update it.</p>
<p>Let us try deleting a module to force its reload.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> when1 = <span class="built_in">require</span>(<span class="string">&#x27;./started&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: started program at&#x27;</span>, <span class="title class_">Number</span>(when1))</span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">require</span>.<span class="property">cache</span>[startedPath]</span><br></pre></td></tr></table></figure>

<p>Same exception happens again - we cannot delete properties from the sealed <code>require.cache</code> object.</p>
<p>If we try to change a loaded module after the fact, it fails, because the exports object
has been frozen.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="comment">// throws an Error</span></span><br></pre></td></tr></table></figure>

<p>This method works, but requires you to really know what modules are necessary. This is hard to estimate,
since blindly loading the entire <code>node_modules</code> folder is going to take a while!</p>
<h2><span id="prefreeze-all-modules-and-stop">Prefreeze all modules and STOP</span></h2><p>Let us make a slight twist on the previous approach. Instead of <em>loading</em> a module, we are going
to put a placeholder into <code>require.cache</code> that will freeze it in the future, just like we did for 
the single root module above. This method is a lot more efficient because we are NOT preloading 
(compiling) all methods from the <code>node_modules</code> folder. Instead we are just setting 
placeholders in the <code>require.cache</code> with a couple of hooks. </p>
<p>First, form fully resolved module paths</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> freeze = <span class="built_in">require</span>(<span class="string">&#x27;deep-freeze&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> allModules = [<span class="string">&#x27;./config&#x27;</span>, <span class="string">&#x27;./set-config&#x27;</span>] <span class="comment">// or read all modules from node_modules!</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">require</span>.<span class="title function_">resolve</span>(name)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>Second, create a property manually for each module - a placeholder</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add placeholders for each module and only allow</span></span><br><span class="line"><span class="comment">// loading it once, also freezing exports</span></span><br><span class="line">allModules.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">loadOnce</span>(<span class="params">fullName</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> thisModule</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">require</span>.<span class="property">cache</span>, fullName,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> thisModule &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">setModule</span>(<span class="params">moduleValue</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setting module value&#x27;</span>, fullName)</span><br><span class="line">        <span class="keyword">if</span> (thisModule) &#123;</span><br><span class="line">          <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;root module has been already set&#x27;</span>)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">message</span>)</span><br><span class="line">          <span class="keyword">throw</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// freezing code will be here</span></span><br><span class="line">        thisModule = moduleValue</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Every time a real module is loaded, it will be passed into the <code>set</code> function.
We cannot freeze the exported object just yet - the module is only <em>starting</em> to load and has not been compiled yet.
There is a special property on the module instance passed to the <code>set</code> called <code>loaded</code>.
In order to really know when the module is loaded, we can define a complex property again!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">setModule</span>(<span class="params">moduleValue</span>) &#123;</span><br><span class="line">  <span class="comment">// check if module has been loaded already code</span></span><br><span class="line">  <span class="comment">// freeze exports when the module gets loaded</span></span><br><span class="line">  <span class="keyword">var</span> loaded</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(moduleValue, <span class="string">&#x27;loaded&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> loaded &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> (<span class="params">moduleLoaded</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;module&#x27;</span>, fullName, <span class="string">&#x27;loaded&#x27;</span>, moduleLoaded)</span><br><span class="line">      loaded = moduleLoaded</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> moduleValue.<span class="property">exports</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;freezing exports&#x27;</span>, moduleValue.<span class="property">exports</span>)</span><br><span class="line">        moduleValue.<span class="property">exports</span> = <span class="title function_">freeze</span>(moduleValue.<span class="property">exports</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally, we can seal the <code>require.cache</code> because all the placeholder properties for
all possible modules have been created.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preloaded all modules&#x27;</span>)</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">seal</span>(<span class="built_in">require</span>.<span class="property">cache</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;require cache sealed&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Normal load works fine (I kept the debug log statements)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./prefreeze.js set-config.js </span><br><span class="line">preloaded all modules</span><br><span class="line">require cache sealed</span><br><span class="line">setting module value /set-config.js</span><br><span class="line">setting module value /config.js</span><br><span class="line">loading config.js</span><br><span class="line">module /config.js loaded <span class="literal">true</span></span><br><span class="line">freezing exports &#123; user: <span class="string">&#x27;limited&#x27;</span> &#125;</span><br><span class="line">1: config.user limited</span><br><span class="line">2: config.user limited</span><br><span class="line">module /set-config.js loaded <span class="literal">true</span></span><br><span class="line">freezing exports &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Now, let us try changing the exported value via <code>require.cache</code> shortcut</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./prefreeze.js set-config.js </span><br><span class="line">preloaded all modules</span><br><span class="line">require cache sealed</span><br><span class="line">setting module value /set-config.js</span><br><span class="line">setting module value /config.js</span><br><span class="line">loading config.js</span><br><span class="line">module /config.js loaded <span class="literal">true</span></span><br><span class="line">freezing exports &#123; user: <span class="string">&#x27;limited&#x27;</span> &#125;</span><br><span class="line">1: config.user limited</span><br><span class="line">module.js:318</span><br><span class="line">      delete Module._cache[filename];</span><br><span class="line">                           ^</span><br><span class="line">TypeError: Cannot delete property <span class="string">&#x27;/set-config.js&#x27;</span> of <span class="comment">#&lt;Object&gt;</span></span><br></pre></td></tr></table></figure>

<p>The error is very clear if the attack is deferred.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">tryAttacking</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;trying to attack&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> configPath = <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line">  <span class="built_in">require</span>.<span class="property">cache</span>[configPath].<span class="property">exports</span>.<span class="property">user</span> = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2: config.user&#x27;</span>, config.<span class="property">user</span>)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ node -r ./prefreeze.js set-config.js </span><br><span class="line">preloaded all modules</span><br><span class="line">require cache sealed</span><br><span class="line">setting module value /set-config.js</span><br><span class="line">setting module value /config.js</span><br><span class="line">loading config.js</span><br><span class="line">module /config.js loaded <span class="literal">true</span></span><br><span class="line">freezing exports &#123; user: <span class="string">&#x27;limited&#x27;</span> &#125;</span><br><span class="line">1: config.user limited</span><br><span class="line">module /set-config.js loaded <span class="literal">true</span></span><br><span class="line">freezing exports &#123;&#125;</span><br><span class="line">trying to attack</span><br><span class="line">/set-config.js:9</span><br><span class="line">  require.cache[configPath].exports.user = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">                                         ^</span><br><span class="line">TypeError: Cannot assign to <span class="built_in">read</span> only property <span class="string">&#x27;user&#x27;</span> of <span class="comment">#&lt;Object&gt;</span></span><br><span class="line">    at tryAttacking [as _onTimeout] (/set-config.js:9:42)</span><br><span class="line">    at Timer.listOnTimeout (timers.js:92:15)</span><br></pre></td></tr></table></figure>

<p>Boom, the attack has been repealed because the fast preload ensured that the entire <code>require.cache</code> 
has been sealed and frozen!</p>
<h2><span id="conclusion">Conclusion</span></h2><p>We need to think how to protect a running Node process for changing its own code
in case of malicious code injection. Most fixes require deep freezing sensitive
objects and code fragments. While external solutions are possible, none is available
at the moment. This leaves only preloading and freezing the cache as the only way
of making the program&#39;s code &quot;read-only&quot;.</p>
<h2><span id="related">Related</span></h2><ul>
<li><a target="_blank" rel="noopener" href="http://fredkschott.com/post/2014/06/require-and-the-module-system/">How <code>require()</code> Actually Works</a></li>
<li><a href="../hacking-node-require/">Hacking Node require</a></li>
<li><a target="_blank" rel="noopener" href="https://nodesource.com/blog/blacklisting-node-js-core-modules-and-bindings-to-enhance-application-security/">Blacklisting Node.js Core Modules</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
  <p>
    Have a Cypress question? Want me to answer it? Consider supporting me via <a target="_blank" rel="noopener" href="https://github.com/sponsors/bahmutov">GitHub Sponsors</a> or by purchasing my <a target="_blank" rel="noopener" href="https://cypress.tips/courses">Cypress courses</a>.
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/playing-havoc-with-node-module-system/" data-id="cl6auyydc00bkgovg78au698e" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/playing-havoc-with-node-module-system/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/security/" rel="tag">security</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../refactoring-to-compose/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Refactoring to compose
        
      </div>
    </a>
  
  
    <a href="../how-to-crash/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">How to crash</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">148</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">488</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">221</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">25</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">145</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.37px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.48px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.74px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.89px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.74px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.78px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 12.96px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.59px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 14.81px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.56px;">browser</a> <a href="../tags/ci/" style="font-size: 17.41px;">ci</a> <a href="../tags/circle/" style="font-size: 13.7px;">circle</a> <a href="../tags/climate/" style="font-size: 14.44px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 15.19px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.22px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14.07px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.74px;">d3</a> <a href="../tags/db/" style="font-size: 14.44px;">db</a> <a href="../tags/docker/" style="font-size: 14.07px;">docker</a> <a href="../tags/documentation/" style="font-size: 11.85px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.44px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.15px;">functional</a> <a href="../tags/generators/" style="font-size: 11.48px;">generators</a> <a href="../tags/git/" style="font-size: 15.19px;">git</a> <a href="../tags/github/" style="font-size: 16.67px;">github</a> <a href="../tags/graphql/" style="font-size: 11.48px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.22px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.74px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.11px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.22px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.48px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.74px;">interview</a> <a href="../tags/jade/" style="font-size: 11.11px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.63px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.74px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.7px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 17.04px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.11px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.52px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.3px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.22px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.41px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.37px;">proposal</a> <a href="../tags/ramda/" style="font-size: 17.04px;">ramda</a> <a href="../tags/react/" style="font-size: 12.22px;">react</a> <a href="../tags/react-native/" style="font-size: 11.11px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.07px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.11px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.48px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.96px;">security</a> <a href="../tags/sentry/" style="font-size: 13.7px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 11.85px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.26px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.93px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.59px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.37px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.33px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.11px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.48px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 11.85px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.74px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/08/">August 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/07/">July 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/06/">June 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/05/">May 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/04/">April 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/03/">March 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../dark-cypress-tips/">Adding Dark Theme to Cypress.Tips Site</a>
          </li>
        
          <li>
            <a href="../cypress-emulate-media/">Emulate Media In Cypress Tests</a>
          </li>
        
          <li>
            <a href="../cypress-js-to-ts/">Convert Cypress Specs from JavaScript to TypeScript</a>
          </li>
        
          <li>
            <a href="../cypress-out-of-band/">Cypress Cannot Add Out-Of-Band Commands</a>
          </li>
        
          <li>
            <a href="../component-code-coverage/">Component Code Coverage in Cypress v10</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/playing-havoc-with-node-module-system/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
