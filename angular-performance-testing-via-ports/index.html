<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Angular performance testing via ports | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="I always advise to refactor code if it is not easily testable. For example, exposing a grouping 
function from the CommonJS module to be able to unit test it
hard to test12345678910function action(inp">
<meta property="og:type" content="article">
<meta property="og:title" content="Angular performance testing via ports">
<meta property="og:url" content="http://glebbahmutov.com/blog/angular-performance-testing-via-ports/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="I always advise to refactor code if it is not easily testable. For example, exposing a grouping 
function from the CommonJS module to be able to unit test it
hard to test12345678910function action(inp">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/access-angular-from-console.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/wrap-angular-scope-method.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/Automatic-OBD-II-port.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Angular performance testing via ports">
<meta name="twitter:description" content="I always advise to refactor code if it is not easily testable. For example, exposing a grouping 
function from the CommonJS module to be able to unit test it
hard to test12345678910function action(inp">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="..//" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="..//" id="subtitle">Software advice from Dr. Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <h2 id="subtitle-wrap">
        <span class="subtitle">Software advice from <a id="subtitle" href="http://glebbahmutov.com">Dr. Gleb Bahmutov PhD</a></span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="..//">Home</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-angular-performance-testing-via-ports" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2015-10-15T04:00:00.000Z" itemprop="datePublished">Oct 15 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/process/">process</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Angular performance testing via ports
    </h1>

    <h2 class="article-title" itemprop="name">
      Leave hooks in the AngularJS application to allow measuring how long individual actions take.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I always advise to refactor code if it is not easily testable. For example, exposing a grouping 
function from the CommonJS module to be able to unit test it</p>
<figure class="highlight js"><figcaption><span>hard to test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params">inputs</span>) </span>{</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> doSomethingWith(inputs);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> doSomethingElse(group());</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    action: action</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>There are ways to unit test private functions like <code>group</code> using NodeJS hooks, for example using 
<a href="https://github.com/bahmutov/describe-it" target="_blank" rel="external">describe-it</a>, but it is much better to refactor the above
code for simple unit testing</p>
<figure class="highlight js"><figcaption><span>simple to test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">group</span>(<span class="params">data</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> doSomethingWith(data);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params">inputs</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> doSomethingElse(group(inputs));</span><br><span class="line">}</span><br><span class="line"><span class="built_in">module</span>.exports = {</span><br><span class="line">    action: action,</span><br><span class="line">    group: group</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>We have added <code>group</code> to the exported object, and are passing the <code>inputs</code> to the function, instead
of using the closure. This makes it simple to write a unit test</p>
<figure class="highlight js"><figcaption><span>unit test spec</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> group = <span class="built_in">require</span>(<span class="string">&apos;./action&apos;</span>).group;</span><br><span class="line">describe(<span class="string">&apos;group&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    it(<span class="string">&apos;works&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">var</span> data = ...;</span><br><span class="line">        <span class="keyword">var</span> result = group(data);</span><br><span class="line">        expect(result).to.equal(...);</span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>AngularJS is a very testable framework. Values, services, controllers - all can be quickly
injected and unit tested from specs. We even wrote <a href="https://github.com/kensho/ng-describe" target="_blank" rel="external">ng-describe</a>
to remove the usual boilerplate code from the testing code</p>
<figure class="highlight js"><figcaption><span>test a controller / scope</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;S&apos;</span>, [])</span><br><span class="line">  .controller(<span class="string">&apos;sample&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$timeout, $scope</span>) </span>{</span><br><span class="line">    $scope.foo = <span class="string">&apos;foo&apos;</span>;</span><br><span class="line">    $scope.update = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        $scope.foo = <span class="string">&apos;bar&apos;</span>;</span><br><span class="line">      }, <span class="number">1000</span>);</span><br><span class="line">    };</span><br><span class="line">  });</span><br><span class="line">ngDescribe({</span><br><span class="line">  name: <span class="string">&apos;timeout in controller&apos;</span>,</span><br><span class="line">  modules: <span class="string">&apos;S&apos;</span>,</span><br><span class="line">  <span class="comment">// inject $timeout so we can flush the timeout queue</span></span><br><span class="line">  inject: [<span class="string">&apos;$timeout&apos;</span>],</span><br><span class="line">  controllers: <span class="string">&apos;sample&apos;</span>,</span><br><span class="line">  tests: <span class="function"><span class="keyword">function</span> (<span class="params">deps</span>) </span>{</span><br><span class="line">    <span class="comment">// deps.sample = $scope object injected into sample controller</span></span><br><span class="line">    it(<span class="string">&apos;has initial values&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      la(deps.sample.foo === <span class="string">&apos;foo&apos;</span>);</span><br><span class="line">    });</span><br><span class="line">    it(<span class="string">&apos;updates after timeout&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      deps.sample.update();</span><br><span class="line">      deps.$timeout.flush();</span><br><span class="line">      la(deps.sample.foo === <span class="string">&apos;bar&apos;</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>What about the performance testing? How do we know if our live application performs fast enough
for the end users? Unit testing the small benchmarks is very time consuming in my opinion. A much
better approach is too treat this problem as a it develops. Typically, a client or a tester
contacts the team with a complain: </p>
<blockquote>
<p>When I click on this button, the application freezes for a long time.</p>
</blockquote>
<p>This is when I start profiling the application using live data. The Angular framework makes
some aspects of the performance profiling very simple. Since most of the data and logic is 
attached to the <em>scope</em> objects, it can be accessed from the <a href="../angular-from-browser-console/">browser&apos;s console</a>.
In the example below, we can grab the reference to a method via an element&apos;s scope, then monitor
and debug it.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/access-angular-from-console.png" alt="debug method"></p>
<p>Even better, all the boilerplate code to attach and time specific scope methods can be stored
outside the application in Chrome&apos;s <a href="../performance-profiling-using-devtools-code-snippets/">code snippets</a>.
In the code snippet below, available in <a href="">bahmutov/code-snippets</a>
we can wrap a specific method with a code that starts the Chrome profiler. When the method finishes (either by
returning a value, or when the returned promise completes), the profiler stops, giving us a very accurate
timing information.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/wrap-angular-scope-method.png" alt="wrap method"></p>
<h2 id="performance-diagnostic-port">Performance diagnostic port</h2><p>Returning a promise from an asynchronous scope method, even if the promise is not used in the other application
parts, is very useful for diagnosing performance problems. You can think of this similar to modern cars having
a standard port for reading the engine&apos;s log and various sensor data.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-from-console/Automatic-OBD-II-port.jpg" alt="sensor"></p>
<p>Most Angular asynchronous services already return a promise by default. For example, we can time how long
a method takes if it uses <code>$timeout</code> service by returning it. Start with the application code</p>
<figure class="highlight js"><figcaption><span>application code without a port</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$scope.sleepNseconds = <span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>{</span><br><span class="line">    $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="comment">// done!</span></span><br><span class="line">    }, n * <span class="number">1000</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>and refactor it to return a promise, exposing a &quot;port&quot; for quick profiling from the browser&apos;s console</p>
<figure class="highlight js"><figcaption><span>application code WITH a port</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$scope.sleepNseconds = <span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="comment">// done!</span></span><br><span class="line">    }, n * <span class="number">1000</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// from the browser console</span></span><br><span class="line"><span class="built_in">console</span>.profile(<span class="string">&apos;sleep&apos;</span>);</span><br><span class="line"><span class="keyword">var</span> action = angular.element($<span class="number">0</span>).scope().sleepNSeconds;</span><br><span class="line">$q.when(action())</span><br><span class="line">    .finally(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.profileEnd(<span class="string">&apos;sleep&apos;</span>);</span><br><span class="line">    });</span><br></pre></td></tr></table></figure>
<p>Sometimes making a promise-returning port is more complicated. For example, the directives might
exchange messages instead of calling methods and returning a promise. In this case, you have to refactor
more code in order to allow an external code to profile the action&apos;s performance. For example,
imagine that the parent controller broadcasts a message to all children. Every child does something
for random number of milliseconds. You can see the application in action below. Click the &quot;action&quot;
button to broadcast the message.</p>
<iframe style="width: 100%; height: 400px" src="http://embed.plnkr.co/MTbxkD5x5SQTYp18hcQ7" frameborder="0" allowfullscren="allowfullscren"></iframe>

<figure class="highlight js"><figcaption><span>original code</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> randomMillis = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">5000</span>);</span><br><span class="line">}</span><br><span class="line">angular.module(<span class="string">&apos;App&apos;</span>, [])</span><br><span class="line">  .controller(<span class="string">&apos;parent&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope</span>) </span>{</span><br><span class="line">    $scope.items = [<span class="string">&apos;one&apos;</span>, <span class="string">&apos;two&apos;</span>, <span class="string">&apos;three&apos;</span>];</span><br><span class="line">    $scope.action = <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>{</span><br><span class="line">      $scope.$broadcast(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;parent sent action broadcast&apos;</span>);</span><br><span class="line">    };</span><br><span class="line">  })</span><br><span class="line">  .controller(<span class="string">&apos;child&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, $timeout</span>) </span>{</span><br><span class="line">    $scope.$on(<span class="string">&apos;action&apos;</span>, <span class="function"><span class="keyword">function</span> <span class="title">childAction</span>(<span class="params"></span>) </span>{</span><br><span class="line">      <span class="keyword">var</span> ms = randomMillis();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;starting action in child for&apos;</span>, ms, <span class="string">&apos;ms&apos;</span>);</span><br><span class="line">      $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&apos;action completed after&apos;</span>, ms, <span class="string">&apos;ms&apos;</span>);</span><br><span class="line">      }, ms);</span><br><span class="line">    });</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>The DOM will have markup for the parent and children controllers</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">&quot;parent&quot;</span>&gt;</span></span><br><span class="line">  this is parent controller. </span><br><span class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">&quot;action&quot;</span> <span class="attribute">ng-click</span>=<span class="value">&quot;action()&quot;</span>&gt;</span>action<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;item in items&quot;</span> <span class="attribute">ng-controller</span>=<span class="value">&quot;child&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h3</span>&gt;</span>child controller {{$index}}<span class="tag">&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>This code cannot be measured or profiled accurately. The profiler could be started and stopped manually, 
but this is inaccurate and not very repeatable. Let us refactor the code to return a promise from the <code>action</code>.
First, we need to keep track how many children controllers are executing. Second, we need to resolve
the promise when every child controller finishes. To do this, the child controllers will emit additional
messages: one when starting an action, and another when the action is complete. This allows
the parent controller to know when every part is complete.</p>
<figure class="highlight js"><figcaption><span>code with a port</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> randomMillis = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">5000</span>);</span><br><span class="line">}</span><br><span class="line">angular.module(<span class="string">&apos;App&apos;</span>, [])</span><br><span class="line">  .controller(<span class="string">&apos;parent&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, $q</span>) </span>{</span><br><span class="line">    $scope.items = [<span class="string">&apos;one&apos;</span>, <span class="string">&apos;two&apos;</span>, <span class="string">&apos;three&apos;</span>];</span><br><span class="line">    <span class="keyword">var</span> defer;</span><br><span class="line">    $scope.action = <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>{</span><br><span class="line">      $scope.actionStarted = <span class="number">0</span>;</span><br><span class="line">      $scope.$broadcast(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;parent sent action broadcast&apos;</span>);</span><br><span class="line">      defer = $q.defer();</span><br><span class="line">      <span class="keyword">return</span> defer.promise;</span><br><span class="line">    };</span><br><span class="line">    $scope.$on(<span class="string">&apos;actionStarted&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      $scope.actionStarted += <span class="number">1</span>;</span><br><span class="line">    });</span><br><span class="line">    $scope.$on(<span class="string">&apos;actionCompleted&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      $scope.actionStarted -= <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;remaining actions&apos;</span>, $scope.actionStarted);</span><br><span class="line">      <span class="keyword">if</span> ($scope.actionStarted === <span class="number">0</span>) {</span><br><span class="line">        defer.resolve();</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  })</span><br><span class="line">  .controller(<span class="string">&apos;child&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, $timeout</span>) </span>{</span><br><span class="line">    $scope.$on(<span class="string">&apos;action&apos;</span>, <span class="function"><span class="keyword">function</span> <span class="title">childAction</span>(<span class="params"></span>) </span>{</span><br><span class="line">      <span class="keyword">var</span> ms = randomMillis();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;starting action in child for&apos;</span>, ms, <span class="string">&apos;ms&apos;</span>);</span><br><span class="line">      $scope.$emit(<span class="string">&apos;actionStarted&apos;</span>);</span><br><span class="line">      $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&apos;action completed after&apos;</span>, ms, <span class="string">&apos;ms&apos;</span>);</span><br><span class="line">        $scope.$emit(<span class="string">&apos;actionCompleted&apos;</span>);</span><br><span class="line">      }, ms);</span><br><span class="line">    });</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>Normally, I would profile this code from the browser&apos;s console using 
<a href="https://github.com/bahmutov/code-snippets/blob/master/ng-profile-scope-method.js" target="_blank" rel="external">ng-profile-scope-method.js</a> 
code snippet. Because the code is embedded in an iframe in the example, I had
to place the wrapping code into the Angular application itself. Here is the additional code
in the parent&apos;s controller</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$scope.profileAction = <span class="function"><span class="keyword">function</span> <span class="title">profileAction</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> _action = $scope.action;</span><br><span class="line">  $scope.action = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.profile(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">    <span class="built_in">console</span>.time(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">    $q.when(_action())</span><br><span class="line">      .finally(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">        <span class="built_in">console</span>.timeEnd(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">        <span class="built_in">console</span>.profileEnd(<span class="string">&apos;action&apos;</span>);</span><br><span class="line">        $scope.action = _action;</span><br><span class="line">      });</span><br><span class="line">  };</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>Open the browser console, then click the &quot;profile action&quot; and then the &quot;action&quot; buttons.</p>
<iframe style="width: 100%; height: 400px" src="http://embed.plnkr.co/h5UBK5t0HtXQVrz3z2xz" frameborder="0" allowfullscren="allowfullscren"></iframe>

<p>You should see the timing information and the generated profile. The last message in the console
comes from <code>console.time() - console.timeEnd()</code> calls and should accurately reflect how long the
entire action took.</p>
<p>We had to add code to our <code>action</code> method, but the new code makes it simple to profile. 
I am sure that this boilerplate code is easy to factor out
into a service to make a truly reusable performance diagnostic tool.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>

    

    <footer class="article-footer">
      <a data-url="http://glebbahmutov.com/blog/angular-performance-testing-via-ports/" data-id="cijcalq7400wjtiurxcqxznvo" class="article-share-link">Share</a>
      
        <a href="http://glebbahmutov.com/blog/angular-performance-testing-via-ports/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/angularjs/">angularjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../changing-the-function-arguments-trick/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Changing the function arguments trick
        
      </div>
    </a>
  
  
    <a href="../async-angular-filter/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Async Angular filter</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">71</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">192</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">146</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">55</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">44</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 12.35px;">QUnit</a><a href="../tags/advice/" style="font-size: 19.41px;">advice</a><a href="../tags/angular/" style="font-size: 10px;">angular</a><a href="../tags/angularjs/" style="font-size: 18.24px;">angularjs</a><a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a><a href="../tags/assertions/" style="font-size: 13.53px;">assertions</a><a href="../tags/boilerplate/" style="font-size: 15.29px;">boilerplate</a><a href="../tags/browser/" style="font-size: 14.71px;">browser</a><a href="../tags/ci/" style="font-size: 11.18px;">ci</a><a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a><a href="../tags/d3/" style="font-size: 11.18px;">d3</a><a href="../tags/database/" style="font-size: 10px;">database</a><a href="../tags/db/" style="font-size: 12.35px;">db</a><a href="../tags/es6/" style="font-size: 14.12px;">es6</a><a href="../tags/es7/" style="font-size: 10px;">es7</a><a href="../tags/functional/" style="font-size: 17.06px;">functional</a><a href="../tags/generators/" style="font-size: 12.35px;">generators</a><a href="../tags/git/" style="font-size: 13.53px;">git</a><a href="../tags/grunt/" style="font-size: 13.53px;">grunt</a><a href="../tags/gulp/" style="font-size: 11.18px;">gulp</a><a href="../tags/immutable/" style="font-size: 10px;">immutable</a><a href="../tags/interview/" style="font-size: 11.18px;">interview</a><a href="../tags/jade/" style="font-size: 11.76px;">jade</a><a href="../tags/javascript/" style="font-size: 20px;">javascript</a><a href="../tags/jshint/" style="font-size: 11.18px;">jshint</a><a href="../tags/modular-development/" style="font-size: 15.29px;">modular development</a><a href="../tags/nodejs/" style="font-size: 18.82px;">nodejs</a><a href="../tags/performance/" style="font-size: 15.88px;">performance</a><a href="../tags/promises/" style="font-size: 16.47px;">promises</a><a href="../tags/proposal/" style="font-size: 10.59px;">proposal</a><a href="../tags/reactive/" style="font-size: 10.59px;">reactive</a><a href="../tags/reactjs/" style="font-size: 10.59px;">reactjs</a><a href="../tags/security/" style="font-size: 11.76px;">security</a><a href="../tags/sentry/" style="font-size: 13.53px;">sentry</a><a href="../tags/testing/" style="font-size: 17.65px;">testing</a><a href="../tags/tutorial/" style="font-size: 12.94px;">tutorial</a><a href="../tags/ui/" style="font-size: 10px;">ui</a><a href="../tags/web-workers/" style="font-size: 12.35px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../i-write-3-types-of-software/">I write 3 types of software</a>
          </li>
        
          <li>
            <a href="../run-express-server-in-your-browser/">Run Express server in your browser</a>
          </li>
        
          <li>
            <a href="../using-webpack/">Using webpack</a>
          </li>
        
          <li>
            <a href="../the-senior-engineer-role/">The senior engineer role</a>
          </li>
        
          <li>
            <a href="../instant-web-application/">Instant Web Application</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="..//" class="mobile-nav-link">Home</a>
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'http://glebbahmutov.com/blog/angular-performance-testing-via-ports/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css" type="text/css">
  <script src="../fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="../js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>