<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Spy On A Complex Method Call | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Here is a question that came from (deprecated) Cypress Gitter chat channel. The user provided a repo with a reproducible test that tried to assert that window.dataLayer.push method was called with an">
<meta property="og:type" content="article">
<meta property="og:title" content="Spy On A Complex Method Call">
<meta property="og:url" content="https://glebbahmutov.com/blog/spy-on-complex-method-call/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Here is a question that came from (deprecated) Cypress Gitter chat channel. The user provided a repo with a reproducible test that tried to assert that window.dataLayer.push method was called with an">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/spy-data/calls.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/spy-data/datalayer.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/spy-data/assert-called.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/spy-data/many-spies.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/spy-data/spy-stub.gif">
<meta property="article:published_time" content="2022-05-04T04:00:00.000Z">
<meta property="article:modified_time" content="2022-05-04T13:55:08.321Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="cypress">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/spy-data/calls.png">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-spy-on-complex-method-call" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2022-05-04T04:00:00.000Z" itemprop="datePublished">May 4 2022</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spy On A Complex Method Call
    </h1>

    <h2 class="article-title" itemprop="name">
      Checking if the window data layer method call was called with an expected argument.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Here is a question that came from (deprecated) Cypress <a target="_blank" rel="noopener" href="https://gitter.im/cypress-io/cypress">Gitter chat channel</a>. The user provided a repo with a reproducible test that tried to assert that <code>window.dataLayer.push</code> method was called with an object with the field <code>event: lead</code>. This is just one particular call among hundreds of calls the application is making to track its various events.</p>
<p><img src="../images/spy-data/calls.png" alt="We are trying to confirm this particular call amongst many others"></p>
<p>The user is struggling to write the correct test and asked me to help.</p>
<h2><span id="the-original-test">The original test</span></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;testin datalayer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">before</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;**mule/customer/clicktocall&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;clicktocall&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;https://flsit.vtr.lla.digital/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="number">5000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;wait &amp; assert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">window</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">win</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-floating-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">0</span>).<span class="title function_">type</span>(<span class="string">&#x27;111111111&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">1</span>).<span class="title function_">type</span>(<span class="string">&#x27;9872819281&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-button.llad-contact-info-form__button button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">      cy.<span class="title function_">wait</span>(<span class="string">&#x27;@clicktocall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      cy.<span class="title function_">wait</span>(<span class="number">10000</span>)</span><br><span class="line">      <span class="comment">// find the index of the argument that corresponds to this event</span></span><br><span class="line">      <span class="comment">// cy.wrap(&#x27;@open&#x27;).should((res) =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//   const index = res.args.findIndex((i) =&gt; i[0].event == &#x27;lead&#x27;);</span></span><br><span class="line">      <span class="comment">//   cy.log(index);</span></span><br><span class="line">      <span class="comment">// &#125;);</span></span><br><span class="line">      <span class="keyword">const</span> data = cy.<span class="title function_">spy</span>(win.<span class="property">dataLayer</span>, <span class="string">&#x27;push&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;dataL&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">log</span>(data.<span class="property">args</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;@dataL&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        cy.<span class="title function_">log</span>(res.<span class="property">args</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>A few observations about this test right away:</p>
<ul>
<li>the base URL is hardcoded in the test, which is an anti-pattern. I prefer setting the base URL in the <code>cypress.json</code> file, watch the video <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=f5UaXuAc52c">How to correctly use the baseUrl to visit a site in Cypress</a></li>
<li>there are several hard-coded <code>cy.wait(ms)</code> commands, probably to let the page load the tracking library and create the <code>window.dataLayer</code> object. We can specifically wait for the <code>window.dataLayer</code> to exist, avoiding the hard-coded waits</li>
</ul>
<h2><span id="updated-test">Updated test</span></h2><p>Let&#39;s start by moving the base URL to the <code>cypress.json</code> file and removing the <code>cy.wait(ms)</code> commands. Instead we will wait for the <code>window</code> object to have a property <code>dataLayer</code> with the method <code>push</code>. See the inline code comments for the full explanation and links to more documentation.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;testing datalayer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">before</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;**mule/customer/clicktocall&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;clicktocall&#x27;</span>)</span><br><span class="line">    <span class="comment">// cy.visit command yields the window object</span></span><br><span class="line">    <span class="comment">// and cy.its command retries until the &quot;dataLayer&quot; property is found</span></span><br><span class="line">    <span class="comment">// then we check if there is a method &quot;push&quot; on that object</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/visit</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/its</span></span><br><span class="line">    <span class="comment">// https://glebbahmutov.com/cypress-examples/commands/assertions.html</span></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">its</span>(<span class="string">&#x27;dataLayer&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;respondTo&#x27;</span>, <span class="string">&#x27;push&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;wait &amp; assert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-floating-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">0</span>).<span class="title function_">type</span>(<span class="string">&#x27;111111111&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">1</span>).<span class="title function_">type</span>(<span class="string">&#x27;9872819281&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-button.llad-contact-info-form__button button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="string">&#x27;@clicktocall&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="../images/spy-data/datalayer.gif" alt="The updated test waits only until the window.dataLayer property is found"></p>
<h2><span id="spying">Spying</span></h2><p>Ok, what about our spy? Sure, let&#39;s add a spy on the method <code>push</code> of the <code>dataLayer</code> object. The most interesting thing here is how to check if the spy function was called by the application. We have complex calls, and are only interested in the call where the first argument is an object with property <code>event: &quot;lead&quot;</code>. Luckily, Chai-Sinon assertions included with Cypress provide a way to use a custom matcher to check the calls.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;testing datalayer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">before</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;**mule/customer/clicktocall&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;clicktocall&#x27;</span>)</span><br><span class="line">    <span class="comment">// cy.visit command yields the window object</span></span><br><span class="line">    <span class="comment">// and cy.its command retries until the &quot;dataLayer&quot; property is found</span></span><br><span class="line">    <span class="comment">// then we check if there is a method &quot;push&quot; on that object</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/visit</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/its</span></span><br><span class="line">    <span class="comment">// https://glebbahmutov.com/cypress-examples/commands/assertions.html</span></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;dataLayer&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;respondTo&#x27;</span>, <span class="string">&#x27;push&#x27;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">dataLayer</span>) =&gt;</span> &#123;</span><br><span class="line">        cy.<span class="title function_">spy</span>(dataLayer, <span class="string">&#x27;push&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;dataL&#x27;</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;wait &amp; assert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-floating-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">0</span>).<span class="title function_">type</span>(<span class="string">&#x27;111111111&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">1</span>).<span class="title function_">type</span>(<span class="string">&#x27;9872819281&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-button.llad-contact-info-form__button button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="string">&#x27;@clicktocall&#x27;</span>)</span><br><span class="line">    <span class="comment">// confirm there was a call that satisfies the custom predicate function</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">isLead</span> = (<span class="params">d</span>) =&gt; d.<span class="property">event</span> === <span class="string">&#x27;lead&#x27;</span></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;@dataL&#x27;</span>).<span class="title function_">should</span>(</span><br><span class="line">      <span class="string">&#x27;have.been.calledWith&#x27;</span>,</span><br><span class="line">      <span class="title class_">Cypress</span>.<span class="property">sinon</span>.<span class="title function_">match</span>(isLead, <span class="string">&#x27;lead event&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>For more Chai-Sinon assertion examples, see my <a href="https://glebbahmutov.com/cypress-examples/commands/spies-stubs-clocks.html"><code>cy.stub</code>, <code>cy.spy</code>, and <code>cy.clock</code> examples</a>. For now, the test works, even if it is pretty noisy - there are lots of <code>dataLayer.push</code> calls!</p>
<p><img src="../images/spy-data/assert-called.gif" alt="The application does call dataLayer.push with the lead event"></p>
<h2><span id="cut-the-noise">Cut the noise</span></h2><p>We only want to be informed about <code>dataLayer.push(lead)</code> events, not every call. Unfortunately, the built-in Sinon mechanism to create a targeted spy <code>cy.spy(dataLayer, &#39;push&#39;).withArgs(&#123; event: &#39;lead&#39; &#125;).as(&#39;lead&#39;)</code> expects the exact argument match, not part of the object. We could use the same match via predicate when creating a spy:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">spy</span>(dataLayer, <span class="string">&#x27;push&#x27;</span>)</span><br><span class="line">  .<span class="title function_">withArgs</span>(<span class="title class_">Cypress</span>.<span class="property">sinon</span>.<span class="title function_">match</span>(isLead))</span><br><span class="line">  .<span class="title function_">as</span>(<span class="string">&#x27;lead&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>It does simplify the assertion</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@lead&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.been.calledOnce&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Unfortunately, this still records <em>other</em> calls to <code>dataLayer.push</code> method ‚òπÔ∏è</p>
<p><img src="../images/spy-data/many-spies.png" alt="The Cypress Command Log still shows all spy calls"></p>
<p>We really need to avoid using <code>cy.spy</code> for calls we are not interested in. We can do this by constructing a &quot;plain&quot; Sinon.js stub function avoiding the <code>cy.stub</code> or <code>cy.spy</code> command to avoid logging <em>every</em> call. Here is the entire test, including printing the event data to the Command Log.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;testing datalayer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isLead</span> = (<span class="params">d</span>) =&gt; d.<span class="property">event</span> === <span class="string">&#x27;lead&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">before</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;**mule/customer/clicktocall&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;clicktocall&#x27;</span>)</span><br><span class="line">    <span class="comment">// cy.visit command yields the window object</span></span><br><span class="line">    <span class="comment">// and cy.its command retries until the &quot;dataLayer&quot; property is found</span></span><br><span class="line">    <span class="comment">// then we check if there is a method &quot;push&quot; on that object</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/visit</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/its</span></span><br><span class="line">    <span class="comment">// https://glebbahmutov.com/cypress-examples/commands/assertions.html</span></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;dataLayer&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;respondTo&#x27;</span>, <span class="string">&#x27;push&#x27;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">dataLayer</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// we need to call the real method on the dataLayer object</span></span><br><span class="line">        <span class="keyword">const</span> realPush = dataLayer.<span class="property">push</span>.<span class="title function_">bind</span>(dataLayer)</span><br><span class="line">        <span class="comment">// and our stub function to be able to check it later</span></span><br><span class="line">        <span class="keyword">const</span> leadStub = cy.<span class="title function_">stub</span>().<span class="title function_">as</span>(<span class="string">&#x27;lead&#x27;</span>)</span><br><span class="line">        <span class="comment">// use &quot;plain&quot; Sinon stub to replace dataLayer.push method</span></span><br><span class="line">        <span class="title class_">Cypress</span>.<span class="property">sinon</span>.<span class="title function_">stub</span>(dataLayer, <span class="string">&#x27;push&#x27;</span>).<span class="title function_">callsFake</span>(<span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// if this is a lead event, call the Cypress stub</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isLead</span>(args[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="title function_">leadStub</span>(...args)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// and always call the real dataLayer.push</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">realPush</span>(...args)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;wait &amp; assert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-floating-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">0</span>).<span class="title function_">type</span>(<span class="string">&#x27;111111111&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-click-to-call-form input&#x27;</span>).<span class="title function_">eq</span>(<span class="number">1</span>).<span class="title function_">type</span>(<span class="string">&#x27;9872819281&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;lla-button.llad-contact-info-form__button button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="string">&#x27;@clicktocall&#x27;</span>)</span><br><span class="line">    <span class="comment">// confirm the cy.stub was called</span></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;@lead&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.been.calledOnce&#x27;</span>)</span><br><span class="line">      <span class="comment">// and grab its first call&#x27;s arguments</span></span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;firstCall.args&#x27;</span>)</span><br><span class="line">      <span class="comment">// and log them to Cypress Command Log</span></span><br><span class="line">      .<span class="title function_">then</span>(<span class="title class_">JSON</span>.<span class="property">stringify</span>)</span><br><span class="line">      .<span class="title function_">then</span>(cy.<span class="property">log</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>The test is beautiful ü•∞ and takes only four seconds üèé instead of 20+ seconds of the original test with hard-coded waits.</p>
<p><img src="../images/spy-data/spy-stub.gif" alt="Logging only the method call we are interested in"></p>
<h2><span id="see-also">See also</span></h2><ul>
<li><a href="/blog/spy-on-dom-methods/" title="Spy On DOM Methods And Properties">Spy On DOM Methods And Properties</a></li>
<li><a target="_blank" rel="noopener" href="https://on.cypress.io/stubs-spies-and-clocks">Cypress Stubs, Spies, and Clocks Guide</a></li>
<li>my <a href="https://glebbahmutov.com/cypress-examples/commands/spies-stubs-clocks.html"><code>cy.stub</code>, <code>cy.spy</code>, and <code>cy.clock</code> examples</a></li>
<li>find more stubbing and spying examples by searching using my <a target="_blank" rel="noopener" href="https://cypress.tips/search">cypress.tips&#x2F;search</a> page</li>
<li><a target="_blank" rel="noopener" href="https://sinonjs.org/">Sinon.js documentation</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
  <p>
    Have a Cypress question? Want me to answer it? Consider supporting me via <a target="_blank" rel="noopener" href="https://github.com/sponsors/bahmutov">GitHub Sponsors</a> or by purchasing my <a target="_blank" rel="noopener" href="https://cypress.tips/courses">Cypress courses</a>.
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/spy-on-complex-method-call/" data-id="clbdyqqf000fl9tvg0xnzhf6y" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/spy-on-complex-method-call/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/" rel="tag">cypress</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../quick-click/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          A Quick React Component Test
        
      </div>
    </a>
  
  
    <a href="../send-data-to-the-test/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Send Data From The Application To The Cypress Test</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">154</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">502</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angular/" rel="tag">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">241</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">155</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.37px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.48px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.74px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.89px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.74px;">algolia</a> <a href="../tags/angular/" style="font-size: 10px;">angular</a> <a href="../tags/angularjs/" style="font-size: 17.78px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 12.96px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.59px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 14.81px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.56px;">browser</a> <a href="../tags/ci/" style="font-size: 17.41px;">ci</a> <a href="../tags/circle/" style="font-size: 14.44px;">circle</a> <a href="../tags/climate/" style="font-size: 14.44px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 15.19px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.22px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14.07px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.74px;">d3</a> <a href="../tags/db/" style="font-size: 14.44px;">db</a> <a href="../tags/docker/" style="font-size: 14.07px;">docker</a> <a href="../tags/documentation/" style="font-size: 11.85px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.44px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.15px;">functional</a> <a href="../tags/generators/" style="font-size: 11.48px;">generators</a> <a href="../tags/git/" style="font-size: 15.19px;">git</a> <a href="../tags/github/" style="font-size: 16.67px;">github</a> <a href="../tags/graphql/" style="font-size: 11.48px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.22px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.74px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.11px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.22px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.48px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.74px;">interview</a> <a href="../tags/jade/" style="font-size: 11.11px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.63px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.74px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.7px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 17.04px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.11px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.52px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.3px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.22px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.41px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.37px;">proposal</a> <a href="../tags/ramda/" style="font-size: 17.04px;">ramda</a> <a href="../tags/react/" style="font-size: 12.22px;">react</a> <a href="../tags/react-native/" style="font-size: 11.11px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.07px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.11px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.48px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 12.96px;">security</a> <a href="../tags/sentry/" style="font-size: 13.7px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 11.85px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.26px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.93px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.59px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.37px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.33px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.11px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.48px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 11.85px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.74px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/11/">November 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/10/">October 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/09/">September 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/08/">August 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/07/">July 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/06/">June 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/05/">May 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/04/">April 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/03/">March 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../slow-loading-jquery-plugin/">Test A Slow-loading jQuery Plugin</a>
          </li>
        
          <li>
            <a href="../test-polyfills/">Test Polyfills</a>
          </li>
        
          <li>
            <a href="../inject-env/">How To Inject Environment Variables Into Cypress Tests</a>
          </li>
        
          <li>
            <a href="../spy-on-clipboard-copy/">Spy On Clipboard Copy Method Call</a>
          </li>
        
          <li>
            <a href="../spy-on-postmessage/">Spy On window.postMessage Calls</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/spy-on-complex-method-call/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
