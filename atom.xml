<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Better world by better software</title>
  
  <subtitle>Gleb Bahmutov PhD</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://glebbahmutov.com/blog/"/>
  <updated>2024-08-30T17:06:47.718Z</updated>
  <id>https://glebbahmutov.com/blog/</id>
  
  <author>
    <name>Gleb Bahmutov</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Refactor Cypress Network Tests</title>
    <link href="https://glebbahmutov.com/blog/refactor-network-tests/"/>
    <id>https://glebbahmutov.com/blog/refactor-network-tests/</id>
    <published>2024-08-30T04:00:00.000Z</published>
    <updated>2024-08-30T17:06:47.718Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I have seen an example screenshot showing two Cypress tests using the great <a href="https://on.cypress.io/intercept">cy.intercept</a> command to test the loading message and error handling. You can see the original post on <a href="https://x.com/AdhithiRavi/status/1828883605680206117">twitter</a> and <a href="https://www.linkedin.com/feed/update/urn:li:activity:7234648800965840896/">linkedin</a>. Here is the screenshot:</p><p><img src="../images/refactor-network-tests/original-tests.jpeg" alt="Two Cypress tests using cy.intercept command"></p><p>Let&#39;s improve these tests a little.</p><h2><span id="set-network-spy-before-the-action">Set network spy before the action</span></h2><p>The first improvement we are going to make is to remove a potential flake in the first test:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/e2e/bonus134.cy.js</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Page loads slowly&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;shows the loading element&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">      req.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        res.<span class="title function_">setDelay</span>(<span class="number">1500</span>) <span class="comment">// 1.5 seconds delay</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test might pass, but it does have a problem</p><p><img src="../images/refactor-network-tests/passing-first-test.png" alt="The first test passes"></p><p>Do you see the potential problem in this test? If not, read the &quot;The intercept was registered too late&quot; in the blog post <a href="https://glebbahmutov.com/blog/cypress-intercept-problems/#the-intercept-was-registered-too-late">Cypress cy.intercept Problems</a>. We can see the error if we modify our application code and make the loading call start sooner.</p><p><img src="../images/refactor-network-tests/too-late.png" alt="The first test fails if the network call happens quickly"></p><p>We should always register the network intercept <em>before</em> the application makes the call. I will move the <code>cy.visit</code> into the test and place it after the <code>cy.intercept</code> command.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the loading element&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">setDelay</span>(<span class="number">1500</span>) <span class="comment">// 1.5 seconds delay</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  <span class="comment">// once the network intercept is set up</span></span><br><span class="line">  <span class="comment">// visit the page which kicks off the request</span></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The above test is robust and should always work.</p><h2><span id="checking-the-loading-element">Checking the loading element</span></h2><p>I noticed a lot of people using <code>cy.get(selector).contains(text)</code> command. The <a href="https://on.cypress.io/contains">cy.contains</a> command already accepts the <code>cy.contains(selector, text)</code> arguments, no need to chain it off a <code>cy.get</code> in most cases. The above test can be rewritten as:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the loading element (2)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">setDelay</span>(<span class="number">1500</span>) <span class="comment">// 1.5 seconds delay</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;#fruit&#x27;</span>, <span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#fruit&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.contain&#x27;</span>, <span class="string">&#x27;loading&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> we could make the test even stronger by checking if the <code>#fruit</code> element shows the fruit returned by the server.</p><h2><span id="delay-the-response">Delay the response</span></h2><p>In our test, we simply spy on the network call. The call still goes to the server, which returns the real data. We simply delay sending the response to the browser by 1.5 seconds. This can be written simply as:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the loading element (3)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, <span class="function">() =&gt;</span></span><br><span class="line">    <span class="title class_">Cypress</span>.<span class="property">Promise</span>.<span class="title function_">delay</span>(<span class="number">1500</span>),</span><br><span class="line">  ).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;#fruit&#x27;</span>, <span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#fruit&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.contain&#x27;</span>, <span class="string">&#x27;loading&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We are delaying sending the request to the server by 1.5 seconds, which is the same for our test.</p><h2><span id="the-second-test">The second test</span></h2><p>The second test shown in the original image tests an error scenario. We stub the network call and return status code 500. <strong>Tip:</strong> when stubbing the network call, we can set the delay right away.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before üëé</span></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should display error message&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">500</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;HTTP error 500&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// after ‚úÖ</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should display error message&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">500</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;HTTP error 500&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor-network-tests/error.png" alt="Testing the application network error handling"></p><p><strong>Tip:</strong> when stubbing network calls using <code>cy.intercept</code>, it is very easy to delay the response using the built-in response stub object property <code>delay</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should display error message after a delay&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/fruit&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">delay</span>: <span class="number">1500</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;fetchFruit&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/loading.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;#fruit&#x27;</span>, <span class="string">&#x27;loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@fetchFruit&#x27;</span>)</span><br><span class="line">  <span class="comment">// the error message should be displayed really quickly</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;#fruit&#x27;</span>, <span class="string">&#x27;HTTP error 500&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor-network-tests/loading-error.png" alt="Testing the application loading state and error handling"></p><blockquote class="pullquote"><p>üéì All examples shown in this blog post are covered by my hands-on course <a href="https://cypress.tips/courses/network-testing">Cypress Network Testing Exercises</a>.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently I have seen an example screenshot showing two Cypress tests using the great &lt;a href=&quot;https://on.cypress.io/intercept&quot;&gt;cy.interce
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Check URL Search Params Using Cypress</title>
    <link href="https://glebbahmutov.com/blog/check-url-params/"/>
    <id>https://glebbahmutov.com/blog/check-url-params/</id>
    <published>2024-08-14T04:00:00.000Z</published>
    <updated>2024-08-14T13:26:16.331Z</updated>
    
    <content type="html"><![CDATA[<p>This blog post shows how to validate the URL search parameters (the part of the URL after the question mark, like <code>?id=123&amp;name=Gleb</code>) from a Cypress test.</p><h2><span id="example-application">Example application</span></h2><p>For this blog post I will use an online e-store application from the <a href="https://cypress.tips/courses/swag-store">Testing The Swag Store</a> online course. When the user adds an item to the cart, the URL changes to include the item&#39;s ID and count (both are pretend) in its search params like this <code>?count=1&amp;itemId=...</code>.</p><p><img src="../images/check-url-params/url.png" alt="Application sets the URL search parameters"></p><p>Here is the starting code for this blog post: we simply want to log in and click the &quot;Add to cart&quot; button.</p><figure class="highlight ts"><figcaption><span>cypress/e2e/login/url-search-params.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginPage</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@support/pages/login.page&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> itemId = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  <span class="title class_">LoginPage</span>.<span class="title function_">getUsername</span>().<span class="title function_">type</span>(<span class="string">&#x27;standard_user&#x27;</span>)</span><br><span class="line">  <span class="title class_">LoginPage</span>.<span class="title function_">getPassword</span>().<span class="title function_">type</span>(<span class="string">&#x27;secret_sauce&#x27;</span>)</span><br><span class="line">  <span class="title class_">LoginPage</span>.<span class="title function_">getLogin</span>().<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/inventory&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">`.inventory_item[data-itemid=&quot;<span class="subst">$&#123;itemId&#125;</span>&quot;]`</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;controls the URL search params ...&#x27;</span>, <span class="function">() =&gt;</span> &#123; ... &#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s validate the <code>count</code> and <code>item</code> values the application sets in the URL search params.</p><h2><span id="check-the-url-search-string">Check the URL search string</span></h2><p>Cypress has two queries that return the URL information: <a href="https://on.cypress.io/url">cy.url</a> and <a href="https://on.cypress.io/location">cy.location</a>. I have seen people mostly using <code>cy.url</code> command, but I prefer using the <code>cy.location</code>. The <code>cy.location</code> returns any part of the parsed URL: the host, the full URL, the search part. In fact, <code>cy.url</code> is simply an alias to <code>cy.location(&#39;href&#39;)</code> command!</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">url</span>() <span class="comment">// yields &quot;https://acme.co/page/foo.html?count=...</span></span><br><span class="line">cy.<span class="title function_">location</span>(<span class="string">&#x27;protocol&#x27;</span>) <span class="comment">// yields &quot;https&quot;</span></span><br><span class="line">cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname]&#x27;</span>) <span class="comment">// yields &quot;/page/foo.html&quot;</span></span><br><span class="line">cy.<span class="title function_">location</span>(<span class="string">&#x27;search]&#x27;</span>) <span class="comment">// yields &quot;?count=...&quot;</span></span><br></pre></td></tr></table></figure><p>Without any arguments, <code>cy.location</code> yields an object with all URL parsed parts</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">location</span>().<span class="title function_">should</span>(<span class="function"><span class="params">loc</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// loc object has protocol, pathname, search and other properties</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Ok, let&#39;s simply check the search property as a string.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;controls the URL search params (check the search string)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;search&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;include&#x27;</span>, <span class="string">`count=1&amp;item=<span class="subst">$&#123;itemId&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test checks the <code>search</code> URL property <a href="https://on.cypress.io/retry-ability">with retries</a> because it follows the form <code>QUERY . SHOULD(assertion)</code>.</p><h2><span id="the-parameters-order">The parameters order</span></h2><p>In our application the order of search params is NOT guaranteed. Sometimes it is <code>count=...&amp;item=...</code> and other times it is <code>item=...&amp;count=...</code>. Thus our solution would fail sometimes. The test is flaky. We can improve it by listing the two possible orders.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;controls the URL search params (check the search string)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;search&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.oneOf&#x27;</span>, [</span><br><span class="line">    <span class="string">`?count=1&amp;item=<span class="subst">$&#123;itemId&#125;</span>`</span>,</span><br><span class="line">    <span class="string">`?item=<span class="subst">$&#123;itemId&#125;</span>&amp;count=1`</span>,</span><br><span class="line">  ])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/check-url-params/string.png" alt="be.oneOf assertion test"></p><p>Great, but the assertion does not show the possible matches, and could fail if we have more parameters, or some unknown parameters that our test should not verify.</p><h2><span id="multiple-assertions">Multiple assertions</span></h2><p>Let&#39;s avoid checking the entire URL search params string and check individual values instead. We are interested in the <code>count=...</code> and the <code>item=...</code> parameters, so let&#39;s attach multiple assertions to the same <code>cy.location(&#39;search&#39;)</code> query.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;controls the URL search params (multiple assertions)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;search&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;include&#x27;</span>, <span class="string">&#x27;count=1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">and</span>(<span class="string">&#x27;include&#x27;</span>, <span class="string">`item=<span class="subst">$&#123;itemId&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test retries because it follows the form <code>QUERY . SHOULD(assertion1) . AND(assertion2) ...</code>. The <code>.should(...)</code> and <code>.and(...)</code> assertion commands are equivalent and are used for better readability.</p><p><img src="../images/check-url-params/two.png" alt="The passing test and the assertions"></p><p>The separate assertions are much clearer in the Command Log.</p><h2><span id="using-urlsearchparams">Using <code>URLSearchParams</code></span></h2><p>Instead of checking substrings, we could let the browser parse and process the URL. There is a built-in standard for URL parsing that we can use via <a href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams">URLSearchParams</a> object. We can create an instance of <code>URLSearchParams</code> and get the individual parameters as strings inside a <code>should(callback)</code> function:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;controls the URL search params (parse URLSearchParams)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;search&#x27;</span>).<span class="title function_">should</span>(<span class="function">(<span class="params">search</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(search)</span><br><span class="line">    <span class="title function_">expect</span>(params.<span class="title function_">get</span>(<span class="string">&#x27;count&#x27;</span>)).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="title function_">expect</span>(params.<span class="title function_">get</span>(<span class="string">&#x27;item&#x27;</span>)).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="title class_">String</span>(itemId))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/check-url-params/parse.png" alt="Parsed URLSearchParams properties"></p><p>If we want to verify all parameters irrespective of their order, we can grab all properties of the parsed search params object, make an object, and use <code>deep.equal</code> assertion to check them:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has only count and item search params&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;search&#x27;</span>).<span class="title function_">should</span>(<span class="function">(<span class="params">search</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(search)</span><br><span class="line">    <span class="keyword">const</span> args = <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>(params)</span><br><span class="line">    <span class="title function_">expect</span>(args, <span class="string">&#x27;params&#x27;</span>).<span class="property">to</span>.<span class="property">deep</span>.<span class="title function_">equal</span>(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">      <span class="attr">item</span>: <span class="title class_">String</span>(itemId),</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/check-url-params/object.png" alt="Parsed URLSearchParams to plain object and deep.equal assertion"></p><p><strong>Tip:</strong> if you only know some parameters, you can use <code>deep.include</code> assertion instead of <code>deep.equal</code>.</p><p>In both cases, I prefer using <code>URLSearchParams</code> to checking strings. The URL parsing might be tricky if the parameters are encoded, so don&#39;t do it yourself.</p><h2><span id="urlsearchparams-without-shouldcallback"><code>URLSearchParams</code> without <code>should(callback)</code></span></h2><p>We can improve the readability of the above test by breaking apart the single <code>should(callback)</code>. If you looks at the assertion callback function it:</p><ul><li>takes the current subject (a string) and constructs an instance of <code>URLSearchParams</code></li><li>calls <code>Object.fromEntries</code> to make a plain object from <code>URLSearchParams</code> instance</li><li>checks the plain object using an assertion</li></ul><p>We can rewrite the callback function into a series of queries that transform the subject (the URL search string) and run an assertion. Cypress lacks the necessary queries, but I can use my plugin <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> to fill the missing pieces.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">it(&#x27;</span>has only count and item search params (cypress-map)<span class="string">&#x27;, () =&gt; &#123;</span></span><br><span class="line"><span class="string">  cy.location(&#x27;</span>search<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    .make(URLSearchParams)</span></span><br><span class="line"><span class="string">    .toPlainObject(&#x27;</span>entries<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    .map(&#123;</span></span><br><span class="line"><span class="string">      count: Number,</span></span><br><span class="line"><span class="string">      item: Number,</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">    .should(&#x27;</span>deep.<span class="property">equal</span><span class="string">&#x27;, &#123;</span></span><br><span class="line"><span class="string">      count: 1,</span></span><br><span class="line"><span class="string">      item: itemId,</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure><p><img src="../images/check-url-params/map.png" alt="Using cypress-map queries to transform the subject before asserting"></p><p>A little explanation of each step in the above test:</p><ul><li><code>cy.location(&#39;search&#39;)</code> yields a string</li><li><code>.make(URLSearchParams)</code> takes the string subject and constructs an object using <code>new URLSearchParams(s)</code></li><li><code>.toPlainObject(&#39;entries&#39;)</code> takes the object and yields <code>Object.fromEntries(o)</code></li><li>we map strings in the current subject to numbers for exact comparison later using<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">map</span>(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="title class_">Number</span>,</span><br><span class="line">  <span class="attr">item</span>: <span class="title class_">Number</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li>the last assertion checks the properties of the current subject<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">item</span>: itemId,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><p>If the assertion fails, it goes back <em>all the way</em> to <code>cy.location(&#39;search&#39;)</code> query and the steps run again. Beautiful.</p><blockquote class="pullquote"><p>üéì This blog post gives examples from the lesson <a href="https://cypress.tips/courses/swag-store/lessons/bonus64">Bonus 64: Validate URL search params</a> of the <a href="https://cypress.tips/courses/swag-store">Testing The Swag Store</a> online course. Often the URL parameters are <a href="https://en.wikipedia.org/wiki/Query_string">URL encoded</a> and thus you need to account for this in your assertions. See the lesson <a href="https://cypress.tips/courses/swag-store/lessons/bonus65">Bonus 65: confirm the escaped URL search params</a> for hands-on exercises showing how to do it reliably.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This blog post shows how to validate the URL search parameters (the part of the URL after the question mark, like &lt;code&gt;?id=123&amp;amp;name=
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Get All Intercepted Network Calls In Cypress</title>
    <link href="https://glebbahmutov.com/blog/get-all-network-calls/"/>
    <id>https://glebbahmutov.com/blog/get-all-network-calls/</id>
    <published>2024-07-27T04:00:00.000Z</published>
    <updated>2024-07-27T15:33:18.036Z</updated>
    
    <content type="html"><![CDATA[<p>This blog post describes a topic really hidden in Cypress documentation: using <code>alias.all</code> to get all intercepted network calls.</p><h2><span id="intro">Intro</span></h2><p>Using Cypress <a href="https://on.cypress.io/intercept">cy.intercept</a> command you can spy on or stub network calls the application makes. Once the intercept is in place, you can click on a button, the application makes a network call, and you can check the intercepted call using the <a href="https://on.cypress.io/wait">cy.wait</a> command.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// üí° always set up network intercepts BEFORE the action</span></span><br><span class="line">cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/comments/*&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;3 network calls&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"><span class="comment">// confirm the 3 calls are made</span></span><br><span class="line">cy.<span class="title function_">wait</span>(<span class="string">&#x27;@networkCall&#x27;</span>).<span class="title function_">wait</span>(<span class="string">&#x27;@networkCall&#x27;</span>).<span class="title function_">wait</span>(<span class="string">&#x27;@networkCall&#x27;</span>)</span><br></pre></td></tr></table></figure><p>Even if the network calls are made after some delay, Cypress waits for the calls to happen.</p><center>  <video autoplay muted loop controls>    <source src="../images/get-all-network-calls/wait3.mp4" type="video/mp4">    <img src="../images/get-all-network-calls/wait3.png">  </video></center><blockquote class="pullquote"><p>üéÅ Examples used in this blog post are available on my site <a href="http://glebbahmutov.com/cypress-examples/">glebbahmutov.com&#x2F;cypress-examples</a>. This particular post is shown in the recipe <a href="https://glebbahmutov.com/cypress-examples/recipes/all-network-calls.html">Get All Intercepted Network Calls</a>. For more in-depth network examples and exercises, see my online course <a href="https://cypress.tips/courses/network-testing">Cypress Network Testing Exercises</a>.</p></blockquote><p>What if you do not know the number of calls to expect? What if you need more flexibility when checking the network calls?</p><h2><span id="get-all-network-calls">Get all network calls</span></h2><p>The syntax <code>cy.get(&#39;alias.all&#39;)</code> is the solution. It yields an array of all <em>current</em> intercepted network calls for the given alias. It might be an empty array. Let&#39;s confirm the application makes 3 calls to <code>GET /comments/*</code> using <code>cy.get(&#39;alias.all&#39;)</code> syntax.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// üí° always set up network intercepts BEFORE the action</span></span><br><span class="line">cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/comments/*&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;3 network calls&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"><span class="comment">// confirm the 3 calls are made using cy.get</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>The video below shows how Cypress keeps retrying until the assertion <code>have.length 3</code> passes.</p><center>  <video autoplay muted loop controls>    <source src="../images/get-all-network-calls/get-all.mp4" type="video/mp4">    <img src="../images/get-all-network-calls/get-all.png">  </video></center><p>We can click on the <code>cy.get</code> command to see the array of intercepted network calls.</p><p><img src="../images/get-all-network-calls/inspect.png" alt="Intercepted network calls"></p><p>Each intercept has the request and the response objects, plus a few other internal properties.</p><p><img src="../images/get-all-network-calls/intercept.png" alt="A single intercept object"></p><p>We can treat these intercepts as plain objects and make assertions against them.</p><h2><span id="wait-for-a-network-intercept">Wait for a network intercept</span></h2><p>We can combine <code>cy.get(&#39;alias.all&#39;)</code> and <code>cy.wait(&#39;alias&#39;)</code> calls - they work independently. Each intercept has <code>responseWaited</code> property that changes on each <code>cy.wait(&#39;alias&#39;)</code> command. Using query commands from my <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> plugin we can confirm it</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// confirm the 3 calls are made using cy.get</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">cy.<span class="title function_">log</span>(<span class="string">&#x27;**cy.wait effect**&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>)</span><br><span class="line">  .<span class="title function_">map</span>(<span class="string">&#x27;responseWaited&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [<span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>])</span><br><span class="line">cy.<span class="title function_">wait</span>(<span class="string">&#x27;@networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>)</span><br><span class="line">  .<span class="title function_">map</span>(<span class="string">&#x27;responseWaited&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>])</span><br><span class="line">cy.<span class="title function_">wait</span>(<span class="string">&#x27;@networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>)</span><br><span class="line">  .<span class="title function_">map</span>(<span class="string">&#x27;responseWaited&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>])</span><br></pre></td></tr></table></figure><p><img src="../images/get-all-network-calls/response-waited.png" alt="Waiting for each network call"></p><h2><span id="flexible-assertions">Flexible assertions</span></h2><p>Using <code>cy.get(alias.all)</code> lets you create very flexible assertions. For example, the application might make multiple calls to the backend. We are only interested in specific responses. In the test below, we confirm the application eventually returns comment with <code>id=2</code>. Here is the application code I will be testing</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we fetch all data from this REST json backend</span></span><br><span class="line"><span class="keyword">const</span> root = <span class="string">&#x27;https://jsonplaceholder.cypress.io&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getComment</span>(<span class="params">id = <span class="number">1</span></span>) &#123;</span><br><span class="line">  $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;root&#125;</span>/comments/<span class="subst">$&#123;id&#125;</span>`</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;.network-count-btn&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  e.<span class="title function_">preventDefault</span>()</span><br><span class="line">  <span class="built_in">setTimeout</span>(getComment, <span class="number">1000</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line">  <span class="built_in">setTimeout</span>(getComment.<span class="title function_">bind</span>(<span class="literal">null</span>, <span class="number">2</span>), <span class="number">2000</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line">  <span class="built_in">setTimeout</span>(getComment, <span class="number">3000</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Notice that only one of the calls is fetching the <code>/comments/2</code> resource. To confirm this call happens, we can use <code>cy.get(&#39;alias.all&#39;)</code> and inspect the response objects.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/comments/*&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;3 network calls&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"><span class="comment">// confirm that at least one call returns an object with ID = 2</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>).<span class="title function_">should</span>(<span class="function">(<span class="params">interceptions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> hasId2 = interceptions.<span class="title function_">some</span>(</span><br><span class="line">    <span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="property">response</span>.<span class="property">body</span>.<span class="property">id</span> === <span class="number">2</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="title function_">expect</span>(hasId2, <span class="string">&#x27;response with id 2&#x27;</span>).<span class="property">to</span>.<span class="property">be</span>.<span class="property">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The combination of query <code>cy.get(&#39;alias.all&#39;)</code> plus assertion <code>should(callback)</code> keeps retrying until the application makes the call with response <code>id: 2</code></p><center>  <video autoplay muted loop controls>    <source src="../images/get-all-network-calls/id2.mp4" type="video/mp4">    <img src="../images/get-all-network-calls/id2.png">  </video></center><p>Nice. We can simplify the <code>should(callback)</code> using query commands from my <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> plugin</p><ul><li>map each intercepted call to its <code>response.body.id</code> deep property<ul><li>this yields an array of ids</li></ul></li><li>assert the array includes the value 2</li></ul><p>which looks like this</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/comments/*&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;networkCall&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;3 network calls&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"><span class="comment">// confirm that at least one call returns an object with ID = 2</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@networkCall.all&#x27;</span>)</span><br><span class="line">  .<span class="title function_">map</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">  .<span class="title function_">print</span>() <span class="comment">// helpful query from cypress-map to print the current subject</span></span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;include&#x27;</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><center>  <video autoplay muted loop controls>    <source src="../images/get-all-network-calls/id2-map.mp4" type="video/mp4">    <img src="../images/get-all-network-calls/id2-map.png">  </video></center><p>Notice how the test finishes even before the third call is made - because the assertion <code>include 2</code> passes on the second intercepted call. Beautiful.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This blog post describes a topic really hidden in Cypress documentation: using &lt;code&gt;alias.all&lt;/code&gt; to get all intercepted network call
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Highlight Elements During Testing</title>
    <link href="https://glebbahmutov.com/blog/highlight-element/"/>
    <id>https://glebbahmutov.com/blog/highlight-element/</id>
    <published>2024-07-19T04:00:00.000Z</published>
    <updated>2024-07-19T18:39:41.166Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I saw a <a href="https://www.linkedin.com/feed/update/urn:li:activity:7219318735461867521/">Linkedin post</a> showing how to highlight an element and take the page screenshot using Selenium and Playwright test runners.</p><p><img src="../images/highlight-element/highlight-selenium.png" alt="Selenium test highlighting an element and saving a screenshot"></p><p>Another user commented with a similar test for Playwright</p><p><img src="../images/highlight-element/highlight-playwright.png" alt="Playwright test highlighting an element and saving a screenshot"></p><p>In both cases we highlight an element by modifying its style. We can do the same highlight ourselves on any page by simply opening the DevTools and changing the <code>style</code> object of any element. Here is my setting the border of the input search box on my favorite search engine <a href="https://ecosia.org/">Ecosia</a></p><p><img src="../images/highlight-element/ecosia.png" alt="Giving the input box a red border from DevTools"></p><h2><span id="cypress-test">Cypress test</span></h2><p>Let&#39;s see how we can do the same using Cypress.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;highlights the input element&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;input[aria-label=&quot;Search the web&quot;]&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">$el</span>) =&gt;</span> &#123;</span><br><span class="line">    $el[<span class="number">0</span>].<span class="property">style</span>.<span class="property">border</span> = <span class="string">&#x27;3px solid red&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  cy.<span class="title function_">screenshot</span>(<span class="string">&#x27;input-highlighted&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">overwrite</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">clip</span>: &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">width</span>: <span class="number">1200</span>, <span class="attr">height</span>: <span class="number">1000</span> &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/highlight-element/input-highlighted.png" alt="Saved screenshot"></p><blockquote class="pullquote"><p>üéÅ You can find the code shown in this blog post in the repo <a href="https://github.com/bahmutov/highlight-element-example">bahmutov&#x2F;highlight-element-example</a>.</p></blockquote><p>A couple of notes about this test:</p><ul><li>the base url is set in the <code>cypress.config.js</code> file, so in the test I can simply visit the root using <code>cy.visit(&#39;/&#39;)</code></li><li>Cypress query commands like <a href="https://on.cypress.io/get">cy.get</a> yield a jQuery object once the element is found. For now I simply used the DOM element <code>$el[0].style = ...</code></li><li>I clipped the captured screenshot using <a href="https://on.cypress.io/screenshot">cy.screenshot</a> command because Ecosia homepage is very tall by default and I am only interested in showing the input element.</li></ul><h2><span id="code-runs-in-the-browser">Code runs in the browser</span></h2><p>Cypress is different from <a href="/blog/cypress-vs-other-test-runners/" title="other test runners">other test runners</a>. Selenium and Playwright tests run in Node.js environment, sending the commands to &quot;get an element&quot;, &quot;take a screenshot&quot; to the browser using some protocol. Cypress test runs <em>inside</em> the browser. Thus you don&#39;t need to &quot;inject&quot; JavaScript which sends the stringified code from Node.js. You can even use local variables, register callbacks, etc - all from the test. No argument marshaling or serialization.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// normal Cypress test code, works just as well</span></span><br><span class="line"><span class="keyword">const</span> border = <span class="string">&#x27;3px solid red&#x27;</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;input[aria-label=&quot;Search the web&quot;]&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">$el</span>) =&gt;</span> &#123;</span><br><span class="line">  $el[<span class="number">0</span>].<span class="property">style</span>.<span class="property">border</span> = border</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="jquery">jQuery</span></h2><p>Cypress wraps all found elements in a jQuery object by default. This makes it simple to use one of the jQuery&#39;s many methods to work with DOM elements. For example, we could set multiple CSS properties at once</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> border = <span class="string">&#x27;3px solid red&#x27;</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;input[aria-label=&quot;Search the web&quot;]&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">$el</span>) =&gt;</span> &#123;</span><br><span class="line">  $el.<span class="title function_">css</span>(&#123;</span><br><span class="line">    <span class="attr">background</span>: <span class="string">&#x27;yellow&#x27;</span>,</span><br><span class="line">    border,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/highlight-element/yellow.png" alt="Input element with multiple CSS properties set from the test"></p><h2><span id="fluent-chain">Fluent chain</span></h2><p>In the test above we get the element, which the test yields to the next command.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(...)</span><br><span class="line">  .<span class="title function_">then</span>($el =&gt; &#123;</span><br><span class="line">    $el.<span class="title function_">css</span>(...)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>Inside the <code>cy.then</code> callback the test invokes the method &quot;css&quot; and that&#39;s it. We can invoke a method by name and pass arguments using the built-in Cypress command <a href="https://on.cypress.io/invoke">cy.invoke</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> border = <span class="string">&#x27;3px solid red&#x27;</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;input[aria-label=&quot;Search the web&quot;]&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;css&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">background</span>: <span class="string">&#x27;yellow&#x27;</span>,</span><br><span class="line">  border,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Works exactly the same.</p><p><strong>Cool trick</strong> because Cypress comes with TypeScript types, when I write <code>cy.get(...).invoke(...)</code> my code editor understands the available jQuery methods we can invoke on the current subject.</p><p><img src="../images/highlight-element/intellisense.png" alt="IntelliSense"></p><p>Nice.</p><h2><span id="side-by-side">Side by side</span></h2><p>Which solution do you prefer?</p><p><img src="../images/highlight-element/side-by-side.png" alt="Highlight a DOM element and save the page screenshot using Selenium, Playwright, and Cypress"></p><p>I will open a poll on each social network to see what people think</p><h2><span id="see-also">See also</span></h2><p><strong>Tip:</strong> I have a little plugin <a href="https://github.com/bahmutov/cypress-highlight">cypress-highlight</a> for Cypress users that lets you quickly highlight found elements</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// highlight all elements with test attributes</span></span><br><span class="line"><span class="keyword">import</span> &#123; highlight &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-highlight&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;loads an app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  <span class="title function_">highlight</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// highlight specific selectors only</span></span><br><span class="line"><span class="title function_">highlight</span>(<span class="string">&#x27;[data-test-id]&#x27;</span>, <span class="string">&#x27;.testable&#x27;</span>)</span><br></pre></td></tr></table></figure><p>I don&#39;t have a Selenium course, but you can practice solving the same testing problems using Cypress and Playwright in my course <a href="https://cypress.tips/courses/cypress-vs-playwright">Cypress vs Playwright</a>. I wonder which solution you would prefer in each case.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently I saw a &lt;a href=&quot;https://www.linkedin.com/feed/update/urn:li:activity:7219318735461867521/&quot;&gt;Linkedin post&lt;/a&gt; showing how to hig
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Testing Pseudo-elements Using Cypress</title>
    <link href="https://glebbahmutov.com/blog/testing-pseudo-elements-using-cypress/"/>
    <id>https://glebbahmutov.com/blog/testing-pseudo-elements-using-cypress/</id>
    <published>2024-07-16T04:00:00.000Z</published>
    <updated>2024-07-16T17:31:02.316Z</updated>
    
    <content type="html"><![CDATA[<p>Imagine you have a product store like the one I am using in the course <a href="https://cypress.tips/courses/swag-store">Swag Store</a>. Some of the items are new, so the inventory page marks them with a &quot;NEW&quot; badge</p><p><img src="../images/pseudo-elements/new.png" alt="The NEW badge shown next to one of the items"></p><p>The badge is implemented using a pseudo-element <code>::after</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.inventory_item_name</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Roboto&#x27;</span>, Arial, Helvetica, sans-serif;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#e2231a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.inventory_new_item_badge</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&#x27;NEW&#x27;</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The React component simply sets the <code>inventory_new_item_badge</code> class based on the passed prop <code>badge</code>.</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div</span><br><span class="line">  className=&#123;<span class="string">`inventory_item_name <span class="subst">$&#123;badge ? <span class="string">&#x27;inventory_new_item_badge&#x27;</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>&#125;</span><br><span class="line">&gt;</span><br><span class="line">  &#123;name&#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/pseudo-elements/markup.png" alt="The HTML markup"></p><p>How can we confirm the badge is present and has the expected text <code>NEW</code>? Easy. We can get the style of the HTML element and get its style property</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newItemTitle = <span class="string">&#x27;Sauce Labs Bike Light&#x27;</span></span><br><span class="line"><span class="comment">// confirm this item has the badge &quot;NEW&quot; after it</span></span><br><span class="line"><span class="comment">// Tip: see how pseudo-elements like &quot;::after&quot; can be tested</span></span><br><span class="line"><span class="comment">// https://glebbahmutov.com/cypress-examples</span></span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item_name&#x27;</span>, newItemTitle).<span class="title function_">then</span>(<span class="function">(<span class="params">$el</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> after = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>($el[<span class="number">0</span>], <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> afterContent = after.<span class="title function_">getPropertyValue</span>(<span class="string">&#x27;content&#x27;</span>)</span><br><span class="line">  <span class="title function_">expect</span>(afterContent).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;&quot;NEW&quot;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> I have similar examples under &quot;Recipes&quot; on my site <a href="https://glebbahmutov.com/cypress-examples">https://glebbahmutov.com/cypress-examples</a></p><p><img src="../images/pseudo-elements/part1.png" alt="The solution"></p><p>What if the badge appears after some delay? <code>cy.then(callback)</code> does not retry, so we can make the above code retry-able using <code>cy.should(callback)</code> since it does not execute any Cypress commands:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test the ::after element with retries</span></span><br><span class="line"><span class="keyword">const</span> newItemTitle = <span class="string">&#x27;Sauce Labs Bike Light&#x27;</span></span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item_name&#x27;</span>, newItemTitle).<span class="title function_">should</span>(<span class="function">(<span class="params">$el</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> after = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>($el[<span class="number">0</span>], <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> afterContent = after.<span class="title function_">getPropertyValue</span>(<span class="string">&#x27;content&#x27;</span>)</span><br><span class="line">  <span class="title function_">expect</span>(afterContent).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;&quot;NEW&quot;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We can improve the above by noticing the individual steps:</p><ul><li><code>const after = window.getComputedStyle($el[0], &#39;::after&#39;)</code> is simply calling a function <code>window.getComputedStyle</code> on the current subject&#39;s first element with the argument <code>::after</code>. We can write the same code using a query from <a href="https://github.com/bahmutov/cypress-map">cypress-map</a></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item_name&#x27;</span>, newItemTitle)</span><br><span class="line">  .<span class="title function_">applyToFirstRight</span>(<span class="variable language_">window</span>.<span class="property">getComputedStyle</span>, <span class="string">&#x27;::after&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>The above query yields the pseudo-element. We now have to get the property <code>content</code> like <code>const afterContent = after.getPropertyValue(&#39;content&#39;)</code>. That is a standard <code>cy.invoke</code> command</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item_name&#x27;</span>, newItemTitle)</span><br><span class="line">  .<span class="title function_">applyToFirstRight</span>(<span class="variable language_">window</span>.<span class="property">getComputedStyle</span>, <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  .<span class="title function_">invoke</span>(<span class="string">&#x27;getPropertyValue&#x27;</span>, <span class="string">&#x27;content&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>the final assertion inside the <code>cy.should(callback)</code> is the explicit <code>expect(afterContent).to.equal(&#39;&quot;NEW&quot;&#39;)</code>. If the <code>afterContent</code> is the subject, we can write it using an implicit <code>should(&#39;equal&#39;, value)</code> assertion completing our refactoring</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item_name&#x27;</span>, newItemTitle)</span><br><span class="line">  .<span class="title function_">applyToFirstRight</span>(<span class="variable language_">window</span>.<span class="property">getComputedStyle</span>, <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  .<span class="title function_">invoke</span>(<span class="string">&#x27;getPropertyValue&#x27;</span>, <span class="string">&#x27;content&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;&quot;NEW&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>It works, as the screenshot below shows</p><p><img src="../images/pseudo-elements/part2.png" alt="The refactored solution"></p><h2><span id="a-dot-pseudo-element">A dot pseudo-element</span></h2><p>Sometimes a pseudo-element is used to simply show a graphical element to get the user&#39;s attention. In the next example, a red dot is shown next to the cart icon if the cart has items.</p><p><img src="../images/pseudo-elements/dot.png" alt="The red dot means the cart has items"></p><p>The CSS markup for the pseudo-element has no content, just <code>background-color</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.shopping_cart_link_with_items</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">25px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#e2231a</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">10%</span>;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We can use the background color to verify the dot&#39;s presence and absence. For example, let&#39;s write a test that confirms that:</p><ul><li>there is no dot initially</li><li>a dot appears when the user adds an item to the cart</li><li>a dot disappears when the cart becomes empty again</li></ul><p>We can even make our life harder by adding a delay between the click and the cart update.</p><figure class="highlight ts"><figcaption><span>cypress/e2e/login/badge.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a couple of helper functions for simplicity and readability</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">haveRedDotBadge</span>(<span class="params">$el: JQuery&lt;HTMLElement&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> badge = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>($el[<span class="number">0</span>], <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> backgroundColor = badge.<span class="title function_">getPropertyValue</span>(<span class="string">&#x27;background-color&#x27;</span>)</span><br><span class="line">  <span class="title function_">expect</span>(backgroundColor, <span class="string">&#x27;red dot&#x27;</span>).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;rgb(226, 35, 26)&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">notHaveDotBadge</span>(<span class="params">$el: JQuery&lt;HTMLElement&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> badge = <span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>($el[<span class="number">0</span>], <span class="string">&#x27;::after&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> backgroundColor = badge.<span class="title function_">getPropertyValue</span>(<span class="string">&#x27;background-color&#x27;</span>)</span><br><span class="line">  <span class="title function_">expect</span>(backgroundColor, <span class="string">&#x27;no dot&#x27;</span>).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;rgba(0, 0, 0, 0)&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make the page taller so we can see the entire inventory</span></span><br><span class="line"><span class="comment">// plus the header component with the cart badge</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the &quot;item in the cart&quot; badge&#x27;</span>, &#123; <span class="attr">viewportHeight</span>: <span class="number">1600</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/inventory&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// there is no red dot badge initially</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.shopping_cart_link&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">and</span>(notHaveDotBadge)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> itemName = <span class="string">&#x27;Sauce Labs Bike Light&#x27;</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item&#x27;</span>, itemName)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// verify the cart icon has a red dot badge (after possible delay)</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.shopping_cart_link&#x27;</span>).<span class="title function_">should</span>(haveRedDotBadge)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove the item from the cart by clicking the &quot;Remove&quot; button</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.inventory_item&#x27;</span>, itemName).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Remove&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// and verify the cart icon badge is removed (after possible delay)</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.shopping_cart_link&#x27;</span>).<span class="title function_">should</span>(notHaveDotBadge)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Here is the test in action:</p><center>  <video autoplay muted loop controls>    <source src="../images/pseudo-elements/red-dot-test.mp4" type="video/mp4">    <img src="../images/pseudo-elements/red-dot-test.png">  </video></center><p>Nice!</p><blockquote class="pullquote"><p>üéì This blog post is based on hands-on lessons in my course <a href="https://cypress.tips/courses/swag-store">Testing The Swag Store</a>. Take a look at the lessons <a href="https://cypress.tips/courses/swag-store/lessons/bonus62">Bonus 62: Testing the ::after pseudo-element</a> and <a href="https://cypress.tips/courses/swag-store/lessons/bonus63">Bonus 63: Confirm a dot pseudo-element</a>.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Imagine you have a product store like the one I am using in the course &lt;a href=&quot;https://cypress.tips/courses/swag-store&quot;&gt;Swag Store&lt;/a&gt;. 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>I Stopped Using Twitter</title>
    <link href="https://glebbahmutov.com/blog/i-stopped-using-twitter/"/>
    <id>https://glebbahmutov.com/blog/i-stopped-using-twitter/</id>
    <published>2024-07-01T04:00:00.000Z</published>
    <updated>2024-07-01T19:41:39.290Z</updated>
    
    <content type="html"><![CDATA[<p>Twitter is dead. The platform went noticeably downhill after musk has purchased it. Every time I check it, the responses to any climate or political news is overrun with bots and trolls (with blue checks, of course), killing any reasonable discussion. I don&#39;t want to see and argue with bad-faith (and probably automated) agents, there is no point in wasting time on it.</p><p>Since normal people lower their engagement with Twitter, the owner tries to &quot;juice&quot; it using ... nonsense notifications. For example, most of my badge notifications are ... synthetic &quot;ai&quot; pings that mean nothing.</p><p><img src="../images/stop-twitter/ai-notifications.png" alt="twitter is trying AI notifications that have nothing to do with me"></p><h2><span id="on-blue-checks">On Blue Checks</span></h2><p>In the old pre-musk days of twitter a blue check meant it was a real person who was really the one they claimed to be. They had to provide docs to the twitter team showing that they were indeed &quot;Musician X&quot;, &quot;Author Y&quot;, &quot;Scientist Z&quot;. I had many Twitter interactions with authors, scientists, etc. These interactions made Twitter special and unique. I did not have to like their views or share their opinions, but it was a fair exchange of ideas between people.</p><p>Nowadays blue checks mean ... nothing. Just that the account pays $8 per month to be bumped first on any thread. Thus any popular tweet is surrounded by blue check replies. Since there is no more identity check step, the blue checks are mostly fake accounts. Here is one example about sudden extreme weather in India:</p><p><img src="../images/stop-twitter/tweet.png" alt="Flooding in Delhi tweet"></p><p>The top responses are ... not good. Either fake accounts or trolls. Do they want to stop all discussion of the climate crisis? &quot;Drown&quot; the tweets from prominent climate scientists in nonsense? The new twitter puts blue check responses from paid accounts at the top, and in my opinion less than 10% of blue check responses even look like they are from good faith human accounts.</p><p><img src="../images/stop-twitter/top-responses.png" alt="Top responses to the flooding in Delhi tweet"></p><p>At this point, unless I personally know the account with the blue check badge, I block them. There is no sense to waste time engaging, reading, or replying to blue check accounts. By blocking them, we minimize their engagement and hopefully drive twitter value down to zero. After all, if twitter is dead, the best we can do is bury if sooner before it starts to decompose and smell. Well, maybe it is too late for that.</p><h2><span id="alternatives-to-twitter">Alternatives to Twitter</span></h2><p>All my climate organizations (350 Massachusetts, Cambridge Bike Safety, Citizen Climate Lobby, Sierra Club, Environment Voters Projects) are using mostly email lists and newsletters. Yes, they still post tweets, and most lock the responses; no need to feed the troll engagement.</p><p>I found that Mastodon is much better at clean engagement without trollish reactions. Thus you can find me there plus these social media places:</p><ul><li>Mastodon: <a href="https://fosstodon.org/@bahmutov">@bahmutov@fosstodon.org</a></li><li>Blue Sky: <a href="https://bsky.app/profile/bahmutov.bsky.social">@bahmutov.bsky.social</a></li><li>Threads: <a href="https://www.threads.net/@bahmutov">@bahmutov</a></li><li>LinkedIn: <a href="https://linkedin.com/in/bahmutov">bahmutov</a></li><li>Substack: <a href="https://substack.com/@bahmutov">@bahmutov</a></li><li>YouTube: <a href="https://youtube.com/@gleb">@gleb</a></li></ul><p>I now share all my blog posts and videos on all above networks right away and post the same update on Twitter after 1-2 day delay. So if you want to know about my plugins and writing, follow me on all those networks. And if you need to get in touch with me directly, there are my email and Discord server, see <a href="https://gleb.dev/">gleb.dev</a> for the links.</p><h2><span id="goodbye-twitter">Goodbye, Twitter</span></h2><p>There is nothing irreplaceable about Twitter. As my friends tweet less and less, I don&#39;t see any value in using musk&#39;s personal vanity project. Goodbye, Twitter, it was nice while it lasted.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Twitter is dead. The platform went noticeably downhill after musk has purchased it. Every time I check it, the responses to any climate o
      
    
    </summary>
    
      <category term="people" scheme="https://glebbahmutov.com/blog/categories/people/"/>
    
    
  </entry>
  
  <entry>
    <title>How To Pick Cypress Plugins You Can Trust</title>
    <link href="https://glebbahmutov.com/blog/how-to-pick-cypress-plugins/"/>
    <id>https://glebbahmutov.com/blog/how-to-pick-cypress-plugins/</id>
    <published>2024-06-27T04:00:00.000Z</published>
    <updated>2024-06-27T14:14:12.519Z</updated>
    
    <content type="html"><![CDATA[<p>Recently a Cypress user asked a good question:</p><blockquote><p>One of Cypress&#39;s powerful features is its support of plugins and there are many really powerful ones, but it also raises some concerns about risks of relying on additional dependencies. You&#39;ve got to be confident of a plugins functionality, security and also ensure you&#39;re updating to latest. This makes me a bit un-easy. Curious how others have rationalized or dealt with such concerns.</p></blockquote><p>This is a great question. Do you install a lot of 3rd-party plugins in your Cypress projects? Do you only trust Cypress official plugins? Do you write a lot of custom testing code? There are a lot of <a href="https://docs.cypress.io/plugins">Cypress plugins out there</a>. I personally use a lot of plugins, here is a portion of <code>package.json</code> from my Mercari US E2E repo:</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cypress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13.12.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-cdp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-data-session&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-each&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.11.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-file-upload&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.0.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-get-by-label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.5.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-high-resolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-highlight&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-if&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.12.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-ld-control&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.12.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-log-to-term&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.5.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-mailosaur&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.14.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-map&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.36.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-network-idle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.14.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-on-fix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-real-events&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.12.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-recurse&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.34.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-set-github-status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-slack-notify&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.14.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-testrail-simple&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.2.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cypress-timestamps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.2.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>I often use the excellent <a href="https://github.com/dmtrKovalenko/cypress-real-events">cypress-real-events</a> plugin plus <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> and <a href="https://github.com/bahmutov/cypress-data-session">cypress-data-session</a>. I wrote before about my <a href="https://cypresstips.substack.com/p/my-favorite-cypress-plugins">My favorite Cypress plugins</a> and <a href="https://cypresstips.substack.com/p/my-favorite-cypress-plugins-part">My favorite Cypress plugins, part II</a>. Here is how I think about Cypress core and its plugins.</p><ol><li>Cypress core Test Runner by itself comes with many bells and whistles: assertions, Lodash, Blob, etc. But it is missing <em>lots of things</em> I need. For example, I love <a href="/blog/cypress-v12/" title="reusable chains of query commands">reusable chains of query commands</a>, yet Cypress API is still very limited in this regard. A plugin like <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> is a 100% must in all my projects, since it fills the gaps in the functionality.</li><li>Cypress core Test Runner almost never merges in features from the plugins. The only thing they have &quot;merged&quot; is my <a href="/blog/how-cypress-component-testing-was-born/" title="component testing plugins">component testing plugins</a>. This is a huge problem. Things like <a href="https://github.com/bahmutov/cy-grep">@bahmutov&#x2F;cy-grep</a> and <a href="https://github.com/bahmutov/cypress-await">cypress-await</a> should be part of the core Test Runner, not a plugin. But the Cypress team does not see it this way, I guess.</li><li>If you have a choice between bringing a plugin or writing the support code yourself: <strong>USE THE PLUGIN</strong>. Your development time costs money. What are you doing spending work hours on the things that exist?!</li></ol><p>Which brings us to the follow-up question from the same user:</p><blockquote><p>I still have some un-ease of having lots of dependencies and, even if from very reputable dev like yourself, there&#39;s some risk. I&#39;d give the example of what if you won the lottery, but I suspect you&#39;d still be supporting your plugins then.</p></blockquote><p><strong>Disclaimer:</strong> I don&#39;t know what I would do if I won a lottery. My hunch is that I would be doing open-source work plus soccer coaching ‚öΩÔ∏è Here is the thing about open-source: any of my plugins can be forked and worked on in the future. If you need a specific feature and would like me to develop it, please consider <a href="https://github.com/sponsors/bahmutov">sponsoring my GitHub work</a>.</p><p>Having said this, here is how I would pick the plugins to include in my work projects:</p><ul><li>is this a necessary plugin, or is there an alternative Cypress core command? Cypress <a href="https://on.cypress.io/api">API</a> is large and powerful. Often we don&#39;t need any additional commands to upload a file, for example.</li><li>is the plugin open-source with all its tests and build steps available? I would never use a plugin with just its NPM module published, I need to have a GitHub repo in case I would like to fork the plugin</li><li>is the plugin well-tested? Is there a build &#x2F; test &#x2F; release workflow? Inspect the tests, do they look reasonable for the plugin&#39;s features?</li><li>how many releases does the plugin have? When was the last release? Does it have many open bugs and issues? I would not worry about feature requests though; I often open GitHub issues with ideas for future enhancements, but I might never have time or energy to work on them (yet)</li><li>is the plugin popular? How many GitHub stars and NPM downloads does it have? You can grab this information from <a href="https://npmtrends.com/">https://npmtrends.com/</a> Here are a couple of my plugins</li></ul><p><img src="../images/pick-plugins/chart.png" alt="Plugin NPM modules chart"></p><p>You can also quickly glance the downloads information from the NPM page for each plugin, for example <a href="https://www.npmjs.com/package/cypress-split">https://www.npmjs.com/package/cypress-split</a></p><p><img src="../images/pick-plugins/npm-page.png" alt="cypress-split plugin NPM page"></p><ul><li>is the plugin used by other projects? The more projects use a plugin, the better. A battle-tested plugin is much better than any custom source code you write in your own single project. You can see how many GitHub <em>public</em> projects depend on the plugin, which is only a part of all projects that might use it.</li></ul><p><img src="../images/pick-plugins/dep.png" alt="GitHub dependent region"></p><p>You can click on the &quot;dependent projects&quot; to see them, here is the list from <a href="https://github.com/bahmutov/cypress-split/network/dependents">https://github.com/bahmutov/cypress-split/network/dependents</a></p><p><img src="../images/pick-plugins/list.png" alt="List of projects dependent on cypress-split plugin"></p><p>Finally, if you are using a plugin for your business work and are worried about support and maintenance: sponsor the plugin&#39;s developers! For my plugins, you can either <a href="https://github.com/sponsors/bahmutov">sponsor me using GitHub</a> or buy my <a href="https://cypress.tips/courses">Cypress courses</a> like the extensive <a href="https://cypress.tips/courses/cypress-plugins">Cypress Plugins course</a>, or even invite me to do <a href="https://cypress.tips/workshops">in-person or remote training</a> for your team.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently a Cypress user asked a good question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;One of Cypress&amp;#39;s powerful features is its support of plugins and t
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Pass Cypress Test Info Via Request Headers</title>
    <link href="https://glebbahmutov.com/blog/pass-cypress-info-via-request-headers/"/>
    <id>https://glebbahmutov.com/blog/pass-cypress-info-via-request-headers/</id>
    <published>2024-06-17T04:00:00.000Z</published>
    <updated>2024-06-17T16:27:28.265Z</updated>
    
    <content type="html"><![CDATA[<p>Imagine the application under test is making web calls to the backend. Sometimes things go wrong, and you have set up server-side logging to debug the failures. It would be nice having the test run information attached to each API call the application makes while Cypress is running its tests. In this blog post I will show how to set such information via <code>X-...</code> request headers. We can easily send the following information with each app call:</p><ul><li>the current test title</li><li>parts of the test title, like test case IDs</li><li>test tags from <a href="https://github.com/bahmutov/cy-grep">@bahmutov&#x2F;cy-grep</a> plugin</li><li>CI server and job information</li></ul><p>The server can log the <code>X-...</code> request headers to let you find the relevant information faster.</p><p><img src="../images/x-headers/headers.png" alt="Example X headers received by the server"></p><blockquote class="pullquote"><p>üéÅ You can find the full source code for this blog post in the repo <a href="https://github.com/bahmutov/cypress-api-headers-example">bahmutov&#x2F;cypress-api-headers-example</a>.</p></blockquote><h2><span id="intercept-middleware">Intercept middleware</span></h2><p>We can spy and stub application network calls using the <a href="https://on.cypress.io/request">cy.request</a> command. I even have an entire <a href="https://cypress.tips/courses/network-testing">course of network testing exercises</a>, but how do you spy on <em>every</em> network call? By using the &quot;middleware&quot; option. For example, let&#39;s add the current test title to the outgoing request:</p><figure class="highlight js"><figcaption><span>cypress/support/e2e.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTestTitle = <span class="title class_">Cypress</span>.<span class="property">currentTest</span>.<span class="property">title</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">intercept</span>(&#123; <span class="attr">resourceType</span>: <span class="regexp">/fetch|xhr/</span> &#125;, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Source&#x27;</span>] = <span class="string">&#x27;Cypress&#x27;</span></span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Title&#x27;</span>] = currentTestTitle</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The server should see the two lowercase <code>X-...</code> headers on every Ajax call sent by the application. The Command Log shows the modified outgoing request:</p><p><img src="../images/x-headers/request.png" alt="The Cypress Command Log shows the request"></p><h2><span id="testrail-case-id">TestRail case ID</span></h2><p>If you are using TestRail to manage your test cases, you might be using my plugin <a href="https://github.com/bahmutov/cypress-testrail-simple">cypress-testrail-simple</a>. I like putting the test case ID into the test title:</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;C123456 serves the homepage&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/home.html&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;Homepage&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click me&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We can parse the test case and send it in a separate request header:</p><figure class="highlight js"><figcaption><span>cypress/support/e2e.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTestTitle = <span class="title class_">Cypress</span>.<span class="property">currentTest</span>.<span class="property">title</span></span><br><span class="line">  <span class="comment">// there might be TestRail case id in the title</span></span><br><span class="line">  <span class="comment">// try extracting it separately</span></span><br><span class="line">  <span class="keyword">const</span> testRailId =</span><br><span class="line">    currentTestTitle.<span class="title function_">match</span>(<span class="regexp">/(?&lt;caseId&gt;C\d+)/</span>)?.<span class="property">groups</span>?.<span class="property">caseId</span></span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">intercept</span>(&#123; <span class="attr">resourceType</span>: <span class="regexp">/fetch|xhr/</span> &#125;, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Source&#x27;</span>] = <span class="string">&#x27;Cypress&#x27;</span></span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Title&#x27;</span>] = currentTestTitle</span><br><span class="line">    <span class="keyword">if</span> (testRailId) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Rail-Id&#x27;</span>] = testRailId</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="effective-test-tags">Effective Test Tags</span></h2><p>If you are using my plugin <a href="https://github.com/bahmutov/cy-grep">@bahmutov&#x2F;cy-grep</a> to filter the tests to run the <a href="/blog/tag-tests/" title="How To Tag And Run End-to-End Tests">How To Tag And Run End-to-End Tests</a>, you can send the effective test tags in the request headers. Here is an example spec showing several levels of test tags:</p><figure class="highlight js"><figcaption><span>cypress/e2e/test-tags.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;API&#x27;</span>, &#123; <span class="attr">tags</span>: <span class="string">&#x27;@static&#x27;</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;Visible button&#x27;</span>, &#123; <span class="attr">tags</span>: <span class="string">&#x27;@sanity&#x27;</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/home.html&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click me&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test &quot;Visible button&quot; has 2 <em>effective</em> test tags: <code>@sanity</code> comes from the test itself. The test tag <code>@static</code> comes from its parent suite &quot;API&quot;. The support E2E file can grab the effective test tags</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> registerCypressGrep <span class="keyword">from</span> <span class="string">&#x27;@bahmutov/cy-grep/src/support&#x27;</span></span><br><span class="line"><span class="title function_">registerCypressGrep</span>()</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTestTitle = <span class="title class_">Cypress</span>.<span class="property">currentTest</span>.<span class="property">title</span></span><br><span class="line">  <span class="comment">// there might be TestRail case id in the title</span></span><br><span class="line">  <span class="comment">// try extracting it separately</span></span><br><span class="line">  <span class="keyword">const</span> testRailId =</span><br><span class="line">    currentTestTitle.<span class="title function_">match</span>(<span class="regexp">/(?&lt;caseId&gt;C\d+)/</span>)?.<span class="property">groups</span>?.<span class="property">caseId</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// the effective test tags are set by the plugin</span></span><br><span class="line">  <span class="comment">// @bahmutov/cy-grep</span></span><br><span class="line">  <span class="keyword">const</span> testTags = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;testTags&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">intercept</span>(&#123; <span class="attr">resourceType</span>: <span class="regexp">/fetch|xhr/</span> &#125;, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Source&#x27;</span>] = <span class="string">&#x27;Cypress&#x27;</span></span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Title&#x27;</span>] = currentTestTitle</span><br><span class="line">    <span class="keyword">if</span> (testRailId) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Rail-Id&#x27;</span>] = testRailId</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (testTags &amp;&amp; testTags.<span class="property">length</span>) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Tags&#x27;</span>] = testTags.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="ci-information">CI information</span></h2><p>I like running my E2E tests using <a href="/blog/trying-github-actions/" title="GitHub Actions">GitHub Actions</a>. Let&#39;s pass CI runtime information too. For simplicity, I will pass the CI runner numbers via <code>CYPRESS_</code> environment variables.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">tests:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">GitHub</span> <span class="string">CI</span> <span class="string">variables</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npx</span> <span class="string">@bahmutov/print-env</span> <span class="string">GITHUB</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">start:</span> <span class="string">npm</span> <span class="string">start</span></span><br><span class="line">        <span class="comment"># pass CI run information via Cypress_ variables</span></span><br><span class="line">        <span class="comment"># to make it readily available in Cypress specs and support files</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">CYPRESS_runId:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.run_id</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">CYPRESS_runNumber:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">CYPRESS_runAttempt:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.run_attempt</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">CYPRESS_jobName:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.job</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>The support file can grab each CI variable using the <code>Cypress.env</code> command</p><figure class="highlight js"><figcaption><span>cypress/support/e2e.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> registerCypressGrep <span class="keyword">from</span> <span class="string">&#x27;@bahmutov/cy-grep/src/support&#x27;</span></span><br><span class="line"><span class="title function_">registerCypressGrep</span>()</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentTestTitle = <span class="title class_">Cypress</span>.<span class="property">currentTest</span>.<span class="property">title</span></span><br><span class="line">  <span class="comment">// there might be TestRail case id in the title</span></span><br><span class="line">  <span class="comment">// try extracting it separately</span></span><br><span class="line">  <span class="keyword">const</span> testRailId =</span><br><span class="line">    currentTestTitle.<span class="title function_">match</span>(<span class="regexp">/(?&lt;caseId&gt;C\d+)/</span>)?.<span class="property">groups</span>?.<span class="property">caseId</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// the effective test tags are set by the plugin</span></span><br><span class="line">  <span class="comment">// @bahmutov/cy-grep</span></span><br><span class="line">  <span class="keyword">const</span> testTags = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;testTags&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">intercept</span>(&#123; <span class="attr">resourceType</span>: <span class="regexp">/fetch|xhr/</span> &#125;, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Source&#x27;</span>] = <span class="string">&#x27;Cypress&#x27;</span></span><br><span class="line">    req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Title&#x27;</span>] = currentTestTitle</span><br><span class="line">    <span class="keyword">if</span> (testRailId) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Rail-Id&#x27;</span>] = testRailId</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runId&#x27;</span>)) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Run-Id&#x27;</span>] = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runId&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runNumber&#x27;</span>)) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Run-Number&#x27;</span>] = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runNumber&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runAttempt&#x27;</span>)) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Run-Attempt&#x27;</span>] = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;runAttempt&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;jobName&#x27;</span>)) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Job-Name&#x27;</span>] = <span class="title class_">Cypress</span>.<span class="title function_">env</span>(<span class="string">&#x27;jobName&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (testTags &amp;&amp; testTags.<span class="property">length</span>) &#123;</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&#x27;X-Test-Tags&#x27;</span>] = testTags.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Here is what the server sees on a typical test run:</p><p><img src="../images/x-headers/test1.png" alt="Custom X- headers for a test with TestRail test case id"></p><p><img src="../images/x-headers/test2.png" alt="Custom X- headers for a test with test tags"></p><p>Nice.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Imagine the application under test is making web calls to the backend. Sometimes things go wrong, and you have set up server-side logging
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Alias Documentation Trick</title>
    <link href="https://glebbahmutov.com/blog/cypress-alias-documentation/"/>
    <id>https://glebbahmutov.com/blog/cypress-alias-documentation/</id>
    <published>2024-04-16T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.503Z</updated>
    
    <content type="html"><![CDATA[<p>Recently a Cypress asked in my <a href="https://glebbahmutov.com/">Discord channel</a> the following question:</p><blockquote><p>I have a question, is the below a good practice? I have a &#39;Test&#39; class (in another file, of course), in it there is a method that takes text from an element. Is assigning an alias in the class and then using that alias in the test a correct approach? Because it&#39;s a bit unclear in the test, especially when the project grows, where a given alias comes from.</p></blockquote><p><img src="../images/cypress-alias-documentation/alias1.png" alt="The original test code with an alias"></p><p>How does the test &quot;know&quot; if a page object method sets <a href="https://on.cypress.io/as">a Cypress alias</a>? Let me describe how I would write the same test.</p><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post in the repo <a href="https://github.com/bahmutov/cypress-alias-example">bahmutov&#x2F;cypress-alias-example</a>.</p></blockquote><h2><span id="the-original-code">The original code</span></h2><p>I will start with placing the <code>Test</code> class in the Cypress E2E support file.</p><figure class="highlight js"><figcaption><span>cypress/e2e/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="title function_">getText</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;buttonText&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> test = <span class="keyword">new</span> <span class="title class_">Test</span>()</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the right text&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;public/index.html&#x27;</span>)</span><br><span class="line">  test.<span class="title function_">getText</span>() <span class="comment">// it provides the alias &#x27;@buttonText&#x27;</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@buttonText&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">text</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(text))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes, even if it unclear from the screenshot <em>what</em> it is checking.</p><p><img src="../images/cypress-alias-documentation/t1.png" alt="The passing test"></p><p><strong>Tip:</strong> if all you do inside a <code>cy.then(callback)</code> is calling another function, you can use <a href="http://en.wikipedia.org/wiki/Tacit_programming">point-free or tacit programming</a> style to write less code.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test.<span class="title function_">getText</span>() <span class="comment">// it provides the alias &#x27;@buttonText&#x27;</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@buttonText&#x27;</span>).<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br></pre></td></tr></table></figure><p>Printing values to the console does not show you the value. Thus I prefer using simple assertions to log the value in the Cypress Log</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test.<span class="title function_">getText</span>() <span class="comment">// it provides the alias &#x27;@buttonText&#x27;</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;@buttonText&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="../images/cypress-alias-documentation/t2.png" alt="Use an assertion to log the subject text"></p><p>Nice.</p><h2><span id="change-the-page-object">Change the page object</span></h2><p>I don&#39;t object to Page Objects in general, but I do think they should be much simpler than most people try to make them. For instance (pun intended), the page objects should never be objects with its own internal state. Thus let&#39;s refactor <code>Test</code> to be a simple static object, no need to even use <code>new Test</code> to call a static method <code>getText</code></p><figure class="highlight js"><figcaption><span>cypress/e2e/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="title function_">getText</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;buttonText&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the right text&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;public/index.html&#x27;</span>)</span><br><span class="line">  <span class="title class_">Test</span>.<span class="title function_">getText</span>() <span class="comment">// it provides the alias &#x27;@buttonText&#x27;</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@buttonText&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Works exactly the same. The <code>Test</code> object is a collection of static methods, even if it creates a global alias side effect <code>@buttonText</code>.</p><h2><span id="change-the-comment-placement">Change the comment placement</span></h2><p>In the original code, the user placed the comment <em>at the call site</em> in the spec file</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cypress/e2e/spec.cy.js</span></span><br><span class="line"><span class="title class_">Test</span>.<span class="title function_">getText</span>() <span class="comment">// it provides the alias &#x27;@buttonText&#x27;</span></span><br></pre></td></tr></table></figure><p>A better place for this comment would be in the page object itself using a JSDoc method documentation.</p><figure class="highlight js"><figcaption><span>cypress/e2e/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * it provides the alias `<span class="doctag">@buttonText</span>`</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getText</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;buttonText&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Any test code calling <code>Test.getText</code> method can see the documentation snippet.</p><p><img src="../images/cypress-alias-documentation/hover.png" alt="JSDoc snippet shown in my VSCode"></p><h2><span id="do-not-hard-code-the-alias">Do not hard-code the alias</span></h2><p>Great. But we still hard-code the alias <code>buttonText</code>. If we call the same <code>getText</code> method twice, we will overwrite the previous subject. We can make it better by passing the alias name as an argument.</p><figure class="highlight js"><figcaption><span>cypress/e2e/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * it provides the alias `<span class="doctag">@buttonText</span>`.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; aliasName Default is `buttonText`</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getText</span>(<span class="params">aliasName = <span class="string">&#x27;buttonText&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(aliasName)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the right text&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;public/index.html&#x27;</span>)</span><br><span class="line">  <span class="title class_">Test</span>.<span class="title function_">getText</span>(<span class="string">&#x27;myText&#x27;</span>)</span><br><span class="line">  <span class="comment">// some time later</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@myText&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The IntelliSense snippet shows the alias parameter.</p><p><img src="../images/cypress-alias-documentation/hover2.png" alt="JSDoc with param"></p><p><strong>Tip:</strong> you can make your JSDoc snippets better by adding a few examples:</p><figure class="highlight js"><figcaption><span>cypress/e2e/test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * it provides the alias `<span class="doctag">@buttonText</span>`.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; aliasName Default is `buttonText`</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText(&#x27;myText&#x27;)</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@myText</span>&#x27;).should(&#x27;be.a&#x27;, &#x27;string&#x27;)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText()</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@buttonText</span>&#x27;).should(&#x27;equal&#x27;, &#x27;Click me&#x27;)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getText</span>(<span class="params">aliasName = <span class="string">&#x27;buttonText&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(aliasName)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="../images/cypress-alias-documentation/examples.png" alt="JSDoc with examples"></p><p>I use <em>a lot</em> of JSDoc examples in my tests and utility functions.</p><h2><span id="write-page-objects-using-typescript">Write Page Objects using TypeScript</span></h2><p>Even when coding my specs using JavaScript, I like using TypeScript for utilities. So I add TypeScript dev dependency and a <code>tsconfig.json</code> file</p><figure class="highlight json"><figcaption><span>tsconfig.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;cypress/e2e/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;cypress/e2e/**/*.js&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;allowJs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;noEmit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;cypress&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;es2015&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dom&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>The <code>test.js</code> file becomes <code>test.ts</code> with slightly simpler JSDoc comment</p><figure class="highlight ts"><figcaption><span>cypress/e2e/test.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * it provides the alias `<span class="doctag">@buttonText</span>`.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> aliasName Default is `buttonText`</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText(&#x27;myText&#x27;)</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@myText</span>&#x27;).should(&#x27;be.a&#x27;, &#x27;string&#x27;)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText()</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@buttonText</span>&#x27;).should(&#x27;equal&#x27;, &#x27;Click me&#x27;)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getText</span>(<span class="params">aliasName = <span class="string">&#x27;buttonText&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(aliasName)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The JavaScript spec can be checked using the <code>// @ts-check</code> comment</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ts-check</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the right text&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;public/index.html&#x27;</span>)</span><br><span class="line">  <span class="title class_">Test</span>.<span class="title function_">getText</span>(<span class="string">&#x27;myText&#x27;</span>)</span><br><span class="line">  <span class="comment">// some time later</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@myText&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(s).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">a</span>(<span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I changed the assertion <code>.should(&#39;be.a&#39;, &#39;string&#39;)</code> to a callback to show a problem: <code>cy.get</code> assumes it yields a jQuery object</p><p><img src="../images/cypress-alias-documentation/yields.png" alt="The cy.get command yields a jQuery element by default"></p><p>We can fix this either by switching the spec to TypeScript and writing <code>cy.get&lt;string&gt;(&#39;@myText&#39;)</code> or by adding a page object method to the <code>Test</code> object.</p><figure class="highlight ts"><figcaption><span>cypress/e2e/test.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Test</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * it provides the alias `<span class="doctag">@buttonText</span>`.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> aliasName Default is `buttonText`</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText(&#x27;myText&#x27;)</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@myText</span>&#x27;).should(&#x27;be.a&#x27;, &#x27;string&#x27;)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  Test.getText()</span></span><br><span class="line"><span class="comment">   *  cy.get(&#x27;<span class="doctag">@buttonText</span>&#x27;).should(&#x27;equal&#x27;, &#x27;Click me&#x27;)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getText</span>(<span class="params">aliasName = <span class="string">&#x27;buttonText&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>).<span class="title function_">as</span>(aliasName)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Yields the previously set Cypress alias</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> aliasName Alias without `@` prefix</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   *  cy.getText(&#x27;myText&#x27;)</span></span><br><span class="line"><span class="comment">   *  // some time later</span></span><br><span class="line"><span class="comment">   *  cy.getAlias(&#x27;myText&#x27;).should(&#x27;equal&#x27;, &#x27;Click me&#x27;)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getAlias</span>(<span class="params">aliasName = <span class="string">&#x27;buttonText&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cy.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;@&#x27;</span> + aliasName)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s use the <code>Test.getAlias</code> from the test JS spec</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ts-check</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the right text&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;public/index.html&#x27;</span>)</span><br><span class="line">  <span class="title class_">Test</span>.<span class="title function_">getText</span>(<span class="string">&#x27;myText&#x27;</span>)</span><br><span class="line">  <span class="comment">// some time later</span></span><br><span class="line">  <span class="title class_">Test</span>.<span class="title function_">getAlias</span>(<span class="string">&#x27;myText&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(s).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">a</span>(<span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>IntelliSense popup shows the correct subject for <code>Test.getAlias</code></p><p><img src="../images/cypress-alias-documentation/string-subject.png" alt="The page objet method yields a string subject"></p><p>TypeScript &quot;knows&quot; the <code>s</code> argument is a string.</p><p><img src="../images/cypress-alias-documentation/string.png" alt="Accessing the aliased value through the page object gives us the right type"></p><p>Nice.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently a Cypress asked in my &lt;a href=&quot;https://glebbahmutov.com/&quot;&gt;Discord channel&lt;/a&gt; the following question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I have
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Flaky IFrame Online Store Test</title>
    <link href="https://glebbahmutov.com/blog/flaky-iframe-test/"/>
    <id>https://glebbahmutov.com/blog/flaky-iframe-test/</id>
    <published>2024-04-01T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.528Z</updated>
    
    <content type="html"><![CDATA[<p>Recently, I was asked to write a solid test for an online demo e-commerce shop <a href="https://demo.prestashop.com/">https://demo.prestashop.com</a>. The site loads a temporary demo shop. We want to write a Cypress test that picks an item and adds it to the cart and goes to the checkout.</p><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/shop1.mp4" type="video/mp4">    <img src="../images/iframe-shop/shop1.png">  </video></center><p>Let&#39;s start. First, visit the page.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>You see the loader element at the start. It is outside the iframe itself, let&#39;s wait for it to disappear.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#loadingMessage&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">15_000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It might take a while to spin up a new shop instance, thus I set the maximum timeout of 15 seconds.</p><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/loader.mp4" type="video/mp4">    <img src="../images/iframe-shop/loader.png">  </video></center><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post in the repo <a href="https://github.com/bahmutov/test-presta-shop">bahmutov&#x2F;test-presta-shop</a>.</p></blockquote><h2><span id="access-the-iframe-contents">Access the iframe contents</span></h2><p>Let&#39;s select Men&#39;s clothes. We can directly access the iframe contents, since it comes from the same domain as the top level window.</p><p><img src="../images/iframe-shop/shop2.png" alt="The iframe source comes from the same top-level domain"></p><p>Let&#39;s get the iframe&#39;s document and find the link to the clothes.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#loadingMessage&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">15_000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.header-top&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    <span class="comment">// we know the iframe body is there</span></span><br><span class="line">    <span class="comment">// but we need a jQuery object to be able to use cy.contains</span></span><br><span class="line">    <span class="comment">// otherwise we see &quot;subject.each&quot; is not a function error</span></span><br><span class="line">    .<span class="title function_">then</span>(cy.<span class="property">wrap</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;.category-sub-menu a&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Every time we click on the link or button, we check that the page has finished updating.</p><ul><li>click on the &quot;Clothes&quot; link<ul><li>confirm the page shows the breadcrumb &quot;Clothes&quot;</li></ul></li><li>click on the &quot;Men&quot; link<ul><li>confirm the page shows the breadcrumb &quot;Men&quot;</li></ul></li></ul><p><strong>Note:</strong> I copy&#x2F;paste the code to access the iframe&#39;s contents, we can clean it up later.</p><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/men.mp4" type="video/mp4">    <img src="../images/iframe-shop/men.png">  </video></center><h2><span id="add-item-to-the-cart">Add item to the cart</span></h2><p>We see at least one item of clothing. Let&#39;s click on it and add it to the cart. We expect to see the following:</p><p><img src="../images/iframe-shop/click-on-item.png" alt="The item view where we want to click on the Add To Cart button"></p><p>After clicking on the &quot;Add to Cart&quot; button we should see the cart modal fade in.</p><p><img src="../images/iframe-shop/added-to-cart.png" alt="The item was added to cart"></p><p>Let&#39;s write these commands in our test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// click on the first product item</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;.products .product&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.length.greaterThan&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">  .<span class="title function_">first</span>()</span><br><span class="line">  .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// click on the &quot;Add to cart&quot; button</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;#main .product-container&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.product-add-to-cart&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// the cart view appears</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;#blockcart-modal&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br></pre></td></tr></table></figure><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/cart-is-empty.mp4" type="video/mp4">    <img src="../images/iframe-shop/cart-is-empty.png">  </video></center><p>Hmm, the test clicked on the &quot;Add to Cart&quot; button, it the cart is empty and the test fails. What is happening? It works if we add a <code>cy.wait</code> before clicking on the &quot;Add to Cart&quot; button:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// click on the &quot;Add to cart&quot; button</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;#main .product-container&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  <span class="comment">// ANTI-PATTERN: add a hard-coded wait</span></span><br><span class="line">  .<span class="title function_">wait</span>(<span class="number">200</span>)</span><br><span class="line">  .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.product-add-to-cart&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>I would like to avoid hard-coded waits. Let&#39;s open DevTools to understand why the item does not &quot;register&quot; the click from the test.</p><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/js.mp4" type="video/mp4">    <img src="../images/iframe-shop/js.png">  </video></center><p>Do you see the waterfall of small JavaScript scripts the page is downloading when we go to the Item view? It takes time to load all of them, one of them registers the &quot;click&quot; event listener on the &quot;Add to Cart&quot; button. The test clicks <em>too fast</em>, the event listener hasn&#39;t been downloaded or registered yet, so it does nothing. We need to wait for the JS resources to finish before clicking.</p><p>A good way to do this is by using my plugin <a href="https://github.com/bahmutov/cypress-network-idle">cypress-network-idle</a>. Let&#39;s wait for all JS resources before clicking.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-network-idle</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-network-idle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">waitForNetworkIdlePrepare</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">pattern</span>: <span class="string">&#x27;*.js&#x27;</span>,</span><br><span class="line">    <span class="attr">alias</span>: <span class="string">&#x27;js&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the first product item</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.products .product&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.length.greaterThan&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_">first</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the &quot;Add to cart&quot; button</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;#main .product-container&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">waitForNetworkIdle</span>(<span class="string">&#x27;@js&#x27;</span>, <span class="number">40</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;.product-add-to-cart&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We start spying on <code>*.js</code> network calls before the item component appears. Once it appears we wait for JS resources to stop for at least 40ms.</p><center>  <video autoplay muted loop controls>    <source src="../images/iframe-shop/js-idle.mp4" type="video/mp4">    <img src="../images/iframe-shop/js-idle.png">  </video></center><p>We don&#39;t know which particular JS script reacts to the button click. If we knew, we could have targeted it better. But for now, we wait for all of them:</p><p><img src="../images/iframe-shop/idle-time.png" alt="The cypress-network-idle plugin in action"></p><h2><span id="burn-it">Burn it</span></h2><p>Good. Now we can finish the test and run it multiple times in a row to confirm that it is solid. Following <a href="/blog/cypress-flaky-tests-exercises/" title="Cypress Flaky Tests Exercises">Cypress Flaky Tests Exercises</a></p><figure class="highlight js"><figcaption><span>cypress/e2e/burn.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-network-idle</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-network-idle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">times</span>(<span class="number">10</span>, <span class="function">(<span class="params">k</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">`goes to the checkout with one item <span class="subst">$&#123;k + <span class="number">1</span>&#125;</span> / 10`</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;#loadingMessage&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">15_000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">find</span>(<span class="string">&#x27;#checkout-personal-information-step&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/iframe-shop/burn.png" alt="The same test ran 10 times in a row"></p><p>Seems solid.</p><h2><span id="simplify-the-code">Simplify the code</span></h2><p>Our testing code is very verbose when accessing the iframe. We have two query chains essentially to access the elements inside the iframe:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BODY -&gt; cy.find</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;.header-top&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">  .<span class="title function_">click</span>()</span><br><span class="line"><span class="comment">// BODY -&gt; cy.then(cy.wrap).contains</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  <span class="comment">// we know the iframe body is there</span></span><br><span class="line">  <span class="comment">// but we need a jQuery object to be able to use cy.contains</span></span><br><span class="line">  <span class="comment">// otherwise we see &quot;subject.each&quot; is not a function error</span></span><br><span class="line">  .<span class="title function_">then</span>(cy.<span class="property">wrap</span>)</span><br><span class="line">  .<span class="title function_">contains</span>(<span class="string">&#x27;.category-sub-menu a&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line">  .<span class="title function_">click</span>()</span><br></pre></td></tr></table></figure><p><strong>Note:</strong> Cypress throws an error if we directly attach <code>cy.contains</code> to the <code>BODY</code> element like this: <code>.its(&#39;0.contentDocument.body&#39;).contains</code>. Thus we have to use <code>cy.then(cy.wrap)</code> which breaks the retries. Luckily we can first confirm the element is there using <code>cy.find</code> and then look at the text.</p><p>Let&#39;s add utility function:</p><figure class="highlight js"><figcaption><span>cypress/e2e/simple.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-network-idle</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-network-idle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getIframeBody</span> = (<span class="params">wrap = <span class="literal">false</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (wrap) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      cy</span><br><span class="line">        .<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">        <span class="comment">// we know the iframe body is there</span></span><br><span class="line">        <span class="comment">// but we need a jQuery object to be able to use cy.contains</span></span><br><span class="line">        <span class="comment">// otherwise we see &quot;subject.each&quot; is not a function error</span></span><br><span class="line">        .<span class="title function_">then</span>(cy.<span class="property">wrap</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cy</span><br><span class="line">      .<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#loadingMessage&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">15_000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.header-top&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">  <span class="title function_">getIframeBody</span>().<span class="title function_">find</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">  <span class="title function_">getIframeBody</span>(<span class="literal">true</span>).<span class="title function_">contains</span>(<span class="string">&#x27;.category-sub-menu a&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  <span class="title function_">getIframeBody</span>().<span class="title function_">find</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">waitForNetworkIdlePrepare</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">pattern</span>: <span class="string">&#x27;*.js&#x27;</span>,</span><br><span class="line">    <span class="attr">alias</span>: <span class="string">&#x27;js&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the first product item</span></span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.products .product&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.length.greaterThan&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_">first</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the &quot;Add to cart&quot; button</span></span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;#main .product-container&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">waitForNetworkIdle</span>(<span class="string">&#x27;@js&#x27;</span>, <span class="number">40</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;.product-add-to-cart&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;#blockcart-modal&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Proceed to checkout&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;.cart-grid&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Proceed to checkout&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getIframeBody</span>()</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;#checkout-personal-information-step&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Nice, but we always have the same syntax <code>getIframeBody().find(selector)</code> and <code>getIframeBody(true).contains(selector, text)</code>. Let&#39;s simplify it.</p><figure class="highlight js"><figcaption><span>cypress/e2e/simple2.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-network-idle</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-network-idle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">iframeBody</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;iframe[title=&quot;Frame of demo shop&quot;]&#x27;</span>).<span class="title function_">its</span>(<span class="string">&#x27;0.contentDocument.body&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">iframeFind</span> = (<span class="params">selector</span>) =&gt; <span class="title function_">iframeBody</span>().<span class="title function_">find</span>(selector)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">iframeContains</span> = (<span class="params">selector, text</span>) =&gt;</span><br><span class="line">  <span class="title function_">iframeBody</span>()</span><br><span class="line">    <span class="comment">// we know the iframe body is there</span></span><br><span class="line">    <span class="comment">// but we need a jQuery object to be able to use cy.contains</span></span><br><span class="line">    <span class="comment">// otherwise we see &quot;subject.each&quot; is not a function error</span></span><br><span class="line">    .<span class="title function_">then</span>(cy.<span class="property">wrap</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(selector, text)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;goes to the checkout with one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#loadingMessage&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">15_000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;.header-top&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Clothes&#x27;</span>)</span><br><span class="line">  <span class="title function_">iframeContains</span>(<span class="string">&#x27;.category-sub-menu a&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;.breadcrumb&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;include.text&#x27;</span>, <span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">waitForNetworkIdlePrepare</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">pattern</span>: <span class="string">&#x27;*.js&#x27;</span>,</span><br><span class="line">    <span class="attr">alias</span>: <span class="string">&#x27;js&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the first product item</span></span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;.products .product&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.length.greaterThan&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_">first</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// click on the &quot;Add to cart&quot; button</span></span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;#main .product-container&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">waitForNetworkIdle</span>(<span class="string">&#x27;@js&#x27;</span>, <span class="number">40</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;.product-add-to-cart&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;#blockcart-modal&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Proceed to checkout&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;.cart-grid&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Proceed to checkout&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">iframeFind</span>(<span class="string">&#x27;#checkout-personal-information-step&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>If you want, you can add the <code>iframeFind</code> and <code>iframeContains</code> as custom commands.</p><h2><span id="see-also">See also</span></h2><ul><li><a href="/blog/cypress-flaky-tests-exercises/" title="Cypress Flaky Tests Exercises">Cypress Flaky Tests Exercises</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently, I was asked to write a solid test for an online demo e-commerce shop &lt;a href=&quot;https://demo.prestashop.com/&quot;&gt;https://demo.presta
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Tests For Apps That Use Central State</title>
    <link href="https://glebbahmutov.com/blog/test-apps-that-use-central-state/"/>
    <id>https://glebbahmutov.com/blog/test-apps-that-use-central-state/</id>
    <published>2024-03-28T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.598Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s say you are testing an app that <a href="https://gomakethings.com/an-intro-to-state-based-ui-with-javascript/">derives its UI from its state object</a>. All data is stored in an object that serialized in our example to&#x2F;from <code>localStorage</code>.</p><figure class="highlight js"><figcaption><span>public/state.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// application data. Increment the suffix counter</span></span><br><span class="line"><span class="comment">// if the schema changes to get fresh state</span></span><br><span class="line"><span class="comment">// or implement data migration logic</span></span><br><span class="line"><span class="keyword">const</span> storeKey = <span class="string">&#x27;todos-state-based-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> defaultState = &#123;</span><br><span class="line">    <span class="attr">todos</span>: [],</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(storeKey)) || defaultState</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">saveState</span>(<span class="params">state</span>) &#123;</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(storeKey, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>public/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getState, saveState &#125; <span class="keyword">from</span> <span class="string">&#x27;./state.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DOM elements</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> form = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#add-todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">getState</span>()</span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create the HTML based on the app state</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getHTML</span>(<span class="params">state</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add todos when form is submitted</span></span><br><span class="line">form.<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, addTodo)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove todos when delete button is clicked</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, removeTodo)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Render the UI</span></span><br><span class="line">app.<span class="property">innerHTML</span> = <span class="title function_">getHTML</span>(state)</span><br></pre></td></tr></table></figure><p>The app is very simple: add and delete Todos</p><p><img src="../images/state/app.png" alt="The application"></p><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post in the repo <a href="https://github.com/bahmutov/state-ui-example">bahmutov&#x2F;state-ui-example</a>.</p></blockquote><p>How can we test this application more efficiently?</p><h2><span id="ui-e2e-tests">UI E2E tests</span></h2><p>We can add Cypress and write end-to-end tests for the main features.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The second test &quot;removes todo&quot; repeats the first one. Let&#39;s simplify it. The application renders its page based on what it reads from the <code>localStorage</code>. Let&#39;s take the second test and <em>start</em> it from a state with 3 todo items.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec2.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;todos-state-based-1&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; todos &#125;))</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The two first lines are crucial</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;todos-state-based-1&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; todos &#125;))</span><br></pre></td></tr></table></figure><p>The test looks exactly like before, only it is <em>much</em> faster: 914ms for the original test vs 224ms for setting the state. Even in our simple app, going directly to the application without using the page UI pays off.</p><center>  <video autoplay muted loop controls>    <source src="../images/state/spec2.mp4" type="video/mp4">    <img src="../images/state/spec2.png">  </video></center><h2><span id="import-application-code-from-the-spec">Import application code from the spec</span></h2><p>Very nice. But we don&#39;t want to hard-code the <code>localStorage.setItem(&#39;todos-state-based-1&#39;, JSON.stringify(&#123; todos &#125;))</code> logic. Let&#39;s simply use the application&#39;s own source code.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec3.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; saveState &#125; <span class="keyword">from</span> <span class="string">&#x27;../../public/state&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line">    <span class="title function_">saveState</span>(&#123; todos &#125;)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Works. What if we don&#39;t have access to the source files? We can use the application code via <code>window</code> objects, what I call &quot;app actions&quot;. Modify the application source code to set the functions you want to call from the test code first:</p><figure class="highlight js"><figcaption><span>public/state.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// application data. Increment the suffix counter</span></span><br><span class="line"><span class="comment">// if the schema changes to get fresh state</span></span><br><span class="line"><span class="comment">// or implement data migration logic</span></span><br><span class="line"><span class="keyword">const</span> storeKey = <span class="string">&#x27;todos-state-based-1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> defaultState = &#123;</span><br><span class="line">    <span class="attr">todos</span>: [],</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(storeKey)) || defaultState</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">saveState</span>(<span class="params">state</span>) &#123;</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(storeKey, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Cypress</span>) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">getState</span> = getState</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">saveState</span> = saveState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now use the <code>window.saveState</code> from the test. The only problem: the application immediately calls <code>getState</code> on load:</p><figure class="highlight js"><figcaption><span>public/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getState, saveState &#125; <span class="keyword">from</span> <span class="string">&#x27;./state.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DOM elements</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> form = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#add-todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">getState</span>()</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>So our test needs to be fast.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec4.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>, &#123;</span><br><span class="line">      <span class="title function_">onBeforeLoad</span>(<span class="params">win</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> saveState</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(win, <span class="string">&#x27;saveState&#x27;</span>, &#123;</span><br><span class="line">          <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> saveState</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="title function_">set</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">            saveState = fn</span><br><span class="line">            <span class="comment">// immediately set the state from the test</span></span><br><span class="line">            <span class="title function_">saveState</span>(&#123; todos &#125;)</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We prepare the test by spying on the application setting the <code>window.saveState</code> property, and as soon as we get the function reference, we call it to set the state object. Thus during testing it looks like this:</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getState, saveState &#125; <span class="keyword">from</span> <span class="string">&#x27;./state.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// calls window.saveState = fn</span></span><br><span class="line"><span class="comment">// test calls fn(&#123; todos &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">getState</span>()</span><br><span class="line"><span class="comment">// application has the state set by the spec</span></span><br></pre></td></tr></table></figure><p>Nice.</p><h2><span id="reload-the-page">Reload the page</span></h2><p>We can do another thing. We could visit the page, get the reference to the <code>saveState</code> method, and then reload the page to have application load it.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec4.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;removes todos (with reload)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cy.visit yields the &quot;window&quot; object, thus we can</span></span><br><span class="line">  <span class="comment">// quickly invoke the &quot;saveState&quot; method</span></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;saveState&#x27;</span>, &#123; todos &#125;).<span class="title function_">reload</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>If we are ok exposing the <code>render</code> method from the application code:</p><figure class="highlight js"><figcaption><span>public/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> state = <span class="title function_">getState</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  state = s</span><br><span class="line">  <span class="comment">// Render the UI</span></span><br><span class="line">  app.<span class="property">innerHTML</span> = <span class="title function_">getHTML</span>(state)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Cypress</span>) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">render</span> = render</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then we can avoid the reload and simply call <code>render</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;removes todos (using app render)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> todos = [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cy.visit yields the &quot;window&quot; object</span></span><br><span class="line">  <span class="comment">// once the app sets the &quot;window.render&quot; method</span></span><br><span class="line">  <span class="comment">// we can call it with new state</span></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;render&#x27;</span>, &#123; todos &#125;)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/state/render.png" alt="Set the state using the app render method"></p><h2><span id="state-checkpoints">State checkpoints</span></h2><p>How do we know if we set the right state at the start of the second test? It should be whatever the state was at the end of the first test. If we are ok with introducing the test order, we could do the following:</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec5.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getState &#125; <span class="keyword">from</span> <span class="string">&#x27;../../public/state&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> state</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        state = <span class="title function_">getState</span>()</span><br><span class="line">        <span class="title function_">expect</span>(state, <span class="string">&#x27;state&#x27;</span>).<span class="property">to</span>.<span class="property">deep</span>.<span class="title function_">equal</span>(&#123;</span><br><span class="line">          <span class="attr">todos</span>: [<span class="string">&#x27;write code&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>, <span class="string">&#x27;deploy&#x27;</span>],</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos (with reload)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;saveState&#x27;</span>, state).<span class="title function_">reload</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/state/checkpoint.png" alt="The state checkpoint at the end of the first test"></p><p>We can verify the entire state or parts of it. The second test starts where the first test finished.</p><h2><span id="cypress-data-session">Cypress data session</span></h2><p>Finally, if you are not using <a href="https://github.com/bahmutov/cypress-data-session">cypress-data-session</a> in your tests, you should do it. Here is how I would write the same test that would reuse the same state between the test <em>but allows each test to be independent</em>.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec6.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-data-session</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-data-session&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">threeTodos</span>(<span class="params">recompute = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="comment">// clear the data session forcing it to call the `setup` method</span></span><br><span class="line">  <span class="comment">// and use the UI to create the todos and grab the state</span></span><br><span class="line">  <span class="keyword">if</span> (recompute) &#123;</span><br><span class="line">    <span class="title class_">Cypress</span>.<span class="title function_">clearDataSession</span>(<span class="string">&#x27;threeTodos&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">dataSession</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;threeTodos&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;input#todo&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(<span class="string">&#x27;write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(<span class="string">&#x27;write tests&#123;enter&#125;&#x27;</span>)</span><br><span class="line">        .<span class="title function_">type</span>(<span class="string">&#x27;deploy&#123;enter&#125;&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">      cy.<span class="title function_">window</span>().<span class="title function_">invoke</span>(<span class="string">&#x27;getState&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// if there is a state in memory, use it</span></span><br><span class="line">    <span class="comment">// to set the application instantly</span></span><br><span class="line">    <span class="title function_">recreate</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      <span class="comment">// it helps to clone the object</span></span><br><span class="line">      <span class="comment">// to prevent mutations from changing the value</span></span><br><span class="line">      <span class="comment">// inside the data session</span></span><br><span class="line">      cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;render&#x27;</span>, <span class="title function_">structuredClone</span>(state))</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Todo app&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">threeTodos</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">threeTodos</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The first test &quot;adds todos&quot; always goes through the UI and the state is saved in the data session called <code>threeTodos</code>. The second test starts by recreating the application from the state.</p><p><img src="../images/state/session1.png" alt="Both tests ran together"></p><p>Imagine you want to run the second test only</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">it.<span class="title function_">only</span>(<span class="string">&#x27;removes todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">threeTodos</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.item&#x27;</span>, <span class="string">&#x27;write tests&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todos .item&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The memory data session is still there, so it immediately recreates the session using the 3 todos.</p><p><img src="../images/state/session2.png" alt="The second test in isolation reused the state session"></p><p>Nice!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s say you are testing an app that &lt;a href=&quot;https://gomakethings.com/an-intro-to-state-based-ui-with-javascript/&quot;&gt;derives its UI f
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Flaky Tests Exercises</title>
    <link href="https://glebbahmutov.com/blog/cypress-flaky-tests-exercises/"/>
    <id>https://glebbahmutov.com/blog/cypress-flaky-tests-exercises/</id>
    <published>2024-03-15T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.506Z</updated>
    
    <content type="html"><![CDATA[<p>No one likes flaky tests, not even their mama (you who wrote them). Luckily, most flaky tests come from several specific places: application taking time to process a user action, page re-rendering, etc. I have set up a small repo with several hands-on exercises for you to practice fixing flaky Cypress tests. Can you solve each exercise?</p><p>The source code can be found in the repo <a href="https://github.com/bahmutov/flaky-test-cypress">bahmutov&#x2F;flaky-test-cypress</a>. Each exercise is in its separate branch: <code>level1</code>, <code>level2</code>, etc. You can get the starting code by cloning the repo and checking out the right branch:</p><ul><li>clone the repo to your local machine</li><li>check out the specific branch, for example <code>git checkout level1</code></li><li>install dependencies with <code>npm install</code></li><li>open Cypress <code>npx cypress open</code></li></ul><p>The application is a simply form with several input fields.</p><p><img src="../images/flaky/app.png" alt="The application UI"></p><p>Run the <code>app.cy.js</code> spec and see the flaky test. Can you fix it? You can <em>only</em> modify the spec source code, no touching the application source code allowed.</p><h2><span id="level-1">level 1</span></h2><p>The original flaky test that sometimes passes and sometimes fails. Can you solve the problem before watching the video below?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/iHDZ53gLltc" frameborder="0" loading="lazy" allowfullscreen></iframe></div><blockquote class="pullquote"><p>üéì Do you like practicing end-to-end test writing using hands-on exercises like this blog post shows? Check out my online courses at <a href="https://cypress.tips/courses">cypress.tips&#x2F;courses</a> that have hundreds of hands-on lessons!</p></blockquote><h2><span id="level-2">level 2</span></h2><p>How do you check if a test has flake? By running it multiple times. How would you run a test 10 or 50 times in a row?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/bWR6zFGywMI" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-3">level 3</span></h2><p>The test should pass, yet somehow it fails to save the user record. Can you fix it?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/MbsEUQPMDzw" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-4">level 4</span></h2><p>The test types an email into the input box, but sometimes it loses the first couple of characters. Can you fix the test, even if you cannot fix the underlying problem?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/iHjPHX2rYiM" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-5">level 5</span></h2><p>The test clicks on the &quot;Submit&quot; button and occasionally the button is not there, even if you can see it. Why does that happen? How can you write this test better?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/BsOIhxEVe4s" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-6">level 6</span></h2><p>The application might be loading data on startup. If the test does not account for it, it might have weird behavior. Can you make the test wait for the loading to be finished?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/ae6QkkWUTog" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-7">level 7</span></h2><p>The application saves the data on the server by making the <code>POST /students</code> network call. But sometimes the call seems to be too slow, can you make the test wait for the network call to finish before proceeding?</p><div class="video-container"><iframe src="https://www.youtube.com/embed/tza6cM9E_q0" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-8">level 8</span></h2><p>If the application includes an iframe that slowly loads, the test must wait with retries. The next video shows how to do it</p><div class="video-container"><iframe src="https://www.youtube.com/embed/jU6-FtlL5KU" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="level-9">level 9</span></h2><p>If the application is showing a random popup, we investigate how the app saves the &quot;hide the popup&quot; state and set it using the <code>localStorage</code> ourselves at the start of the test.</p><div class="video-container"><iframe src="https://www.youtube.com/embed/L4EQT2L7yLY" frameborder="0" loading="lazy" allowfullscreen></iframe></div><h2><span id="see-also">See also</span></h2><ul><li>the full <a href="https://www.youtube.com/playlist?list=PLP9o9QNnQuAYfFNgCWIxzRVdomGINKhH9">YT playlist</a> with these flaky test videos</li><li><a href="/blog/flaky-cy-type/" title="Solve Flake In Cypress Typing Into An Input Element">Solve Flake In Cypress Typing Into An Input Element</a></li><li><a href="/blog/flakiness-example/" title="Cypress Flakiness Examples">Cypress Flakiness Examples</a></li><li><a href="/blog/repeat-to-fight-flake/" title="Repeat Test to Fight Flake">Repeat Test to Fight Flake</a></li><li><a href="/blog/flaky-iframe-test/" title="Flaky IFrame Online Store Test">Flaky IFrame Online Store Test</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;No one likes flaky tests, not even their mama (you who wrote them). Luckily, most flaky tests come from several specific places: applicat
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Using Cypress App Action With ngrx/store Angular Applications</title>
    <link href="https://glebbahmutov.com/blog/ngrx-store-app-actions/"/>
    <id>https://glebbahmutov.com/blog/ngrx-store-app-actions/</id>
    <published>2024-03-10T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.560Z</updated>
    
    <content type="html"><![CDATA[<p>Let&#39;s say you are writing end-to-end tests for a modern Angular application. The app is showing a list of customers, so your first test is checking if adding a customer works. You are testing the application the way the user would do it: by filling the input fields and clicking the &quot;Save&quot; button.</p><figure class="highlight js"><figcaption><span>e2e/src/e2e/add-customer.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-slow-down</span></span><br><span class="line"><span class="keyword">import</span> &#123; slowCypressDown &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-slow-down&#x27;</span>;</span><br><span class="line"><span class="comment">// slow each Cypress command by 100ms</span></span><br><span class="line"><span class="title function_">slowCypressDown</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Customers&#x27;</span>, &#123; <span class="attr">viewportHeight</span>: <span class="number">800</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds a customer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Customers&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Add Customer&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer/new&#x27;</span>);</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=firstname]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=name]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Lincoln&#x27;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-label&#x27;</span>, <span class="string">&#x27;Country&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-option&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-label&#x27;</span>, <span class="string">&#x27;Birthdate&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=birthdate]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;12.09.1995&#x27;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Save&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">    <span class="comment">// confirm the record is in the list</span></span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;Tom Lincoln&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;exist&#x27;</span>)</span><br><span class="line">      .<span class="title function_">invoke</span>(<span class="string">&#x27;css&#x27;</span>, <span class="string">&#x27;border&#x27;</span>, <span class="string">&#x27;2px solid red&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post and the test code in the branch <code>add-via-store</code> of my repo <a href="https://github.com/bahmutov/basta-spring-2024-cypress-and-playwright/tree/add-via-store">bahmutov&#x2F;basta-spring-2024-cypress-and-playwright</a>.</p></blockquote><p>The test is passing. For clarity, I am using <a href="https://github.com/bahmutov/cypress-slow-down">cypress-slow-down</a> plugin to slow down each Cypress command by 100ms.</p><center>  <video autoplay muted loop controls>    <source src="../images/ngrx-store-app-actions/add-customer.mp4" type="video/mp4">    <img src="../images/ngrx-store-app-actions/add-customer.png">  </video></center><p>Nice.</p><h2><span id="the-second-test">The second test</span></h2><p>Once we have tested adding a customer, we can test so many other things. For example, we can test deleting a customer. To delete a customer, we need to ... add a customer first. Will you write almost the same test as before?</p><figure class="highlight js"><figcaption><span>e2e/src/e2e/delete-customer.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;deletes a customer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Customers&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Add Customer&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer/new&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=firstname]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=name]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Lincoln&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-label&#x27;</span>, <span class="string">&#x27;Country&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-option&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;mat-label&#x27;</span>, <span class="string">&#x27;Birthdate&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;input[formcontrolname=birthdate]&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;12.09.1995&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Save&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">  <span class="comment">// delete the customer</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-testid=row-customer]&#x27;</span>, <span class="string">&#x27;Tom Lincoln&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;match&#x27;</span>, <span class="regexp">/\/customer\/\d+$/</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=row-customer]&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Tom Lincoln&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>The test passes.</p><center>  <video autoplay muted loop controls>    <source src="../images/ngrx-store-app-actions/deleted.mp4" type="video/mp4">    <img src="../images/ngrx-store-app-actions/deleted.png">  </video></center><p>Hmm. If you look at the Command Log column, 24 out of 36 commands are the same as in the &quot;adds a customer&quot; test and are adding a new customer record using the page elements. It is slow too.</p><p>Will we write a page object to abstract adding a customer? We could.</p><figure class="highlight ts"><figcaption><span>e2e/src/pom/customer.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">&#x27;date-fns&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Customer</span> &#123;</span><br><span class="line">  <span class="title function_">setFirstname</span>(<span class="params">firstname: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;inp-firstname&#x27;</span>).<span class="title function_">clear</span>().<span class="title function_">type</span>(firstname);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;inp-name&#x27;</span>).<span class="title function_">clear</span>().<span class="title function_">type</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setCountry</span>(<span class="params">country: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;sel-country&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;opt-country&#x27;</span>).<span class="title function_">contains</span>(country).<span class="title function_">click</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setBirthday</span>(<span class="params">date: <span class="built_in">Date</span></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;inp-birthdate&#x27;</span>).<span class="title function_">clear</span>().<span class="title function_">type</span>(<span class="title function_">format</span>(date, <span class="string">&#x27;dd.MM.yyyy&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">submit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">&#x27;btn-submit&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> customer = <span class="keyword">new</span> <span class="title class_">Customer</span>();</span><br></pre></td></tr></table></figure><p>We could use the above page object in our test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; sidemenu &#125; <span class="keyword">from</span> <span class="string">&#x27;../pom/sidemenu&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; customer &#125; <span class="keyword">from</span> <span class="string">&#x27;../pom/customer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; customers &#125; <span class="keyword">from</span> <span class="string">&#x27;../pom/customers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds a customer via UI&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  sidemenu.<span class="title function_">open</span>(<span class="string">&#x27;Customers&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">testid</span>(<span class="string">&#x27;btn-customers-add&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  customer.<span class="title function_">setFirstname</span>(<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line">  customer.<span class="title function_">setName</span>(<span class="string">&#x27;Lincoln&#x27;</span>);</span><br><span class="line">  customer.<span class="title function_">setCountry</span>(<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">  customer.<span class="title function_">setBirthday</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1995</span>, <span class="number">9</span>, <span class="number">12</span>));</span><br><span class="line">  customer.<span class="title function_">submit</span>();</span><br><span class="line"></span><br><span class="line">  customers.<span class="title function_">goTo</span>(<span class="string">&#x27;Tom Lincoln&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;css&#x27;</span>, <span class="string">&#x27;border&#x27;</span>, <span class="string">&#x27;2px solid red&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>I don&#39;t like such page objects. All they do is &quot;hide&quot; individual <code>cy.contains</code> and <code>cy.get</code> commands in their tiny methods. Of course, we could create an abstraction on top of these tiny methods.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; customer &#125; <span class="keyword">from</span> <span class="string">&#x27;./customer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Customers</span> &#123;</span><br><span class="line">  <span class="title function_">submitForm</span>(<span class="params"></span></span><br><span class="line"><span class="params">    firstname: string,</span></span><br><span class="line"><span class="params">    name: string,</span></span><br><span class="line"><span class="params">    country: string,</span></span><br><span class="line"><span class="params">    birthdate: <span class="built_in">Date</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    customer.<span class="title function_">setFirstname</span>(firstname);</span><br><span class="line">    customer.<span class="title function_">setName</span>(name);</span><br><span class="line">    customer.<span class="title function_">setCountry</span>(country);</span><br><span class="line">    customer.<span class="title function_">setBirthday</span>(birthdate);</span><br><span class="line">    customer.<span class="title function_">submit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> customers = <span class="keyword">new</span> <span class="title class_">Customers</span>();</span><br></pre></td></tr></table></figure><p>Then the test could use <code>customers.submitForm()</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds a customer via UI (2nd version)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  sidemenu.<span class="title function_">open</span>(<span class="string">&#x27;Customers&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">testid</span>(<span class="string">&#x27;btn-customers-add&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  customers.<span class="title function_">submitForm</span>(<span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Lincoln&#x27;</span>, <span class="string">&#x27;USA&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1995</span>, <span class="number">9</span>, <span class="number">12</span>));</span><br><span class="line"></span><br><span class="line">  customers.<span class="title function_">goTo</span>(<span class="string">&#x27;Tom Lincoln&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;css&#x27;</span>, <span class="string">&#x27;border&#x27;</span>, <span class="string">&#x27;2px solid red&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Even with multiple levels of abstractions, we still have a test that repeats 2&#x2F;3 of its commands between the test &quot;adds a customer&quot; and &quot;deletes a customer&quot;. We also built up levels of testing code in the page objects ... that the actual user of our web page does not see or benefit from.</p><p><img src="../images/ngrx-store-app-actions/pom.png" alt="Page objects on top of page UI"></p><p>You are building levels of code on top of the elements on the page. The end user does not benefit from this code, and the tests simply repeat actions on the page from the other tests. By the time you get to the &quot;deletes a customer&quot; test, you know that adding a customer works. So repeating the same clicks and typing in the test simply spends time.</p><h2><span id="a-better-way">A better way</span></h2><p>Inside the application&#39;s code, the event handlers take the input from the page and pass it on to the business logic. For example, when you add a customer, here is what the application code is doing:</p><figure class="highlight ts"><figcaption><span>src/app/customer/customer/customer.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, inject, <span class="title class_">OnInit</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Store</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@ngrx/store&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-customer&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./customer.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./customer.component.scss&#x27;</span>],</span><br><span class="line">  <span class="attr">standalone</span>: <span class="literal">true</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CustomerComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  #store = <span class="title function_">inject</span>(<span class="title class_">Store</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">submit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">formGroup</span>.<span class="property">valid</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> customer = <span class="variable language_">this</span>.<span class="property">formGroup</span>.<span class="title function_">getRawValue</span>();</span><br><span class="line">      <span class="keyword">if</span> (customer.<span class="property">id</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.#store.<span class="title function_">dispatch</span>(customerActions.<span class="title function_">update</span>(&#123; customer &#125;));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> action = customerActions.<span class="title function_">add</span>(&#123; customer &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.#store.<span class="title function_">dispatch</span>(action);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The most important lines are:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> action = customerActions.<span class="title function_">add</span>(&#123; customer &#125;);</span><br><span class="line"><span class="variable language_">this</span>.#store.<span class="title function_">dispatch</span>(action);</span><br></pre></td></tr></table></figure><p>If you print the constructed action, it looks like this:</p><p><img src="../images/ngrx-store-app-actions/add-action.png" alt="Adding the customer event object"></p><p>Ok, so all those UI clicks and typings lead to calling <code>this.#store.dispatch(action)</code>. We can do it ourselves from the test. First, we need to expose the store object so that the test can access it. No biggie. We can expose the global store from any top-level component.</p><figure class="highlight ts"><figcaption><span>src/app/customer/customers/customers.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CustomersComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  #store = <span class="title function_">inject</span>(<span class="title class_">Store</span>);</span><br><span class="line">  data$ = <span class="variable language_">this</span>.#store.<span class="title function_">select</span>(fromCustomer.<span class="property">selectCustomersAndPage</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// expose the store instance</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Cypress</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">store</span> = <span class="variable language_">this</span>.#store;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>Technical detail:</strong> in Angular applications we need to dispatch the actions using <code>ngZone</code> wrapper. This will force all components to update their user interface after propagating our action. Thus we need to expose the <code>ngZone</code> instance.</p><figure class="highlight ts"><figcaption><span>src/app/app.component.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> ngZone: NgZone</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Cypress</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">ngZone</span> = <span class="variable language_">this</span>.<span class="property">ngZone</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s update our test.</p><figure class="highlight ts"><figcaption><span>e2e/src/e2e/delete-customer.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;deletes a customer (app action)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> firstname = <span class="string">&#x27;Tom&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> name = <span class="string">&#x27;Lincoln&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> fullName = <span class="string">`<span class="subst">$&#123;firstname&#125;</span> <span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> addCustomer = &#123;</span><br><span class="line">    <span class="attr">customer</span>: &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">      firstname,</span><br><span class="line">      name,</span><br><span class="line">      <span class="attr">country</span>: <span class="string">&#x27;AT&#x27;</span>,</span><br><span class="line">      <span class="attr">birthdate</span>: <span class="string">&#x27;1985-12-12T05:00:00.000Z&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;[Customer] add&#x27;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">window</span>().<span class="title function_">should</span>(<span class="string">&#x27;have.property&#x27;</span>, <span class="string">&#x27;store&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">window</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">win</span>) =&gt;</span> &#123;</span><br><span class="line">    win.<span class="property">ngZone</span>!.<span class="title function_">run</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      win.<span class="property">store</span>!.<span class="title function_">dispatch</span>(addCustomer);</span><br><span class="line">      win.<span class="property">store</span>!.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;[Customer] load&#x27;</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// delete the customer</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-testid=row-customer]&#x27;</span>, <span class="string">&#x27;Tom Lincoln&#x27;</span>)</span><br><span class="line">    .<span class="title function_">contains</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;match&#x27;</span>, <span class="regexp">/\/customer\/\d+$/</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Delete&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;eq&#x27;</span>, <span class="string">&#x27;/customer&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=row-customer]&#x27;</span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Tom Lincoln&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>We build an object with the customer information, then dispatch an NgRx action. We wait for the <code>window</code> object to have the store instance - then we know the app has finished loading.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">window</span>().<span class="title function_">should</span>(<span class="string">&#x27;have.property&#x27;</span>, <span class="string">&#x27;store&#x27;</span>);</span><br><span class="line">cy.<span class="title function_">window</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">win</span>) =&gt;</span> &#123;</span><br><span class="line">  win.<span class="property">ngZone</span>!.<span class="title function_">run</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    win.<span class="property">store</span>!.<span class="title function_">dispatch</span>(addCustomer);</span><br><span class="line">    win.<span class="property">store</span>!.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;[Customer] load&#x27;</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Because of the design of our application, we need to dispatch the load event too in order to update the entire list. Here is how the test looks.</p><center>  <video autoplay muted loop controls>    <source src="../images/ngrx-store-app-actions/delete-app-action.mp4" type="video/mp4">    <img src="../images/ngrx-store-app-actions/delete-app-action.png">  </video></center><p>The test loads the page and immediately creates a customer record, simply by calling <code>win.store!.dispatch(addCustomer);</code>. Then we can use the page UI and delete that customer, just like a real user. We lost nothing in our testing by removing the duplicate commands between the two tests. The &quot;adds a customer&quot; still exercises the page object flow for adding a new record. The current test simply reaches into the app and calls the same production code as the regular page ui would. Want to have a better test experience? Improve the application code, don&#39;t create levels of &quot;better&quot; testing code.</p><p><img src="../images/ngrx-store-app-actions/diagram.png" alt="App actions are built on top of the application code"></p><p>We can still use some small Page Object utilities, like opening a specific menu</p><figure class="highlight ts"><figcaption><span>e2e/src/pom/sidemenu.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Sidemenu</span> &#123;</span><br><span class="line">  <span class="title function_">open</span>(<span class="params">name: <span class="string">&#x27;Customers&#x27;</span> | <span class="string">&#x27;Holidays&#x27;</span></span>) &#123;</span><br><span class="line">    cy.<span class="title function_">testid</span>(<span class="string">`btn-<span class="subst">$&#123;name.toLowerCase()&#125;</span>`</span>).<span class="title function_">click</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sidemenu = <span class="keyword">new</span> <span class="title class_">Sidemenu</span>();</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; sidemenu &#125; <span class="keyword">from</span> <span class="string">&#x27;../pom/sidemenu&#x27;</span>;</span><br><span class="line">sidemenu.<span class="title function_">open</span>(<span class="string">&#x27;Customers&#x27;</span>);</span><br></pre></td></tr></table></figure><p>But in general, we can do larger actions to add new data by calling the app&#39;s code. Cypress tests run in the same browser as the app code, so no problems with passing the real object references, circular objects, etc.</p><blockquote class="pullquote"><p>üéì If you want to see what I think a Page Object should have, check out a free lesson &quot;Lesson b5: Write a Page Object&quot; in my course <a href="https://cypress.tips/courses/cy-copilot">Write Cypress Tests Using GitHub Copilot</a>.</p></blockquote><p><strong>A note about types:</strong> We need to &quot;tell&quot; the application and the testing code that the <code>window</code> object might have properties <code>Cypress</code>, <code>ngZone</code>, and <code>store</code>. We can use <code>src/index.d.ts</code> file for this:</p><figure class="highlight ts"><figcaption><span>src/index.d.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">NgZone</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Store</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@ngrx/store&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">global</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Window</span> &#123;</span><br><span class="line">    <span class="title class_">Cypress</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">    ngZone?: <span class="title class_">NgZone</span>;</span><br><span class="line">    store?: <span class="title class_">Store</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="see-also">See also</span></h2><ul><li>üìù read the blog post <a href="/blog/testing-angular-application-via-app-actions/" title="Testing Angular application via App Actions">Testing Angular application via App Actions</a></li><li>üì∫ videos I made showing how I refactor this Angular application:<ul><li><a href="https://youtu.be/CgmKKs8nmjE">Refactor A Test: Part One</a></li><li><a href="https://youtu.be/KrcTbp7lV4A">Refactor A Test Part Two: Data-Driven Tests For Multiple Viewports</a></li><li><a href="https://youtu.be/VHLJA_9EJx0">Refactor A Test Part 3: Checking A Paginated List</a></li><li><a href="https://youtu.be/hDTpRhcOmjs">Refactor A Test Part 4: A Better Delete Method</a></li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Let&amp;#39;s say you are writing end-to-end tests for a modern Angular application. The app is showing a list of customers, so your first te
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="angular" scheme="https://glebbahmutov.com/blog/tags/angular/"/>
    
  </entry>
  
  <entry>
    <title>Check Fees And Totals Using Cypress</title>
    <link href="https://glebbahmutov.com/blog/check-fees-using-cypress/"/>
    <id>https://glebbahmutov.com/blog/check-fees-using-cypress/</id>
    <published>2024-03-06T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.494Z</updated>
    
    <content type="html"><![CDATA[<p>Imagine you have a small page showing item prices and fees. For example, it could be a checkout page. The fees must add up to the total.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;price&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Price<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$10.99<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;shipping&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Shipping (2-day)<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$6.99<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;handling&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Handling fee<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$1.39<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;tips&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Tips<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$1.99<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;total&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Total<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$21.36<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/fees/page.png" alt="The example page"></p><p>Can we verify the individual fees and confirm the total is correct?</p><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post in the repo <a href="https://github.com/bahmutov/cypress-prices-check">bahmutov&#x2F;cypress-prices-check</a>.</p></blockquote><!-- toc --><ul><li><a href="#hardcoded-values">Hardcoded values</a></li><li><a href="#one-array">One array</a></li><li><a href="#one-object">One object</a></li><li><a href="#cy-spok">cy-spok</a></li><li><a href="#custom-difference">Custom difference</a></li><li><a href="#confirm-the-sum">Confirm the sum</a></li><li><a href="#the-test-retries">The test retries</a></li><li><a href="#close-enough">Close enough</a></li></ul><!-- tocstop --><h2><span id="hardcoded-values">Hardcoded values</span></h2><p>If you know the precise values, the test becomes easy.</p><figure class="highlight js"><figcaption><span>cypress/e2e/fees.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the expected fees&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=price] dd&#x27;</span>, <span class="string">&#x27;$10.99&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=shipping] dd&#x27;</span>, <span class="string">&#x27;$6.99&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=handling] dd&#x27;</span>, <span class="string">&#x27;$1.39&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=tips] dd&#x27;</span>, <span class="string">&#x27;$1.99&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=total] dd&#x27;</span>, <span class="string">&#x27;$21.36&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/v1.png" alt="The test checks the hard-coded values"></p><p>We can refactor the test a little to avoid duplicated selectors</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">fee</span> = (<span class="params">name, value</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the expected fees (simple selectors)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fee</span>(<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;$10.99&#x27;</span>)</span><br><span class="line">  <span class="title function_">fee</span>(<span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;$6.99&#x27;</span>)</span><br><span class="line">  <span class="title function_">fee</span>(<span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;$1.39&#x27;</span>)</span><br><span class="line">  <span class="title function_">fee</span>(<span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;$1.99&#x27;</span>)</span><br><span class="line">  <span class="title function_">fee</span>(<span class="string">&#x27;total&#x27;</span>, <span class="string">&#x27;$21.36&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/v2.png" alt="Utility function to check each fee"></p><p><strong>Tip:</strong> I usually refactor my tests with the help of Copilot, see my course <a href="https://cypress.tips/courses/cy-copilot">Write Cypress Tests Using GitHub Copilot</a></p><p><img src="../images/fees/copilot.png" alt="GitHub Copilot code suggestion based on the test"></p><h2><span id="one-array">One array</span></h2><p>Instead of checking each fee element, we can collect all fees and totals into a single array for checking. For simplicity and elegance, I will use custom queries from my <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> plugin.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the expected fees (one array)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  <span class="comment">// cy.getInOrder and cy.map are custom commands</span></span><br><span class="line">  <span class="comment">// from the cypress-map plugin</span></span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [<span class="string">&#x27;$10.99&#x27;</span>, <span class="string">&#x27;$6.99&#x27;</span>, <span class="string">&#x27;$1.39&#x27;</span>, <span class="string">&#x27;$1.99&#x27;</span>, <span class="string">&#x27;$21.36&#x27;</span>])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/a1.png" alt="All fees in one array"></p><p>Long object and arrays are shortened by the Chai assertions, but we can increase the truncation threshold.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chai.<span class="property">config</span>.<span class="property">truncateThreshold</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the expected fees (one array)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/a2.png" alt="Showing full arrays"></p><p>Still, the array might be pretty long and have just a single item difference, yet we print it entirely.</p><h2><span id="one-object">One object</span></h2><p>Let&#39;s give each fee a name before comparing.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">it.<span class="title function_">only</span>(<span class="string">&#x27;shows the expected fees (one object)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">apply</span>(<span class="function">(<span class="params">values</span>) =&gt;</span> <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">zipObject</span>(names, values))</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">price</span>: <span class="string">&#x27;$10.99&#x27;</span>,</span><br><span class="line">      <span class="attr">shipping</span>: <span class="string">&#x27;$6.99&#x27;</span>,</span><br><span class="line">      <span class="attr">handling</span>: <span class="string">&#x27;$1.39&#x27;</span>,</span><br><span class="line">      <span class="attr">tips</span>: <span class="string">&#x27;$1.99&#x27;</span>,</span><br><span class="line">      <span class="attr">total</span>: <span class="string">&#x27;$21.36&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Again, <code>cy.getInOrder</code>, <code>cy.map</code>, and <code>cy.apply</code> are queries from <a href="https://github.com/bahmutov/cypress-map">cypress-map</a>.</p><p><img src="../images/fees/o1.png" alt="Showing full objects"></p><p>Let&#39;s see how it looks when some of the properties are incorrect.</p><p><img src="../images/fees/o2.png" alt="The failing test when some of the object properties are different"></p><p>Which values in the large object are different?</p><h2><span id="cy-spok">cy-spok</span></h2><p>We can use plugin <a href="https://github.com/bahmutov/cy-spok">cy-spok</a> to better report <em>the first different property</em>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cy-spok</span></span><br><span class="line"><span class="keyword">import</span> spok <span class="keyword">from</span> <span class="string">&#x27;cy-spok&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has wrong fees (cy-spok)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">apply</span>(<span class="function">(<span class="params">values</span>) =&gt;</span> <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">zipObject</span>(names, values))</span><br><span class="line">    .<span class="title function_">should</span>(</span><br><span class="line">      <span class="title function_">spok</span>(&#123;</span><br><span class="line">        <span class="attr">price</span>: <span class="string">&#x27;$10.99&#x27;</span>,</span><br><span class="line">        <span class="attr">shipping</span>: <span class="string">&#x27;$6.99&#x27;</span>,</span><br><span class="line">        <span class="attr">handling</span>: <span class="string">&#x27;$1.39&#x27;</span>,</span><br><span class="line">        <span class="attr">tips</span>: <span class="string">&#x27;$0.99&#x27;</span>,</span><br><span class="line">        <span class="attr">total</span>: <span class="string">&#x27;$25.36&#x27;</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/spok.png" alt="Correct and the first wrong property as shown by cy-spok"></p><p>Unfortunately, cy-spok stops when it sees the first property with the different value. I would like to see <em>all</em> different properties.</p><h2><span id="custom-difference">Custom difference</span></h2><p>We can compute the difference between the current subject and the expected object of values ourselves. Let&#39;s add a query command so it retries. If there are no differences, <code>cy.difference</code> yields an empty object.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Cypress</span>.<span class="property">Commands</span>.<span class="title function_">addQuery</span>(<span class="string">&#x27;difference&#x27;</span>, <span class="function">(<span class="params">expected</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = <span class="title class_">Object</span>.<span class="title function_">keys</span>(expected)</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">subject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> diff = &#123;&#125;</span><br><span class="line">    names.<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> actual = subject[name]</span><br><span class="line">      <span class="keyword">const</span> expectedValue = expected[name]</span><br><span class="line">      <span class="keyword">if</span> (actual !== expectedValue) &#123;</span><br><span class="line">        diff[name] = &#123; actual, <span class="attr">expected</span>: expectedValue &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> diff</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has wrong fees (custom difference)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">apply</span>(<span class="function">(<span class="params">values</span>) =&gt;</span> <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">zipObject</span>(names, values))</span><br><span class="line">    .<span class="title function_">difference</span>(&#123;</span><br><span class="line">      <span class="attr">price</span>: <span class="string">&#x27;$10.99&#x27;</span>,</span><br><span class="line">      <span class="attr">shipping</span>: <span class="string">&#x27;$6.99&#x27;</span>,</span><br><span class="line">      <span class="attr">handling</span>: <span class="string">&#x27;$1.39&#x27;</span>,</span><br><span class="line">      <span class="attr">tips</span>: <span class="string">&#x27;$0.99&#x27;</span>,</span><br><span class="line">      <span class="attr">total</span>: <span class="string">&#x27;$25.36&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.empty&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The error is now simply reports the properties with the different values.</p><p><img src="../images/fees/difference.png" alt="Custom difference query"></p><p><strong>Tip:</strong> you can use point-free programming by partially applying the first argument to the <code>Cypress._.zipObject</code> method:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">  .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">  <span class="comment">// partially apply the zip callback</span></span><br><span class="line">  .<span class="title function_">apply</span>(<span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="property">zipObject</span>.<span class="title function_">bind</span>(<span class="literal">null</span>, names))</span><br></pre></td></tr></table></figure><p><strong>Tip 2:</strong> there is <code>cy.difference</code> query in the <code>cypress-map</code> plugin, with the same logic.</p><blockquote class="pullquote"><p>üì∫ Watch the same test refactored from normal to <code>cy.difference</code> chain in the video <a href="https://youtu.be/WKVaJjst_-8">Check Multiple Properties At Once Using cy.difference Query</a>.</p></blockquote><p><strong>Tip 3:</strong> the command <code>cy.difference</code> in <code>cypress-map</code> even allows you to use predicates to check each property</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">tid</span> = (<span class="params">id</span>) =&gt; <span class="string">`[data-cy=<span class="subst">$&#123;id&#125;</span>] dd`</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the fees and the total&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;tips&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">shippingPriceCheck</span> = (<span class="params">amount</span>) =&gt; amount &gt; <span class="number">5</span> &amp;&amp; amount &lt; <span class="number">10</span></span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(names.<span class="title function_">map</span>(tid))</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="title class_">Number</span>)</span><br><span class="line">    .<span class="title function_">print</span>()</span><br><span class="line">    .<span class="title function_">apply</span>(<span class="function">(<span class="params">values</span>) =&gt;</span> <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">zipObject</span>(names, values))</span><br><span class="line">    .<span class="title function_">difference</span>(&#123;</span><br><span class="line">      <span class="attr">price</span>: <span class="number">10.99</span>,</span><br><span class="line">      <span class="attr">shipping</span>: shippingPriceCheck,</span><br><span class="line">      <span class="attr">handling</span>: <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="property">isNumber</span>,</span><br><span class="line">      <span class="attr">tips</span>: <span class="function">(<span class="params">amount</span>) =&gt;</span> <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">inRange</span>(amount, <span class="number">0.1</span>, <span class="number">2</span>),</span><br><span class="line">      <span class="attr">total</span>: <span class="number">21.36</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.empty&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>You can watch the above test explained in my video <a href="https://youtu.be/RKgSBN2fk_s">cy.difference Command With Predicates</a>.</p><h2><span id="confirm-the-sum">Confirm the sum</span></h2><p>Now let&#39;s move away from confirming individual fees to computing the total. The final <code>total</code> price on the page should equal to the sum of all fees. We must also consider negative fees and formatted currency.</p><p><img src="../images/fees/total.png" alt="A checkout page with formatted currency and negative fees"></p><p>Ok, let&#39;s convert each string to a number and confirm the sum is equal to the last number</p><figure class="highlight js"><figcaption><span>cypress/e2e/total.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;total.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds up all fees to equal the total&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;coupon&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="title class_">Number</span>)</span><br><span class="line">    .<span class="title function_">print</span>()</span><br><span class="line">    .<span class="title function_">should</span>(<span class="function">(<span class="params">numbers</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> [price, shipping, handling, coupon, total] = numbers</span><br><span class="line">      <span class="title function_">expect</span>(price + shipping + handling + coupon).<span class="property">to</span>.<span class="title function_">equal</span>(total)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/total-test.png" alt="The test confirming the fees add up"></p><h2><span id="the-test-retries">The test retries</span></h2><p>All commands in the above test are queries, thus they retry. Even if some fees load slowly, the test should pass. Imagine, the coupon&#39;s value is fetched from a remote service, thus there is a delay.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;total&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Total<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$1,072.97<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// load the coupon after a delay</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> coupon = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;[data-cy=coupon] dd&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    coupon.<span class="property">innerText</span> = <span class="string">&#x27;-$75.00&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>No problem, the test will retry. The invalid number is a <code>null</code>, which causes the sum to be <code>NaN</code>.</p><center>  <video autoplay muted loop controls>    <source src="../images/fees/r1.mp4" type="video/mp4">    <img src="../images/fees/r1.png">  </video></center><p>Just a precaution I like checking the total to be within some certain numerical range. This should avoid accidentally confirming <code>0 + 0 + ... + 0 = 0</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">should</span>(<span class="function">(<span class="params">numbers</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [price, shipping, handling, coupon, total] = numbers</span><br><span class="line">  <span class="title function_">expect</span>(price + shipping + handling + coupon)</span><br><span class="line">    .<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">greaterThan</span>(<span class="number">100</span>)</span><br><span class="line">    .<span class="property">and</span>.<span class="property">to</span>.<span class="title function_">equal</span>(total)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="close-enough">Close enough</span></h2><p>We are using floats to compute the dollar sum. Floating-point numbers suffer from precision loss. Let&#39;s imagine we have two numbers that end in <code>4</code> and <code>3</code>. Their sum will have a floating-point error</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;price&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Price<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$1,099.93<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dl</span> <span class="attr">data-cy</span>=<span class="string">&quot;shipping&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dt</span>&gt;</span>Shipping (2-day)<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dd</span>&gt;</span>$16.94<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="../images/fees/f1.png" alt="I got 99 problems, or is it 99.00000001?"></p><p>We can deal with this problem in 3 different ways.</p><ol><li>Use the <code>closeTo</code> assertion</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">should</span>(<span class="function">(<span class="params">numbers</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [price, shipping, handling, coupon, total] = numbers</span><br><span class="line">  <span class="title function_">expect</span>(price + shipping + handling + coupon)</span><br><span class="line">    .<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">greaterThan</span>(<span class="number">100</span>)</span><br><span class="line">    .<span class="property">and</span>.<span class="property">be</span>.<span class="title function_">closeTo</span>(total, <span class="number">0.001</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/f2.png" alt="Comparing floating-point numbers using closeTo assertion"></p><ol start="2"><li>Perform arithmetic using whole numbers</li></ol><p>Instead of dollars, we can use cents to compute the sum and do the comparison.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds up all fees using cents&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;coupon&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">mapInvoke</span>(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="title class_">Number</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">n</span>) =&gt;</span> n * <span class="number">100</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="title class_">Math</span>.<span class="property">round</span>)</span><br><span class="line">    .<span class="title function_">print</span>()</span><br><span class="line">    .<span class="title function_">should</span>(<span class="function">(<span class="params">numbers</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> [price, shipping, handling, coupon, total] = numbers</span><br><span class="line">      <span class="title function_">expect</span>(price + shipping + handling + coupon)</span><br><span class="line">        .<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">greaterThan</span>(<span class="number">10_000</span>)</span><br><span class="line">        .<span class="property">and</span>.<span class="property">to</span>.<span class="title function_">equal</span>(total)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/f3.png" alt="Comparing currency using whole numbers of cents"></p><ol start="3"><li>Use a dedicated library for dealing with currency operations</li></ol><p>In this blog post I will use <a href="https://v2.dinerojs.com/docs">Dinero.js</a> v2. Let&#39;s install the necessary dev dependencies</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -D dinero.js@alpha @dinero.js/currencies@alpha</span><br><span class="line">+ dinero.js@alpha 2.0.0-alpha.14</span><br><span class="line">+ @dinero.js/currencies@alpha 2.0.0-alpha.14</span><br></pre></td></tr></table></figure><p>Here is out test that uses a few utility functions from Dinero library</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"><span class="comment">// https://v2.dinerojs.com/docs</span></span><br><span class="line"><span class="keyword">import</span> &#123; dinero, add, equal, toDecimal &#125; <span class="keyword">from</span> <span class="string">&#x27;dinero.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">USD</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@dinero.js/currencies&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dineroFromFloat</span>(<span class="params">amountString</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> cleaned = amountString.<span class="title function_">replace</span>(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> amount = <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Number</span>(cleaned * <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">dinero</span>(&#123; amount, <span class="attr">currency</span>: <span class="variable constant_">USD</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds up all fees using Dinero.js&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> names = [<span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;shipping&#x27;</span>, <span class="string">&#x27;handling&#x27;</span>, <span class="string">&#x27;coupon&#x27;</span>, <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">  <span class="keyword">const</span> selectors = names.<span class="title function_">map</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> <span class="string">`[data-cy=<span class="subst">$&#123;name&#125;</span>] dd`</span>)</span><br><span class="line">  cy.<span class="title function_">getInOrder</span>(...selectors)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="string">&#x27;innerText&#x27;</span>)</span><br><span class="line">    .<span class="title function_">print</span>()</span><br><span class="line">    .<span class="title function_">map</span>(dineroFromFloat)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="function">(<span class="params">numbers</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> [price, shipping, handling, coupon, total] = numbers</span><br><span class="line">      <span class="keyword">const</span> sum = [price, shipping, handling, coupon].<span class="title function_">reduce</span>(add)</span><br><span class="line">      <span class="title function_">expect</span>(<span class="title function_">equal</span>(sum, total), <span class="string">`<span class="subst">$&#123;toDecimal(sum)&#125;</span> = <span class="subst">$&#123;toDecimal(total)&#125;</span>`</span>).<span class="property">to</span>.<span class="property">be</span></span><br><span class="line">        .<span class="property">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/fees/dinero.png" alt="Calculating currency using Dinero.js"></p><p>Nice.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Imagine you have a small page showing item prices and fees. For example, it could be a checkout page. The fees must add up to the total.&lt;
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Vs SafeTest</title>
    <link href="https://glebbahmutov.com/blog/cypress-vs-safetest/"/>
    <id>https://glebbahmutov.com/blog/cypress-vs-safetest/</id>
    <published>2024-03-04T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.515Z</updated>
    
    <content type="html"><![CDATA[<p>Recently Netflix has released <a href="https://github.com/kolodny/safetest">SafeTest</a> - a component testing framework built on top of Playwright. In this blog post I want to compare it to my <a href="/blog/how-cypress-component-testing-was-born/" title="Cypress component testing">Cypress component testing</a> feature. To compare these test runners using concrete examples I grabbed an example from the SafeTest&#39;s own repo and placed with additional Cypress tests into the repo <a href="https://github.com/bahmutov/safetest-vs-cypress">bahmutov&#x2F;safetest-vs-cypress</a>.</p><p><img src="../images/cypress-vs-safetest/repo.png" alt="The bahmutov/safetest-vs-cypress repo"></p><p>Let&#39;s see if can learn what SafeTest can and cannot do.</p><!-- toc --><ul><li><a href="#is-it-dev-or-prod-dependency">Is it dev or prod dependency?</a></li><li><a href="#installation">Installation</a></li><li><a href="#hello-world-test">Hello World test</a></li><li><a href="#test-speed">Test speed</a></li><li><a href="#mocks-and-spies">Mocks and Spies</a></li><li><a href="#overrides-providers-etc">Overrides, providers, etc</a></li><li><a href="#dev-experience">Dev experience</a></li><li><a href="#dev-support">Dev support</a></li><li><a href="#the-final-tally">The final tally</a></li><li><a href="#update-1-safetest-vs-cypress-vs-webdriver">Update 1: SafeTest vs Cypress vs WebDriver</a></li></ul><!-- tocstop --><h2><span id="is-it-dev-or-prod-dependency">Is it dev or prod dependency?</span></h2><p>The first thing I have noticed was that SafeTest seems to be a production dependency. Yes, the docs say to install SafeTest using <code>npm install --save-dev safetest</code>, but then you should include it in your <code>src/index.tsx</code> file:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bootstrap &#125; <span class="keyword">from</span> <span class="string">&#x27;safetest/react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App&quot;</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>The example folders in <a href="https://github.com/kolodny/safetest">kolodny&#x2F;safetest</a> all list <code>safetest</code> as a prod dependency:</p><figure class="highlight json"><figcaption><span>kolodny/safetest/blob/main/examples/cra/package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;safetest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:../..&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Call me old-fashioned, but I feel a testing library should be a dev dependency, just like Cypress.</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr></tbody></table><h2><span id="installation">Installation</span></h2><p>With SafeTest you create a config file <code>setup-safetest.tsx</code>, add <code>package.json</code> scripts, and modify your <code>src/index.tsx</code> file.</p><p><img src="../images/cypress-vs-safetest/install.png" alt="Installing SafeTest"></p><p>You also need to be running the application before you can start testing, just as if this was an end-to-end test against the local environment.</p><p>With Cypress, you just open it and click on the &quot;Component Testing&quot;.</p><p><img src="../images/cypress-vs-safetest/ct1.png" alt="Pick Component Testing"></p><p>Cypress finds from the source code the framework your are using and creates appropriate files automatically.</p><p><img src="../images/cypress-vs-safetest/ct2.png" alt="React with Vite"></p><p><img src="../images/cypress-vs-safetest/ct3.png" alt="Scaffolded files"></p><p>The modifications to the <code>cypress.config.ts</code> file:</p><figure class="highlight js"><figcaption><span>cypress.config.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&quot;cypress&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">component</span>: &#123;</span><br><span class="line">    <span class="attr">devServer</span>: &#123;</span><br><span class="line">      <span class="attr">framework</span>: <span class="string">&quot;react&quot;</span>,</span><br><span class="line">      <span class="attr">bundler</span>: <span class="string">&quot;vite&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>That it is. You can start writing component tests.</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td><strong>Installation</strong></td><td>manual üëé</td><td>auto üëç</td></tr><tr><td><strong>Start the app</strong></td><td>needed üëé</td><td>not needed üëç</td></tr></tbody></table><h2><span id="hello-world-test">Hello World test</span></h2><p>Let&#39;s take a look at the example test shown in the SafeTest folder.</p><figure class="highlight tsx"><figcaption><span>safetest-example/src/misc.safetest.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; describe, it, expect &#125; <span class="keyword">from</span> <span class="string">&#x27;safetest/vitest&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&#x27;safetest/react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;simple&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;s&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; page &#125; = <span class="keyword">await</span> <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Test1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Test1&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>We are rendering a simple React component with the text &quot;Test1&quot; and confirm it is visible. SafeTest is built on top of Playwright, thus the test runs in a real browser. The test confirms that the component is visible in the real browser. Nice. The same test can be written using Cypress:</p><figure class="highlight jsx"><figcaption><span>cypress-example/src/misc.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;simple&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;s&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Test1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;Test1&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s interact with a component. Here is the example test that clicks on the component 500 times.</p><figure class="highlight jsx"><figcaption><span>safetest-example/src/App.safetest.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;can do many interactions fast&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Counter</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Count is &#123;count&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123; page &#125; = <span class="keyword">await</span> <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Count is 0&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">500</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">locator</span>(<span class="string">&#x27;button:not(a)&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">`text=Count is <span class="subst">$&#123;i&#125;</span>`</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>And an equivalent Cypress component test</p><figure class="highlight jsx"><figcaption><span>cypress-example/src/App.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;can do many interactions fast&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Counter</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Count is &#123;count&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 0&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">500</span>; i++) &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;button:not(a)&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">`Count is <span class="subst">$&#123;i&#125;</span>`</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Ok. How about using shortcut to change the state of the component to perform an &quot;app action&quot;? SafeTest can give you a &quot;bridge&quot; function, whatever it is:</p><figure class="highlight jsx"><figcaption><span>safetest-example/src/App.safetest.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;can use the bridge function&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">forceNumber</span>: <span class="function">(<span class="params">num: number</span>) =&gt;</span> <span class="keyword">void</span> = <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Counter</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> forceRender = <span class="title class_">React</span>.<span class="title function_">useReducer</span>(<span class="function">() =&gt;</span> count, <span class="number">0</span>)[<span class="number">1</span>];</span><br><span class="line">    forceNumber = <span class="function">(<span class="params">n</span>) =&gt;</span> &#123;</span><br><span class="line">      count = n;</span><br><span class="line">      <span class="title function_">forceRender</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            count++;</span></span><br><span class="line"><span class="language-xml">            forceRender();</span></span><br><span class="line"><span class="language-xml">          &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Count is &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; page, bridge &#125; = <span class="keyword">await</span> <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Count is 0&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Count is 1&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">bridge</span>(<span class="function">() =&gt;</span> <span class="title function_">forceNumber</span>(<span class="number">50</span>));</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Count is 50&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Count is 51&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Seems we need the bridge to call the component code running in the browser from the Playwright test running in Node. Cypress can simply interact with the component, since it is the same browser code, so nothing special is needed.</p><figure class="highlight js"><figcaption><span>cypress-example/src/App.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;can use the bridge function&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">forceNumber</span>: <span class="function">(<span class="params">num: number</span>) =&gt;</span> <span class="keyword">void</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">Counter</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> forceRender = <span class="title class_">React</span>.<span class="title function_">useReducer</span>(<span class="function">() =&gt;</span> count, <span class="number">0</span>)[<span class="number">1</span>]</span><br><span class="line">    forceNumber = <span class="function">(<span class="params">n</span>) =&gt;</span> &#123;</span><br><span class="line">      count = n</span><br><span class="line">      <span class="title function_">forceRender</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            count++</span></span><br><span class="line"><span class="language-xml">            forceRender()</span></span><br><span class="line"><span class="language-xml">          &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Count is &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 0&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 1&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">forceNumber</span>(<span class="number">50</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 50&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 51&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>People new to Cypress tip over its &quot;schedule all commands, then run them with retries&quot; execution model. This is why we use the following syntax to call the <code>forceNumber</code> <em>after</em> we confirm the page confirms the component has text &quot;Count is 1&quot;</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 1&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">forceNumber</span>(<span class="number">50</span>)</span><br><span class="line">&#125;)</span><br><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;Count is 50&#x27;</span>)</span><br></pre></td></tr></table></figure><p>I always though the <code>cy.then</code> command should have been called <code>cy.later</code>, as I wrote in the blog post <a href="/blog/replace-and-remove-cy-then-command/" title="Replace The cy.then Command">Replace The cy.then Command</a>.</p><p>So let&#39;s add a few rows to our comparison:</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td><strong>Test syntax</strong></td><td>easy üëç</td><td>easy üëç</td></tr><tr><td><strong>Execution environment</strong></td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr></tbody></table><h2><span id="test-speed">Test speed</span></h2><p>Let&#39;s run the same test &quot;can use the bridge function&quot; by itself to see how long it takes in SafeTest vs Cypress</p><p>We start the SafeTest app with <code>npm run dev</code> and run the single spec. The test is isolated to run by itself using <code>it.only</code></p><p><img src="../images/cypress-vs-safetest/speed-safetest.png" alt="SafeTest runs the test in 1200ms"></p><p>Let&#39;s run the same test using Cypress component testing</p><p><img src="../images/cypress-vs-safetest/speed-cy.png" alt="Cypress runs the test in 300ms"></p><p>Cypress component testing is <em>very fast</em> because it bundles only the component under the test plus the test itself. SafeTest loads the full E2E bundle and extracts the component to be tested. This is why you need to include it in the bundling entry and execute the application while running the component tests. In the CI mode, Cypress disables time-traveling debugger, thus alleviating the overhead. Thus Cypress CT can be faster than the SafeTest. Still, <em>it does not matter</em>. The component tests are fast enough in both cases.</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td><strong>Speed</strong></td><td>fast üëç</td><td>fast üëç</td></tr></tbody></table><blockquote class="pullquote"><p>üìù SafeTest is extracting components &#x2F; functions for testing from the production bundle. It is is a pretty cool idea. I have described doing it for Angular.JS (!) in the blog post <a href="/blog/unit-testing-angular-from-node-like-a-boss/" title="Unit testing Angular from Node like a boss">Unit testing Angular from Node like a boss</a> in 2015. Dmitriy Tishin <a href="https://itnext.io/cypress-storybook-keeping-test-scenario-data-and-component-rendering-in-one-place-c57b23cc1640">described how</a> to grab React components from Storybook bundles to use my Cypress component testing library <code>cypress-react-unit-test</code> in 2020.</p></blockquote><h2><span id="mocks-and-spies">Mocks and Spies</span></h2><p>SafeTest provides Jest mocks and spies</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; describe, it, expect, browserMock &#125; <span class="keyword">from</span> <span class="string">&#x27;safetest/jest&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&#x27;safetest/react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Header</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Header&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Header&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;calls the passed logout handler when clicked&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> spy = browserMock.<span class="title function_">fn</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123; page &#125; = <span class="keyword">await</span> <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Header</span> <span class="attr">handleLogout</span>=<span class="string">&#123;spy&#125;</span> /&gt;</span></span>);</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Logout&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">    <span class="title function_">expect</span>(<span class="keyword">await</span> spy).<span class="title function_">toHaveBeenCalled</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Cypress includes Sinon.js <a href="https://glebbahmutov.com/cypress-examples/commands/spies-stubs-clocks.html">mocks and spies</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;calls the passed logout handler when clicked&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Header</span> <span class="attr">handleLogout</span>=<span class="string">&#123;cy.stub().as(</span>&#x27;<span class="attr">logout</span>&#x27;)&#125; /&gt;</span></span>);</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Logout&#x27;</span>).<span class="title function_">click</span>();</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@logout&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.been.called&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td>Speed</td><td>fast üëç</td><td>fast üëç</td></tr><tr><td><strong>Spies and stubs</strong></td><td>present üëç</td><td>present üëç</td></tr></tbody></table><h2><span id="overrides-providers-etc">Overrides, providers, etc</span></h2><p>SafeTest exposes <code>createOverride</code> that let&#39;s you change the behavior of the component; one more proof that SafeTest is a production dependency. You can call use the override from the test</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Records.tsx</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">UseGetRecordsQuery</span> = <span class="title function_">createOverride</span>(useGetRecordsQuery)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">Records</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> useGetRecordQuery = <span class="title class_">UseGetRecordsQuery</span>.<span class="title function_">useValue</span>()</span><br><span class="line">  <span class="keyword">const</span> &#123; records, loading, error &#125; = <span class="title function_">useGetRecordsQuery</span>();</span><br><span class="line">  <span class="keyword">if</span> (loading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Loader</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Error</span> <span class="attr">error</span>=<span class="string">&#123;error&#125;</span> /&gt;</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">RecordList</span> <span class="attr">records</span>=<span class="string">&#123;records&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// from the safetest</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Has an error state&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; page &#125; = <span class="title function_">render</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">UseGetRecordQuery.Override</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">with</span>=<span class="string">&#123;(old)</span> =&gt;</span> (&#123; ...old(), error: new Error(&#x27;Test Error&#x27;) &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">    &gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Records</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">UseGetRecordQuery.Override</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(<span class="keyword">await</span> page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Test Error&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>In Cypress, you could pass the overrides via the shared <code>window</code> object to the component to implement the same substitution. I strongly discourage using the implementation-specific overrides. Test the interface of the component. You want to see how the component reacts to the loader error? How the loader shows? Stub the network call and confirm.</p><figure class="highlight jsx"><figcaption><span>src/components/Overlay.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Overlay</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Overlay&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../App.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;is visible and clickable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">mount</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Overlay</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">overlay</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onClickOverlay</span>=<span class="string">&#123;cy.stub().as(</span>&#x27;<span class="attr">click</span>&#x27;)&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span>,</span><br><span class="line">  )</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.overlay&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@click&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.been.called&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the loading element&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/times/90&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">delay</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">statusCode</span>: <span class="number">404</span>,</span><br><span class="line">    <span class="attr">body</span>: [],</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;times&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Overlay</span> <span class="attr">overlay</span>=<span class="string">&#123;true&#125;</span> <span class="attr">time</span>=<span class="string">&#123;90&#125;</span> /&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.overlay__loading&#x27;</span>, <span class="string">&#x27;Loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@times&#x27;</span>)</span><br><span class="line">  <span class="comment">// the loader goes away</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.overlay__loading&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the top times&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/times/90&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">fixture</span>: <span class="string">&#x27;times.json&#x27;</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;scores&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Overlay</span> <span class="attr">overlay</span>=<span class="string">&#123;true&#125;</span> <span class="attr">time</span>=<span class="string">&#123;90&#125;</span> /&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@scores&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.overlay__times li&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">4</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.overlay__times li&#x27;</span>, <span class="string">&#x27;01:30&#x27;</span>).<span class="title function_">should</span>(</span><br><span class="line">    <span class="string">&#x27;have.class&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;overlay__current&#x27;</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote class="pullquote"><p>üíª The above example comes from my presentation <a href="https://slides.com/bahmutov/sudoku-confoo">Learn Cypress React component testing by playing Sudoku</a>. The source code with all component tests is in the repo <a href="https://github.com/bahmutov/the-fuzzy-line">bahmutov&#x2F;the-fuzzy-line</a>.</p></blockquote><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td>Speed</td><td>fast üëç</td><td>fast üëç</td></tr><tr><td>Spies and stubs</td><td>present üëç</td><td>present üëç</td></tr><tr><td><strong>Overrides</strong></td><td>present ‚ö†Ô∏è</td><td>possible ‚ö†Ô∏è</td></tr></tbody></table><h2><span id="dev-experience">Dev experience</span></h2><p>With Cypress you get an excellent interactive mode that shows the component and let&#39;s you write full tests quickly. It is no wonder that the SafeTest repo itself comes with lots of React components and <em>none of them are tested</em>.</p><p><img src="../images/cypress-vs-safetest/t1.png" alt="The reporter components"></p><p>But it is easy to write Cypress tests, here are a couple.</p><figure class="highlight jsx"><figcaption><span>cypress-example/src/report/label.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Label</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./label.tsx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;labels&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Label</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">Label</span>&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress-example/src/report/expandable.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Expandable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./expandable&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;expands&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">mount</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Expandable</span> <span class="attr">expanded</span>=<span class="string">&#123;true&#125;</span>&gt;</span>Expandable content<span class="tag">&lt;/<span class="name">Expandable</span>&gt;</span></span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Expandable content&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/cypress-vs-safetest/t2.png" alt="The reporter components with Cypress CT specs"></p><p>A good test example is a sanity test for the Accordion component</p><figure class="highlight jsx"><figcaption><span>cypress-example/src/report/accordion.cy.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Accordion</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./accordion.tsx&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ComponentsContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./report&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Expandable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./expandable.tsx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;works&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">mount</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ComponentsContext.Provider</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">value</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">Expandable</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Accordion</span> <span class="attr">summary</span>=<span class="string">&quot;All is good&quot;</span> <span class="attr">defaultOpen</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Accordion content is here</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Accordion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ComponentsContext.Provider</span>&gt;</span></span>,</span><br><span class="line">  )</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Accordion content is here&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-testid=toggle]&#x27;</span>, <span class="string">&#x27;All is good&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Accordion content is here&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><center>  <video autoplay muted loop controls>    <source src="../images/cypress-vs-safetest/accordion.mp4" type="video/mp4">    <img src="../images/cypress-vs-safetest/accordion.png">  </video></center><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td>Speed</td><td>fast üëç</td><td>fast üëç</td></tr><tr><td>Spies and stubs</td><td>present üëç</td><td>present üëç</td></tr><tr><td>Overrides</td><td>present ‚ö†Ô∏è</td><td>possible ‚ö†Ô∏è</td></tr><tr><td><strong>Want to write tests</strong></td><td>maybe ü§∑‚Äç‚ôÇÔ∏è</td><td>yes üëç</td></tr></tbody></table><h2><span id="dev-support">Dev support</span></h2><p>SafeTest was <a href="https://netflixtechblog.com/introducing-safetest-a-novel-approach-to-front-end-testing-37f9f88c152d">announced by Netflix</a>. If they seriously use it to standardize on Playwright for the E2E tests and SafeTest for the component tests, it is going to be well-maintaned and supported. Cypress is backing its component testing. Judging from previous OSS library experience, I would say</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td>Speed</td><td>fast üëç</td><td>fast üëç</td></tr><tr><td>Spies and stubs</td><td>present üëç</td><td>present üëç</td></tr><tr><td>Overrides</td><td>present ‚ö†Ô∏è</td><td>possible ‚ö†Ô∏è</td></tr><tr><td>Want to write tests</td><td>maybe ü§∑‚Äç‚ôÇÔ∏è</td><td>yes üëç</td></tr><tr><td><strong>Backed by</strong></td><td>Netflix üëç</td><td>Cypress.io üëé</td></tr></tbody></table><h2><span id="the-final-tally">The final tally</span></h2><p>SafeTest has other features that I like, for example the built-in visual comparisons</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; page &#125; = <span class="keyword">await</span> <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span>);</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">expect</span>(page.<span class="title function_">locator</span>(<span class="string">&#x27;text=Logout&#x27;</span>)).<span class="title function_">toBeVisible</span>();</span><br><span class="line"><span class="title function_">expect</span>(<span class="keyword">await</span> page.<span class="title function_">screenshot</span>()).<span class="title function_">toMatchImageSnapshot</span>();</span><br></pre></td></tr></table></figure><p>I do not count this feature towards SafeTest benefits, since it is built into Playwright.</p><table><thead><tr><th>Feature</th><th>SafeTest</th><th>Cypress Component Testing (CT)</th></tr></thead><tbody><tr><td>Dependency</td><td>prod üëé</td><td>dev üëç</td></tr><tr><td>Installation</td><td>manual üëé</td><td>auto üëç</td></tr><tr><td>Start the app</td><td>needed üëé</td><td>not needed üëç</td></tr><tr><td>Test syntax</td><td>easy üëç</td><td>easy üëç</td></tr><tr><td>Execution environment</td><td>mix of Node and browser üëé</td><td>browser üëç</td></tr><tr><td>Speed</td><td>fast üëç</td><td>fast üëç</td></tr><tr><td>Spies and stubs</td><td>present üëç</td><td>present üëç</td></tr><tr><td>Overrides</td><td>present ‚ö†Ô∏è</td><td>possible ‚ö†Ô∏è</td></tr><tr><td>Want to write tests</td><td>maybe ü§∑‚Äç‚ôÇÔ∏è</td><td>yes üëç</td></tr><tr><td>Backed by</td><td>Netflix üëç</td><td>Cypress.io üëé</td></tr><tr><td><strong>Total</strong></td><td>4 üëç 3 üëé</td><td>8 üëç 1 üëé</td></tr></tbody></table><p>Do you have a good SafeTest spec example and want to see how it looks in Cypress? Make the code public and send it my way.</p><h2><span id="update-1-safetest-vs-cypress-vs-webdriver">Update 1: SafeTest vs Cypress vs WebDriver</span></h2><p><a href="https://bromann.dev/">Christian Bromann</a> has published a nice comparison following the same metrics <a href="https://bromann.dev/post/safetest-vs-cypress-vs-webdriverio/">COMPONENT TESTING WITH SAFETEST VS. CYPRESS VS. WEBDRIVERIO</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently Netflix has released &lt;a href=&quot;https://github.com/kolodny/safetest&quot;&gt;SafeTest&lt;/a&gt; - a component testing framework built on top of 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Solve Tough Pagination Cases Using Cypress</title>
    <link href="https://glebbahmutov.com/blog/solve-tough-pagination-cases-using-cypress/"/>
    <id>https://glebbahmutov.com/blog/solve-tough-pagination-cases-using-cypress/</id>
    <published>2024-02-28T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.590Z</updated>
    
    <content type="html"><![CDATA[<p>In my recent blog post <a href="/blog/cypress-pagination-challenge/" title="Cypress Pagination Challenge">Cypress Pagination Challenge</a> I have shown several solutions to a common testing problem: flip through the rows of data, looking for something to be there (or to not be there). In this blog post, I will take it up a notch. I will show several pagination edge cases that make writing a good flake-free end-to-end test difficult. I have seen these errors in my tests and in the testing code written by others. It is time to solve it for good. Let&#39;s go.</p><blockquote class="pullquote"><p>üéÅ You can find the full source code in the repo <a href="https://github.com/bahmutov/cypress-pagination-tough-case">bahmutov&#x2F;cypress-pagination-tough-case</a>.</p></blockquote><!-- toc --><ul><li><a href="#the-easy-case">The easy case</a></li><li><a href="#unhappy-paths">Unhappy paths</a></li><li><a href="#slow-application-load">Slow application load</a></li><li><a href="#slow-page-transition">Slow page transition</a></li><li><a href="#speed">Speed</a></li></ul><!-- tocstop --><h2><span id="the-easy-case">The easy case</span></h2><p>Let us start with a nice happy path. We see a list with a few items. We can click on the &quot;Next&quot; button and go to the second page. For simplicity, the list ends on the second page, but our solution does not know that. The list has only the words <code>first</code>, <code>second</code>, <code>third</code>, <code>fourth</code>, <code>fifth</code>, and <code>sixth</code>. The test should stop checking the list when the &quot;Next&quot; button becomes disabled.</p><center>  <video autoplay muted loop controls>    <source src="../images/tough-pagination/f1.mp4" type="video/mp4">    <img src="../images/tough-pagination/f1.png">  </video></center><p>Here is the code for the page. As you can see, the app is <em>very fast</em>. It instantly renders the first list, then instantly renders the second page after clicking the &quot;Next&quot; button.</p><figure class="highlight html"><figcaption><span>cypress/fixtures/spec1.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>first<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>second<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>third<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;next&quot;</span>&gt;</span>Next ‚ñ∂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// the page is _very fast_</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// and the new page loads synchronously</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> next = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;next&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    next.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      list.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;fourth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;fifth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;sixth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">      `</span></span></span><br><span class="line"><span class="language-javascript">      next.<span class="title function_">setAttribute</span>(<span class="string">&#x27;disabled&#x27;</span>, <span class="literal">true</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>How would you write this test?</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec1.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/spec1.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;confirms the list has no such item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// text of an item that should NOT be in the list</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;apples&#x27;</span></span><br><span class="line">  <span class="comment">// ???</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We are doing an example of <em>negative testing</em>, we are trying to confirm that something is NOT there. This is <a href="/blog/negative-assertions/" title="always more complex">always more complex</a> than confirming the presence, since an item can missing for many reasons. In any case, let&#39;s write a recursive algorithm, I will put it in the <code>cypress/e2e/utils.js</code> file so we can use it from other specs. In the code below we are doing a conditional command depending on the &quot;Next&quot; button state. For more examples of conditional clicking see the blog post <a href="/blog/click-button-if-enabled/" title="Click Button If Enabled">Click Button If Enabled</a>.</p><figure class="highlight js"><figcaption><span>cypress/e2e/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the given item is not present on the page and</span></span><br><span class="line"><span class="comment"> * recursively clicks the &quot;Next&quot; button until the item is found</span></span><br><span class="line"><span class="comment"> * or the button is disabled.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">item</span> - The item to check for on the page.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">void</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">checkPage1</span> = (<span class="params">item</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;li&#x27;</span>, item).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">enabled</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">        <span class="title function_">checkPage1</span>(item)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cy.<span class="title function_">log</span>(<span class="string">&#x27;**end of the list**&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Our test can call the <code>checkPage1</code> with the a string argument. <strong>Note:</strong> for this blog post, I slow down every Cypress commands by 200ms using my plugin <a href="https://github.com/bahmutov/cypress-slow-down">cypress-slow-down</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-slow-down</span></span><br><span class="line"><span class="keyword">import</span> &#123; slowCypressDown &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-slow-down&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; checkPage1 <span class="keyword">as</span> checkPage &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">slowCypressDown</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/spec1.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;confirms the list has no such item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// text of an item that should NOT be in the list</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;apples&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><center>  <video autoplay muted loop controls>    <source src="../images/tough-pagination/f2.mp4" type="video/mp4">    <img src="../images/tough-pagination/f2.png">  </video></center><p>The test passes. If we inspect the <code>contains ...</code> commands for both pages, we see that the test did check the list at the right moment. In the first instance it checked the list when the list had values <code>first</code>, <code>second</code>, and <code>third</code>. And in the second instance, the test checked the list when it was on the second page showing the values <code>fourth</code>, <code>fifth</code>, and <code>sixth</code>.</p><p><img src="../images/tough-pagination/f2-check.png" alt="The two places where the test checked the list"></p><p>If you look at the video again, I am showing the page at the moment the <code>cy.contains</code> command ran twice.</p><h2><span id="unhappy-paths">Unhappy paths</span></h2><p>Let&#39;s break the test on purpose to make sure it works correctly. Let&#39;s give it a string value that is present on the page. The value is <code>second</code> so it should be found on the first page.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the first page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// test with an item that is on the first page</span></span><br><span class="line">  <span class="comment">// =&gt; the test should fail</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;second&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/tough-pagination/f3.png" alt="The test fails if the item is found on the first page"></p><p>What if the item is on the second page? Let&#39;s test it.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the second page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;fifth&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/tough-pagination/f4.png" alt="The test fails if the item is found on the second page"></p><p>Beautiful, our <code>checkPage1</code> recursive test function is correct. Or is it?</p><h2><span id="slow-application-load">Slow application load</span></h2><p>A common problem in the SPA is the slow initial data load. I simulate it in the <code>spec2.html</code> page</p><figure class="highlight html"><figcaption><span>cypress/fixtures/spec2.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">      loading...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;next&quot;</span>&gt;</span>Next ‚ñ∂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// the initial list loads slowly,</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// but then the page is very fast</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// and the new page loads synchronously</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> next = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;next&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      list.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;first&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;second&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;third&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">      `</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">    next.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      list.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;fourth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;fifth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;sixth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">      `</span></span></span><br><span class="line"><span class="language-javascript">      next.<span class="title function_">setAttribute</span>(<span class="string">&#x27;disabled&#x27;</span>, <span class="literal">true</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The initial list loads after 1 second, meanwhile the app is showing the <code>loading...</code> text. Let&#39;s run <em>the same</em> 3 tests again and see if we have the same outcome:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// EXPECTED</span><br><span class="line">‚úÖ confirms the list has no such item</span><br><span class="line">üö® fails if the item is on the first page</span><br><span class="line">üö® fails if the item is on the second page</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>cypress/e2e/spec2.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-slow-down</span></span><br><span class="line"><span class="keyword">import</span> &#123; slowCypressDown &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-slow-down&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; checkPage1 <span class="keyword">as</span> checkPage &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">slowCypressDown</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/spec2.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;confirms the list has no such item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// text of an item that should NOT be in the list</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;apples&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the first page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// test with an item that is on the first page</span></span><br><span class="line">  <span class="comment">// =&gt; the test should fail</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;second&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the second page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;fifth&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Hmm. We are getting one test &quot;flipped&quot;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// ACTUAL</span><br><span class="line">‚úÖ confirms the list has no such item</span><br><span class="line">‚úÖ fails if the item is on the first page</span><br><span class="line">üö® fails if the item is on the second page</span><br></pre></td></tr></table></figure><p><img src="../images/tough-pagination/f5.png" alt="The second test somehow passes"></p><p>The second test that checks the item that should be found on the first page is green for some reason. Let&#39;s debug it. We can expand the test commands and click on the &quot;contains &#39;second&#39;&quot; command to see how the page looked when the test checked the list.</p><p><img src="../images/tough-pagination/f5-debug.png" alt="The app page when the second test checked it"></p><p>Ooops, the test looked for the item with the test &quot;second&quot;, the page was showing &quot;loading...&quot;, the test happily continued on its way.</p><blockquote><p>Remember: a negative assertion can pass for many reasons</p></blockquote><p>The reason for the test passing while it should have been failing is confusion to what <a href="/blog/negative-assertions-and-missing-states/" title="state the application is in">state the application is in</a>. The test thinks the app is showing the list. The app is still showing the loading element. The solution is to &quot;sync&quot; the application and the test states. For example, the test can wait for the <code>li</code> elements to appear before running a negative assertion. This will ensure the app is in the right state showing the items.</p><figure class="highlight js"><figcaption><span>cypress/e2e/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the given item is not present on the page and</span></span><br><span class="line"><span class="comment"> * recursively clicks the &quot;Next&quot; button until the item is found</span></span><br><span class="line"><span class="comment"> * or the button is disabled.</span></span><br><span class="line"><span class="comment"> * Waits for the items to load first.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">item</span> - The item to check for on the page.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">void</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">checkPage2</span> = (<span class="params">item</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;li&#x27;</span>).<span class="title function_">log</span>(<span class="string">&#x27;**has list items**&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;li&#x27;</span>, item).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">enabled</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">        <span class="title function_">checkPage2</span>(item)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cy.<span class="title function_">log</span>(<span class="string">&#x27;**end of the list**&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In a TodoMVC application, the code might set a <code>loaded</code> class to signal that the page has the list, and the test could do something like this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br></pre></td></tr></table></figure><p>In our code, the <code>checkPage2</code> function confirms the list items are present before checking them: <code>cy.get(&#39;li&#39;).log(&#39;**has list items**&#39;)</code>. Let&#39;s see if the <code>checkPage2</code> test utility leads to the correct test outcome.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec2.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-slow-down</span></span><br><span class="line"><span class="keyword">import</span> &#123; slowCypressDown &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-slow-down&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; checkPage2 <span class="keyword">as</span> checkPage &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">slowCypressDown</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/spec2.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;confirms the list has no such item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// text of an item that should NOT be in the list</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;apples&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the first page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// test with an item that is on the first page</span></span><br><span class="line">  <span class="comment">// =&gt; the test should fail</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;second&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the second page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;fifth&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/tough-pagination/f6.png" alt="One passing, two failing tests as expected"></p><p>If we debug the second test, we see that it fails for the right reason. The application is showing the actual list items <code>first</code>, <code>second</code>, and <code>third</code> when the first &quot;contains&quot; assertion checks it.</p><p><img src="../images/tough-pagination/f6-debug.png" alt="The second test fails for the right reason"></p><p>Good. But this is not the entire story.</p><h2><span id="slow-page-transition">Slow page transition</span></h2><p>Let&#39;s introduce another challenge. Our application might be slow to update the list after the user clicks the &quot;Next&quot; button. I have seen applications where clicking the &quot;Next&quot; button updated the <em>button</em> itself, yet the list was still showing the old items for X milliseconds. Here is how I simulate it in the <code>spec3.html</code> code:</p><figure class="highlight html"><figcaption><span>cypress/fixtures/spec3.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">      loading...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;next&quot;</span>&gt;</span>Next ‚ñ∂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// the initial list loads slowly,</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// and when clicking on the next button</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// there is a delay before the new list is shown</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> next = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;next&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      list.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;first&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;second&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        &lt;li&gt;third&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">      `</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">    next.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        list.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">          &lt;li&gt;fourth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">          &lt;li&gt;fifth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">          &lt;li&gt;sixth&lt;/li&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">        `</span></span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">      next.<span class="title function_">setAttribute</span>(<span class="string">&#x27;disabled&#x27;</span>, <span class="literal">true</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s use our <code>checkPage2</code> function to run against this application.</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec3.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-slow-down</span></span><br><span class="line"><span class="keyword">import</span> &#123; slowCypressDown &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-slow-down&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; checkPage2 <span class="keyword">as</span> checkPage &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">slowCypressDown</span>(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/spec3.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;confirms the list has no such item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// text of an item that should NOT be in the list</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;apples&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the first page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// test with an item that is on the first page</span></span><br><span class="line">  <span class="comment">// =&gt; the test should fail</span></span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;second&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fails if the item is on the second page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> item = <span class="string">&#x27;fifth&#x27;</span></span><br><span class="line">  <span class="title function_">checkPage</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We are expecting again the first test to pass and the last two tests to fail. But we are getting something else:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// EXPECTED</span><br><span class="line">‚úÖ confirms the list has no such item</span><br><span class="line">üö® fails if the item is on the first page</span><br><span class="line">üö® fails if the item is on the second page</span><br><span class="line">// ACTUAL</span><br><span class="line">‚úÖ confirms the list has no such item</span><br><span class="line">üö® fails if the item is on the first page</span><br><span class="line">‚úÖ fails if the item is on the second page</span><br></pre></td></tr></table></figure><p><img src="../images/tough-pagination/f7.png" alt="Why is the third test passing?!"></p><p>Let&#39;s debug the third test. Hover or click over the second &quot;contains li, fifth&quot; command. Why is it still showing the first page?!!</p><p><img src="../images/tough-pagination/f7-debug.png" alt="We expected to see the second page, but the first page was visible still"></p><p>Again, this is the confusion between the test and the application <em>state</em>. The test assumed that after clicking on the &quot;Next&quot; button and seeing list items, the app would be on the second page. But the application still showed the first page. In other circumstances we could have looked at the URL to confirm the page number</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if the app rendered the page in the URL</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/pages/2&#x27;</span>)</span><br><span class="line"><span class="title function_">checkPage2</span>(item)</span><br></pre></td></tr></table></figure><p>But we don&#39;t have it. So somehow we need to check that <em>new</em> list item elements are there on the page. People often use the text of an element to detect when the new list was rendered:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// üö® INCORRECT, LEADS TO FLAKE</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;li:first&#x27;</span>)</span><br><span class="line">  .<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;li:first&#x27;</span>, text).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">    <span class="title function_">checkPage2</span>(item)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>The above code might work in some cases, but if the list has duplicates, it would fail. Imagine our list has items <code>A</code>, <code>A</code>, and <code>A</code> on the first page, and the items <code>A</code>, <code>B</code>, and <code>C</code> on the second. It would not be able to tell the two <code>A</code> strings apart. A better way would be to check the element references, since the application replaces <code>&lt;LI&gt;</code> elements on click:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ‚úÖ check element references</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;li:first&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>($el =&gt; &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;li:first&#x27;</span>).<span class="title function_">should</span>($li =&gt; &#123;</span><br><span class="line">      <span class="comment">// compare two element references</span></span><br><span class="line">      <span class="title function_">expect</span>($el[<span class="number">0</span>]).<span class="property">to</span>.<span class="property">not</span>.<span class="title function_">equal</span>($li[<span class="number">0</span>])</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// the list has new &lt;LI&gt; elements</span></span><br><span class="line">    <span class="title function_">checkPage2</span>(item)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>To simplify the above code we can use a query <code>cy.stable</code> from my <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> plugin. The query retries until an element&#39;s reference remains constant for N milliseconds. Thus, if we know that the list switch takes at most 1 second, we can wait for the reference to remain stable for slightly longer period.</p><figure class="highlight js"><figcaption><span>cypress/e2e/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the given item is not present on the page and</span></span><br><span class="line"><span class="comment"> * recursively clicks the &quot;Next&quot; button until the item is found</span></span><br><span class="line"><span class="comment"> * or the button is disabled.</span></span><br><span class="line"><span class="comment"> * Waits for the items to load first.</span></span><br><span class="line"><span class="comment"> * When going to the next page, waits for the current list</span></span><br><span class="line"><span class="comment"> * to not change its text for 1500ms.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">item</span> - The item to check for on the page.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">void</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">checkPage3</span> = (<span class="params">item</span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;li&#x27;</span>).<span class="title function_">log</span>(<span class="string">&#x27;**has list items**&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;li&#x27;</span>, item).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">enabled</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">        cy.<span class="title function_">get</span>(<span class="string">&#x27;li&#x27;</span>).<span class="title function_">first</span>().<span class="title function_">stable</span>(<span class="string">&#x27;element&#x27;</span>, <span class="number">1500</span>, &#123; <span class="attr">timeout</span>: <span class="number">3000</span> &#125;)</span><br><span class="line">        <span class="title function_">checkPage3</span>(item)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cy.<span class="title function_">log</span>(<span class="string">&#x27;**end of the list**&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s see our spec now.</p><center>  <video autoplay muted loop controls>    <source src="../images/tough-pagination/f8.mp4" type="video/mp4">    <img src="../images/tough-pagination/f8.png">  </video></center><p>The tests work exactly as expected. The third test gets to the second page, waits for the <code>&lt;LI&gt;</code> elements to be stable, and then correctly finds the item with text &quot;fifth&quot;..</p><p><img src="../images/tough-pagination/f8.png" alt="The stable list on the second page"></p><h2><span id="speed">Speed</span></h2><p>A huge downside to the <code>cy.stable</code> command is that it must wait for N milliseconds. In our case, it waits for 1500ms. If the <code>&lt;LI&gt;</code> elements switch after 300ms, then it would wait for 300 + 1500ms. We can make our test better. Remember: if the test &quot;knows&quot; what state the applicatin is in, then it can precisely wait for it, before running a negative assertion. Here is how I would modify my application to make it testable.</p><figure class="highlight js"><figcaption><span>cypress/fixtures/spec4.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the list sets the correct data attribute</span></span><br><span class="line"><span class="comment">// with the rendered page number</span></span><br><span class="line"><span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> next = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;next&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  list.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">  list.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;li&gt;first&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;second&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;third&lt;/li&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line">next.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    list.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-page&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">    list.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;li&gt;fourth&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;fifth&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;sixth&lt;/li&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">  next.<span class="title function_">setAttribute</span>(<span class="string">&#x27;disabled&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The only thing this code does it sets the <code>data-page</code> attribute when it renders the page:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">list.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">list.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;li&gt;first&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;second&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;third&lt;/li&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="comment">// and later</span></span><br><span class="line">list.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-page&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">list.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;li&gt;fourth&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;fifth&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;li&gt;sixth&lt;/li&gt;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p>Our test can take the advantage of the <code>data-page=...</code> attribute to be much simpler</p><figure class="highlight js"><figcaption><span>cypress/e2e/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the given item is not present on the page and</span></span><br><span class="line"><span class="comment"> * recursively clicks the &quot;Next&quot; button until the item is found</span></span><br><span class="line"><span class="comment"> * or the button is disabled.</span></span><br><span class="line"><span class="comment"> * Confirm the list page has rendered before checking</span></span><br><span class="line"><span class="comment"> * by checking a data attribute.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">item</span> - The item to check for on the page.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; <span class="variable">page</span> - The current page number (1-based), default 1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">void</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">checkPage4</span> = (<span class="params">item, page = <span class="number">1</span></span>) =&gt; &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">`ul[data-page=<span class="subst">$&#123;page&#125;</span>]`</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;li&#x27;</span>).<span class="title function_">log</span>(<span class="string">`**page <span class="subst">$&#123;page&#125;</span> has list items**`</span>)</span><br><span class="line">  <span class="comment">// we can use zero timeout since we are on the right page</span></span><br><span class="line">  <span class="comment">// and we know the LI elements have finished loading</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;li&#x27;</span>, item, &#123; <span class="attr">timeout</span>: <span class="number">0</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">enabled</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        cy.<span class="title function_">get</span>(<span class="string">&#x27;button#next&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">        <span class="title function_">checkPage4</span>(item, page + <span class="number">1</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cy.<span class="title function_">log</span>(<span class="string">&#x27;**end of the list**&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Once the command <code>cy.get(&quot;ul[data-page=$&#123;page&#125;]&quot;)</code> passes, the test is good to check the items. We can even use a very short timeout limit to run our negative assertion, since we know the items are already there and won&#39;t change.</p><p><img src="../images/tough-pagination/f9.png" alt="The best test is quick and deterministic"></p><p>Nice.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;In my recent blog post &lt;a href=&quot;/blog/cypress-pagination-challenge/&quot; title=&quot;Cypress Pagination Challenge&quot;&gt;Cypress Pagination Challenge&lt;/a
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Click Button If Enabled</title>
    <link href="https://glebbahmutov.com/blog/click-button-if-enabled/"/>
    <id>https://glebbahmutov.com/blog/click-button-if-enabled/</id>
    <published>2024-02-22T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.495Z</updated>
    
    <content type="html"><![CDATA[<p>Imagine you have a button on the page. This button sometimes is enabled and sometimes is disabled. The test does not control the button (that would be too simple). The test must click the button <em>only if it is enabled</em>. How would you write this Cypress test?</p><p><img src="../images/click-button-if-enabled/button.png" alt="The button can be disabled"></p><p>Conditional testing is an anti-pattern, but <a href="https://glebbahmutov.com/cypress-examples/recipes/conditional-testing.html">Cypress can do it</a>. Here is how to solve this problem in several ways.</p><h2><span id="plain-cypress-syntax">Plain Cypress syntax</span></h2><p>üì∫ Watch the first solution explained in the video <a href="https://www.youtube.com/watch?v=F5uoYgCenFg">Check If A Button Is Enabled Before Clicking</a>.</p><p>Let&#39;s use plain Cypress command. We first get the button, then check its attribute inside <code>cy.then(callback)</code>. We can schedule more commands in the <code>callback</code> function.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;#btn&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">$btn</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ($btn.<span class="title function_">attr</span>(<span class="string">&#x27;disabled&#x27;</span>)) &#123;</span><br><span class="line">      cy.<span class="title function_">log</span>(<span class="string">&#x27;Nothing to click&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cy.<span class="title function_">wrap</span>($btn).<span class="title function_">click</span>().<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><strong>Remember:</strong> any time you get something <em>from the app</em>, you must pass it forward to the next command, assertion, or <code>cy.then(callback)</code>.</p><p>If the button is enabled, the test clicks and checks the updated text.</p><p><img src="../images/click-button-if-enabled/s1.png" alt="The test clicked on the enabled button"></p><p>If the button happened to be disabled, the test simply logged a message and finished.</p><p><img src="../images/click-button-if-enabled/s2.png" alt="The test did not click on the disabled button"></p><p>We can rewrite the test to use <a href="https://api.jquery.com/is/">jQuery <code>is</code> method</a> to check if the button is enabled using the jQuery pseudo-selector <code>:enabled</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;#btn&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>)</span><br><span class="line">  .<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">enabled</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;#btn&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>)</span><br><span class="line">        .<span class="title function_">click</span>()</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cy.<span class="title function_">log</span>(<span class="string">&#x27;**not clicking**&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>I like this syntax because it makes it clear what we are getting at; we are checking if the button is enabled. This is better than &quot;hiding&quot; the effects in the <code>cy.then(callback)</code> via <code>$btn.attr(&#39;disabled&#39;)</code> or even <code>$btn.is(&#39;:enabled&#39;)</code> which are invisible to Cypress Command Log. If we are using <a href="https://on.cypress.io/invoke">cy.invoke</a> command, we can click on it to see what it produced.</p><p><img src="../images/click-button-if-enabled/is.png" alt="Debugging the cy.invoke is command"></p><p>You can find the above examples under recipes on my <a href="https://glebbahmutov.com/cypress-examples/">Cypress examples</a> site.</p><h2><span id="cypress-if-solution">cypress-if solution</span></h2><p>üì∫ Watch the next two solutions shown in the video <a href="https://youtu.be/H04FSnH-6U0">Click Button If Enabled Using cypress-if And cypress-await Plugins</a>.</p><p>I have introduced my plugin <a href="https://github.com/bahmutov/cypress-if">cypress-if</a> in the blog post <a href="/blog/cypress-if/" title="Conditional Commands For Cypress">Conditional Commands For Cypress</a>. It lets you do conditional &quot;if &#x2F; else&quot; chains of commands based on the current subject. Here is how the above solution looks when using <code>cypress-if</code>. The commands <code>cy.if</code> and <code>cy.else</code> are from the <code>cypress-if</code> plugin</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-if</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-if&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;clicks the button if enabled&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/enabled-button.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>)</span><br><span class="line">    <span class="comment">// tests using Chai assertion &quot;be.enabled&quot;</span></span><br><span class="line">    .<span class="title function_">if</span>(<span class="string">&#x27;enabled&#x27;</span>)</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">    .<span class="title function_">else</span>(<span class="string">&#x27;Nothing to click&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/click-button-if-enabled/if1.png" alt="The button was enabled"></p><p>When the current subject passes the jQuery assertion <code>if(&#39;enabled&#39;)</code>, the logic takes the &quot;IF&quot; command chain path, executing all commands between <code>cy.if</code> and <code>cy.else</code>. Let&#39;s see how it behaves when the button is disabled.</p><p><img src="../images/click-button-if-enabled/if2.png" alt="The button was disabled"></p><p>So, so easy. <strong>Tip:</strong> want to run more commands? Just stick <code>cy.then(callback)</code> inside the <code>if / else</code> chain:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>)</span><br><span class="line">  .<span class="title function_">if</span>(<span class="string">&#x27;enabled&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>($btn =&gt; &#123;</span><br><span class="line">    cy.<span class="title function_">log</span>(<span class="string">&#x27;Clicking the button&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">wrap</span>($btn).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">else</span>(<span class="string">&#x27;Nothing to click&#x27;</span>)</span><br></pre></td></tr></table></figure><p>I really enjoy using <code>cypress-if</code>, to be honest.</p><h2><span id="cypress-await-solution">cypress-await solution</span></h2><p>If you don&#39;t like working with the Cypress subjects and chains, I have <a href="https://github.com/bahmutov/cypress-await">cypress-await</a> plugin for you. It sets up a spec file preprocessor that rewrites specs:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in your spec</span></span><br><span class="line"><span class="keyword">const</span> value = cy.<span class="title function_">get</span>(...).<span class="title function_">should</span>(...).<span class="title function_">find</span>(...).<span class="title function_">invoke</span>(...)</span><br><span class="line"><span class="comment">// =&gt; use value</span></span><br><span class="line"><span class="comment">// becomes</span></span><br><span class="line">cy.<span class="title function_">get</span>(...)</span><br><span class="line">  .<span class="title function_">should</span>(...)</span><br><span class="line">  .<span class="title function_">find</span>(...)</span><br><span class="line">  .<span class="title function_">invoke</span>(...)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// =&gt; use value</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>It looks synchronous, but under the hood all Cypress retries are still executing for each chain before assigning the value. Our conditional test can be rewritten like this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(</span><br><span class="line">  <span class="string">&#x27;clicks on the button if it is enabled&#x27;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;cypress/fixtures/enabled-button.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> enabled = cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>).<span class="title function_">invoke</span>(<span class="string">&#x27;is&#x27;</span>, <span class="string">&#x27;:enabled&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">log</span>(<span class="string">`enabled? <span class="subst">$&#123;enabled&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Click Me&#x27;</span>).<span class="title function_">click</span>().<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Clicked&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cy.<span class="title function_">log</span>(<span class="string">&#x27;Nothing to click&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="../images/click-button-if-enabled/await.png" alt="The conditional test using cypress-await"></p><p>You can find more lessons on how to use <code>cypress-if</code> and <code>cypress-await</code> in my <a href="https://cypress.tips/courses/cypress-plugins">Cypress Plugins</a> course.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Imagine you have a button on the page. This button sometimes is enabled and sometimes is disabled. The test does not control the button (
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>My Favorite ImageMagick Convert Commands</title>
    <link href="https://glebbahmutov.com/blog/imagemagick/"/>
    <id>https://glebbahmutov.com/blog/imagemagick/</id>
    <published>2024-02-21T05:00:00.000Z</published>
    <updated>2024-05-14T15:52:18.662Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://imagemagick.org/">ImageMagick</a> is an amazing CLI image manipulation utility I have been using for 20 years. Here are some of the common PNG&#x2F;JPG&#x2F;etc commands I use.</p><h2><span id="add-solid-background-to-the-image">Add solid background to the image</span></h2><p>While keeping the original contents in the center. You need to know the output width &#x2F; height. For example to make the output image width 600 pixels with white border on both sides use the command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert input.png -background white -gravity center -extent 600 output.png</span><br></pre></td></tr></table></figure><h2><span id="combine-several-images-into-one-row">Combine several images into one row</span></h2><p>Use <code>+append</code> to create a single row. Use <code>-append</code> to create a column.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert image1.png image2.png image3.png ... +append output.png</span><br></pre></td></tr></table></figure><h2><span id="compute-average-image-color">Compute average image color</span></h2><p>See <a href="/blog/give-browser-a-chance/" title="Give browser a chance">Give browser a chance</a> blog post.</p><h2><span id="generate-an-image-with-solid-color">Generate an image with solid color</span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># hex format</span><br><span class="line">convert -size 100x100 xc:#ff00ff cyan.png</span><br><span class="line"># rgba format using quotes</span><br><span class="line">convert -size 100x1000 &#x27;xc:rgba(255, 0, 255, 0.5)&#x27; cyan.png</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://imagemagick.org/&quot;&gt;ImageMagick&lt;/a&gt; is an amazing CLI image manipulation utility I have been using for 20 years. Here are 
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
  </entry>
  
  <entry>
    <title>Quickly Run The Changed Specs on GitHub Actions</title>
    <link href="https://glebbahmutov.com/blog/quick-changed-specs/"/>
    <id>https://glebbahmutov.com/blog/quick-changed-specs/</id>
    <published>2024-02-14T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.570Z</updated>
    
    <content type="html"><![CDATA[<p>In the previous blog post <a href="/blog/trace-changed-specs/" title="Run Changed Traced Specs On GitHub Actions">Run Changed Traced Specs On GitHub Actions</a> I have explained how you can determine the Cypress specs that changed in the current pull request. In this post, I will show how to run them even quicker using GitHub Actions.</p><blockquote class="pullquote"><p>üéÅ You can find the source code for this blog post in the repo <a href="https://github.com/bahmutov/changed-specs-quickly-example">bahmutov&#x2F;changed-specs-quickly-example</a>.</p></blockquote><h2><span id="precompute-spec-dependencies">Precompute spec dependencies</span></h2><p>If you have multiple specs plus utilities, it makes sense to precompute their import graph and store it in a JSON file in the repo. We will use my tool <a href="https://github.com/bahmutov/spec-change">spec-change</a> to compute dependencies among spec files.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;trace-deps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spec-change --folder cypress --save-deps deps.json --time&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>We can run the <code>npm run trace-deps</code> command locally. Here is its partial outut</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ npm run trace-deps</span><br><span class="line"></span><br><span class="line">&gt; changed-specs-quickly-example@1.0.0 trace-deps</span><br><span class="line">&gt; spec-change --folder cypress --save-deps deps.json --time</span><br><span class="line"></span><br><span class="line">spec-change took 1523ms</span><br><span class="line">&#123;</span><br><span class="line">  &quot;e2e/utils.ts&quot;: [</span><br><span class="line">    &quot;e2e/adding-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/clear-completed-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/complete-all-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/editing-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/item-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/persistence-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/routing-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/spec.ts&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;e2e/model.d.ts&quot;: [</span><br><span class="line">    &quot;e2e/cast-fixture-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/fixture-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/import-fixture-spec.ts&quot;,</span><br><span class="line">    &quot;e2e/using-fixture-spec.ts&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;fixtures/todos.json&quot;: [</span><br><span class="line">    &quot;e2e/import-fixture-spec.ts&quot;</span><br><span class="line">  ],</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The file <code>cypress/e2e/utils.ts</code> is popular. Several specs depend on it. If this file changes, we would consider <code>e2e/adding-spec.ts</code>, <code>e2e/clear-completed-spec.ts</code> and others changed too.</p><p>We can periodically update the <code>deps.json</code> file on CI using a job like this:</p><figure class="highlight yml"><figcaption><span>.github/workflows/spec-dependencies.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this workflow computes the dependencies between Cypress spec</span></span><br><span class="line"><span class="comment"># source files every day and saves it to the file deps.json</span></span><br><span class="line"><span class="comment"># and pushes any changes back to the origin.</span></span><br><span class="line"><span class="comment"># This lets the pull requests quickly determine which spec</span></span><br><span class="line"><span class="comment"># files to re-run by looking at the changes</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">spec</span> <span class="string">dependencies</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;0 4 * * *&#x27;</span></span><br><span class="line">  <span class="comment"># trigger this workflow from GitHub Actions UI</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">find-dependencies:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Find</span> <span class="string">source</span> <span class="string">dependencies</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">spec-change</span> <span class="string">üì¶</span></span><br><span class="line">        <span class="comment"># https://github.com/bahmutov/npm-install</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># use just package.json checksum</span></span><br><span class="line">          <span class="attr">useLockFile:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">install-command:</span> <span class="string">&#x27;npm install spec-change&#x27;</span></span><br><span class="line">          <span class="attr">cache-key-prefix:</span> <span class="string">&#x27;spec-change&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Find</span> <span class="string">Cypress</span> <span class="string">spec</span> <span class="string">dependencies</span> <span class="string">üß±</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">trace-deps</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Commit</span> <span class="string">any</span> <span class="string">changed</span> <span class="string">files</span> <span class="string">üíæ</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">stefanzweifel/git-auto-commit-action@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">Updated</span> <span class="string">Cypress</span> <span class="string">spec</span> <span class="string">dependencies</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">          <span class="attr">file_pattern:</span> <span class="string">deps.json</span></span><br></pre></td></tr></table></figure><p>The install step installs <em>only</em> the <code>spec-change</code> NPM dependency and caches it by caching the <code>~/.npm</code> folder. We don&#39;t want to install all dependencies, and we don&#39;t want to download the Cypress binary.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">spec-change</span> <span class="string">üì¶</span></span><br><span class="line">  <span class="comment"># https://github.com/bahmutov/npm-install</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># use just package.json checksum</span></span><br><span class="line">    <span class="attr">useLockFile:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">install-command:</span> <span class="string">&#x27;npm install spec-change&#x27;</span></span><br><span class="line">    <span class="attr">cache-key-prefix:</span> <span class="string">&#x27;spec-change&#x27;</span></span><br></pre></td></tr></table></figure><h2><span id="run-changed-specs-first">Run changed specs first</span></h2><p>When a user opens a pull request, they probably have modified some specs. We want to run the modified specs first, and if they pass, we would like to run all specs. We can find the changed between the current branch and the main branch using the <a href="https://github.com/bahmutov/find-cypress-specs">find-cypress-specs</a> utility. We can use either simple Git file change or trace dependencies.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;trace-deps&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spec-change --folder cypress --save-deps deps.json --time&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;changed-specs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;find-cypress-specs --branch main --parent&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trace-changed-specs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;find-cypress-specs --branch main --parent --trace-imports cypress --cache-trace&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>I prefer using the trace so that any change to the <code>utils.ts</code> forces the spec files that import it to run. Here is our workflow to determine the changed spec files.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">PR</span> <span class="string">checks</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">pull_request</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">find-changed-specs:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">changedSpecs:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.changedSpecs</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">changedSpecsN:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.changedSpecsN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">machinesNeeded:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.machinesNeeded</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># need to fetch info about all branches</span></span><br><span class="line">          <span class="comment"># to determine the changed spec files</span></span><br><span class="line">          <span class="comment"># https://glebbahmutov.com/blog/faster-ci-feedback/</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">find-cypress-specs</span> <span class="string">üì¶</span></span><br><span class="line">        <span class="comment"># https://github.com/bahmutov/npm-install</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># use just package.json checksum</span></span><br><span class="line">          <span class="attr">useLockFile:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">install-command:</span> <span class="string">&#x27;npm install find-cypress-specs&#x27;</span></span><br><span class="line">          <span class="attr">cache-key-prefix:</span> <span class="string">&#x27;find-cypress-specs&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Trace</span> <span class="string">changed</span> <span class="string">specs</span></span><br><span class="line">        <span class="comment"># against the &quot;main&quot; branch</span></span><br><span class="line">        <span class="comment"># and including changed files imported by specs</span></span><br><span class="line">        <span class="comment"># and compute how many machines we need to</span></span><br><span class="line">        <span class="comment"># run changed the changed specs in parallel</span></span><br><span class="line">        <span class="comment"># https://github.com/bahmutov/find-cypress-specs</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">trace</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm run trace-changed-specs -- \</span></span><br><span class="line"><span class="string">            --set-gha-outputs --gha-summary \</span></span><br><span class="line"><span class="string">            --specs-per-machine 2 \</span></span><br><span class="line"><span class="string">            --max-machines 3</span></span><br></pre></td></tr></table></figure><p>Notice the last job &quot;Trace changed specs&quot; has an id &quot;trace&quot;. This job produces outputs, like the list of changed specs, the number of changed specs, and even the recommended number of machines to use to run the changed specs in parallel. We expose these outputs from the job <code>find-changed-specs</code>:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">find-changed-specs:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">changedSpecs:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.changedSpecs</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">changedSpecsN:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.changedSpecsN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">machinesNeeded:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.trace.outputs.machinesNeeded</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s pretend we modified the <code>utils.ts</code> file and opened a pull request. The workflow runs and detects all the specs that rely on <code>utils.ts</code> file</p><p><img src="../images/quick-changed-specs/q1.png" alt="We found 8 specs that are changed in this pull request"></p><h2><span id="the-workflow">The workflow</span></h2><p>After finding the changed specs, we should quickly run them. First, we run all changed specs across the N recommended machines. Then we want ti run the other specs, also in parallel. Here is how we can do it using <a href="https://github.com/bahmutov/cypress-workflows">bahmutov&#x2F;cypress-workflows</a> reusable GitHub workflows. This is the rest of the PR workflow shown above; two jobs are after the &quot;find-changed-specs&quot; job.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run all changed specs in parallel</span></span><br><span class="line"><span class="attr">changed-specs:</span></span><br><span class="line">  <span class="attr">needs:</span> <span class="string">find-changed-specs</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.find-changed-specs.outputs.changedSpecsN</span> <span class="string">&gt;</span> <span class="number">0</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># https://github.com/bahmutov/cypress-workflows</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/cypress-workflows/.github/workflows/split.yml@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.find-changed-specs.outputs.changedSpecs</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="comment"># convert the output string to a number</span></span><br><span class="line">    <span class="attr">nE2E:</span> <span class="string">$&#123;&#123;</span> <span class="string">fromJson(needs.find-changed-specs.outputs.machinesNeeded)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">start:</span> <span class="string">&#x27;npm start&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run other specs in parallel IF changes specs passed</span></span><br><span class="line"><span class="attr">other-specs:</span></span><br><span class="line">  <span class="attr">needs:</span> [<span class="string">find-changed-specs</span>, <span class="string">changed-specs</span>]</span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/cypress-workflows/.github/workflows/split.yml@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># we already have done the changed specs</span></span><br><span class="line">    <span class="comment"># now let&#x27;s run all other specs</span></span><br><span class="line">    <span class="attr">skip-spec:</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.find-changed-specs.outputs.changedSpecs</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">nE2E:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">start:</span> <span class="string">&#x27;npm start&#x27;</span></span><br></pre></td></tr></table></figure><p>We take the <code>find-changed-specs</code> job&#39;s outputs and make two jobs, both using the <code>split</code> workflow from <code>bahmutov/cypress-workflows</code>. I used just two machines to run the rest of the specs. In the future I hope to compute a good number of machines based on the specs.</p><p><img src="../images/quick-changed-specs/q2.png" alt="The output from the machines running the changed specs"></p><p>You can find the full workflow and source code in the repo <a href="https://github.com/bahmutov/changed-specs-quickly-example">bahmutov&#x2F;changed-specs-quickly-example</a>.</p><h2><span id="see-more">See more</span></h2><ul><li>üìù blog post <a href="/blog/trace-changed-specs/" title="Run Changed Traced Specs On GitHub Actions">Run Changed Traced Specs On GitHub Actions</a></li><li>üíª utility <a href="https://github.com/bahmutov/spec-change">spec-change</a></li><li>üíª utility <a href="https://github.com/bahmutov/find-cypress-specs">find-cypress-specs</a></li><li>üß© plugin <a href="https://github.com/bahmutov/cypress-split">cypress-split</a></li><li>üèóÔ∏è GH action <a href="https://github.com/bahmutov/npm-install">bahmutov&#x2F;npm-install</a></li><li>üèóÔ∏è GH workflows <a href="https://github.com/bahmutov/cypress-workflows">cypress-workflows</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;In the previous blog post &lt;a href=&quot;/blog/trace-changed-specs/&quot; title=&quot;Run Changed Traced Specs On GitHub Actions&quot;&gt;Run Changed Traced Spec
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
      <category term="ci" scheme="https://glebbahmutov.com/blog/tags/ci/"/>
    
  </entry>
  
  <entry>
    <title>Use Cypress For API Testing</title>
    <link href="https://glebbahmutov.com/blog/use-cypress-for-api-testing/"/>
    <id>https://glebbahmutov.com/blog/use-cypress-for-api-testing/</id>
    <published>2024-02-08T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.617Z</updated>
    
    <content type="html"><![CDATA[<p>Cypress is known as an End-To-End test runner, but it can happily run component, unit, and even API tests. I have projects that use Cypress just for API testing. It works pretty nicely: rich set of commands and assertions, good user interface, easy to run on CI. Using plugins like <a href="https://github.com/bahmutov/cy-api">@bahmutov&#x2F;cy-api</a> and <a href="https://github.com/filiphric/cypress-plugin-api">cypress-plugin-api</a> you can even give API tests nice graphical interface inside the browser.</p><p>In this blog post I will give examples of Cypress api tests using the <a href="https://github.com/bahmutov/use-cypress-for-api-testing">use-cypress-for-api-testing</a> application as my example. The application is a simple TodoMVC web application on top of REST API. There are endpoints to create, delete, and modify Todo items, plus an endpoint to reset the data:</p><ul><li><code>GET /todos</code> returns all todo items</li><li><code>POST /todos</code> adds a new todo item</li><li><code>PATCH /todos/:id</code> updates the given todo item</li><li><code>DELETE /todos/:id</code> deletes on todo item</li><li><code>POST /reset</code> replaces the entire backend data with the given object</li></ul><p>Let&#39;s write a few API tests.</p><h2><span id="table-of-contents">Table of Contents</span></h2><!-- toc --><ul><li><a href="#adding-new-todos">Adding new todos</a></li><li><a href="#update-an-item">Update an item</a></li><li><a href="#delete-an-item">Delete an item</a></li><li><a href="#show-more-data-during-assertions">Show more data during assertions</a></li><li><a href="#show-the-full-request-and-response">Show the full request and response</a></li><li><a href="#complex-data-assertions">Complex data assertions</a></li><li><a href="#async-mode">Async mode</a></li><li><a href="#run-tests-on-ci">Run tests on CI</a></li><li><a href="#loop-through-data">Loop through data</a></li><li><a href="#produce-detailed-report">Produce detailed report</a></li><li><a href="#combine-api-and-web-testing">Combine API and Web testing</a></li><li><a href="#final-thoughts">Final thoughts</a></li><li><a href="#see-also">See also</a></li></ul><!-- tocstop --><h2><span id="adding-new-todos">Adding new todos</span></h2><p>Let&#39;s write a simple API test that resets all todos, adds a todo, then fetches all items. We will use the core Cypress command <a href="https://on.cypress.io/request">cy.request</a> to make all HTTP calls</p><figure class="highlight js"><figcaption><span>cypress/e2e/api.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;adds one item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// clear all existing backend data</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">    <span class="comment">// confirm there are no todo items</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// add a new todo item</span></span><br><span class="line">    <span class="keyword">const</span> todo = &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">      <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">    <span class="comment">// confirm all todos now has a single item</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [todo])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes. There is nothing to render in the Cypress application frame on the right, since we never did <code>cy.visit</code> in the test. Still, the Command Log on the left shows every API test command.</p><p><img src="../images/use-cypress-for-api-testing/api1.png" alt="The passing API test"></p><p>If we are using the Cypress interactive mode <code>cypress open</code> we can click on the <code>REQUEST</code> command to see the request and the response. For example, let&#39;s examine the <code>cy.request(&#39;POST&#39;, &#39;/todos&#39;, todo)</code> command</p><p><img src="../images/use-cypress-for-api-testing/api2.png" alt="Inspect the new item sent by the test"></p><p>When using the interactive <code>cypress open</code> mode you can inspect each call by clicking on the command.</p><h2><span id="update-an-item">Update an item</span></h2><p>Once we know our backend API supports adding and fetching new items, let&#39;s confirm that we can complete an item.</p><figure class="highlight js"><figcaption><span>cypress/e2e/api.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;completes an item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// clear all existing backend data</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">    <span class="comment">// add a new todo item</span></span><br><span class="line">    <span class="keyword">const</span> todo = &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">      <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">    <span class="comment">// complete an item by patching the existing item</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;/todos/1&#x27;</span>, &#123; <span class="attr">completed</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    <span class="comment">// confirm the item is now completed</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [</span><br><span class="line">        &#123;</span><br><span class="line">          ...todo,</span><br><span class="line">          <span class="attr">completed</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/complete.png" alt="Complete an item API test"></p><h2><span id="delete-an-item">Delete an item</span></h2><p>Let&#39;s confirm that we can delete an item using an API call. We can take a shortcut and set the backend data using <code>POST /reset</code> instead of creating individual items via <code>POST /todos</code>. We know that adding items is working from the first test.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;deletes an item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// set several todos at once</span></span><br><span class="line">    <span class="keyword">const</span> todos = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;write another test&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; todos &#125;)</span><br><span class="line">    <span class="comment">// delete the first item</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;/todos/1&#x27;</span>)</span><br><span class="line">    <span class="comment">// confirm the remaining items</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [todos[<span class="number">1</span>]])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/delete.png" alt="Deleting an item via API works"></p><h2><span id="show-more-data-during-assertions">Show more data during assertions</span></h2><p>In our tests we used the built-in Chai assertions like <code>deep.equal</code>. By default, these assertions truncate the data shown in the Command Log. Let&#39;s increase the truncation threshold to see more information.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// show more information in each assertion</span></span><br><span class="line">chai.<span class="property">config</span>.<span class="property">truncateThreshold</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/truncate.png" alt="Short objects are shown fully in the Chai assertions"></p><h2><span id="show-the-full-request-and-response">Show the full request and response</span></h2><p>Since we have an empty web application frame on the right and want to see more information for each request, let&#39;s redirect the request &#x2F; response to the frame. I will use the <a href="https://github.com/filiphric/cypress-plugin-api">cypress-plugin-api</a> plugin to give my API tests a nice UI.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/filiphric/cypress-plugin-api</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-plugin-api&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// show more information in each assertion</span></span><br><span class="line">chai.<span class="property">config</span>.<span class="property">truncateThreshold</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;deletes an item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// set several todos at once</span></span><br><span class="line">    <span class="keyword">const</span> todos = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;write another test&#x27;</span>,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">    cy.<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; todos &#125;)</span><br><span class="line">    <span class="comment">// delete the first item</span></span><br><span class="line">    cy.<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;/todos/1&#x27;</span>)</span><br><span class="line">    <span class="comment">// confirm the remaining items</span></span><br><span class="line">    cy.<span class="title function_">api</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [todos[<span class="number">1</span>]])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We simply imported the plugin and used <code>cy.api</code> instead of <code>cy.request</code> to make the calls. The Cypress UI is now much nicer.</p><p><img src="../images/use-cypress-for-api-testing/plugin.png" alt="cypress-plugin-api reflects each request and response in the web application frame"></p><p>We can even combine <code>cy.request</code> and <code>cy.api</code> to only show the relevant test information. For example, we might not want to see the <code>POST /reset</code> calls while being interested in the other calls in the test:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;completes an item&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all existing backend data</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="comment">// add a new todo item</span></span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">  <span class="comment">// complete an item by patching the existing item</span></span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;/todos/1&#x27;</span>, &#123; <span class="attr">completed</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  <span class="comment">// confirm the item is now completed</span></span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;deep.equal&#x27;</span>, [</span><br><span class="line">      &#123;</span><br><span class="line">        ...todo,</span><br><span class="line">        <span class="attr">completed</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/combine.png" alt="Combine cy.request and cy.api commands"></p><h2><span id="complex-data-assertions">Complex data assertions</span></h2><p>When creating a new item using <code>POST /todos</code> call, the app sends the item, and the server responds with the same item. If the sent item does not include the <code>id</code> property, the server will assign one. The server signals the success by returning status code 201. Let&#39;s confirm this.</p><figure class="highlight js"><figcaption><span>cypress/e2e/api.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;gets an id from the server&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(response.<span class="property">status</span>, <span class="string">&#x27;status code&#x27;</span>).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="number">201</span>)</span><br><span class="line">    <span class="comment">// we don&#x27;t know what id the server will assign</span></span><br><span class="line">    <span class="comment">// thus we cannot compare the whole response body</span></span><br><span class="line">    <span class="title function_">expect</span>(response.<span class="property">body</span>, <span class="string">&#x27;body&#x27;</span>).<span class="property">to</span>.<span class="property">deep</span>.<span class="title function_">include</span>(todo)</span><br><span class="line">    <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">id</span>, <span class="string">&#x27;id&#x27;</span>).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">a</span>(<span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/id.png" alt="The assigned id test"></p><p>The test is becoming verbose, and the Command Log is getting noisy. Let&#39;s use <a href="https://github.com/bahmutov/cy-spok">cy-spok</a> plugin to make our assertions more powerful.</p><figure class="highlight js"><figcaption><span>cypress/e2e/api.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/filiphric/cypress-plugin-api</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-plugin-api&#x27;</span></span><br><span class="line"><span class="comment">// https://github.com/bahmutov/cy-spok</span></span><br><span class="line"><span class="keyword">import</span> spok <span class="keyword">from</span> <span class="string">&#x27;cy-spok&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;gets an id from the server (cy-spok)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo).<span class="title function_">should</span>(</span><br><span class="line">    <span class="title function_">spok</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="number">201</span>,</span><br><span class="line">      <span class="attr">body</span>: &#123;</span><br><span class="line">        ...todo,</span><br><span class="line">        <span class="attr">id</span>: spok.<span class="property">number</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Using a single <code>cy-spok</code> assertion we can match complex objects with nested properties and predicate checks.</p><p><img src="../images/use-cypress-for-api-testing/spok.png" alt="The nice cy-spok assertions"></p><h2><span id="async-mode">Async mode</span></h2><p>Often API tests get something from the server and use that piece of data to make new calls. For example, if we want to get the ID of the created item to delete it, we could write the following test</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;deletes the created item using its id&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">    <span class="comment">// any time we get something from the application</span></span><br><span class="line">    <span class="comment">// we need to &quot;pass it forward&quot; into the next command</span></span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">`/todos/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">its</span>(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="number">200</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Anytime the test gets something from the application, it needs to pass it forward to the <code>cy.then(callback)</code> or to the next assertion. Some people are intimidated by such coding style; they miss <code>async / await</code> syntax. For them I wrote <a href="https://github.com/bahmutov/cypress-await">cypress-await</a> plugin that allows you to use the <code>await</code> syntax with the Cypress command chains. Here is how we can rewrite the above test:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/filiphric/cypress-plugin-api</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-plugin-api&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;deletes the created item using its id (cypress-await)&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">await</span> cy</span><br><span class="line">    .<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> cy.<span class="title function_">log</span>(<span class="string">`deleting todo <span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">await</span> cy</span><br><span class="line">    .<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">`/todos/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="number">200</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test works the same, but it might be more intuitive to read.</p><p><img src="../images/use-cypress-for-api-testing/async.png" alt="Using await in Cypress tests via cypress-await plugin"></p><p><strong>Bonus:</strong> cypress-await plugin includes a sync mode which allows you to drop the verbose <code>await</code> in front of every <code>cy</code> command. The test runs the same and becomes simply:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sync mode from cypress-await</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;deletes the created item using its id (cypress-await)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  <span class="keyword">const</span> todo = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;write a test&#x27;</span>,</span><br><span class="line">    <span class="attr">completed</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> id = cy</span><br><span class="line">    .<span class="title function_">api</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, todo)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`deleting todo <span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">`/todos/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="number">200</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="run-tests-on-ci">Run tests on CI</span></h2><p>We want to run API tests on CI from day one. Let&#39;s use <a href="/blog/trying-github-actions/" title="GitHub Actions">GitHub Actions</a>. We can use <a href="https://github.com/cypress-io/github-action">cypress-io&#x2F;github-action</a> to manage dependencies, caching, and running Cypress for us:</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">tests:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="comment"># Install NPM dependencies, cache them correctly</span></span><br><span class="line">      <span class="comment"># and run all Cypress tests</span></span><br><span class="line">      <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># check the spec types</span></span><br><span class="line">          <span class="attr">build:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">lint</span></span><br><span class="line">          <span class="comment"># start the application before running Cypress</span></span><br><span class="line">          <span class="attr">start:</span> <span class="string">npm</span> <span class="string">start</span></span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/ci.png" alt="Running Cypress tests on GitHub Actions"></p><p>Beautiful. Want even more power? Learn how to run tests in parallel using GitHub Actions in <a href="https://youtu.be/jvBzNs0pRXU">this video</a>. In general, Cypress API tests running in the browser are slower than an equivalent Node-only API tests. But the debugging is faster, and on CI I can parallelize the tests using a one minute change; see <a href="https://github.com/bahmutov/cypress-split">cypress-split</a> and <a href="https://github.com/bahmutov/cypress-workflows">cypress-workflows</a>.</p><h2><span id="loop-through-data">Loop through data</span></h2><p>Because Cypress queues up its commands, it is easy to iterate over collections. For example, let&#39;s see how we can delete each item one by one</p><figure class="highlight js"><figcaption><span>cypress/e2e/delete.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/filiphric/cypress-plugin-api</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-plugin-api&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// show more information in each assertion</span></span><br><span class="line">chai.<span class="property">config</span>.<span class="property">truncateThreshold</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// load the fixture with four todos</span></span><br><span class="line">    cy.<span class="title function_">fixture</span>(<span class="string">&#x27;four-todos&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;data&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we can access the fixture data using &quot;this.data&quot;</span></span><br><span class="line">  <span class="comment">// inside the &quot;it... function () &#123;&#125;&quot;</span></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;deletes all items one by one&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">expect</span>(<span class="variable language_">this</span>.<span class="property">data</span>, <span class="string">&#x27;loaded todos&#x27;</span>)</span><br><span class="line">      .<span class="property">to</span>.<span class="property">have</span>.<span class="title function_">property</span>(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">      .<span class="property">and</span>.<span class="property">have</span>.<span class="title function_">length</span>(<span class="number">4</span>)</span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, <span class="variable language_">this</span>.<span class="property">data</span>)</span><br><span class="line">    <span class="comment">// confirm there are four todo items</span></span><br><span class="line">    cy.<span class="title function_">api</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="comment">// delete each item one by one</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">todos</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">todo</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">`/todos/<span class="subst">$&#123;todo.id&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// there should be no todos left</span></span><br><span class="line">    cy.<span class="title function_">api</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">      .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The expression to delete each Todo item simply queues up 4 Cypress commands:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// delete each item one by one</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">todos</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">todo</span>) =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">api</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">`/todos/<span class="subst">$&#123;todo.id&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/use-cypress-for-api-testing/delete-all.png" alt="Deleting each todo one by one"></p><h2><span id="produce-detailed-report">Produce detailed report</span></h2><p>Since API tests do not use the browser to show the web page, there is less information to go on when the test fails. We can produce detailed terminal log (stdout and even JSON) using the plugin <a href="https://github.com/archfz/cypress-terminal-report">cypress-terminal-report</a>. Here is an example terminal report output for the above &quot;deletes all items one by one&quot; test produced.</p><p><img src="../images/use-cypress-for-api-testing/terminal.png" alt="Terminal report for the API test"></p><h2><span id="combine-api-and-web-testing">Combine API and Web testing</span></h2><p>Finally, a nice feature of Cypress API tests is how easy it is to combine them with the UI web tests. Let&#39;s see one such example. The example application reloads all todos every minute:</p><figure class="highlight js"><figcaption><span>todomvc/app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// how would you test the periodic loading of todos?</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;loadTodos&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">60_000</span>)</span><br></pre></td></tr></table></figure><p>Let&#39;s write a test that <em>quickly</em> tests this feature. We will create the initial data using API calls, then visit the site and confirm the initial list is visible. Then we can delete an item using an API call, fast-forward the app clock by 1 minute, and confirm the web view has updated and shows N - 1 todos.</p><figure class="highlight js"><figcaption><span>cypress/e2e/mixed-test.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// show more information in each assertion</span></span><br><span class="line">chai.<span class="property">config</span>.<span class="property">truncateThreshold</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;TodoMVC API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;reloads the todos every minute&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">fixture</span>(<span class="string">&#x27;four-todos&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, data)</span><br><span class="line">    &#125;)</span><br><span class="line">    cy.<span class="title function_">clock</span>()</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todo-list li&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="comment">// delete the first todo</span></span><br><span class="line">    <span class="comment">// use cy.request and not cy.api to avoid</span></span><br><span class="line">    <span class="comment">// overwriting the web application</span></span><br><span class="line">    cy.<span class="title function_">request</span>(<span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;/todos/101&#x27;</span>)</span><br><span class="line">    <span class="comment">// advance the clock by 1 minute</span></span><br><span class="line">    cy.<span class="title function_">tick</span>(<span class="number">60_000</span>)</span><br><span class="line">    <span class="comment">// confirm the new data has loaded</span></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;.todo-list li&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>I am using <a href="https://on.cypress.io/clock">cy.clock</a> and <a href="https://on.cypress.io/tick">cy.tick</a> commands to control the web application&#39;s clock. In between, we are deleting the data using the <code>cy.request(&#39;DELETE&#39;, &#39;/todos/101&#39;)</code> command.</p><p><img src="../images/use-cypress-for-api-testing/clock.png" alt="Test time-depending app features by controlling the clock"></p><p>For more clock examples, see <a href="https://glebbahmutov.com/cypress-examples/commands/spies-stubs-clocks.html">Spies, Stubs &amp; Clocks</a>.</p><h2><span id="final-thoughts">Final thoughts</span></h2><p>Cypress can be a powerful API testing tool. It has good API, assertions, and a visual interactive test runner great for seeing the test run. It also can be extended using open source plugins to provide even better API testing experience.</p><h2><span id="see-also">See also</span></h2><ul><li>üéì Course <a href="https://cypress.tips/courses/cypress-plugins">Cypress Plugins</a> has lessons covering <code>cy-api</code>, <code>cy-spok</code>, <code>cypress-plugin-api</code>, and lots of other plugins</li><li>üéì Course <a href="https://cypress.tips/courses/network-testing">Cypress Network Testing Exercises</a> teaches advanced network testing through hands-on exercises</li><li><a href="/blog/test-using-apis/" title="You Should Test More Using APIs">You Should Test More Using APIs</a></li><li><a href="/blog/ui-to-api-to-app-actions/" title="Change E2E Tests From UI To API To App Actions">Change E2E Tests From UI To API To App Actions</a></li><li><a href="/blog/api-testing-with-server-logs/" title="Black box API testing with server logs">Black box API testing with server logs</a></li><li><a href="/blog/realworld-app-action/" title="How to write end-to-end test using app and api actions">How to write end-to-end test using app and api actions</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Cypress is known as an End-To-End test runner, but it can happily run component, unit, and even API tests. I have projects that use Cypre
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Cypress Flakiness Examples</title>
    <link href="https://glebbahmutov.com/blog/flakiness-example/"/>
    <id>https://glebbahmutov.com/blog/flakiness-example/</id>
    <published>2024-01-19T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.528Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I watched <a href="https://filiphric.com/">Filip Hric</a> YT livestream <a href="https://www.youtube.com/watch?v=fFw-FkXk3ec">Debugging test flakes in Cypress</a>. Good video. He has shown several examples of flaky tests caused by the bad test design. In this blog post, I will give my take on the solid test design that avoids all shown pitfalls.</p><!-- toc --><ul><li><a href="#the-application">The application</a></li><li><a href="#the-loading">The loading</a><ul><li><a href="#the-loading-time">The loading time</a></li></ul></li><li><a href="#the-number-of-items">The number of items</a></li><li><a href="#active-subscriptions">Active subscriptions</a></li><li><a href="#sample-data">Sample data</a></li><li><a href="#github-copilot-trick">GitHub Copilot trick</a></li><li><a href="#the-data-edge-case">The data edge case</a></li><li><a href="#control-the-data">Control the data</a></li><li><a href="#response-data-changes">Response data changes</a><ul><li><a href="#api-test">API test</a></li><li><a href="#network-spy-test">Network spy test</a></li></ul></li><li><a href="#see-also">See also</a></li></ul><!-- tocstop --><blockquote class="pullquote"><p>üéÅ The source code for this blog post is in the public repo <a href="https://github.com/bahmutov/cypress-flakiness-debug-examples">bahmutov&#x2F;cypress-flakiness-debug-examples</a>. I have grabbed the initial code from <a href="https://github.com/filiphric/cypress-flakiness-debug-examples">filiphric&#x2F;cypress-flakiness-debug-examples</a> branch <code>customer-subscriptions</code>. The examples in this blog post are using the application and the tests in the subfolder <code>customer-subscriptions</code>.</p></blockquote><h2><span id="the-application">The application</span></h2><p>The application displays a list of subscriptions. Some subscriptions are active and some are not.</p><p><img src="../images/flakiness-example/e1.png" alt="Customer subscriptions app"></p><p>The list is generated dynamically using <a href="https://github.com/faker-js/faker#readme">@faker-js&#x2F;faker</a> module. The number of items can be from 1 to 6:</p><figure class="highlight ts"><figcaption><span>customer-subscriptions/src/modules/generateCustomers.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; faker &#125; <span class="keyword">from</span> <span class="string">&#x27;@faker-js/faker&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Subscription</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@/interfaces/subscription&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">generateCustomers</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">customers</span>: <span class="title class_">Subscription</span>[] = []</span><br><span class="line">  <span class="keyword">let</span> customerCount = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">6</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; customerCount; index++) &#123;</span><br><span class="line">    <span class="keyword">let</span> firstName = faker.<span class="property">person</span>.<span class="title function_">firstName</span>()</span><br><span class="line">    <span class="keyword">let</span> lastName = faker.<span class="property">person</span>.<span class="title function_">lastName</span>()</span><br><span class="line">    <span class="keyword">let</span> status = [<span class="string">&#x27;active&#x27;</span>, <span class="string">&#x27;inactive&#x27;</span>, <span class="string">&#x27;trial&#x27;</span>] <span class="keyword">as</span> <span class="keyword">const</span></span><br><span class="line"></span><br><span class="line">    customers.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>: faker.<span class="property">string</span>.<span class="title function_">uuid</span>(),</span><br><span class="line">      <span class="attr">fullName</span>: <span class="string">`<span class="subst">$&#123;firstName&#125;</span> <span class="subst">$&#123;lastName&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">email</span>: faker.<span class="property">internet</span>.<span class="title function_">exampleEmail</span>(&#123; firstName, lastName &#125;),</span><br><span class="line">      <span class="attr">status</span>: status[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">3</span>)],</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> customers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There is also a loading &quot;splash&quot; screen before the items load.</p><figure class="highlight ts"><figcaption><span>customer-subscriptions/src/components/SubscriptionList.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Fetch subscriptions from API</span></span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">&#x27;/api/subscriptions&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network response was not ok&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> response.<span class="title function_">json</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setSubscriptions</span>(data)</span><br><span class="line">      <span class="title function_">setLoading</span>(<span class="literal">false</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setError</span>(error.<span class="property">message</span>)</span><br><span class="line">      <span class="title function_">setLoading</span>(<span class="literal">false</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (loading) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Error: &#123;error&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let&#39;s see how Cypress end-to-end tests for this app can be flaky or solid.</p><h2><span id="the-loading">The loading</span></h2><p>If you just started the application, the webserver might take longer to bundle and return the homepage, especially in the dev mode. To better simulate the unpredictable initial load, I will add a random delay between 1 and 11 seconds to the <code>fetch</code> call.</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Fetch subscriptions from API</span></span><br><span class="line">      <span class="title function_">fetch</span>(<span class="string">&#x27;/api/subscriptions&#x27;</span>)</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10_000</span> + <span class="number">1000</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure><p>Here is the first test as shown by Filip. It is flaky <em>on purpose</em>. Can you see at least two potential problems?</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> randomItem = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>).<span class="title function_">eq</span>(randomItem).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3><span id="the-loading-time">The loading time</span></h3><p>The first problem we see when running the test is the command <code>cy.get(&#39;[data-cy=customer-item]&#39;)</code> failing.</p><p><img src="../images/flakiness-example/e2.png" alt="The test fails to find any items"></p><p>The test runner simply did not &quot;see&quot; the subscriptions list in time. To determine it, click on the failed command <code>GET</code> and look at the restored DOM snapshot: the app was still showing the &quot;Loading&quot; message.</p><p><img src="../images/flakiness-example/e3.png" alt="The app snapshot at the moment the GET command failed"></p><p>But sometimes the test succeeds. If you inspect the same command <code>GET</code> using the time-traveling debugger, instead of &quot;Loading&quot; you see the items.</p><p><img src="../images/flakiness-example/e4.png" alt="The app snapshot at the moment the GET command succeeded"></p><p>This is test flake: depending on the application&#39;s speed the same command step fails or succeeds. We need to take the maximum loading time into the account. The error message &quot;Timed out retrying after 4000ms: Expected to find element: <code>[data-cy=customer-item]</code>, but never found it.&quot; tells us the solution: we must increase the timeout for the <code>GET</code> command because the application might not show the items until after 11 seconds passed. Let&#39;s fix the test:</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">  .<span class="title function_">eq</span>(randomItem)</span><br><span class="line">  .<span class="title function_">click</span>()</span><br></pre></td></tr></table></figure><p>The command now retries for 11 seconds instead of the default 4. You can see the slower progress bar.</p><p><img src="../images/flakiness-example/progress.gif" alt="The GET command can retry finding items up to 11 seconds"></p><h2><span id="the-number-of-items">The number of items</span></h2><p>Here is the second problem with the test. The application can show between 1 and 6 items. The test picks a random index between 1 and 6. If the test picks an index larger than the random number of items, the test will fail, since there is no such item. We must pick one of the <em>existing</em> items. Filip changed his test to do so:</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;length&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">numberOfItems</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, numberOfItems - <span class="number">1</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>).<span class="title function_">eq</span>(randomItem).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote class="pullquote"><p>üí° If you do need to pick a random number between min and max in your Cypress tests, please use the bundled <a href="https://lodash.com/docs">Lodash</a> function <a href="https://lodash.com/docs/4.17.15#random">_.random</a>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instead of this</span></span><br><span class="line"><span class="keyword">let</span> randomItem = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">7</span>)</span><br><span class="line"><span class="comment">// use Cypress._.random function</span></span><br><span class="line"><span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, <span class="number">6</span>)</span><br></pre></td></tr></table></figure></blockquote><p>The above test is good. I would also print the picked item index to make it very clear which item we are subscribing to. It certainly removes the flake from trying to pick an item that is not there.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">numberOfItems</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, numberOfItems - <span class="number">1</span>)</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`Activating subscription for item #<span class="subst">$&#123;randomItem&#125;</span>`</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>).<span class="title function_">eq</span>(randomItem).<span class="title function_">click</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2><span id="active-subscriptions">Active subscriptions</span></h2><p>The test is less flaky than before but occasionally it still fails. Here is a good example of the failing test:</p><p><img src="../images/flakiness-example/e5.png" alt="The test fails to activate the subscription"></p><p>We only have one item, so we pick it to activate the subscription. But the item is <em>already</em> active. We cannot click on it to activate again. When picking an item, we must only consider the items that are &quot;trial&quot; or &quot;inactive&quot;.</p><p><img src="../images/flakiness-example/e6.png" alt="Can only activate trial or inactive subscriptions"></p><p>We can look at the HTML markup to see if the &quot;trial&quot; and &quot;inactive&quot; items have any HTML attributes that we can use to easily query them while omitting the &quot;active&quot; subscriptions.</p><p><img src="../images/flakiness-example/e7.png" alt="Subscription items HTML markup"></p><p>Hmm, nothing. No biggie, we can add <code>data-status</code> attribute to our <code>SubscriptionItem</code> component.</p><figure class="highlight tsx"><figcaption><span>customer-subscriptions/src/components/SubscriptionItem.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">SubscriptionItem</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">SubscriptionItemProps</span>&gt; = <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">  subscription,</span></span></span><br><span class="line"><span class="params"><span class="function">  onOpenModal,</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">className</span>=<span class="string">&quot;flex items-center cursor-pointer hover:bg-slate-100 px-4 py-2 rounded-md&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">data-cy</span>=<span class="string">&quot;customer-item&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">data-status</span>=<span class="string">&#123;subscription.status&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> onOpenModal(subscription)&#125;</span></span><br><span class="line"><span class="language-xml">    &gt;</span></span><br><span class="line"><span class="language-xml">    ...</span></span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> I use separate <code>data-</code> attribute to pass the status following the advice in my blog post <a href="/blog/no-id-in-test-ids/" title="Do Not Put Ids Into Test Ids">Do Not Put Ids Into Test Ids</a>.</p><p>Now our test can be very explicit and only consider the &quot;trial&quot; or &quot;inactive&quot; items by using the <code>OR</code> CSS selector.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&#x27;[data-cy=customer-item][data-status=trial], [data-cy=customer-item][data-status=inactive]&#x27;</span>,</span><br><span class="line">  &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>We can also go the other way and filter out all active subscriptions using the <a href="https://on.cypress.io/not">cy.not</a> command.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">  .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;length&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">numberOfItems</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, numberOfItems - <span class="number">1</span>)</span><br><span class="line">    cy.<span class="title function_">log</span>(<span class="string">`Activating subscription for item #<span class="subst">$&#123;randomItem&#125;</span>`</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>).<span class="title function_">eq</span>(randomItem).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>We still have two problems with this test that will cause flake. Do you see them? One is caused by the random data, another by the test design.</p><h2><span id="sample-data">Sample data</span></h2><p>Here is the problem caused by the test design. In the failure below we see that we are picking the item number one (zero-based index).</p><p><img src="../images/flakiness-example/e8.png" alt="Failed to active the subscription number one"></p><p>Hmm, let&#39;s hover over the items we picked initially using <code>cy.get(&#39;[data-cy=customer-item]&#39;, &#123; timeout: 11_000 &#125;).not(&#39;[data-status=active]&#39;)</code> command. Seems we correctly picked 4 subscriptions.</p><p><img src="../images/flakiness-example/e9.png" alt="Subscriptions that can be activated"></p><p>Now hover over the <code>EQ 1</code> command. Why it picking the already activated subscription that is NOT part of the original four items?</p><p><img src="../images/flakiness-example/e10.png" alt="Why is it picking the active subscription to try to activate it?"></p><p>Ohhh, we picked the &quot;trial&quot; or &quot;inactive&quot; subscriptions initially to pick the random item index. But then we applied this index to <em>all</em> items</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">  .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;length&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">numberOfItems</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, numberOfItems - <span class="number">1</span>)</span><br><span class="line">    cy.<span class="title function_">log</span>(<span class="string">`Activating subscription for item #<span class="subst">$&#123;randomItem&#125;</span>`</span>)</span><br><span class="line">    <span class="comment">// WRONG: we must pick on the of the original items</span></span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>).<span class="title function_">eq</span>(randomItem).<span class="title function_">click</span>()</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>Let&#39;s fix it. Just apply the same logic to filter items.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">    .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;length&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">numberOfItems</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> randomItem = <span class="title class_">Cypress</span>.<span class="property">_</span>.<span class="title function_">random</span>(<span class="number">0</span>, numberOfItems - <span class="number">1</span>)</span><br><span class="line">      cy.<span class="title function_">log</span>(<span class="string">`Activating subscription for item #<span class="subst">$&#123;randomItem&#125;</span>`</span>)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>)</span><br><span class="line">        .<span class="title function_">eq</span>(randomItem)</span><br><span class="line">        .<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test works pretty well. But we can express our test even simpler by using my <a href="https://github.com/bahmutov/cypress-map">cypress-map</a> plugin. Like Lodash, the <code>cypress-map</code> provides a lot of &quot;missing&quot; queries and commands that make Cypress tests much simpler and stable. In our case, we need something like Lodash&#39;s <a href="https://lodash.com/docs/4.17.15#sample"><code>_.sample</code></a> function.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_.<span class="title function_">sample</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="comment">// =&gt; 2</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">11_000</span> &#125;)</span><br><span class="line">    .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">sample</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/flakiness-example/e11.png" alt="Using cy.sample query command simplifies the test"></p><p>Boom. Simple and solid. Almost.</p><h2><span id="github-copilot-trick">GitHub Copilot trick</span></h2><p>Here my <strong>#1 tip</strong> for you when writing Cypress tests. I have stated it many many years ago at a <a href="https://slides.com/bahmutov/well-tested-software">few conference presentations</a>. When writing Cypress tests, write first &quot;directions&quot; to a human user. For example:</p><p><img src="../images/flakiness-example/slide.png" alt="List of test steps for a human tester"></p><p>Write the steps as comments, telling the tester <em>what</em> to do, but not <em>how</em> to do it. Here are the steps I wrote as comments inside an empty Cypress test</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  <span class="comment">// get all items with data-cy attribute &quot;customer-item&quot;</span></span><br><span class="line">  <span class="comment">// omit all items with data-status attribute &quot;active&quot;</span></span><br><span class="line">  <span class="comment">// sample an item using cy.sample command</span></span><br><span class="line">  <span class="comment">// click on the item</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Now add an empty line in your VSCode and it should trigger GitHub Copilot. Here is what happens for me:</p><p><img src="../images/flakiness-example/co1.png" alt="GitHub Copilot suggest the right Cypress commands"></p><p>Nice! Our comments got &quot;translated&quot; into correct Cypress code that even uses the custom <code>cy.sample</code> command from <code>cypress-map</code>. Click &quot;Tab&quot; to accept the suggested code, and we have a passing test.</p><p><img src="../images/flakiness-example/co2.png" alt="The AI-generated test passes"></p><p>Let&#39;s continue generating our test. Write more user instructions.</p><p><img src="../images/flakiness-example/co3.png" alt="There should be a link to activate the subscription"></p><p>Then we need to confirm the subscription was activated.</p><p><img src="../images/flakiness-example/co4.png" alt="GitHub Copilot suggestion how to check the successfully activated subscription"></p><p>The test is complete.</p><p><img src="../images/flakiness-example/co5.png" alt="The full generated test"></p><p>Not bad, right?</p><h2><span id="the-data-edge-case">The data edge case</span></h2><p>Yet, there is one more source of test flake that we did not consider. Sometimes the test fails.</p><p><img src="../images/flakiness-example/p1.png" alt="The test can still fail sometimes"></p><p>Again, by inspecting the Command Log column, you can see the problem. The test did find items. The test failed to find non-active items, because there all randomly generated subscriptions were &quot;active&quot; already. Our test always assumed there will be some inactive subscriptions, but that is an invalid assumption. We can do <a href="https://glebbahmutov.com/cypress-examples/recipes/conditional-testing.html">conditional testing</a> in Cypress, even if it is an anti-pattern. The simplest way to run testing command only if there are items to be activated is by using my <a href="https://github.com/bahmutov/cypress-if">cypress-if</a> plugin.</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-if</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-if&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  <span class="comment">// get all items with data-cy attribute &quot;customer-item&quot;</span></span><br><span class="line">  <span class="comment">// omit all items with data-status attribute &quot;active&quot;</span></span><br><span class="line">  <span class="comment">// sample an item using cy.sample command</span></span><br><span class="line">  <span class="comment">// click on the item</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>)</span><br><span class="line">    <span class="comment">// the elements are there, the list will not change</span></span><br><span class="line">    <span class="comment">// thus we can set the timeout to 0</span></span><br><span class="line">    <span class="comment">// to quickly move to the next steps</span></span><br><span class="line">    .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    .<span class="title function_">if</span>(<span class="string">&#x27;exists&#x27;</span>)</span><br><span class="line">    .<span class="title function_">sample</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// find the button that contains the text &quot;Activate Subscription&quot;</span></span><br><span class="line">      <span class="comment">// and click on it</span></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">      <span class="comment">// the page should contain a visible element</span></span><br><span class="line">      <span class="comment">// with text &quot;Subscription was activated&quot;</span></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">else</span>(<span class="string">&#x27;Could not find inactive subscription&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>If the <code>NOT [data-status=active]</code> command yields no elements, we take the <code>ELSE</code> branch where we simply print the info message.</p><p><img src="../images/flakiness-example/else.png" alt="Handle the data case when there are no items to activate"></p><h2><span id="control-the-data">Control the data</span></h2><p>Finally, let&#39;s confirm that our code works no matter what the backend sends us. We need to control the data, and the best way is to use <a href="https://on.cypress.io/intercept">cy.intercept</a> command to stub the loading network call. We can use fixtures of different types: no inactive subscription, one item, a mixture of items to make sure our testing code can handle each possible situation. We can copy the starting response data straight from the browser.</p><p><img src="../images/flakiness-example/copy.png" alt="Copy the network response into a JSON fixture file"></p><p>The first JSON fixture will have a mixture of items, with &quot;active&quot; items first. This will test the case we discussed in the &quot;Sample data&quot; section above. The index of the inactive item should not accidentally apply to <em>all</em> items.</p><figure class="highlight json"><figcaption><span>customer-subscriptions/cypress/fixtures/mixed.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d216125a-426a-40f9-bfa4-03bfd96cff1c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Herman Stark&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Herman15@example.net&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ff86ef5d-da46-4079-8ac7-44135e399627&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liliana Parisian&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liliana_Parisian@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4852ee4c-8d75-49de-8d99-fb49cc03318d&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Grover Bartoletti&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Grover.Bartoletti@example.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inactive&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5e4cef59-116c-4f70-8e3f-fd8cf270c0af&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lacy Abshire&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lacy.Abshire@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inactive&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3291bea3-71a8-42e0-9199-0240827e58f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gia Marvin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gia_Marvin53@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trial&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>Our next fixture will have just an active subscription to test the &quot;ELSE&quot; logic.</p><figure class="highlight json"><figcaption><span>customer-subscriptions/cypress/fixtures/active-only.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d216125a-426a-40f9-bfa4-03bfd96cff1c&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Herman Stark&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Herman15@example.net&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ff86ef5d-da46-4079-8ac7-44135e399627&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liliana Parisian&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Liliana_Parisian@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>Finally, we want to make sure we test the &quot;trial&quot; items and that they can be activated</p><figure class="highlight json"><figcaption><span>customer-subscriptions/cypress/fixtures/trial.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3291bea3-71a8-42e0-9199-0240827e58f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fullName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gia Marvin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gia_Marvin53@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trial&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>Let&#39;s write the tests. We can refactor the code to avoid the duplication.</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spec.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-map</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-map&#x27;</span></span><br><span class="line"><span class="comment">// https://github.com/bahmutov/cypress-if</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;cypress-if&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">activateOneSubscription</span>(<span class="params"></span>) &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  <span class="comment">// get all items with data-cy attribute &quot;customer-item&quot;</span></span><br><span class="line">  <span class="comment">// omit all items with data-status attribute &quot;active&quot;</span></span><br><span class="line">  <span class="comment">// sample an item using cy.sample command</span></span><br><span class="line">  <span class="comment">// click on the item</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-cy=customer-item]&#x27;</span>)</span><br><span class="line">    <span class="comment">// the elements are there, the list will not change</span></span><br><span class="line">    <span class="comment">// thus we can set the timeout to 0</span></span><br><span class="line">    <span class="comment">// to quickly move to the next steps</span></span><br><span class="line">    .<span class="title function_">not</span>(<span class="string">&#x27;[data-status=active]&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    .<span class="title function_">if</span>(<span class="string">&#x27;exists&#x27;</span>)</span><br><span class="line">    .<span class="title function_">sample</span>()</span><br><span class="line">    .<span class="title function_">click</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// find the button that contains the text &quot;Activate Subscription&quot;</span></span><br><span class="line">      <span class="comment">// and click on it</span></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;Activate Subscription&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">      <span class="comment">// the page should contain a visible element</span></span><br><span class="line">      <span class="comment">// with text &quot;Subscription was activated&quot;</span></span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;Subscription was activated&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">else</span>(<span class="string">&#x27;Could not find inactive subscription&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/subscriptions&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">fixture</span>: <span class="string">&#x27;mixed.json&#x27;</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;subscriptions&#x27;</span>)</span><br><span class="line">  <span class="title function_">activateOneSubscription</span>()</span><br><span class="line">  <span class="comment">// confirm the subscription network call happened</span></span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@subscriptions&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Activates a trial subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/subscriptions&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">fixture</span>: <span class="string">&#x27;trial.json&#x27;</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;subscriptions&#x27;</span>)</span><br><span class="line">  <span class="title function_">activateOneSubscription</span>()</span><br><span class="line">  <span class="comment">// confirm the subscription network call happened</span></span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@subscriptions&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Does not activate an active subscription&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/subscriptions&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">fixture</span>: <span class="string">&#x27;active-only.json&#x27;</span>,</span><br><span class="line">  &#125;).<span class="title function_">as</span>(<span class="string">&#x27;subscriptions&#x27;</span>)</span><br><span class="line">  <span class="title function_">activateOneSubscription</span>()</span><br><span class="line">  <span class="comment">// confirm the subscription network call happened</span></span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@subscriptions&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/flakiness-example/full.png" alt="Three different tests use different data to confirm our logic works"></p><h2><span id="response-data-changes">Response data changes</span></h2><p>When using a network stub there is a danger that the server changes its response and our tests don&#39;t catch it. We can prevent this by adding a quick API test or a spy E2E test. Since we only want to ensure the properties &#x2F; types of the objects in the response, I recommend using my <a href="https://github.com/bahmutov/cy-spok">cy-spok</a> plugin.</p><h3><span id="api-test">API test</span></h3><p>In this test we will make a network call ourselves using the <a href="https://on.cypress.io/request">cy.request</a> command and will validate the response. The response should be an array, and we can validate the first object using the built-in assertions plus <code>spok</code> property predicates.</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/api.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> spok <span class="keyword">from</span> <span class="string">&#x27;cy-spok&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isStatus</span> = (<span class="params">s</span>) =&gt;</span><br><span class="line">  s === <span class="string">&#x27;active&#x27;</span> || s === <span class="string">&#x27;inactive&#x27;</span> || s === <span class="string">&#x27;trial&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;responds with a subscription object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;/api/subscriptions/&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.an&#x27;</span>, <span class="string">&#x27;array&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="number">0</span>, &#123; <span class="attr">timeout</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    <span class="comment">// confirm each item can only have these properties</span></span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.keys&#x27;</span>, [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;fullName&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;status&#x27;</span>])</span><br><span class="line">    <span class="comment">// use cy-spok to check the types of each property</span></span><br><span class="line">    .<span class="title function_">and</span>(</span><br><span class="line">      <span class="title function_">spok</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">fullName</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">email</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">status</span>: isStatus,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>There is no web page in this test, since we never called <code>cy.visit</code>. Instead we simply see the assertions in the Command Log.</p><p><img src="../images/flakiness-example/api.png" alt="The API test confirms the server response schema"></p><h3><span id="network-spy-test">Network spy test</span></h3><p>Sometimes it is hard to make a valid request from the test: the format of the call might be complicated, plus require authentication. It might be easier to just spy on the call made by the application. The same logic applies.</p><figure class="highlight js"><figcaption><span>customer-subscriptions/cypress/e2e/spy.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> spok <span class="keyword">from</span> <span class="string">&#x27;cy-spok&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isStatus</span> = (<span class="params">s</span>) =&gt;</span><br><span class="line">  s === <span class="string">&#x27;active&#x27;</span> || s === <span class="string">&#x27;inactive&#x27;</span> || s === <span class="string">&#x27;trial&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;spies on the server response&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// set up the network spy before the page loads</span></span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/subscriptions&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;subscriptions&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@subscriptions&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;response.body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.an&#x27;</span>, <span class="string">&#x27;array&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="number">0</span>, &#123; <span class="attr">timeout</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    <span class="comment">// confirm each item can only have these properties</span></span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.keys&#x27;</span>, [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;fullName&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;status&#x27;</span>])</span><br><span class="line">    <span class="comment">// use cy-spok to check the types of each property</span></span><br><span class="line">    .<span class="title function_">and</span>(</span><br><span class="line">      <span class="title function_">spok</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">fullName</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">email</span>: spok.<span class="property">string</span>,</span><br><span class="line">        <span class="attr">status</span>: isStatus,</span><br><span class="line">      &#125;),</span><br><span class="line">    )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/flakiness-example/spy-test.png" alt="Spying on the network call to confirm its schema"></p><p>Beautiful.</p><blockquote class="pullquote"><p>üéì In this blog post I used a lot of Cypress plugins. If you want to learn them better, I have an online hands-on course <a href="https://cypress.tips/courses/cypress-plugins">Cypress Plugins</a>. You can also level up your network testing by taking my <a href="https://cypress.tips/courses/network-testing">Cypress Network Testing Exercises</a> course.</p></blockquote><h2><span id="see-also">See also</span></h2><ul><li><a href="/blog/flaky-cy-type/" title="Solve Flake In Cypress Typing Into An Input Element">Solve Flake In Cypress Typing Into An Input Element</a></li><li><a href="/blog/cypress-flaky-tests-exercises/" title="Cypress Flaky Tests Exercises">Cypress Flaky Tests Exercises</a></li><li><a href="/blog/repeat-to-fight-flake/" title="Repeat Test to Fight Flake">Repeat Test to Fight Flake</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently I watched &lt;a href=&quot;https://filiphric.com/&quot;&gt;Filip Hric&lt;/a&gt; YT livestream &lt;a href=&quot;https://www.youtube.com/watch?v=fFw-FkXk3ec&quot;&gt;De
      
    
    </summary>
    
      <category term="process" scheme="https://glebbahmutov.com/blog/categories/process/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Check Broken Images Using Cypress</title>
    <link href="https://glebbahmutov.com/blog/check-broken-images/"/>
    <id>https://glebbahmutov.com/blog/check-broken-images/</id>
    <published>2024-01-04T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.494Z</updated>
    
    <content type="html"><![CDATA[<p>There is nothing more embarrassing than a broken image link right there in the middle of the page.</p><p><img src="../images/check-broken-images/broken-images.png" alt="Oops, some images did not make it"></p><p>Can we catch broken images using Cypress tests?</p><blockquote class="pullquote"><p>üéÅ The source code for this blog post can be found in my recipe &quot;Image Has Loaded&quot; at <a href="https://glebbahmutov.com/cypress-examples/">glebbahmutov.com&#x2F;cypress-examples</a>.</p></blockquote><p>üì∫ Watch this example in the video <a href="https://youtu.be/uJF2tnxN1dk">Check Broken Images On The Page</a>.</p><h2><span id="check-a-single-image">Check a single image</span></h2><p>Imagine a single <code>&lt;img&gt;</code> element. It loads the image using its <code>src</code> attribute. The source could be a link URL, or a <code>data:...</code> encoded image. Even if the URL is valid, the image itself could be corrupted and the browser might fail to decode it. Thus we want to check if the image <em>loads</em>, rather than simply checking the URL. A good way to check is to confirm the <code>naturalWidth</code> or <code>naturalHeight</code> of the <code>img</code> element. For successfully loaded and decoded images it should be positive.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;loads&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://glebbahmutov.com/images/warming-stripes.png&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">width</span>=<span class="string">&quot;400&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">height</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;#loads&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  .<span class="title function_">and</span>(<span class="string">&#x27;have.prop&#x27;</span>, <span class="string">&#x27;naturalWidth&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.greaterThan&#x27;</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img src="../images/check-broken-images/loads.png" alt="The test verifies the image loads"></p><p>If the <code>src</code> URL points at a non-existent image, the test catches it.</p><p><img src="../images/check-broken-images/nope.png" alt="The test catches a broken image"></p><p>üì∫ You can find this example explained in the video <a href="https://youtu.be/R79ai463xIM">Check If An Image Loads</a>.</p><h2><span id="multiple-images">Multiple images</span></h2><p>Now let&#39;s check all images on the page. Rather than failing a test immediately, we will collect all broken image information before reporting it all at once. This allows us to judge how broken the page is and maybe even debug it faster. Imagine multiple images on the page. Some elements load the image from a remote URL, others use <code>data:...</code> encoding, or even an SVG element.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;img1&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://glebbahmutov.com/images/warming-stripes.png&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">width</span>=<span class="string">&quot;400&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">height</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">alt</span>=<span class="string">&quot;Warming stripes&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- image without the &quot;src&quot; attribute --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;img2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;40&quot;</span> <span class="attr">height</span>=<span class="string">&quot;40&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Second image&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- image with data source --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;img3&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">width</span>=<span class="string">&quot;40&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">height</span>=<span class="string">&quot;40&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4</span></span></span><br><span class="line"><span class="string"><span class="tag">  //8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">alt</span>=<span class="string">&quot;red dot&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- image with data SVG --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&#x27;data:image/svg+xml;utf8,&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; version=&quot;1.1&quot; id=&quot;Layer_1&quot; x=&quot;0px&quot; y=&quot;0px&quot; viewBox=&quot;0 0 100 100&quot; enable-background=&quot;new 0 0 100 100&quot; xml:space=&quot;preserve&quot; height=&quot;100px&quot; width=&quot;100px&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;g&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M28.1,36.6c4.6,1.9,12.2,1.6,20.9,1.1c8.9-0.4,19-0.9,28.9,0.9c6.3,1.2,11.9,3.1,16.8,6c-1.5-12.2-7.9-23.7-18.6-31.3   c-4.9-0.2-9.9,0.3-14.8,1.4C47.8,17.9,36.2,25.6,28.1,36.6z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M70.3,9.8C57.5,3.4,42.8,3.6,30.5,9.5c-3,6-8.4,19.6-5.3,24.9c8.6-11.7,20.9-19.8,35.2-23.1C63.7,10.5,67,10,70.3,9.8z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M16.5,51.3c0.6-1.7,1.2-3.4,2-5.1c-3.8-3.4-7.5-7-11-10.8c-2.1,6.1-2.8,12.5-2.3,18.7C9.6,51.1,13.4,50.2,16.5,51.3z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M9,31.6c3.5,3.9,7.2,7.6,11.1,11.1c0.8-1.6,1.7-3.1,2.6-4.6c0.1-0.2,0.3-0.4,0.4-0.6c-2.9-3.3-3.1-9.2-0.6-17.6   c0.8-2.7,1.8-5.3,2.7-7.4c-5.2,3.4-9.8,8-13.3,13.7C10.8,27.9,9.8,29.7,9,31.6z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M15.4,54.7c-2.6-1-6.1,0.7-9.7,3.4c1.2,6.6,3.9,13,8,18.5C13,69.3,13.5,61.8,15.4,54.7z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M39.8,57.6C54.3,66.7,70,73,86.5,76.4c0.6-0.8,1.1-1.6,1.7-2.5c4.8-7.7,7-16.3,6.8-24.8c-13.8-9.3-31.3-8.4-45.8-7.7   c-9.5,0.5-17.8,0.9-23.2-1.7c-0.1,0.1-0.2,0.3-0.3,0.4c-1,1.7-2,3.4-2.9,5.1C28.2,49.7,33.8,53.9,39.8,57.6z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M26.2,88.2c3.3,2,6.7,3.6,10.2,4.7c-3.5-6.2-6.3-12.6-8.8-18.5c-3.1-7.2-5.8-13.5-9-17.2c-1.9,8-2,16.4-0.3,24.7   C20.6,84.2,23.2,86.3,26.2,88.2z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  &lt;path d=&quot;M30.9,73c2.9,6.8,6.1,14.4,10.5,21.2c15.6,3,32-2.3,42.6-14.6C67.7,76,52.2,69.6,37.9,60.7C32,57,26.5,53,21.3,48.6   c-0.6,1.5-1.2,3-1.7,4.6C24.1,57.1,27.3,64.5,30.9,73z&quot;/&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;/g&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;/svg&gt;&#x27;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">alt</span>=<span class="string">&quot;Basketball&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- image with broken data SVG --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;data:image/svg+xml;utf8,&lt;svg&gt;&lt;/svg&gt;&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">alt</span>=<span class="string">&quot;Basketball 2&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s check all images at once.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> brokenImages = []</span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;img&#x27;</span>)</span><br><span class="line">  .<span class="title function_">each</span>(<span class="function">(<span class="params">$el, k</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ($el.<span class="title function_">prop</span>(<span class="string">&#x27;naturalWidth&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> id = $el.<span class="title function_">attr</span>(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> alt = $el.<span class="title function_">attr</span>(<span class="string">&#x27;alt&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> info = <span class="string">`<span class="subst">$&#123;id ? <span class="string">&#x27;#&#x27;</span> + id : <span class="string">&#x27;&#x27;</span>&#125;</span> <span class="subst">$&#123;alt ? alt : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span></span><br><span class="line">      brokenImages.<span class="title function_">push</span>(info)</span><br><span class="line">      cy.<span class="title function_">log</span>(<span class="string">`Broken image <span class="subst">$&#123;k + <span class="number">1</span>&#125;</span>: <span class="subst">$&#123;info&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// report all broken images at once</span></span><br><span class="line">    <span class="keyword">if</span> (brokenImages.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Found <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">          brokenImages.length</span></span></span><br><span class="line"><span class="subst"><span class="string">        &#125;</span> broken images\n<span class="subst">$&#123;brokenImages.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>`</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/check-broken-images/all-broken.png" alt="Two image elements did not load"></p><p>By reporting <code>id</code> and <code>alt</code> attribute we can point the team to the right direction. We could also use <a href="https://github.com/bahmutov/cyclope">cyclope</a> plugin to save the entire page as static HTML snapshot to debug the markup.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;There is nothing more embarrassing than a broken image link right there in the middle of the page.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;../images/check-broke
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>How To Learn Cypress.io Test Runner In 2024</title>
    <link href="https://glebbahmutov.com/blog/how-to-learn-cypress-2024/"/>
    <id>https://glebbahmutov.com/blog/how-to-learn-cypress-2024/</id>
    <published>2024-01-01T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.534Z</updated>
    
    <content type="html"><![CDATA[<p>If your 2024 resolution is to acquire web automation testing skills, then learning how to write Cypress.io tests is the way to go. Here is my advice on how to learn it much faster and make the knowledge stick:</p><ul><li>When stuck quickly consult the official documentation at <a href="https://docs.cypress.io/">docs.cypress.io</a>. Do not &quot;invent&quot; your own way of coding things, and do not &quot;fight&quot; the Cypress approach: the Cypress docs are extensive and comprehensive. They probably show a good solution to the problem you are hitting.</li><li>Start learning by taking a course. Yes, I know, it is a time investment. But a few weeks of studying on your own can save you months and months of frustration down the line. There are Cypress courses available at LinkedIn and AutomationU, but if you want a practical, complete, and hands-on course, consider one of my <a href="https://cypress.tips/courses">Cypress courses</a>.</li><li>During day-to-day test writing, find <em>lots of tested</em> Cypress examples and recipes showing how to use every <code>cy</code> command on my <a href="https://glebbahmutov.com/cypress-examples/">glebbahmutov.com&#x2F;cypress-examples</a> site. <strong>Tip:</strong> use the built-in search widget to quickly find the answers.</li><li>Use my <a href="https://cypress.tips/search">Cypress Tips search page</a>. I have scraped my Cypress examples, my blog posts, video descriptions, and courses to put all these search results on a single page.</li><li>Subscribe to my testing blog <a href="https://glebbahmutov.com/blog/">glebbahmutov.com&#x2F;blog</a> and my YouTube channel <a href="https://www.youtube.com/glebbahmutov">www.youtube.com/glebbahmutov</a>. I write and record new Cypress content regularly. The short videos help me <em>show</em> Cypress in action.</li><li>Ask me any Cypress questions in my <a href="https://glebbahmutov.com/">Discord channel</a> or in <a href="https://filiphric.com/">Filip Hric&#39;s Discord</a>. I promise to answer it. Of course, my answer could be just a link to a blog post, a video, or one of my course lessons üòâ</li><li>You should skim <a href="https://learn.cypress.io/">learn.cypress.io</a> but don&#39;t spend much time on it. The advice is generic and the code examples are pretty obsolete and not maintained.</li><li>Browse through my Cypress-themed presentations at <a href="https://slides.com/bahmutov">slides.com&#x2F;bahmutov</a>. Many slide decks include links to the presentation recording, if available.</li><li>If you are working in an organization interested in hands-on Cypress and Playwright training, consider ordering an online or in-person testing workshop. I have several workshops that I taught multiple times, see them at <a href="https://cypress.tips/workshops">cypress.tips&#x2F;workshops</a>. Each workshop can be adapted to your organization&#39;s needs, and I guarantee that everyone studying with me will learn something new no matter how little or how much you already know.</li></ul><p><img src="../images/how-to-learn-cypress-2024/learn-testing.jpeg" alt="Learn Cypress in 2024"></p><h2><span id="bonus-learn-cypress-and-playwright">Bonus: Learn Cypress And Playwright</span></h2><p>Why learn just one web testing tool if you could learn both to double your chances of finding a better job? I have created <a href="https://cypress.tips/courses/cypress-vs-playwright">Cypress Vs Playwright</a> online course that trains you to solve practical testing problems using hands-on coding lessons. Each lesson poses a problem and gives you the starting code. You must solve the assignment using each test runner to appreciate the difference in syntax and capabilities between Cypress and Playwright.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;If your 2024 resolution is to acquire web automation testing skills, then learning how to write Cypress.io tests is the way to go. Here i
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Do Not Put Ids Into Test Ids</title>
    <link href="https://glebbahmutov.com/blog/no-id-in-test-ids/"/>
    <id>https://glebbahmutov.com/blog/no-id-in-test-ids/</id>
    <published>2023-12-21T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.560Z</updated>
    
    <content type="html"><![CDATA[<p>Here is a piece of advice based on my experience using <code>data-testid</code> or <code>data-cy</code> to access elements in my end-to-end tests: use simple test ID values. Do not include randomly generated values. For example, when testing TodoMVC, each item could be:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- üö® I do not recommend --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-testid</span>=<span class="string">&quot;Todo-734ab&quot;</span>&gt;</span>Write code<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-testid</span>=<span class="string">&quot;Todo-ce601&quot;</span>&gt;</span>Write tests<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ‚úÖ I recommend --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-testid</span>=<span class="string">&quot;Todo&quot;</span> <span class="attr">data-id</span>=<span class="string">&quot;734ab&quot;</span>&gt;</span>Write code<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">data-testid</span>=<span class="string">&quot;Todo&quot;</span> <span class="attr">data-id</span>=<span class="string">&quot;ce601&quot;</span>&gt;</span>Write tests<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Separating the id part from the &quot;test-id&quot; will make writing tests much simpler.</p><h2><span id="example-application">Example Application</span></h2><p>I have created an example repo <a href="https://github.com/bahmutov/test-ids-blog-post">bahmutov&#x2F;test-ids-blog-post</a> to go with this blog post. The initial code uses <code>data-testid</code> attributes for the TodoMVC fields.</p><p><img src="../images/no-id-in-test-ids/app.png" alt="The application with data-testid attributes"></p><p>The input element has <code>data-testid=TodoInput</code>, the main list has <code>data-testid=Todos</code>, and the two current todos have attributes <code>data-testid=&quot;Todo-5589433909&quot;</code> and <code>data-testid=&quot;Todo-7392832596&quot;</code>. The ids are coming from the application itself. If we look at the JSON data, we can see these values:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;todos&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Write code&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5589433909&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Write tests&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;completed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7392832596&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Great, so how does it affect writing the tests?</p><p><strong>Tip:</strong> you can see which elements have <code>data-testid</code> attribute by using my <a href="https://github.com/bahmutov/cypress-highlight">cypress-highlight</a> plugin:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; highlight &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress-highlight&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds 2 items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;TodoInput&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  <span class="title function_">highlight</span>(<span class="string">&#x27;[data-testid]&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/highlight.png" alt="Highlighted elements with a data-testid attribute"></p><h2><span id="adding-todos">Adding Todos</span></h2><p>Let&#39;s select the important elements using the <code>data-testid</code> attribute. This is what Cypress selector playground tool suggests using:</p><p><img src="../images/no-id-in-test-ids/input.png" alt="The input element selector suggestion"></p><p>Plus having an explicit <code>data-testid</code> signals everyone that this field is tested, makes finding tests easier, etc.</p><p>Let&#39;s start writing an end-to-end test</p><figure class="highlight js"><figcaption><span>cypress/e2e/spec.cy.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds 2 items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;TodoInput&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Hmm, how would we confirm that 2 items are visible on the page? We could use <code>LI</code> selector:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds 2 items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;TodoInput&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;Todos&quot;]&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;li&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/two-li.png" alt="Two LI elements inside the Todos component"></p><p>Ok, it works, but what if we switch from using <code>LI</code> elements to <code>DIV</code>? Ok, let&#39;s use <code>data-testid</code> attributes. Because we know the start of each attribute &quot;Todo-&quot; we could use a <a href="https://glebbahmutov.com/cypress-examples/commands/querying.html#attribute-prefix">prefix attribute selector</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds 2 items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;TodoInput&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;[data-testid=&quot;Todos&quot;]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">find</span>(<span class="string">&#x27;[data-testid^=Todo-]&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Ughh, ok, it works.</p><p><img src="../images/no-id-in-test-ids/prefix.png" alt="Using prefix data-testid attribute selector"></p><h2><span id="custom-commands">Custom Commands</span></h2><p>Since we will use <code>data-testid</code> in a lot of queries, let&#39;s make a tiny <a href="https://on.cypress.io/custom-commands">custom command</a>. We want to have the equivalents to <code>cy.get</code> parent and <code>cy.find</code> child commands, so we add two commands.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Cypress</span>.<span class="property">Commands</span>.<span class="title function_">add</span>(<span class="string">&#x27;getByTestId&#x27;</span>, <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> selector = <span class="string">`[data-testid=&quot;<span class="subst">$&#123;id&#125;</span>&quot;]`</span></span><br><span class="line">  <span class="keyword">return</span> cy.<span class="title function_">get</span>(selector)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Cypress</span>.<span class="property">Commands</span>.<span class="title function_">add</span>(</span><br><span class="line">  <span class="string">&#x27;findByTestId&#x27;</span>,</span><br><span class="line">  &#123; <span class="attr">prevSubject</span>: <span class="string">&#x27;element&#x27;</span> &#125;,</span><br><span class="line">  <span class="function">(<span class="params">subject, id</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> selector = <span class="string">`[data-testid^=&quot;<span class="subst">$&#123;id&#125;</span>&quot;]`</span></span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">wrap</span>(subject, &#123; <span class="attr">log</span>: <span class="literal">false</span> &#125;).<span class="title function_">find</span>(selector)</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>These commands make sense when checking the Todo items:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;TodoInput&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todos&#x27;</span>).<span class="title function_">findByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>But when we check the number of remaining todos, we have to use the same prefix.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Footer&#x27;</span>)</span><br><span class="line">  .<span class="title function_">findByTestId</span>(<span class="string">&#x27;TodosRemaining&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/remaining.png" alt="The number of remaining todos is 2"></p><p>Because we need the prefix for <code>Todo-</code> items, the <code>cy.findByTestId</code> uses unnecessary prefix for <code>[data-testid^=&quot;TodosRemaining&quot;]</code> too. This might not be a problem, but let&#39;s try another situation. Let&#39;s say we want to confirm there are two Todo items in the <code>&lt;section class=&quot;todoapp&quot;&gt;</code> top parent element.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows 2 items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;TodoInput&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.todoapp&#x27;</span>).<span class="title function_">findByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test fails when it finds 5 items instead of 2.</p><p><img src="../images/no-id-in-test-ids/fails.png" alt="The test fails when it accidentally matches other elements"></p><p>Turns out, when looking for <code>Todo</code> prefix we matched non-list items, like <code>TodoInput</code> and <code>TodosRemaining</code>. We could update the <code>findByTestId</code> command to assume the <code>-</code> separator:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Cypress</span>.<span class="property">Commands</span>.<span class="title function_">add</span>(</span><br><span class="line">  <span class="string">&#x27;findByTestId&#x27;</span>,</span><br><span class="line">  &#123; <span class="attr">prevSubject</span>: <span class="string">&#x27;element&#x27;</span> &#125;,</span><br><span class="line">  <span class="function">(<span class="params">subject, id</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> selector = <span class="string">`[data-testid^=&quot;<span class="subst">$&#123;id&#125;</span>-&quot;]`</span></span><br><span class="line">    <span class="keyword">return</span> cy.<span class="title function_">wrap</span>(subject, &#123; <span class="attr">log</span>: <span class="literal">false</span> &#125;).<span class="title function_">find</span>(selector)</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>But the larger question remains: why are we parsing the data attribute and encode values in our testing code? What if the application code changes?</p><h2><span id="validate-the-todo-id">Validate The Todo Id</span></h2><p>Another situation shows how combining the element &quot;type&quot; with a random value in a single attribute is problematic. Let&#39;s say we spy on the added Todo items sent over the network. The network call contains the item&#39;s unique ID. Can we validate the ID against the element? Sure. Let&#39;s do this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the correct item id&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;newTodo&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;TodoInput&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@newTodo&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTestId</span>(<span class="string">`Todo-<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The test passes and clearly shows the item&#39;s id, even if we had to concatenate <code>Todo</code> and the id strings.</p><p><img src="../images/no-id-in-test-ids/has-id.png" alt="Finding the Todo item with the expected id"></p><p>Great, but we do not want to do <code>cy.getByTestId(&#39;Todo-$&#123;id&#125;&#39;)</code> in our code. We want to get the <code>Todos</code> component and find its child element with <code>Todo-$&#123;id&#125;</code> data test id attribute, just like we did before. Does it work?</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">wait</span>(<span class="string">&#x27;@newTodo&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todos&#x27;</span>).<span class="title function_">findByTestId</span>(<span class="string">`Todo-<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/no-id.png" alt="Cannot find the item using the findByTestId command"></p><p>Oops, the fix the previous stray element problem broken finding the item when we know the entire attribute and do not need the trailing <code>-</code> character.</p><h2><span id="a-better-way">A Better Way</span></h2><p>Let&#39;s simplify our code. In the HTML template instead of concatenating <code>Todo-&lt;id&gt;</code> we can put the <code>id</code> value into its own <code>data-...</code> attribute. Almost like <a href="https://guides.visual-paradigm.com/a-comprehensive-guide-to-database-normalization-with-examples/">normalizing database schema</a> and splitting the first and last names into two columns, we can &quot;normalize&quot; data attributes to keep just a single type of value in each one.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- üö® BEFORE --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-for</span>=<span class="string">&quot;todo in filteredTodos&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;todo&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:data-testid</span>=<span class="string">&quot;&#x27;Todo-&#x27; + todo.id&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:key</span>=<span class="string">&quot;todo.id&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:class</span>=<span class="string">&quot;&#123; completed: todo.completed &#125;&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ‚úÖ AFTER --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-for</span>=<span class="string">&quot;todo in filteredTodos&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;todo&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">data-testid</span>=<span class="string">&quot;Todo&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:data-id</span>=<span class="string">&quot;todo.id&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:key</span>=<span class="string">&quot;todo.id&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:class</span>=<span class="string">&quot;&#123; completed: todo.completed &#125;&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure><p>We can now remove test attribute prefix and simply confirm the Todo element.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has the correct item id&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;newTodo&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;TodoInput&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@newTodo&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todos&#x27;</span>)</span><br><span class="line">        .<span class="title function_">findByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.attr&#x27;</span>, <span class="string">&#x27;data-id&#x27;</span>, id)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/separate-id.png" alt="The Todo id attribute is separate"></p><p>Let&#39;s create several todos and confirm the first item&#39;s id is unique on the page.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has a unique item id&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// clear all todos before the test</span></span><br><span class="line">  cy.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/reset&#x27;</span>, &#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loaded&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;newTodo&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;TodoInput&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Write code&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">type</span>(<span class="string">&#x27;Test it again&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  <span class="comment">// the first item sent to the server</span></span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@newTodo&#x27;</span>)</span><br><span class="line">    .<span class="title function_">its</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>)</span><br><span class="line">        .<span class="title function_">filter</span>(<span class="string">`[data-id=&quot;<span class="subst">$&#123;id&#125;</span>&quot;]`</span>)</span><br><span class="line">        .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Filtering all Todo elements by <code>data-id</code> attribute is simple and uses the standard attribute selector.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>)</span><br><span class="line">  .<span class="title function_">filter</span>(<span class="string">`[data-id=&quot;<span class="subst">$&#123;id&#125;</span>&quot;]`</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>The test passes - the first item has the unique id. We can even confirm it is the first one amongst its siblings.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">wait</span>(<span class="string">&#x27;@newTodo&#x27;</span>)</span><br><span class="line">  .<span class="title function_">its</span>(<span class="string">&#x27;response.body.id&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;be.a&#x27;</span>, <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>)</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="string">`[data-id=&quot;<span class="subst">$&#123;id&#125;</span>&quot;]`</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    cy.<span class="title function_">getByTestId</span>(<span class="string">&#x27;Todo&#x27;</span>).<span class="title function_">first</span>().<span class="title function_">should</span>(<span class="string">&#x27;have.attr&#x27;</span>, <span class="string">&#x27;data-id&#x27;</span>, id)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/no-id-in-test-ids/first.png" alt="The first todo has the correct unique id"></p><p>Beautiful.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Here is a piece of advice based on my experience using &lt;code&gt;data-testid&lt;/code&gt; or &lt;code&gt;data-cy&lt;/code&gt; to access elements in my end-to-e
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Refactor Cypress Modal Tests</title>
    <link href="https://glebbahmutov.com/blog/refactor-cypress-modal-tests/"/>
    <id>https://glebbahmutov.com/blog/refactor-cypress-modal-tests/</id>
    <published>2023-12-05T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.574Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I noticed a video in a Linkedin post showing a few Cypress tests. The tests confirmed an alert is happening with right text, plus a modal was showing the right text. Here is a screenshot of the original <a href="https://www.linkedin.com/posts/jaimejunior123_lidando-com-alguns-popupsalerts-no-cypress-activity-7137456060209971201-jraY">post</a>.</p><p><img src="../images/refactor-modals/l.png" alt="The original tests video"></p><p>I noticed a few things about those tests that might be improved. Here is my refactoring of each of the three tests.</p><blockquote class="pullquote"><p>üéÅ You can find the original source code in my repo <a href="https://github.com/bahmutov/webdriverSite/">bahmutov&#x2F;webdriverSite</a>. You can see the final solution in the branch <a href="https://github.com/bahmutov/webdriverSite/tree/solution">solution</a>. üì∫ You can watch a recording of me refactoring all tests in the video <a href="https://youtu.be/lnYd0cPnCa8">Refactor Cypress Tests Checking Alerts And Modals</a>.</p></blockquote><h2><span id="test-one">Test one</span></h2><p>The first test confirms the application calls the <code>alert(...)</code> with the right text.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Lidando com Popups e Alerts&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&#x27;/Popup-Alerts/index.html&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;Javascript Alert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;#button1&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">on</span>(<span class="string">&#x27;window:alert&#x27;</span>, <span class="function">(<span class="params">txt</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">expect</span>(txt).<span class="property">to</span>.<span class="title function_">contains</span>(<span class="string">&#x27;I am an alert box!&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Above the test I added my notes about what could be improved in this test. We never actually confirm that the application calls <code>alert(...)</code>. You could comment out the <code>.click()</code> and the test would still work. Here is the improved test that uses <a href="https://on.cypress.io/stub">cy.stub</a> command to confirm the app does call <code>alert</code> with the right text argument.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// need to ensure the alert actually happens</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Javascript Alert&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#button1&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> text = <span class="string">&#x27;I am an alert box!&#x27;</span></span><br><span class="line">  cy.<span class="title function_">on</span>(<span class="string">&#x27;window:alert&#x27;</span>, cy.<span class="title function_">stub</span>().<span class="title function_">as</span>(<span class="string">&#x27;alert&#x27;</span>))</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;@alert&#x27;</span>, &#123; <span class="attr">timeout</span>: <span class="number">1000</span> &#125;).<span class="title function_">should</span>(<span class="string">&#x27;have.been.calledOnceWith&#x27;</span>, text)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor-modals/test1.png" alt="The first test refactored"></p><p>For more stub examples and checking the <code>alert</code> behavior, see my <a href="https://glebbahmutov.com/cypress-examples/commands/spies-stubs-clocks.html">stubs examples</a> page.</p><h2><span id="test-two">Test two</span></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Modal Popup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#button2&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  <span class="comment">// Removendo espa√ßos em branco do in√≠cio e do final da string</span></span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.modal-body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> txtEsperado =</span><br><span class="line">        <span class="string">&#x27;We can inject and use JavaScript code if all else fails! ...&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> txtNaPagina = text.<span class="title function_">trim</span>()</span><br><span class="line"></span><br><span class="line">      <span class="title function_">expect</span>(txtNaPagina).<span class="property">to</span>.<span class="title function_">equal</span>(txtEsperado)</span><br><span class="line">    &#125;)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.modal-content&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;.modal-footer&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Close&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>We can take advantage of <a href="https://on.cypress.io/contains">cy.contains</a> command to find elements by text. We should also confirm the modal disappears after clicking the &quot;Close&quot; button.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// refactor to use cy.contains command</span></span><br><span class="line"><span class="comment">// and confirm the dialog disappears when closed</span></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Modal Popup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#button2&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  <span class="comment">// Removendo espa√ßos em branco do in√≠cio e do final da string</span></span><br><span class="line">  <span class="keyword">const</span> txtEsperado =</span><br><span class="line">    <span class="string">&#x27;We can inject and use JavaScript code if all else fails! ...&#x27;</span></span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;.modal-body&#x27;</span>, txtEsperado).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.modal-content&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;.modal-footer&#x27;</span>).<span class="title function_">contains</span>(<span class="string">&#x27;Close&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.modal-body&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor-modals/test2.png" alt="The second test refactored"></p><h3><span id="test-three">Test three</span></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Outra maneira para o Modal Popup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">intercept</span>(<span class="string">&#x27;/**&#x27;</span>).<span class="title function_">as</span>(<span class="string">&#x27;googleAnalytics&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;p &gt; a&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.loader&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">wait</span>(<span class="string">&#x27;@googleAnalytics&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;#button1 &gt; p&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;.modal-body&#x27;</span>)</span><br><span class="line">    .<span class="title function_">invoke</span>(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> txtEsperado =</span><br><span class="line">        <span class="string">&#x27;The waiting game can be a tricky one; ...&#x27;</span></span><br><span class="line">      <span class="keyword">const</span> txtNaPagina = text.<span class="title function_">trim</span>()</span><br><span class="line"></span><br><span class="line">      <span class="title function_">expect</span>(txtNaPagina).<span class="property">to</span>.<span class="title function_">equal</span>(txtEsperado)</span><br><span class="line">    &#125;)</span><br><span class="line">  cy.<span class="title function_">contains</span>(<span class="string">&#x27;Close&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>In the test above we are spying on the network requests, but the spy is too permissive. We can limit it to only spy on the calls to the Google Analytics website. To learn more about network intercepts, see my course <a href="https://cypress.tips/courses/network-testing">Cypress Network Testing Exercises</a></p><p>We can also fix several selectors to be precise. We also need to better check the behavior of the Loader element that first must appear and the go away.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use a better selector for to click the ajax loader</span></span><br><span class="line">  <span class="comment">// confirm the loader is visible before checking that it does not exist</span></span><br><span class="line">  <span class="comment">// use precise network matcher for google analytics, otherwise everything matches</span></span><br><span class="line">  <span class="comment">// use cy.contains command</span></span><br><span class="line">  <span class="comment">// use precise selector for the close button</span></span><br><span class="line">  <span class="comment">// confirm the modal does not exist after closing it</span></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;Outra maneira para o Modal Popup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">intercept</span>(&#123;</span><br><span class="line">      <span class="attr">hostname</span>: <span class="string">&#x27;www.google-analytics.com&#x27;</span>,</span><br><span class="line">    &#125;).<span class="title function_">as</span>(<span class="string">&#x27;googleAnalytics&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.thumbnail&#x27;</span>, <span class="string">&#x27;Ajax Loader&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;a&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;#loader&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">get</span>(<span class="string">&#x27;#loader&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.be.visible&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">wait</span>(<span class="string">&#x27;@googleAnalytics&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;#button1&#x27;</span>, <span class="string">&#x27;CLICK ME!&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    <span class="keyword">const</span> txtEsperado =</span><br><span class="line">      <span class="string">&#x27;The waiting game can be a tricky one; ...&#x27;</span></span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.modal-body&#x27;</span>, txtEsperado).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>).<span class="title function_">wait</span>(<span class="number">1000</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;Close&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;.modal-body&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor-modals/test3.png" alt="The third test refactored"></p><p>For more details, read the blog posts <a href="/blog/negative-assertions/" title="Be Careful With Negative Assertions">Be Careful With Negative Assertions</a> and <a href="/blog/negative-assertions-and-missing-states/" title="Negative Assertions And Missing States">Negative Assertions And Missing States</a>. To learn more about testing different application states and confirming the application behaviors, see my course <a href="https://cypress.tips/courses/swag-store">Testing The Swag Store</a></p><p><strong>Tip:</strong> have a complex Cypress test you are unhappy with? Is it public? If yes, send it my way, and maybe I will record a video refactoring it to make the spec elegant, precise, and solid.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently I noticed a video in a Linkedin post showing a few Cypress tests. The tests confirmed an alert is happening with right text, plu
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Set Commit Status In Another Repo</title>
    <link href="https://glebbahmutov.com/blog/set-commit-status-in-another-repo/"/>
    <id>https://glebbahmutov.com/blog/set-commit-status-in-another-repo/</id>
    <published>2023-11-30T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.586Z</updated>
    
    <content type="html"><![CDATA[<p>See the blog post <a href="/blog/two-repo-github-actions-setup/" title="Separate Application And Tests Repos GitHub Actions Setup">Separate Application And Tests Repos GitHub Actions Setup</a> for how I set up two repos: one for a web application, another for its tests. In this blog post I will show how I set the commit status in the first repo before the tests execute and then when the tests finish. Having an explicit test commit status lets you protected the main branch from pull requests that have not executed the tests, or where the tests have failed.</p><blockquote class="pullquote"><p>üéÅ You can find the web application repo at <a href="https://github.com/bahmutov/todo-app">bahmutov&#x2F;todo-app</a>, and the tests repo at <a href="https://github.com/bahmutov/todo-app-tests">bahmutov&#x2F;todo-app-tests</a>.</p></blockquote><h2><span id="trigger-the-workflow">Trigger the workflow</span></h2><p>When the user types <code>/cypress</code> comment on a pull request in the first repo &quot;test-app&quot;, we can get the commit SHA from the pull request itself.</p><figure class="highlight yml"><figcaption><span>.github/workflows/slash-command-cypress.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Trigger</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line">  <span class="comment"># https://github.com/actions/github-script</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/github-script@v6</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">trigger</span></span><br><span class="line">  <span class="comment"># pass this repo&#x27;s name and PR number</span></span><br><span class="line">  <span class="comment"># plus the comment ID so the tests workflow can post results back</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">REPO_NAME:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">PR_NUMBER:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pull_request.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">REF:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">FEEDBACK_COMMENT_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.github.payload.comment.id</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">COMMIT_SHA:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pull_request.head.sha</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># unfortunately we need to use a personal token to trigger</span></span><br><span class="line">    <span class="comment"># a workflow in another repo, cannot use just GITHUB_TOKEN</span></span><br><span class="line">    <span class="attr">github-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      const result = await require(&#x27;./.github/workflows/trigger-cypress.js&#x27;)(&#123; github, core &#125;);</span></span><br><span class="line"><span class="string">      return result;</span></span><br></pre></td></tr></table></figure><p>You can see the full workflow <a href="https://github.com/bahmutov/todo-app/blob/main/.github/workflows/slash-command-cypress.yml">here</a>. For example, in the <a href="https://github.com/bahmutov/todo-app/pull/3">PR 3</a> the last commit short SHA was <code>9053795</code>.</p><p><img src="../images/set-commit-status/short-sha.png" alt="The branch head commit SHA"></p><p>We can see this commit being sent to the test repo inside the payload body</p><p><img src="../images/set-commit-status/payload.png" alt="The full commit SHA is sent with the test trigger"></p><h2><span id="the-tests-workflow">The tests workflow</span></h2><p>When the tests workflow starts, it should update the commit status twice. First, before anything runs we set the commit status to &quot;pending&quot; to let the user know the tests are executing. After the tests finish, we can set the final result (success, failure, error) based on the outcome of the test job.</p><p>You can find the full testing workflow <a href="https://github.com/bahmutov/todo-app-tests/blob/main/.github/workflows/trigger.yml">here</a>. The relevant part is below</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add a pending commit status check</span></span><br><span class="line"><span class="comment"># https://github.com/bahmutov/cypress-set-github-status</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">pending</span> <span class="string">commit</span> <span class="string">status</span> <span class="string">üö¶</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.commit</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">PERSONAL_GH_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    npx --package cypress-set-github-status set-gh-status \</span></span><br><span class="line"><span class="string">      --repo $&#123;&#123; github.event.client_payload.repo &#125;&#125; \</span></span><br><span class="line"><span class="string">      --commit $&#123;&#123; github.event.client_payload.commit &#125;&#125; \</span></span><br><span class="line"><span class="string">      --status pending --context &quot;todo-app-tests&quot; \</span></span><br><span class="line"><span class="string">      --description &quot;E2E tests&quot; \</span></span><br><span class="line"><span class="string">      --target-url $&#123;&#123; github.server_url &#125;&#125;/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># check out both the app and the tests</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">this</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">the</span> <span class="string">application</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">app</span> <span class="string">dependencies</span> <span class="string">üì¶</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">working-directory:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">the</span> <span class="string">application</span> <span class="string">üé¨</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    cd app</span></span><br><span class="line"><span class="string">    npm run start &amp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">E2E</span> <span class="string">tests</span> <span class="string">üèÉüèª‚Äç‚ôÇÔ∏è</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">tests</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Post</span> <span class="string">results</span> <span class="string">üì®</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">always()</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">peter-evans/create-or-update-comment@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># need a personal token to be able to post a comment back</span></span><br><span class="line">    <span class="comment"># in the original repo</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">comment-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">issue-number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pullRequestNumber</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      Tests result: $&#123;&#123; steps.tests.outcome &#125;&#125;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">reactions:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      $&#123;&#123; steps.tests.outcome == &#x27;success&#x27; &amp;&amp; &#x27;hooray&#x27; || &#x27;-1&#x27; &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># set the commit status based on the E2E test job outcome</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">the</span> <span class="string">commit</span> <span class="string">status</span> <span class="string">üö¶</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.commit</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">PERSONAL_GH_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    npx --package cypress-set-github-status set-gh-status \</span></span><br><span class="line"><span class="string">      --repo $&#123;&#123; github.event.client_payload.repo &#125;&#125; \</span></span><br><span class="line"><span class="string">      --commit $&#123;&#123; github.event.client_payload.commit &#125;&#125; \</span></span><br><span class="line"><span class="string">      --status $&#123;&#123; steps.tests.outcome &#125;&#125; --context &quot;todo-app-tests&quot; \</span></span><br><span class="line"><span class="string">      --description &quot;E2E tests&quot; \</span></span><br><span class="line"><span class="string">      --target-url $&#123;&#123; github.server_url &#125;&#125;/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;</span></span><br><span class="line"><span class="string">    echo &#x27;Posted job outcome $&#123;&#123; steps.tests.outcome &#125;&#125; to \</span></span><br><span class="line"><span class="string">      $&#123;&#123; github.event.client_payload.repo &#125;&#125; commit $&#123;&#123; github.event.client_payload.commit &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br></pre></td></tr></table></figure><p>I am using my own utility <a href="https://github.com/bahmutov/cypress-set-github-status">cypress-set-github-status</a>. Typically you would pass the commit status which is one of the values &quot;pending&quot;, &quot;success&quot;, &quot;failure&quot;, or &quot;error&quot;. But we can also use <code>--status $&#123;&#123; steps.tests.outcome &#125;&#125;</code> which will automatically convert job status string to the commit status: job outcome &quot;success&quot; is commit status &quot;success&quot;, &quot;failure&quot; is &quot;failure&quot;, and both job outcomes &quot;canceled&quot; and &quot;skipped&quot; are commit status &quot;error&quot;.</p><p>Here is a passing test commit status set back in the &quot;todo-app&quot; pull request</p><p><img src="../images/set-commit-status/pass.png" alt="The passing tests commit status"></p><p>Now we can configure the branch protection rule in the &quot;todo-app&quot; repo that requires the &quot;todo-app-tests&quot; status check to be green before merging.</p><p><img src="../images/set-commit-status/status-check.png" alt="Branch protection requiring the todo-app-tests to pass"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;See the blog post &lt;a href=&quot;/blog/two-repo-github-actions-setup/&quot; title=&quot;Separate Application And Tests Repos GitHub Actions Setup&quot;&gt;Separa
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>Separate Application And Tests Repos GitHub Actions Setup</title>
    <link href="https://glebbahmutov.com/blog/two-repo-github-actions-setup/"/>
    <id>https://glebbahmutov.com/blog/two-repo-github-actions-setup/</id>
    <published>2023-11-29T05:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.613Z</updated>
    
    <content type="html"><![CDATA[<p>In my previous blog post <a href="/blog/how-to-keep-cypress-tests-in-another-repo/" title="How to Keep Cypress Tests in Another Repo While Using GitHub Actions">How to Keep Cypress Tests in Another Repo While Using GitHub Actions</a> I have described how the end-to-end tests can live in a separate repository from the web application. Keeping a separate tests repo comes with its advantages and challenges. I like using a separate tests repo when we want to iterate over the tests really quickly. In this blog post I will describe how I set up two repos using GitHub Actions. To summarize: every time we open a web app pull request, we can enter a new comment with the text  <code>/cypress</code> and it will trigger a test run in the tests repo. The results of the test run will be posted back to the comment.</p><p><img src="../images/two-repos/two-repos.png" alt="The overall diagram"></p><blockquote class="pullquote"><p>üéÅ You can find the web application repo at <a href="https://github.com/bahmutov/todo-app">bahmutov&#x2F;todo-app</a>, and the tests repo at <a href="https://github.com/bahmutov/todo-app-tests">bahmutov&#x2F;todo-app-tests</a>.</p></blockquote><!-- toc --><ul><li><a href="#todo-app-cypress-slash-command">Todo-app: Cypress slash command</a></li><li><a href="#todo-app-cypress-workflow">Todo-app: Cypress workflow</a></li><li><a href="#todo-app-tests-trigger-workflow">Todo-app-tests: Trigger workflow</a></li></ul><!-- tocstop --><h2><span id="todo-app-cypress-slash-command">Todo-app: Cypress slash command</span></h2><p>To trigger the test run, we will trust the developer who opened a pull request or is reviewing it to type a new comment <code>/cypress</code>. This is our &quot;slash&quot; command, and there is a reusable Github Action <a href="https://github.com/peter-evans/slash-command-dispatch">peter-evans&#x2F;slash-command-dispatch</a> that can handle it for us beautifully.</p><figure class="highlight yml"><figcaption><span>.github/workflows/slash-command-dispatch.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a workflow that runs when a user enters a pull request comment</span></span><br><span class="line"><span class="comment"># if the user enters &quot;/cypress&quot; we trigger the workflow &quot;slash-command-cypress&quot;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Slash</span> <span class="string">Command</span> <span class="string">Dispatch</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">issue_comment:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">created</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">slash_command_dispatch:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">event</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo off</span></span><br><span class="line"><span class="string">          echo &#x27;$&#123;&#123; toJson(github.event) &#125;&#125;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># we only know the pull request number, like 12, 20, etc</span></span><br><span class="line">      <span class="comment"># but to trigger the workflow we need the branch name</span></span><br><span class="line">      <span class="comment"># use personal token to be able to query the branch by PR number</span></span><br><span class="line">      <span class="comment"># https://github.com/bahmutov/get-branch-name-by-pr</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Find</span> <span class="string">the</span> <span class="string">PR</span> <span class="string">branch</span> <span class="string">name</span> <span class="string">üîé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">bahmutov/get-branch-name-by-pr@v1</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">pr</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">repo-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">pr-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.issue.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Slash</span> <span class="string">Command</span> <span class="string">Dispatch</span></span><br><span class="line">        <span class="comment"># https://github.com/peter-evans/slash-command-dispatch</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peter-evans/slash-command-dispatch@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># use personal token to be able to trigger more workflows</span></span><br><span class="line">          <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="comment"># the personal token to post the comment emoji</span></span><br><span class="line">          <span class="attr">reaction-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">permission:</span> <span class="string">none</span></span><br><span class="line">          <span class="attr">static-args:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            repository=$&#123;&#123; github.repository &#125;&#125;</span></span><br><span class="line"><span class="string">            comment-id=$&#123;&#123; github.event.comment.id &#125;&#125;</span></span><br><span class="line"><span class="string">            ref=$&#123;&#123; steps.pr.outputs.branch &#125;&#125;</span></span><br><span class="line"><span class="string"></span>          <span class="attr">commands:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">cypress</span></span><br></pre></td></tr></table></figure><p>A couple of notes about the above workflow that you can find at <a href="https://github.com/bahmutov/todo-app/blob/main/.github/workflows/slash-command-dispatch.yml">slash-command-dispatch.yml</a>:</p><p>It runs on every new issue and pull request comment</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">issue_comment:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">created</span>]</span><br></pre></td></tr></table></figure><p>It grabs the branch name using my GitHub Action <a href="https://github.com/bahmutov/get-branch-name-by-pr">bahmutov&#x2F;get-branch-name-by-pr</a> because we will need to check out the code when running the test. We need to use a GitHub personal access token set as a repo secret.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># we only know the pull request number, like 12, 20, etc</span></span><br><span class="line"><span class="comment"># but to trigger the workflow we need the branch name</span></span><br><span class="line"><span class="comment"># use personal token to be able to query the branch by PR number</span></span><br><span class="line"><span class="comment"># https://github.com/bahmutov/get-branch-name-by-pr</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Find</span> <span class="string">the</span> <span class="string">PR</span> <span class="string">branch</span> <span class="string">name</span> <span class="string">üîé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/get-branch-name-by-pr@v1</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">pr</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">repo-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">pr-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.issue.number</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>Similarly, we use the personal token to trigger the specific workflow for the &quot;cypress&quot; command</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Slash</span> <span class="string">Command</span> <span class="string">Dispatch</span></span><br><span class="line">  <span class="comment"># https://github.com/peter-evans/slash-command-dispatch</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">peter-evans/slash-command-dispatch@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># use personal token to be able to trigger more workflows</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="comment"># the personal token to post the comment emoji</span></span><br><span class="line">    <span class="attr">reaction-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">permission:</span> <span class="string">none</span></span><br><span class="line">    <span class="attr">static-args:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      repository=$&#123;&#123; github.repository &#125;&#125;</span></span><br><span class="line"><span class="string">      comment-id=$&#123;&#123; github.event.comment.id &#125;&#125;</span></span><br><span class="line"><span class="string">      ref=$&#123;&#123; steps.pr.outputs.branch &#125;&#125;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">commands:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">cypress</span></span><br></pre></td></tr></table></figure><p>You can have multiple commands dispatched by this workflow, and they can even parse arguments. For example, I could trigger Cypress tests run against a new pull request, or measure its performance using <code>/lighthouse</code> command, following the blog post <a href="/blog/trying-lighthouse/" title="Trying Lighthouse">Trying Lighthouse</a>.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">commands:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  cypress</span></span><br><span class="line"><span class="string">  lighthouse</span></span><br></pre></td></tr></table></figure><p>Ok, so let&#39;s trigger the Cypress command workflow. The dispatch workflow adds the comment id and triggers the actual <code>slash-command-cypress.yml</code> workflow</p><p><img src="../images/two-repos/dispatch.png" alt="The dispatch workflow execution"></p><p>If the workflow is found, the dispatch immediately adds two emoji reactions to the comment.</p><p><img src="../images/two-repos/found.png" alt="This reactions mean the command workflow was found and started"></p><h2><span id="todo-app-cypress-workflow">Todo-app: Cypress workflow</span></h2><p>We are still in the &quot;todo-app&quot; repository. We triggered the <code>slash-command-cypress.yml</code> workflow. You can find the current YAML code in <a href="https://github.com/bahmutov/todo-app/blob/main/.github/workflows/slash-command-cypress.yml">slash-command-cypress.yml</a> and below:</p><figure class="highlight yml"><figcaption><span>.github/workflows/slash-command-cypress.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this workflow runs when the user comments &quot;/cypress&quot; on a pull request</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Slash</span> <span class="string">Command</span> <span class="string">(Cypress)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">repository_dispatch:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">cypress-command</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">permissions:</span></span><br><span class="line">  <span class="attr">contents:</span> <span class="string">read</span></span><br><span class="line">  <span class="attr">pull-requests:</span> <span class="string">write</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">launc-tests:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Launch</span> <span class="string">API</span> <span class="string">tests</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">event</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo off</span></span><br><span class="line"><span class="string">          echo &#x27;$&#123;&#123; toJson(github.event.client_payload.slash_command) &#125;&#125;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">the</span> <span class="string">repo</span> <span class="string">üõéÔ∏è</span></span><br><span class="line">        <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># only check out one JS file</span></span><br><span class="line">          <span class="comment"># that we use to trigger workflow in the tests repo</span></span><br><span class="line">          <span class="attr">sparse-checkout:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            .github/workflows/trigger-cypress.js</span></span><br><span class="line"><span class="string"></span>          <span class="attr">sparse-checkout-cone-mode:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Trigger</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line">        <span class="comment"># https://github.com/actions/github-script</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/github-script@v6</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">trigger</span></span><br><span class="line">        <span class="comment"># pass this repo&#x27;s name and PR number</span></span><br><span class="line">        <span class="comment"># plus the comment ID so the tests workflow can post results back</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">REPO_NAME:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">PR_NUMBER:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pull_request.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">REF:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">FEEDBACK_COMMENT_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.github.payload.comment.id</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># unfortunately we need to use a personal token to trigger</span></span><br><span class="line">          <span class="comment"># a workflow in another repo, cannot use just GITHUB_TOKEN</span></span><br><span class="line">          <span class="attr">github-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            const result = await require(&#x27;./.github/workflows/trigger-cypress.js&#x27;)(&#123; github, core &#125;);</span></span><br><span class="line"><span class="string">            return result;</span></span><br></pre></td></tr></table></figure><p>Let me explain what the workflow is doing step by step.</p><p>The workflow runs when triggered by the GitHub API with <code>repository_dispatch</code> event and <code>type=cypress-command</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">repository_dispatch:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">cypress-command</span>]</span><br></pre></td></tr></table></figure><p>This workflow needs to trigger a new run in another repo &quot;bahmutov&#x2F;todo-app-tests&quot;. A simple way to call GitHub API is to use the GitHub&#39;s own action <a href="https://github.com/actions/github-script">actions&#x2F;github-script</a>. Since I put some logic into a Node.js script, which I will show in a second, I need to check out just the file <a href="https://github.com/bahmutov/todo-app/blob/main/.github/workflows/trigger-cypress.js">.github&#x2F;workflows&#x2F;trigger-cypress.js</a>. This is the sparse checkout step:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">the</span> <span class="string">repo</span> <span class="string">üõéÔ∏è</span></span><br><span class="line">  <span class="comment"># https://github.com/actions/checkout</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># only check out one JS file</span></span><br><span class="line">    <span class="comment"># that we use to trigger workflow in the tests repo</span></span><br><span class="line">    <span class="attr">sparse-checkout:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      .github/workflows/trigger-cypress.js</span></span><br><span class="line"><span class="string"></span>    <span class="attr">sparse-checkout-cone-mode:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>Now let&#39;s see what the dispatch workflow sent us in the payload. I am printing the object first</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">event</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    echo off</span></span><br><span class="line"><span class="string">    echo &#x27;$&#123;&#123; toJson(github.event.client_payload.slash_command) &#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>For our run, it shows:</p><p><img src="../images/two-repos/named.png" alt="Cypress todo-app workflow was given parsed arguments by the dispatch workflow"></p><p>Great, so if we want to grab individual arguments, like the name of the branch, we can use expression to get the nested property <code>$&#123;&#123; github.event.client_payload.slash_command.args.named.ref &#125;&#125;</code>. We now call the script <code>trigger-cypress.js</code> and pass the individual values as environment variables:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Trigger</span> <span class="string">Cypress</span> <span class="string">run</span></span><br><span class="line">  <span class="comment"># https://github.com/actions/github-script</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/github-script@v6</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">trigger</span></span><br><span class="line">  <span class="comment"># pass this repo&#x27;s name and PR number</span></span><br><span class="line">  <span class="comment"># plus the comment ID so the tests workflow can post results back</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">REPO_NAME:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">PR_NUMBER:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pull_request.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">REF:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.slash_command.args.named.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">FEEDBACK_COMMENT_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.github.payload.comment.id</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># unfortunately we need to use a personal token to trigger</span></span><br><span class="line">    <span class="comment"># a workflow in another repo, cannot use just GITHUB_TOKEN</span></span><br><span class="line">    <span class="attr">github-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      const result = await require(&#x27;./.github/workflows/trigger-cypress.js&#x27;)(&#123; github, core &#125;);</span></span><br><span class="line"><span class="string">      return result;</span></span><br></pre></td></tr></table></figure><p>Inside the script we can use GitHub wrapper objects that call the API methods using the personal token we passed.</p><figure class="highlight js"><figcaption><span>.github/workflows/trigger-cypress.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">&#123; github, core &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> payload = &#123;</span><br><span class="line">    <span class="comment">// the name of this repo</span></span><br><span class="line">    <span class="attr">repo</span>: process.<span class="property">env</span>.<span class="property">REPO_NAME</span>,</span><br><span class="line">    <span class="attr">pullRequestNumber</span>: process.<span class="property">env</span>.<span class="property">PR_NUMBER</span>,</span><br><span class="line">    <span class="attr">ref</span>: process.<span class="property">env</span>.<span class="property">REF</span>,</span><br><span class="line">    <span class="attr">feedbackCommentId</span>: process.<span class="property">env</span>.<span class="property">FEEDBACK_COMMENT_ID</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  core.<span class="title function_">info</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// https://octokit.github.io/rest.js/v19#repos-create-dispatch-event</span></span><br><span class="line">    github.<span class="property">rest</span>.<span class="property">repos</span></span><br><span class="line">      .<span class="title function_">createDispatchEvent</span>(&#123;</span><br><span class="line">        <span class="attr">owner</span>: <span class="string">&#x27;bahmutov&#x27;</span>,</span><br><span class="line">        <span class="attr">repo</span>: <span class="string">&#x27;todo-app-tests&#x27;</span>,</span><br><span class="line">        <span class="attr">event_type</span>: <span class="string">&#x27;trigger-tests&#x27;</span>,</span><br><span class="line">        <span class="attr">client_payload</span>: payload,</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(&#123;</span><br><span class="line">          <span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;‚úÖ Success&#x27;</span>,</span><br><span class="line">          payload,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        core.<span class="title function_">error</span>(<span class="string">`Failed to dispatch event:<span class="subst">$&#123;err&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// In order to send error message in the following steps, do not raise an error</span></span><br><span class="line">        <span class="title function_">resolve</span>(&#123;</span><br><span class="line">          <span class="attr">status</span>: <span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">`‚ùå Error: <span class="subst">$&#123;err.message || <span class="string">&#x27;Unknown error&#x27;</span>&#125;</span>`</span>,</span><br><span class="line">          payload,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The action shows the parameters being passed to the repo <code>bahmutov/todo-app-tests</code> correctly</p><p><img src="../images/two-repos/params.png" alt="Trigger the workflow run in the tests repo"></p><p>Now we can shift our attention to the repo <a href="https://github.com/bahmutov/todo-app-tests">bahmutov&#x2F;todo-app-tests</a> that runs the E2E tests.</p><h2><span id="todo-app-tests-trigger-workflow">Todo-app-tests: Trigger workflow</span></h2><p>Any external caller can trigger the tests run in our <code>todo-app-tests</code> repo by calling GitHub API and sending the <code>repository_dispatch</code> event with type <code>trigger-tests</code>. For details, see <a href="/blog/run-and-trigger-github-workflow/" title="Run And Trigger GitHub Workflow">Run And Trigger GitHub Workflow</a> blog post. Here is the full workflow <a href="https://github.com/bahmutov/todo-app-tests/blob/main/.github/workflows/trigger.yml">.github&#x2F;workflows&#x2F;trigger.yml</a> that receives this event.</p><figure class="highlight yml"><figcaption><span>.github/workflows/trigger.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">trigger</span></span><br><span class="line"><span class="comment"># run this workflow on trigger or manually</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment"># trigger this workflow by calling GitHub API</span></span><br><span class="line">  <span class="attr">repository_dispatch:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">trigger-tests</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">tests:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">variables</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &#x27;### Workflow info üñ®Ô∏è&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">          echo &#x27;PR number $&#123;&#123; github.event.client_payload.pullRequestNumber &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">          echo &#x27;original repo $&#123;&#123; github.event.client_payload.repo &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">          echo &#x27;original repo reference $&#123;&#123; github.event.client_payload.ref &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># quickly post the workflow URL back in the original repo PR</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Post</span> <span class="string">workflow</span> <span class="string">URL</span> <span class="string">üîó</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="comment"># https://github.com/peter-evans/create-or-update-comment</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peter-evans/create-or-update-comment@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># need a personal token to be able to post a comment back</span></span><br><span class="line">          <span class="comment"># in the original repo</span></span><br><span class="line">          <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">comment-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">issue-number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pullRequestNumber</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            Tests workflow at $&#123;&#123; github.server_url &#125;&#125;/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment"># check out both the app and the tests</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">this</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">the</span> <span class="string">application</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">app</span> <span class="string">dependencies</span> <span class="string">üì¶</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">working-directory:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">the</span> <span class="string">application</span> <span class="string">üé¨</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          cd app</span></span><br><span class="line"><span class="string">          npm run start &amp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">E2E</span> <span class="string">tests</span> <span class="string">üèÉüèª‚Äç‚ôÇÔ∏è</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">tests</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Post</span> <span class="string">results</span> <span class="string">üì®</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">always()</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peter-evans/create-or-update-comment@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># need a personal token to be able to post a comment back</span></span><br><span class="line">          <span class="comment"># in the original repo</span></span><br><span class="line">          <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">comment-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">issue-number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pullRequestNumber</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            Tests result: $&#123;&#123; steps.tests.outcome &#125;&#125;</span></span><br><span class="line"><span class="string"></span>          <span class="attr">reactions:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">$&#123;&#123;</span> <span class="string">steps.tests.outcome</span> <span class="string">==</span> <span class="string">&#x27;success&#x27;</span> <span class="string">&amp;&amp;</span> <span class="string">&#x27;hooray&#x27;</span> <span class="string">||</span> <span class="string">&#x27;-1&#x27;</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>When we triggered the workflow using our <code>/cypress</code> comment, it finished successfully.</p><p><img src="../images/two-repos/finished.png" alt="The tests workflow has finished"></p><p>There are several things this workflow does to make it developer-friendly in two repos.</p><p>It posts the main information with the parameters it has received:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">variables</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    echo &#x27;### Workflow info üñ®Ô∏è&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">    echo &#x27;PR number $&#123;&#123; github.event.client_payload.pullRequestNumber &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">    echo &#x27;original repo $&#123;&#123; github.event.client_payload.repo &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br><span class="line"><span class="string">    echo &#x27;original repo reference $&#123;&#123; github.event.client_payload.ref &#125;&#125;&#x27; &gt;&gt; $GITHUB_STEP_SUMMARY</span></span><br></pre></td></tr></table></figure><p>This is what you see right away in the workflow summary</p><p><img src="../images/two-repos/summary.png" alt="Client payload params in the job summary"></p><p>Then it forms the browser URL to the workflow run that you see in the browser screenshot and appends it back to the original comment using the repo name and the comment id. It uses GitHub Action <a href="https://github.com/peter-evans/create-or-update-comment">peter-evans&#x2F;create-or-update-comment</a> by the same person <a href="https://github.com/peter-evans">Peter Evans</a> that wrote the slash comment dispatch action.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># quickly post the workflow URL back in the original repo PR</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Post</span> <span class="string">workflow</span> <span class="string">URL</span> <span class="string">üîó</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># https://github.com/peter-evans/create-or-update-comment</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">peter-evans/create-or-update-comment@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># need a personal token to be able to post a comment back</span></span><br><span class="line">    <span class="comment"># in the original repo</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">comment-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">issue-number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pullRequestNumber</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">Tests</span> <span class="string">workflow</span> <span class="string">at</span> <span class="string">$&#123;&#123;</span> <span class="string">github.server_url</span> <span class="string">&#125;&#125;/$&#123;&#123;</span> <span class="string">github.repository</span> <span class="string">&#125;&#125;/actions/runs/$&#123;&#123;</span> <span class="string">github.run_id</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>If you are looking at the pull request in the &quot;todo-app&quot; repo, you will see the tests workflow that you can click.</p><p><img src="../images/two-repos/url.png" alt="The tests workflow URL is appended to the original slash comment"></p><p>Then we need to check out the tests, the application code, and start the application. We will check out the application code using the branch reference name passed to us using <code>ref: $&#123;&#123; github.event.client_payload.ref &#125;&#125;</code> parameter.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check out both the app and the tests</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">this</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">the</span> <span class="string">application</span> <span class="string">repo</span> <span class="string">üõé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">app</span> <span class="string">dependencies</span> <span class="string">üì¶</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">bahmutov/npm-install@v1</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">working-directory:</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">the</span> <span class="string">application</span> <span class="string">üé¨</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    cd app</span></span><br><span class="line"><span class="string">    npm run start &amp;</span></span><br></pre></td></tr></table></figure><p>Now that the application is running in the background, let&#39;s run Cypress tests</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">E2E</span> <span class="string">tests</span> <span class="string">üèÉüèª‚Äç‚ôÇÔ∏è</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">tests</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br></pre></td></tr></table></figure><p>I am assigning this step an id <code>tests</code> so that later we can refer to the outcome of the step. We want to post the result back in the original comment in the &quot;todo-app&quot; repository.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Post</span> <span class="string">results</span> <span class="string">üì®</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">always()</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">peter-evans/create-or-update-comment@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># need a personal token to be able to post a comment back</span></span><br><span class="line">    <span class="comment"># in the original repo</span></span><br><span class="line">    <span class="attr">token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PERSONAL_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">comment-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.feedbackCommentId</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">issue-number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.pullRequestNumber</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.client_payload.repo</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      Tests result: $&#123;&#123; steps.tests.outcome &#125;&#125;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">reactions:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">steps.tests.outcome</span> <span class="string">==</span> <span class="string">&#x27;success&#x27;</span> <span class="string">&amp;&amp;</span> <span class="string">&#x27;hooray&#x27;</span> <span class="string">||</span> <span class="string">&#x27;-1&#x27;</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>The <code>steps.tests.outcome</code> can be &quot;success&quot;, &quot;failure&quot;, &quot;cancelled&quot;, or &quot;skipped&quot;. We are only interested in the &quot;success&quot; vs the others. In our case, the step succeeded, and thus we see in the comment the final status</p><p><img src="../images/two-repos/final.png" alt="The tests outcome posted as text and reaction"></p><p>Nice, this pull request is passing its tests.</p><p>In the next blog post I will describe how you can post a commit status back in the original repo. This way you can protected the branch and require the tests to pass before merging pull requests. Read the blog post <a href="/blog/set-commit-status-in-another-repo/" title="Set Commit Status In Another Repo">Set Commit Status In Another Repo</a>.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;In my previous blog post &lt;a href=&quot;/blog/how-to-keep-cypress-tests-in-another-repo/&quot; title=&quot;How to Keep Cypress Tests in Another Repo Whil
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
  <entry>
    <title>Test Refactoring Example</title>
    <link href="https://glebbahmutov.com/blog/test-refactoring/"/>
    <id>https://glebbahmutov.com/blog/test-refactoring/</id>
    <published>2023-11-02T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.600Z</updated>
    
    <content type="html"><![CDATA[<p>Recently a user posted on <a href="https://www.linkedin.com/posts/keith-petryshyn_soloproject-webdeveloper-opentowork-activity-7124944500061335553-nOn3/">LinkedIn</a> and <a href="https://x.com/KeithABCoding/status/1719179665410068497?s=20">Twitter</a> a Cypress test that checks each card element on the page against the data object. Here is the posted code screenshot.</p><p><img src="../images/refactor/cards-initial.jpeg" alt="The initial test"></p><p>In this blog post I will show how to refactor the above test to make it simpler and more accurate. There are hidden problems in the test code that might make it pass accidentally. We want to avoid such false positives, since they destroy the confidence in the ability of our automated tests to discover problems.</p><blockquote class="pullquote"><p>üéÅ You can find the source code in the recipe &quot;Check Cards&quot; hosted on my <a href="https://glebbahmutov.com/cypress-examples">Cypress examples</a> site. You can watch me refactoring the code and explaining how I go about it in the video <a href="https://youtu.be/lWWzQFt-0BI">Check Cards Test Refactoring</a> üì∫.</p></blockquote><h2><span id="the-initial-code">The initial code</span></h2><p>Let&#39;s take the following HTML fragment to be our dummy &quot;app&quot;.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Project A<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>10 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>4 events in the last 24 hours<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>stable<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Project B<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>10 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>1 event in the last 24 hours<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Project C<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>100 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>10 events in the last 24 hours<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>critical<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure><p>We need the list of projects to be the source of truth. We will check the page against this array.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mockProjects = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Project A&#x27;</span>,</span><br><span class="line">    <span class="attr">numIssues</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">numEvents24h</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;stable&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Project B&#x27;</span>,</span><br><span class="line">    <span class="attr">numIssues</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">numEvents24h</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Project C&#x27;</span>,</span><br><span class="line">    <span class="attr">numIssues</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">numEvents24h</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;critical&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>The initial code that closely resembles the code screenshot is below.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;li&#x27;</span>)</span><br><span class="line">  .<span class="title function_">each</span>(<span class="function">(<span class="params">$el, index</span>) =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">contains</span>(mockProjects[index].<span class="property">name</span>)</span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">contains</span>(mockProjects[index].<span class="property">numIssues</span>)</span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">contains</span>(mockProjects[index].<span class="property">numEvents24h</span>)</span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">contains</span>(mockProjects[index].<span class="property">status</span>)</span><br><span class="line">    cy.<span class="title function_">wrap</span>($el)</span><br><span class="line">      .<span class="title function_">find</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.attr&#x27;</span>, <span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;/dashboard/issues&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>The test passes, all is green and good in the world.</p><p><img src="../images/refactor/r1.png" alt="The initial test passes"></p><h2><span id="refactor-the-code">Refactor the code</span></h2><p>Let&#39;s shorten the code. We don&#39;t have to use <code>cy.wrap($el)</code> multiple times. We can use the <code>expect($el).to.include.text(...)</code> assertion from <a href="https://www.chaijs.com/plugins/chai-jquery/">Chai-jQuery library</a> to verify the text is present.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;li&#x27;</span>)</span><br><span class="line">  .<span class="title function_">each</span>(<span class="function">(<span class="params">$el, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, numIssues, numEvents24h, status &#125; =</span><br><span class="line">      mockProjects[index]</span><br><span class="line"></span><br><span class="line">    <span class="title function_">expect</span>($el)</span><br><span class="line">      .<span class="property">to</span>.<span class="property">include</span>.<span class="title function_">text</span>(name)</span><br><span class="line">      .<span class="property">and</span>.<span class="property">to</span>.<span class="property">include</span>.<span class="title function_">text</span>(numIssues)</span><br><span class="line">      .<span class="property">and</span>.<span class="property">to</span>.<span class="property">include</span>.<span class="title function_">text</span>(numEvents24h)</span><br><span class="line">      .<span class="property">and</span>.<span class="property">to</span>.<span class="property">include</span>.<span class="title function_">text</span>(status)</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">find</span>(<span class="string">&#x27;a[href=&quot;/dashboard/issues&quot;]&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>Since the page is static by the time we start checking, the <code>expect(...).to...</code> assertions work just fine. Alternatively, we can use <code>cy.wrap($el).within(() =&gt; ...)</code> commands to limit the search to the element.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main&#x27;</span>)</span><br><span class="line">  .<span class="title function_">find</span>(<span class="string">&#x27;li&#x27;</span>)</span><br><span class="line">  .<span class="title function_">each</span>(<span class="function">(<span class="params">$el, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, numIssues, numEvents24h, status &#125; =</span><br><span class="line">      mockProjects[index]</span><br><span class="line"></span><br><span class="line">    cy.<span class="title function_">wrap</span>($el).<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">contains</span>(name)</span><br><span class="line">      cy.<span class="title function_">contains</span>(numIssues)</span><br><span class="line">      cy.<span class="title function_">contains</span>(numEvents24h)</span><br><span class="line">      cy.<span class="title function_">contains</span>(status)</span><br><span class="line">      cy.<span class="title function_">get</span>(<span class="string">&#x27;a[href=&quot;/dashboard/issues&quot;]&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor/r2.png" alt="Using cy.within command"></p><p>I really like using <a href="https://on.cypress.io/within">cy.within</a> command. It shortens the code and makes it less likely to find a wrong element accidentally. Check out my video üì∫ <a href="https://youtu.be/YpbkEBE42QI">Find The Right Item Using The cy.within Command Or The Parent Selector</a> for another <code>cy.within</code> example.</p><h2><span id="use-selectors">Use selectors</span></h2><p>There is a problem with out test. If you have over individual <code>contains</code> commands in the left Command Log column, you can see the element if finds. Oops, seems we tried to find <code>cy.contains(&#39;4&#39;)</code> and accidentally found <code>1 even in the last 24 hours</code>. Not what we expected to find.</p><p><img src="../images/refactor/r3.png" alt="The test passed when it should have failed"></p><p>I really dislike using <code>cy.contains(partial text)</code> command, and instead prefer <code>cy.contains(selector, partial text)</code>. Let&#39;s add <code>data-cy</code> attributes to our HTML markup to be able to precisely find elements.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">main</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span> <span class="attr">data-cy</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Project A<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;issues&quot;</span>&gt;</span>10 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">data-cy</span>=<span class="string">&quot;24h&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span> events in the last 24 hours</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;status&quot;</span>&gt;</span>stable<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span> <span class="attr">data-cy</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Project B<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;issues&quot;</span>&gt;</span>10 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">data-cy</span>=<span class="string">&quot;24h&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span> event in the last 24 hours</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;status&quot;</span>&gt;</span>error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h2</span> <span class="attr">data-cy</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Project C<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;issues&quot;</span>&gt;</span>100 issues<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">data-cy</span>=<span class="string">&quot;24h&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">span</span>&gt;</span> events in the last 24 hours</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">data-cy</span>=<span class="string">&quot;status&quot;</span>&gt;</span>critical<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/dashboard/issues&quot;</span>&gt;</span>issues<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Now we can target the precise element when searching for each field.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main li.card&#x27;</span>).<span class="title function_">each</span>(<span class="function">(<span class="params">$el, index</span>) =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`checking card **<span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>**`</span>)</span><br><span class="line">  <span class="keyword">const</span> &#123; name, numIssues, numEvents24h, status &#125; =</span><br><span class="line">    mockProjects[index]</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">wrap</span>($el).<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=name]&#x27;</span>, name)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=issues]&#x27;</span>, <span class="string">`<span class="subst">$&#123;numIssues&#125;</span> issues`</span>)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=24h]&#x27;</span>, numEvents24h)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=status]&#x27;</span>, status)</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&#x27;a[href=&quot;/dashboard/issues&quot;]&#x27;</span>, <span class="string">&#x27;issues&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Super. We now don&#39;t find stray elements with the same text.</p><p><img src="../images/refactor/r4.png" alt="We target the right element when using cy.contains command"></p><h2><span id="use-data-as-the-source-of-truth">Use data as the source of truth</span></h2><p>Our test still does it backwards. It looks at the page and checks each <code>li</code> item:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main li.card&#x27;</span>).<span class="title function_">each</span>(<span class="function">(<span class="params">$el, index</span>) =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">log</span>(<span class="string">`checking card **<span class="subst">$&#123;index + <span class="number">1</span>&#125;</span>**`</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>What if our page rendering is incorrect and it only renders the first card? No problem, the test passes!</p><p><img src="../images/refactor/r5.png" alt="The test can pass even if the page does not render 2 out of 3 cards"></p><p>Remember: you cannot trust the page, but you can trust the data. Thus you should iterate over the data list of projects and check each item against what is on the page.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// confirm the correct number of items is shown</span></span><br><span class="line">cy.<span class="title function_">get</span>(<span class="string">&#x27;main li.card&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, mockProjects.<span class="property">length</span>)</span><br><span class="line"><span class="comment">// iterate over the data to confirm the info</span></span><br><span class="line"><span class="comment">// for each card is shown correctly</span></span><br><span class="line">mockProjects.<span class="title function_">forEach</span>(<span class="function">(<span class="params">project, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name, numIssues, numEvents24h, status &#125; = project</span><br><span class="line">  cy.<span class="title function_">get</span>(<span class="string">&#x27;main li.card&#x27;</span>)</span><br><span class="line">    .<span class="title function_">eq</span>(index)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=name]&#x27;</span>, name)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=issues]&#x27;</span>, <span class="string">`<span class="subst">$&#123;numIssues&#125;</span> issues`</span>)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=24h]&#x27;</span>, numEvents24h)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;[data-cy=status]&#x27;</span>, status)</span><br><span class="line">      cy.<span class="title function_">contains</span>(<span class="string">&#x27;a[href=&quot;/dashboard/issues&quot;]&#x27;</span>, <span class="string">&#x27;issues&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/refactor/r6.png" alt="The test should iterate over the data and check the rendered elements"></p><p>You can get the data the page is derived from by observing network traffic using the <code>cy.intercept</code> command or by accessing the data in the application.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently a user posted on &lt;a href=&quot;https://www.linkedin.com/posts/keith-petryshyn_soloproject-webdeveloper-opentowork-activity-7124944500
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>How I Add Test Ids To Front-End Components</title>
    <link href="https://glebbahmutov.com/blog/how-i-add-test-ids/"/>
    <id>https://glebbahmutov.com/blog/how-i-add-test-ids/</id>
    <published>2023-10-24T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.532Z</updated>
    
    <content type="html"><![CDATA[<p>When writing Cypress end-to-end or component tests, it is nice to have ways to easily select elements on the page. For example:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- not nice --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;Form-4hh4a&quot;</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- very nice --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;Form-4hh4a&quot;</span> <span class="attr">data-testid</span>=<span class="string">&quot;LoginForm&quot;</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Here is how I think about adding data test ids like <code>data-testid</code>, or <code>data-cy</code> to my HTML markup:</p><ul><li>make it simple to interact with the page</li><li>make it simple to verify the page is showing the right information</li></ul><p><strong>Tip:</strong> I suggest you read Cypress best practices for <a href="https://on.cypress.io/best-practices#Selecting-Elements">selecting elements</a></p><h2><span id="why-test-id-attributes">Why test id attributes</span></h2><p>I like using explicit test ids to select elements for two reasons:</p><ul><li>makes it obvious to every developer that this attribute is used during testing. Any other attribute can be changed or removed, but if the <code>data-test</code> is modified or removed the developer is expected to update the tests.</li><li>finding specs to run to test the source files with the given test ids is easy, see my blog posts <a href="/blog/using-test-ids-to-pick-specs-to-run/" title="Using Test Ids To Pick Cypress Specs To Run">Using Test Ids To Pick Cypress Specs To Run</a> and <a href="/blog/pick-tests-in-another-repo/" title="Pick Tests Using Test Ids From Another Source Repo">Pick Tests Using Test Ids From Another Source Repo</a>.</li></ul><p>Nothing stops you from implementing a similar policy for aria attributes. You can also verify the a11y attributes from the test when needed:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CloseButton&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.attr&#x27;</span>, <span class="string">&#x27;aria-role&#x27;</span>, <span class="string">&#x27;button&#x27;</span>)</span><br></pre></td></tr></table></figure><p>So how do I assign test ids to the elements on the page? Here are some practical examples from my <a href="https://cypress.tips/courses/swag-store">Testing The Swag Store</a> course.</p><h2><span id="the-login-page">The login page</span></h2><p>Let&#39;s start with the first UI step: logging in. The container that has the input fields needs a test id, plus the input elements and the &quot;Login&quot; button.</p><p><img src="../images/how-i-add-test-ids/t1.png" alt="The Login form component needs a test id"></p><p>Using a custom command <code>cy.getByTest</code> in my project I can fill the form without relying on random HTML attributes like <code>name</code> or <code>password</code>. I will add <code>data-test</code> attributes to:</p><ul><li>the form component</li><li>each input field to be filled</li><li>the login button</li></ul><p>Here is the test:</p><figure class="highlight js"><figcaption><span>cypress/e2e/login/login-page.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;fills the form and logs in&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;LoginForm&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;username&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;standard_user&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;password&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;secret_sauce&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;login-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/inventory.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>Tip:</strong> I love using <a href="https://on.cypress.io/within">cy.within</a> command to limit query commands to the parent element. But note that this command <a href="https://youtu.be/Emvz1PDRl3M">does not retry</a>.</p><p>Selecting the login button by its <code>data-test</code> attribute works better long-term than using text and <code>cy.contains</code> command. The text might change, but the <code>data-test</code> makes it clear: if you want to change this attribute, you better run the tests.</p><p><img src="../images/how-i-add-test-ids/t2.png" alt="The login test using test ids"></p><h2><span id="the-inventory-page">The inventory page</span></h2><p>The inventory page has several buttons in the header, the list of products, plus the sort selection. Each inventory item has text that we might want to verify: the title, the price (maybe), plus the button to add the item to the cart.</p><p><img src="../images/how-i-add-test-ids/t3.png" alt="Where to add data test ids on the inventory page"></p><p>I also add a <code>data-test</code> attribute to the top level container element: it will help verify we are on the right page if the inventory has zero items.</p><p><img src="../images/how-i-add-test-ids/t4.png" alt="Top level data test id for the inventory page"></p><p>Here is a typical test to verify the inventory page loads.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;LoginForm&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;username&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;standard_user&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;password&#x27;</span>).<span class="title function_">type</span>(<span class="string">&#x27;secret_sauce&#x27;</span>)</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;login-button&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;has items on the inventory page&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/inventory.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPage&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.length.above&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The two assertions make it easy to understand what is happening:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the inventory component loads</span></span><br><span class="line">cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPage&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line"><span class="comment">// the inventory loads at least a few items</span></span><br><span class="line">cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.length.above&#x27;</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>Let&#39;s verify the information shown by the first item. Since we added test ids to the individual text fields, we can use the <code>have.text</code> assertion:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.length.above&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  .<span class="title function_">first</span>()</span><br><span class="line">  .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemTitle&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Sauce Labs Backpack&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemPrice&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;$29.99&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemActionButton&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/how-i-add-test-ids/t5.png" alt="Checking the info specific to the item"></p><p><strong>Tip:</strong> Cypress comes with many Chai and Chai-jQuery and Sinon-Chai assertions, see <a href="https://glebbahmutov.com/cypress-examples/commands/assertions.html">my examples</a></p><p>Since checking an element&#39;s text is so common, I prefer writing custom commands like <code>cy.getByTest</code> that can act like both <code>cy.get</code> and <code>cy.contains</code> commands.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">  .<span class="title function_">should</span>(<span class="string">&#x27;have.length.above&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  .<span class="title function_">first</span>()</span><br><span class="line">  .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemTitle&#x27;</span>, <span class="string">&#x27;Sauce Labs Backpack&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemPrice&#x27;</span>, <span class="string">&#x27;$29.99&#x27;</span>)</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemActionButton&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p><img src="../images/how-i-add-test-ids/t6.png" alt="Elegant test code by passing the test id and the text to the custom command"></p><p>Before we move to the cart page, let&#39;s confirm the inventory page updates the cart badge</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;adds items to the cart&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.<span class="title function_">location</span>(<span class="string">&#x27;pathname&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;equal&#x27;</span>, <span class="string">&#x27;/inventory.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPage&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initially there is no cart badge</span></span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartBadge&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;not.exist&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">    .<span class="title function_">first</span>()</span><br><span class="line">    .<span class="title function_">within</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemActionButton&#x27;</span>, <span class="string">&#x27;Add to cart&#x27;</span>).<span class="title function_">click</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">// cart badge shows 1</span></span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartBadge&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  <span class="comment">// and the item changes its label to &quot;Remove&quot;</span></span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;InventoryPageItem&#x27;</span>)</span><br><span class="line">    .<span class="title function_">first</span>()</span><br><span class="line">    .<span class="title function_">getByTest</span>(<span class="string">&#x27;ItemActionButton&#x27;</span>)</span><br><span class="line">    .<span class="title function_">should</span>(<span class="string">&#x27;have.text&#x27;</span>, <span class="string">&#x27;Remove&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Here are the two test ids we used</p><p><img src="../images/how-i-add-test-ids/t7.png" alt="Adding items to the cart using test ids"></p><h2><span id="the-cart-page">The cart page</span></h2><p>Let&#39;s test just the cart page. We can set the user local state with items in the cart and visit the page.</p><figure class="highlight js"><figcaption><span>cypress/e2e/cart/cart-page.cy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;shows the cart items&#x27;</span>, &#123; <span class="attr">viewportHeight</span>: <span class="number">1200</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ids = [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">0</span>, <span class="attr">n</span>: <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">n</span>: <span class="number">2</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">n</span>: <span class="number">5</span> &#125;,</span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">// set the ids in the local storage item &quot;cart-contents&quot;</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;cart-contents&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(ids))</span><br><span class="line">  cy.<span class="title function_">visit</span>(<span class="string">&#x27;/cart.html&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartBadge&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartContents&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartItem&#x27;</span>).<span class="title function_">should</span>(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  <span class="comment">// iterate over the data and verify each item shown</span></span><br><span class="line">  ids.<span class="title function_">forEach</span>(<span class="function">(<span class="params">id, k</span>) =&gt;</span> &#123;</span><br><span class="line">    cy.<span class="title function_">getByTest</span>(<span class="string">&#x27;CartItem&#x27;</span>)</span><br><span class="line">      .<span class="title function_">eq</span>(k)</span><br><span class="line">      .<span class="title function_">getByTest</span>(<span class="string">&#x27;CartQuantity&#x27;</span>)</span><br><span class="line">      .<span class="title function_">should</span>(<span class="string">&#x27;have.value&#x27;</span>, ids[k].<span class="property">n</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>By setting the data in the <code>localStorage</code> we know exactly what to expect to see on the page. Thus we can loop through the list and confirm each <code>CartItem</code> item.</p><p><img src="../images/how-i-add-test-ids/t8.png" alt="Test ids for the Cart page"></p><h2><span id="bonus-show-test-ids">Bonus: show test ids</span></h2><p>If you use my plugin <a href="https://github.com/bahmutov/changed-test-ids">changed-test-ids</a> you can see all test ids used in the source files and in the spec files. For example, let&#39;s list test ids used in the specs and also list all test ids <em>not</em> covered by specs.</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;specs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;find-ids find-ids --specs &#x27;cypress/e2e/**/*.cy.&#123;js,ts&#125;&#x27; --command getByTest --verbose&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;missing-tests&quot;</span><span class="punctuation">:</span> <span class="string">&quot;find-ids --specs &#x27;cypress/e2e/**/*.cy.&#123;js,ts&#125;&#x27; --command getByTest --sources &#x27;src/**/*.jsx&#x27;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s list test ids in the specs</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ npm run specs</span><br><span class="line"></span><br><span class="line">&gt; taste-the-sauce@1.0.0 specs</span><br><span class="line">&gt; find-ids find-ids --specs &#x27;cypress/e2e/**/*.cy.&#123;js,ts&#125;&#x27; --command getByTest --verbose</span><br><span class="line"></span><br><span class="line">&quot;CartBadge&quot; used in 3 spec(s)</span><br><span class="line">  cypress/e2e/cart/cart-page.cy.ts, cypress/e2e/inventory/inventory-page.cy.ts, cypress/e2e/inventory/inventory-page.cy.ts</span><br><span class="line">&quot;CartContents&quot; used in 1 spec(s)</span><br><span class="line">  cypress/e2e/cart/cart-page.cy.ts</span><br><span class="line">&quot;CartItem&quot; used in 2 spec(s)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Let&#39;s see all test ids without any tests</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ npm run missing-tests</span><br><span class="line"></span><br><span class="line">&gt; taste-the-sauce@1.0.0 missing-tests</span><br><span class="line">&gt; find-ids --specs &#x27;cypress/e2e/**/*.cy.&#123;js,ts&#125;&#x27; --command getByTest --sources &#x27;src/**/*.jsx&#x27;</span><br><span class="line"></span><br><span class="line">‚ö†Ô∏è found 6 test id(s) not covered by any specs</span><br><span class="line">AddToCart</span><br><span class="line">CartBackToShopping</span><br><span class="line">cancel</span><br><span class="line">continue</span><br><span class="line">error</span><br><span class="line">finish</span><br></pre></td></tr></table></figure><p>Nice.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;When writing Cypress end-to-end or component tests, it is nice to have ways to easily select elements on the page. For example:&lt;/p&gt;
&lt;figu
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
  </entry>
  
  <entry>
    <title>Run Cypress Specs In Parallel For Free Using Spec Timings</title>
    <link href="https://glebbahmutov.com/blog/cypress-parallel-free-based-on-timings/"/>
    <id>https://glebbahmutov.com/blog/cypress-parallel-free-based-on-timings/</id>
    <published>2023-10-17T04:00:00.000Z</published>
    <updated>2024-04-23T22:55:08.510Z</updated>
    
    <content type="html"><![CDATA[<p>Recently Cypress-the-company blocked projects that use 3rd party dashboard plugins like <code>sorry-cypress</code>.</p><p><img src="../images/split-time/blocked.png" alt="Cypress blocked 3rd party dashboard plugins"></p><p>For more details see <a href="https://currents.dev/posts/v13-blocking">Cypress.io Blocking of Sorry Cypress and Currents</a>.</p><h2><span id="free-solution-is-available">Free solution is available</span></h2><p>If you want to split your multiple specs across multiple machines for free, I have created <a href="https://github.com/bahmutov/cypress-split">cypress-split</a> plugin and described how to <a href="/blog/cypress-parallel-free/" title="Run Cypress Specs In Parallel For Free">Run Cypress Specs In Parallel For Free</a>. This solution does not &quot;mimic&quot; the Cypress Cloud API, thus it should not be banned.</p><blockquote class="pullquote"><p>‚ò¢Ô∏è If Cypress team DOES block <a href="https://github.com/bahmutov/cypress-split">cypress-split</a> plugin, then I will have no choice but to block all my Cypress plugins (I have written 75+ Cypress plugins) if Cypress is run with <code>--record</code> flag.</p></blockquote><p>All we need to do to use this plugin is to add it to the <code>setupNodeEvents</code> callback.</p><figure class="highlight js"><figcaption><span>cypress.config.mjs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;cypress&#x27;</span></span><br><span class="line"><span class="keyword">import</span> cypressSplit <span class="keyword">from</span> <span class="string">&#x27;cypress-split&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">e2e</span>: &#123;</span><br><span class="line">    <span class="comment">// baseUrl, etc</span></span><br><span class="line">    <span class="attr">supportFile</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">fixturesFolder</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="title function_">setupNodeEvents</span>(<span class="params">on, config</span>) &#123;</span><br><span class="line">      <span class="title function_">cypressSplit</span>(on, config)</span><br><span class="line">      <span class="comment">// IMPORTANT: return the config object</span></span><br><span class="line">      <span class="keyword">return</span> config</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The specs were split purely based on their names in the list, which can create unbalanced lists for machines. For example, let&#39;s take a project with five specs split across two machines. The first run splits the specs alphabetically:</p><p><img src="../images/split-time/t1.png" alt="Alphabetical spec timings on two machines"></p><p>Here is our GitHub Actions workflow file</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">test-split:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="comment"># use two containers to run the tests</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">containers:</span> [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">split</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">üß™</span></span><br><span class="line">        <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># we don&#x27;t need Cypress own runner summary</span></span><br><span class="line">          <span class="attr">publish-summary:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">SPLIT:</span> <span class="string">$&#123;&#123;</span> <span class="string">strategy.job-total</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">SPLIT_INDEX:</span> <span class="string">$&#123;&#123;</span> <span class="string">strategy.job-index</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><blockquote class="pullquote"><p>üéÅ You can find the example application in the repo <a href="https://github.com/bahmutov/cypress-split-timings-example">cypress-split-timings-example</a>. In this examples I am using version v1 the <code>cypress-split</code> plugin.</p></blockquote><p>Ughh, there is a spec <code>spec-d.cy.js</code> that is much longer than others, and it makes the second machine take much longer. While the second machine is running <code>spec-d.cy.js</code> and <code>spec-e.cy.js</code>, the first machine is idle. It would be better to shift the spec <code>spec-e.cy.js</code> to the first machine. Then we would save 10 seconds.</p><h2><span id="timings">Timings</span></h2><p>Let&#39;s tell <code>cypress-split</code> to split specs based on previous run timings. Unfortunately, we do not have 3rd party service to keep track of spec timings, thus we need to do it ourselves. Let&#39;s set another environment variable <code>SPLIT_FILE</code> on the test runners. Right now, it points at a non-existent file <code>timings.json</code> in the root folder of the repo.</p><figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">split</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">üß™</span></span><br><span class="line">  <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># we don&#x27;t need Cypress own runner summary</span></span><br><span class="line">    <span class="attr">publish-summary:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">SPLIT:</span> <span class="string">$&#123;&#123;</span> <span class="string">strategy.job-total</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">SPLIT_INDEX:</span> <span class="string">$&#123;&#123;</span> <span class="string">strategy.job-index</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">SPLIT_FILE:</span> <span class="string">&#x27;timings.json&#x27;</span></span><br></pre></td></tr></table></figure><p>Let&#39;s run the workflow again. The <code>timings.json</code> file is not found yet, no big deal. The specs are split alphabetically.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cypress-split: there are 5 found specs</span><br><span class="line">cypress-split: chunk 1 of 2</span><br><span class="line">cypress-split: Could not split specs by duration</span><br><span class="line">ENOENT: no such file or directory, open &#x27;timings.json&#x27;</span><br><span class="line">cypress-split: splitting as is by name</span><br><span class="line">k  spec</span><br><span class="line">-  ------------------------</span><br><span class="line">1  cypress/e2e/spec-a.cy.js</span><br><span class="line">2  cypress/e2e/spec-b.cy.js</span><br><span class="line">3  cypress/e2e/spec-c.cy.js</span><br></pre></td></tr></table></figure><p>At the end of the run, the plugin prints JSON object with spec durations for the current machines.</p><p><img src="../images/split-time/t2.png" alt="Spec timings from the first machine"></p><p>The second machine prints its timings JSON</p><p><img src="../images/split-time/t3.png" alt="Spec timings from the second machine"></p><p><strong>Note:</strong> the timings are logged to the terminal and saved in the local file on CI. Thus at the end of the test-run each machine has its own uncommitted <code>SPLIT_FILE</code> file on disk.</p><p>You manually copy &#x2F; paste both timings and merge them into a single <code>timings.json</code> file and add to the repo.</p><figure class="highlight json"><figcaption><span>timings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;durations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cypress/e2e/spec-a.cy.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">10065</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cypress/e2e/spec-b.cy.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">10054</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cypress/e2e/spec-c.cy.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">10061</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cypress/e2e/spec-d.cy.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">60124</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cypress/e2e/spec-e.cy.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">10053</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>With this file present in the repo, the CI runs and <code>cypress-split</code> splits the specs based on durations. The first machine runs only the spec <code>cypress/e2e/spec-d.cy.js</code> which takes by itself 60 seconds. The second machine runs the rest of the specs that together take up 40 seconds.</p><p><img src="../images/split-time/t4.png" alt="Specs split based on timings"></p><p>Nice. The spec split implementation can be found in the <a href="https://github.com/bahmutov/cypress-split/blob/main/src/timings.js">src&#x2F;timings.js</a> file in the <code>cypress-split</code> plugin. Right now it is a simple greedy algorithm, but it seems to work just fine.</p><h2><span id="updating-timingsjson-file-single-ci-job">Updating timings.json file: single CI job</span></h2><p>If specs change or new specs are added, the timings file becomes out-of-date. I have a couple of ideas how to update it periodically without relying on 3rd party service.</p><p><strong>Note:</strong> if the spec is new and does not have duration in the timings file yet, the split algorithm assigns it an average duration of all existing specs.</p><p>The first strategy is to use a single long CI job that runs all specs and then commits the updated <code>timings.json</code> file. It is very easy to commit changed files when using GitHub Actions CI.</p><figure class="highlight yml"><figcaption><span>.github/workflows/nightly.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">nightly</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment"># run this workflow every night at 3am</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;0 3 * * *&#x27;</span></span><br><span class="line">  <span class="comment"># or when the user triggers it from GitHub Actions page</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">all-tests:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">all</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">üß™</span></span><br><span class="line">        <span class="comment"># https://github.com/cypress-io/github-action</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v6</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># we don&#x27;t need Cypress own runner summary</span></span><br><span class="line">          <span class="attr">publish-summary:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># pretend we want to split all specs</span></span><br><span class="line">          <span class="comment"># just so we can write all spec timings into the file</span></span><br><span class="line">          <span class="attr">SPLIT:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">SPLIT_INDEX:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">SPLIT_FILE:</span> <span class="string">&#x27;timings.json&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Commit</span> <span class="string">changed</span> <span class="string">spec</span> <span class="string">timings</span> <span class="string">‚è±Ô∏è</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">github.ref</span> <span class="string">==</span> <span class="string">&#x27;refs/heads/main&#x27;</span></span><br><span class="line">        <span class="comment"># https://github.com/stefanzweifel/git-auto-commit-action</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">stefanzweifel/git-auto-commit-action@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">Updated</span> <span class="string">spec</span> <span class="string">timings</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">file_pattern:</span> <span class="string">timings.json</span></span><br></pre></td></tr></table></figure><p>The above workflow runs every day or when I start it manually from GitHub repo Actions tab. If there are any changes to the timings, the <code>timings.json</code> file is committed and pushed to the repository using the wonderful reusable GitHub Action <a href="https://github.com/stefanzweifel/git-auto-commit-action">stefanzweifel&#x2F;git-auto-commit-action</a>.</p><p><strong>Note:</strong> <code>cypress-split</code> writes new timings file only if there are new specs or any durations are off by more than 10% from the existing ones.</p><h2><span id="updating-timingsjson-file-merge-timings">Updating timings.json file: merge timings</span></h2><p>Instead of running a single job with all specs to update the timings file, we can use my <code>split</code> workflow from <a href="https://github.com/bahmutov/cypress-workflows">cypress-workflows</a> repo. It works with <code>cypress-split</code> alias <code>cypress-split-merge</code> to merge downloaded timings files from parallel runs and output a single combined JSON as a GitHub Actions output. Here is an example workflow from <a href="https://github.com/bahmutov/cypress-split-timings-example">cypress-split-timings-example</a> repo.</p><figure class="highlight yml"><figcaption><span>.github/workflows/split.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">split</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment"># launch this workflow from GitHub Actions page</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">split:</span></span><br><span class="line">    <span class="comment"># https://github.com/bahmutov/cypress-workflows</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">bahmutov/cypress-workflows/.github/workflows/split.yml@v2</span></span><br><span class="line">    <span class="attr">with:</span></span><br><span class="line">      <span class="attr">nE2E:</span> <span class="number">2</span></span><br><span class="line">      <span class="comment"># use timings to split E2E specs across 2 machines efficiently</span></span><br><span class="line">      <span class="attr">split-file:</span> <span class="string">&#x27;timings.json&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># this job grab the output for the `split` workflow</span></span><br><span class="line">  <span class="comment"># and writes it into a JSON file &quot;timings.json&quot;</span></span><br><span class="line">  <span class="comment"># and then commits the updated file to the repository</span></span><br><span class="line">  <span class="attr">commit-updated-timings:</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">github.ref</span> <span class="string">==</span> <span class="string">&#x27;refs/heads/main&#x27;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-22.04</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">split</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">merged</span> <span class="string">timings</span> <span class="string">üñ®Ô∏è</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo off</span></span><br><span class="line"><span class="string">          echo &#x27;$&#123;&#123; needs.split.outputs.merged-timings &#125;&#125;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">updated</span> <span class="string">timings</span> <span class="string">üíæ</span></span><br><span class="line">        <span class="comment"># pretty-print json string into a file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&#x27;$<span class="template-variable">&#123;&#123; toJson(fromJson(needs.split.outputs.merged-timings)) &#125;&#125;</span>&#x27;</span> <span class="string">&gt;</span> <span class="string">timings.json</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Commit</span> <span class="string">changed</span> <span class="string">spec</span> <span class="string">timings</span> <span class="string">‚è±Ô∏è</span></span><br><span class="line">        <span class="comment"># https://github.com/stefanzweifel/git-auto-commit-action</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">stefanzweifel/git-auto-commit-action@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">commit_message:</span> <span class="string">Updated</span> <span class="string">spec</span> <span class="string">timings</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">file_pattern:</span> <span class="string">timings.json</span></span><br></pre></td></tr></table></figure><p><img src="../images/split-time/split-workflow.png" alt="The above workflow in action"></p><p>The reusable workflow <code>split</code> expands into multiple jobs. At the end, the <code>merge-split-timings</code> job creates the <code>merged-timings</code> output with all combined timings. We can commit the timings into the repo to be used for next CI run.</p><p><img src="../images/split-time/t5.png" alt="Showing merged timings"></p><p>If you have any problems using <a href="https://github.com/bahmutov/cypress-split">cypress-split</a> or <a href="https://github.com/bahmutov/cypress-workflows">cypress-workflows</a> do not hesitate opening a GitHub issue. I will be happy to help.</p><p>Running all E2E tests should be fast and easy.</p><h2><span id="see-also">See also</span></h2><ul><li>üì∫ Watch presentation <a href="https://youtu.be/1idlr9IE0oU">Fast Testing Using Cypress For Free üí∏üí∏üí∏</a> and see its <a href="https://slides.com/bahmutov/fast-testing-using-cypress-for-free">slides</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Recently Cypress-the-company blocked projects that use 3rd party dashboard plugins like &lt;code&gt;sorry-cypress&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;../i
      
    
    </summary>
    
      <category term="products" scheme="https://glebbahmutov.com/blog/categories/products/"/>
    
    
      <category term="testing" scheme="https://glebbahmutov.com/blog/tags/testing/"/>
    
      <category term="cypress" scheme="https://glebbahmutov.com/blog/tags/cypress/"/>
    
      <category term="github" scheme="https://glebbahmutov.com/blog/tags/github/"/>
    
  </entry>
  
</feed>
