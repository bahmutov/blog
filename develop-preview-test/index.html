<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Test the Preview Vercel Deploys | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="The site Vercel deployment Index page   Preview deploys Testing Testing previews Bonus: print the GitHub event and values   GitHub Checks Cypress Dashboard Cypress GH Integration More info    The s">
<meta property="og:type" content="article">
<meta property="og:title" content="Test the Preview Vercel Deploys">
<meta property="og:url" content="https://glebbahmutov.com/blog/develop-preview-test/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="The site Vercel deployment Index page   Preview deploys Testing Testing previews Bonus: print the GitHub event and values   GitHub Checks Cypress Dashboard Cypress GH Integration More info    The s">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/readme.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/settings.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/git-integration.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/domains.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/main.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/navigation.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/vercel-for-github.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/preview-comment.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/preview.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/urls.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/navigation-test.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/deployment-checks.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/ci-events.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/skip-jobs.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/protected-branch.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/fails.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/trailing-slash.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/passing-e2e.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/no-status.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/post-status.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/post-jobs.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/target_url.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/runs.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/set-up-project.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/record-settings.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/secret.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/recording-url.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/first-run.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/gh-app.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/configure-gh-app.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/comments.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/checks.png">
<meta property="article:published_time" content="2020-08-20T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.267Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="cypress">
<meta property="article:tag" content="github">
<meta property="article:tag" content="ci">
<meta property="article:tag" content="cypress dashboard">
<meta property="article:tag" content="vercel">
<meta property="article:tag" content="11ty">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/deploy-preview-test/readme.png">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-develop-preview-test" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2020-08-20T04:00:00.000Z" itemprop="datePublished">Aug 20 2020</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/process/">process</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Test the Preview Vercel Deploys
    </h1>

    <h2 class="article-title" itemprop="name">
      Run end-to-end Cypress tests against Vercel preview deploys using GitHub Actions
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- toc -->

<ul>
<li><a href="#the-site">The site</a></li>
<li><a href="#vercel-deployment">Vercel deployment</a><ul>
<li><a href="#index-page">Index page</a></li>
</ul>
</li>
<li><a href="#preview-deploys">Preview deploys</a></li>
<li><a href="#testing">Testing</a><ul>
<li><a href="#testing-previews">Testing previews</a></li>
<li><a href="#bonus-print-the-github-event-and-values">Bonus: print the GitHub event and values</a></li>
</ul>
</li>
<li><a href="#github-checks">GitHub Checks</a></li>
<li><a href="#cypress-dashboard">Cypress Dashboard</a></li>
<li><a href="#cypress-gh-integration">Cypress GH Integration</a></li>
<li><a href="#more-info">More info</a></li>
</ul>
<!-- tocstop -->

<h2><span id="the-site">The site</span></h2><p>Let&#39;s play with a personal site made using <a target="_blank" rel="noopener" href="https://www.11ty.dev/">11ty</a>. You can find the source code in the repo <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example">bahmutov&#x2F;eleventy-example</a>. We start with a basic page in the <code>README.md</code> file.</p>
<figure class="highlight md"><figcaption><span>README.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># My site</span></span><br><span class="line"><span class="quote">&gt; A static site using [<span class="string">11ty</span>](<span class="link">https://www.11ty.dev/</span>)</span></span><br></pre></td></tr></table></figure>

<p>Install the <code>11ty</code> NPM package</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm i -D @11ty/eleventy</span></span><br><span class="line">+ @11ty/eleventy@0.11.0</span><br></pre></td></tr></table></figure>

<p>And start the local site</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npx eleventy --serve</span></span><br><span class="line">Writing _site/README/index.html from ./README.md.</span><br><span class="line">Writing _site/index.html from ./index.html.</span><br><span class="line">Wrote 2 files in 0.08 seconds (v0.11.0)</span><br><span class="line">Watching‚Ä¶</span><br><span class="line">[Browsersync] Access URLs:</span><br><span class="line"> -----------------------------------</span><br><span class="line">       Local: http://localhost:8081</span><br><span class="line">    External: http://10.0.0.141:8081</span><br><span class="line"> -----------------------------------</span><br><span class="line">          UI: http://localhost:3001</span><br><span class="line"> UI External: http://localhost:3001</span><br><span class="line"> -----------------------------------</span><br><span class="line">[Browsersync] Serving files from: _site</span><br></pre></td></tr></table></figure>

<p>The static page does not look like much - but the generator is fast and simple to use.</p>
<p><img src="/blog/images/deploy-preview-test/readme.png" alt="README page"></p>
<p><strong>Tip:</strong> by default <code>eleventy --start</code> serves the page at port 8080. If that port is busy, it automatically serves at the next available port, in this case the site was serves at port 8081.</p>
<h2><span id="vercel-deployment">Vercel deployment</span></h2><p>We need the entire world to see our awesome site. Let&#39;s deploy it using <a target="_blank" rel="noopener" href="https://vercel.com/">Vercel</a> platform. I have created a new project and picked &quot;11ty&quot; application&#39;s default settings for the build command and output folder.</p>
<p><img src="/blog/images/deploy-preview-test/settings.png" alt="Vercel project settings page"></p>
<p>I have linked the Vercel project with the GitHub repository <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example">bahmutov&#x2F;eleventy-example</a></p>
<p><img src="/blog/images/deploy-preview-test/git-integration.png" alt="Vercel project is linked to the GitHub repository"></p>
<p>Every time we push a new commit to the <code>main</code> branch, the static site is built and deployed globally under a subdomain of <code>vercel.app</code>.</p>
<p><img src="/blog/images/deploy-preview-test/domains.png" alt="Production site lives at this domain"></p>
<p>Here is the production site deployed from the <code>main</code> branch.</p>
<p><img src="/blog/images/deploy-preview-test/main.png" alt="Deployed main branch is the production"></p>
<h3><span id="index-page">Index page</span></h3><p>We probably want to deploy the top level index page as well, and navigate to the <code>/README</code> page. Let&#39;s throw a root <code>index.html</code> there</p>
<figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>11ty Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hi there<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Check out <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/README&quot;</span>&gt;</span>the README<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The navigation works: when the users clicks on the link, the browser goes to the <code>/README</code> page. When the user clicks the browser&#39;s &quot;back&quot; button, it navigates back to the index page.</p>
<p><img src="/blog/images/deploy-preview-test/navigation.gif" alt="Navigation is working locally"></p>
<h2><span id="preview-deploys">Preview deploys</span></h2><p>I want to deploy the new index page - but I am not sure if the top level navigation is going to work with an actual domain (because I seriously doubt my programming skills). It would be a nice idea to deploy the full site to a temporary <em>preview domain</em> first, test it out, and if it works correctly, then merge the pull request to the <code>main</code> branch, which deploys to production.</p>
<p>I will create a new branch <code>add-index-page</code> and commit the new code there:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/git/eleventy-example on add-index-page</span><br><span class="line">$ git log --oneline</span><br><span class="line">1407be3 (HEAD -&gt; add-index-page) add index page with navigation</span><br></pre></td></tr></table></figure>

<p>In my GitHub repository I have installed the <a target="_blank" rel="noopener" href="https://vercel.com/docs/git-integrations/vercel-for-github">Vercel GitHub App</a> which automatically deploys every pull request.</p>
<p><img src="/blog/images/deploy-preview-test/vercel-for-github.png" alt="Vercel for GitHub"></p>
<p>By pushing the new branch to the repository and opening a pull request <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example/pull/2">#2</a> I trigger the deployment. The Vercel bot comments on the PR with the deployed URL</p>
<p><img src="/blog/images/deploy-preview-test/preview-comment.png" alt="Preview deployment comment"></p>
<p>We can click on the preview URL to visit the deployed site and confirm manually that the navigation works</p>
<p><img src="/blog/images/deploy-preview-test/preview.gif" alt="Preview deployment shows the navigation is working"></p>
<p>The PR preview URL <code>https://eleventy-example-git-add-index-page.bahmutov.vercel.app/</code> is a concatenation of the project name &quot;eleventy-example&quot;, the source type &quot;git&quot;, the branch name &quot;add-index-page&quot;, my user name &quot;bahmutov&quot;, and the top level domain name &quot;vercel.app&quot;. In addition, there is a unique preview URL for <em>every commit</em>. You can find these URLs at the Vercel deploy page.</p>
<p><img src="/blog/images/deploy-preview-test/urls.png" alt="PR preview URLs"></p>
<p>If we push more commits to the branch <code>add-index-page</code>, the new deploys will get their new unique <code>eleventy-example-&lt;HASH&gt;.vercel.app</code> URLs, while the latest branch preview will still have the top level <code>&lt;project&gt;-git-&lt;branch&gt;-&lt;username&gt;.vercel.app</code> URL.</p>
<h2><span id="testing">Testing</span></h2><p>We have tried the PR preview manually, but a better idea to prevent bugs in the deployed web applications is to write automated end-to-end tests using <a target="_blank" rel="noopener" href="https://www.cypress.io/">Cypress</a>. Let&#39;s install Cypress and write a test in our pull request.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm i -D cypress</span></span><br></pre></td></tr></table></figure>

<p>When we ran the site locally, we tested it at the <code>localhost:8080</code>. Let&#39;s put this setting into <code>cypress.json</code> file.</p>
<figure class="highlight json"><figcaption><span>cypress.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;baseUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Our spec file will perform what we have done manually - it will navigate by using the link to the <code>/README</code> page and back.</p>
<figure class="highlight js"><figcaption><span>cypress/integration/spec.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;cypress&quot; /&gt;</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;11ty&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;navigates&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// find more Cypress commands at</span></span><br><span class="line">    <span class="comment">// https://on.cypress.io/api</span></span><br><span class="line">    cy.<span class="title function_">visit</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&quot;Hi there&quot;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;the README&quot;</span>).<span class="title function_">click</span>();</span><br><span class="line">    cy.<span class="title function_">location</span>(<span class="string">&quot;pathname&quot;</span>).<span class="title function_">should</span>(<span class="string">&quot;match&quot;</span>, <span class="regexp">/\/README\/$/</span>);</span><br><span class="line">    cy.<span class="title function_">go</span>(<span class="string">&quot;back&quot;</span>);</span><br><span class="line">    cy.<span class="title function_">contains</span>(<span class="string">&quot;Hi there&quot;</span>); <span class="comment">// back on the index page</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Start Cypress with <code>npx cypress open</code> while the application is running and observe the test passing for the right reason. Hover over each command to observe the site&#39;s DOM snapshot and how it changed in response to the anchor <code>click</code> or <code>cy.go(&#39;back&#39;)</code> command.</p>
<p><img src="/blog/images/deploy-preview-test/navigation-test.gif" alt="Navigation test passing locally"></p>
<p><strong>Tip:</strong> read how to write flake-free Cypress tests when navigating from page to page in the blog post <a target="_blank" rel="noopener" href="https://www.cypress.io/blog/2020/08/17/when-can-the-test-navigate/">When Can The Test Navigate?</a>.</p>
<h3><span id="testing-previews">Testing previews</span></h3><p>We ran the above test locally. Let&#39;s run the same test automatically against the deployed preview URL. Luckily for us, Vercel for GitHub dispatches <em>deployment</em> events to GitHub, and we can write a GitHub Action that would execute in response to this event. Let&#39;s first simply print the event object to see if it has the target preview URL to test.</p>
<p><strong>Tip:</strong> if you have never used GitHub Actions, read my <a href="../trying-github-actions/">Trying GitHub Actions</a> blog post.</p>
<figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">deployment</span>, <span class="string">deployment_status</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">show-event:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;$GITHUB_CONTEXT&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>push</code> event happens for every commit. This would give us a chance to test the site separately from the deployment. For example, we could lint the site&#39;s source text and run the Cypress tests against the site running locally.</li>
<li><code>deployment</code> event happens when Vercel starts the preview deploy - it does not have the deploy URL</li>
<li><code>deployment_status</code> event is sent by Vercel twice. First, when the preview deployment starts, and second time when the preview deployment finishes.</li>
</ul>
<p>Notice that the <code>deployment_status</code> is not listed in the PR checks - they are &quot;hidden&quot; or overwritten by the &quot;deployment&quot; event, which to me seems like a bad user interface.</p>
<p><img src="/blog/images/deploy-preview-test/deployment-checks.png" alt="GitHub pull request checks"></p>
<p>Instead, we need to look at the &quot;Actions&quot; tab to see the <code>ci</code> workflows run, and by clicking inside figure out they ran triggered by the <code>deployment_status</code> events.</p>
<p><img src="/blog/images/deploy-preview-test/ci-events.png" alt="CI events for every commit"></p>
<p>The pending <code>deployment_status</code> event has the following information inside the <code>github</code> JSON event</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;description&quot;: &quot;Vercel is deploying your app&quot;,</span><br><span class="line">&quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">&quot;state&quot;: &quot;pending&quot;,</span><br><span class="line">&quot;target_url&quot;: &quot;https://eleventy-example-5ccl0n3a7.vercel.app&quot;</span><br></pre></td></tr></table></figure>

<p>The second <code>deployment_status</code> event inside the GitHub CI action has status</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;description&quot;: &quot;Deployment has completed&quot;,</span><br><span class="line">&quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">&quot;state&quot;: &quot;success&quot;,</span><br><span class="line">&quot;target_url&quot;: &quot;https://eleventy-example-5ccl0n3a7.vercel.app&quot;</span><br></pre></td></tr></table></figure>

<p>We can limit the GitHub Action to only run a job when an expression is true. In our case we want to run end-to-end tests only after successful deploy - and we want to pass the &quot;target_url&quot; as <code>baseUrl</code> parameter. We can pass the base url using the <code>CYPRESS_BASE_URL</code> environment variable. Here is our updated workflow file</p>
<figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">deployment</span>, <span class="string">deployment_status</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">e2e:</span></span><br><span class="line">    <span class="comment"># only runs this job on successful deploy</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">github.event_name</span> <span class="string">==</span> <span class="string">&#x27;deployment_status&#x27;</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.deployment_status.state</span> <span class="string">==</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Dump</span> <span class="string">GitHub</span> <span class="string">context</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_CONTEXT:</span> <span class="string">$&#123;&#123;</span> <span class="string">toJson(github)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;$GITHUB_CONTEXT&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">üå≤</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>When we push the commit, we can see the CI jobs skipped - except for the last job.</p>
<p><img src="/blog/images/deploy-preview-test/skip-jobs.png" alt="Skip all jobs but one - which runs on successful deployment"></p>
<p>I love requiring certain test jobs to pass before a pull request can be merged. Thus I set up protected branches with <code>e2e</code> job required to allow merging.</p>
<p><img src="/blog/images/deploy-preview-test/protected-branch.png" alt="Protected branch `main` requires `e2e` job to pass successfully"></p>
<p>The E2E job runs ... and fails!</p>
<p><img src="/blog/images/deploy-preview-test/fails.png" alt="Our test against the preview URL fails"></p>
<p><strong>Tip:</strong> debugging realistic test failures is much simpler when you have access to the screenshots and test run videos, I recommend using <a target="_blank" rel="noopener" href="https://on.cypress.io/dashboard-introduction">Cypress Dashboard</a> to <a target="_blank" rel="noopener" href="https://www.cypress.io/blog/2018/08/28/record-test-artifacts-from-any-ci/">record the test artifacts from any CI</a>.</p>
<p>Hmm, seems Vercel does not add a trailing slash when serving the production version of the code, while <code>11ty</code> running locally does add one.</p>
<p><img src="/blog/images/deploy-preview-test/trailing-slash.png" alt="The difference in trailing slashes"></p>
<p>Testing against the deployed preview URLs just showed its usefulness. Let&#39;s update the test to be less strict.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- cy.location(&quot;pathname&quot;).should(&quot;match&quot;, /\/README\/$/);</span></span><br><span class="line"><span class="addition">+ cy.location(&quot;pathname&quot;).should(&quot;include&quot;, &quot;/README&quot;);</span></span><br></pre></td></tr></table></figure>

<p>Perfect. The test passes locally and against the preview URL.</p>
<p><img src="/blog/images/deploy-preview-test/passing-e2e.png" alt="Passing E2E test"></p>
<p>Once the checks are green, I am confident and merge the pull request into the <code>main</code> branch. Vercel then deploys the production site. I can also remove extra CI events and only run the GitHub workflow on successful deployment. To install, cache and run Cypress we can use <a target="_blank" rel="noopener" href="https://github.com/cypress-io/github-action">Cypress GitHub Action</a>:</p>
<figure class="highlight yml"><figcaption><span>.github/workflows/ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">ci</span></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/events-that-trigger-workflows</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">deployment_status</span>]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">e2e:</span></span><br><span class="line">    <span class="comment"># only runs this job on successful deploy</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">github.event.deployment_status.state</span> <span class="string">==</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">üå≤</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h3><span id="bonus-print-the-github-event-and-values">Bonus: print the GitHub event and values</span></h3><p>In the previous workflow file we used the <code>github.event.deployment_status.target_url</code> value. The <code>github.event</code> contains lots of <a target="_blank" rel="noopener" href="https://docs.github.com/en/free-pro-team@latest/actions/reference/context-and-expression-syntax-for-github-actions">other properties</a>. We can also print the <a target="_blank" rel="noopener" href="https://docs.github.com/en/free-pro-team@latest/actions/reference/environment-variables">GitHub environment variables</a> by using <a target="_blank" rel="noopener" href="https://github.com/bahmutov/print-env">@bahmutov&#x2F;print-env</a>. Then we get things like the branch name that are not present in the <code>github.event</code> object.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: Print GitHub event üñ®</span><br><span class="line">  env:</span><br><span class="line">    GITHUB_EVENT: $&#123;&#123; toJson(github.event) &#125;&#125;</span><br><span class="line">  run: echo &quot;$GITHUB_EVENT&quot;</span><br><span class="line"></span><br><span class="line">- name: Print GitHub env variables üñ®</span><br><span class="line">  run: npx @bahmutov/print-env GITHUB</span><br></pre></td></tr></table></figure>

<p>For example pull request deploy we will see print out like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;$GITHUB_EVENT&quot;</span><br><span class="line">shell: /bin/bash -e &#123;0&#125;</span><br><span class="line">env:</span><br><span class="line">GITHUB_EVENT: &#123;</span><br><span class="line">&quot;action&quot;: &quot;created&quot;,</span><br><span class="line">&quot;deployment&quot;: &#123;</span><br><span class="line">  &quot;created_at&quot;: &quot;2020-11-27T18:20:25Z&quot;,</span><br><span class="line">  &quot;description&quot;: null,</span><br><span class="line">  &quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">  &quot;id&quot;: 295433471,</span><br><span class="line">  &quot;original_environment&quot;: &quot;Preview&quot;,</span><br><span class="line">  &quot;payload&quot;: &#123;&#125;,</span><br><span class="line">  &quot;performed_via_github_app&quot;: null,</span><br><span class="line">  &quot;ref&quot;: &quot;3019a87169a5a9df28c88561fc21e71dd4c18ab2&quot;,</span><br><span class="line">  &quot;repository_url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example&quot;,</span><br><span class="line">  &quot;sha&quot;: &quot;3019a87169a5a9df28c88561fc21e71dd4c18ab2&quot;,</span><br><span class="line">  &quot;statuses_url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example/deployments/295433471/statuses&quot;,</span><br><span class="line">  &quot;task&quot;: &quot;deploy&quot;,</span><br><span class="line">  &quot;updated_at&quot;: &quot;2020-11-27T18:20:35Z&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example/deployments/295433471&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;deployment_status&quot;: &#123;</span><br><span class="line">  &quot;created_at&quot;: &quot;2020-11-27T18:20:35Z&quot;,</span><br><span class="line">  &quot;deployment_url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example/deployments/295433471&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;Deployment has completed&quot;,</span><br><span class="line">  &quot;environment&quot;: &quot;Preview&quot;,</span><br><span class="line">  &quot;id&quot;: 436572748,</span><br><span class="line">  &quot;performed_via_github_app&quot;: null,</span><br><span class="line">  &quot;repository_url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example&quot;,</span><br><span class="line">  &quot;state&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;target_url&quot;: &quot;eleventy-example-7wrr5ezkh.vercel.app&quot;,</span><br><span class="line">  &quot;updated_at&quot;: &quot;2020-11-27T18:20:35Z&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;api.github.com/repos/bahmutov/eleventy-example/deployments/295433471/statuses/436572748&quot;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Run npx @bahmutov/print-env GITHUB</span><br><span class="line">npx: installed 8 in 1.684s</span><br><span class="line">Found environment variables that start with GITHUB:</span><br><span class="line">GITHUB_ACTION=run2</span><br><span class="line">GITHUB_ACTIONS=true</span><br><span class="line">GITHUB_ACTOR=vercel[bot]</span><br><span class="line">GITHUB_API_URL=api.github.com</span><br><span class="line">GITHUB_BASE_REF=</span><br><span class="line">GITHUB_ENV=/home/runner/work/_temp/_runner_file_commands/set_env_67b033b7-e4d5-452a-838a-3ceabd989b00</span><br><span class="line">GITHUB_EVENT_NAME=deployment_status</span><br><span class="line">GITHUB_EVENT_PATH=/home/runner/work/_temp/_github_workflow/event.json</span><br><span class="line">GITHUB_GRAPHQL_URL=api.github.com/graphql</span><br><span class="line">GITHUB_HEAD_REF=</span><br><span class="line">GITHUB_JOB=print</span><br><span class="line">GITHUB_PATH=/home/runner/work/_temp/_runner_file_commands/add_path_67b033b7-e4d5-452a-838a-3ceabd989b00</span><br><span class="line">GITHUB_REF=</span><br><span class="line">GITHUB_REPOSITORY=bahmutov/eleventy-example</span><br><span class="line">GITHUB_REPOSITORY_OWNER=bahmutov</span><br><span class="line">GITHUB_RETENTION_DAYS=90</span><br><span class="line">GITHUB_RUN_ID=387593912</span><br><span class="line">GITHUB_RUN_NUMBER=4</span><br><span class="line">GITHUB_SERVER_URL=github.com</span><br><span class="line">GITHUB_SHA=3019a87169a5a9df28c88561fc21e71dd4c18ab2</span><br><span class="line">GITHUB_WORKFLOW=print</span><br><span class="line">GITHUB_WORKSPACE=/home/runner/work/eleventy-example/eleventy-example</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> I could not find the branch name in the <code>deployment</code> event or GitHub environment variables, thus to print the branch name I did the following</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># let&#x27;s get the source code and find branch using the commit SHA</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">üõé</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># fetch all commits so we can find the branch</span></span><br><span class="line">    <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">branch</span> <span class="string">üå≥</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">git</span> <span class="string">name-rev</span> <span class="string">--name-only</span> <span class="string">$GITHUB_SHA</span></span><br></pre></td></tr></table></figure>

<p>Which prints for branch <code>print-event</code> the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Run git name-rev --name-only $GITHUB_SHA</span><br><span class="line">remotes/origin/print-event</span><br></pre></td></tr></table></figure>

<h2><span id="github-checks">GitHub Checks</span></h2><p>There is one more detail that GitHub gets wrong when running tests on <code>deployment_status</code> event. It seems to be confused about <em>which commit</em> is tested, so it never reports the status back to the Pull Request. For example in <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example/pull/3">#3</a> we see a pending check.</p>
<p><img src="/blog/images/deploy-preview-test/no-status.png" alt="The e2e CI check is pending even after the tests have finished"></p>
<p>To fix this, we can send the commit status ourselves using GitHub REST API call. Here is the added section of the GitHub workflow file. If the Cypress tests pass, we post success. If the Cypress tests fail, or any job step fails, we post the failure status.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ci.yml file</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">üå≤</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#job-status-check-functions</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">‚úÖ</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">success()</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># set the merge commit status check</span></span><br><span class="line">  <span class="comment"># using GitHub REST API</span></span><br><span class="line">  <span class="comment"># see https://docs.github.com/en/rest/reference/repos#create-a-commit-status</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    curl --request POST \</span></span><br><span class="line"><span class="string">    --url https://api.github.com/repos/$&#123;&#123; github.repository &#125;&#125;/statuses/$&#123;&#123; github.sha &#125;&#125; \</span></span><br><span class="line"><span class="string">    --header &#x27;authorization: Bearer $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;&#x27; \</span></span><br><span class="line"><span class="string">    --header &#x27;content-type: application/json&#x27; \</span></span><br><span class="line"><span class="string">    --data &#x27;&#123;</span></span><br><span class="line"><span class="string">      &quot;context&quot;: &quot;e2e&quot;,</span></span><br><span class="line"><span class="string">      &quot;state&quot;: &quot;success&quot;,</span></span><br><span class="line"><span class="string">      &quot;description&quot;: &quot;Cypress tests passed&quot;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cypress</span> <span class="string">tests</span> <span class="string">üö®</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">failure()</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    curl --request POST \</span></span><br><span class="line"><span class="string">    --url https://api.github.com/repos/$&#123;&#123; github.repository &#125;&#125;/statuses/$&#123;&#123; github.sha &#125;&#125; \</span></span><br><span class="line"><span class="string">    --header &#x27;authorization: Bearer $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;&#x27; \</span></span><br><span class="line"><span class="string">    --header &#x27;content-type: application/json&#x27; \</span></span><br><span class="line"><span class="string">    --data &#x27;&#123;</span></span><br><span class="line"><span class="string">      &quot;context&quot;: &quot;e2e&quot;,</span></span><br><span class="line"><span class="string">      &quot;state&quot;: &quot;failure&quot;,</span></span><br><span class="line"><span class="string">      &quot;description&quot;: &quot;Cypress tests failed&quot;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>You can see the example run in PR <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example/pull/4">#4</a>. The check &quot;e2e&quot; matches the required check name, thus the pull request is all green.</p>
<p><img src="/blog/images/deploy-preview-test/post-status.png" alt="Posted commit checks"></p>
<p>When we look at the Action steps, we can see the &quot;Post success&quot; step ran, while the &quot;Post failure&quot; step was skipped.</p>
<p><img src="/blog/images/deploy-preview-test/post-jobs.png" alt="Job steps"></p>
<p>We can even provide a link that would take us from the status check straight to the workflow run by forming the full <code>target_url</code> property when posting the status check.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--data &#x27;&#123;</span><br><span class="line">  &quot;context&quot;: &quot;e2e&quot;,</span><br><span class="line">  &quot;state&quot;: &quot;success&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;Cypress tests passed&quot;,</span><br><span class="line">  &quot;target_url&quot;: &quot;https://github.com/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;&quot;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>This creates the little &quot;Details&quot; link on the right.</p>
<p><img src="/blog/images/deploy-preview-test/target_url.png" alt="Run URL in the status check"></p>
<h2><span id="cypress-dashboard">Cypress Dashboard</span></h2><p>I have mentioned before that every Cypress run generates a video, and every failed Cypress test automatically saves the screenshot of the failure. You can store these test artifacts on GitHub, or send them to the <a target="_blank" rel="noopener" href="https://on.cypress.io/dashboard-introduction">Cypress Dashboard</a> where they can be easily viewed. Let&#39;s set up our project for recording.</p>
<p>In the Cypress Desktop GUI select the &quot;Runs&quot; tab.</p>
<p><img src="/blog/images/deploy-preview-test/runs.png" alt="Cypress Runs tab"></p>
<p>Click the &quot;Set up project to record&quot; button.</p>
<p>I will place the &quot;eleventy-example&quot; project under my personal &quot;Gleb OSS&quot; organization that has the <a target="_blank" rel="noopener" href="https://on.cypress.io/organizations#Requesting-OSS-plan-for-an-org">Cypress Open Source Software billing plan</a>. The test recordings will be public - everyone should be able to see them.</p>
<p><img src="/blog/images/deploy-preview-test/set-up-project.png" alt="Setting up the project"></p>
<p>Once I click &quot;Set up project&quot; button, its project id will be added to the <code>cypress.json</code> file and the recording key is shown. Please keep this <a target="_blank" rel="noopener" href="https://on.cypress.io/projects#Record-key">key private</a>.</p>
<p><img src="/blog/images/deploy-preview-test/record-settings.png" alt="Project recording key"></p>
<p>I will set the recording key as a GitHub Action Secret in my repository.</p>
<p><img src="/blog/images/deploy-preview-test/secret.png" alt="Set the record key as GH Action Secret"></p>
<p>Let&#39;s update the GitHub workflow file to record test results and artifacts. We are using <a target="_blank" rel="noopener" href="https://github.com/cypress-io/github-action">Cypress GitHub Action</a>, thus we need to add <code>record: true</code> parameter and pass the recording secret as an environment variable.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># updated ci.yml file</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Cypress</span> <span class="string">üå≤</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cypress-io/github-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">record:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">CYPRESS_BASE_URL:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.deployment_status.target_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">CYPRESS_RECORD_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CYPRESS_RECORD_KEY</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>The tests run on GitHub and show the recorded run URL <code>https://dashboard.cypress.io/projects/y2sysj/runs/1 </code></p>
<p><img src="/blog/images/deploy-preview-test/recording-url.png" alt="Recorded test runs show the Dashboard URL"></p>
<p>At the <a target="_blank" rel="noopener" href="https://dashboard.cypress.io/projects/y2sysj/runs">Dashboard page</a> you can see every spec, every video, every screenshot, and lots of <a target="_blank" rel="noopener" href="https://on.cypress.io/analytics">test analytics</a>.</p>
<p><img src="/blog/images/deploy-preview-test/first-run.png" alt="First recorded run"></p>
<h2><span id="cypress-gh-integration">Cypress GH Integration</span></h2><p>If we are using GitHub and Cypress Dashboard, we might as well use the <a target="_blank" rel="noopener" href="https://on.cypress.io/github-integration">Cypress GitHub Integration App</a>. I can add it to all my repositories, or just install it for selected repository &quot;eleventy-example&quot;.</p>
<p><img src="/blog/images/deploy-preview-test/gh-app.png" alt="Installing Cypress GitHub App"></p>
<p>Once installed, we can configure how the Cypress GH App comments on pull requests and sets status checks.</p>
<p><img src="/blog/images/deploy-preview-test/configure-gh-app.png" alt="Configure Cypress GitHub App"></p>
<p>Let&#39;s try a new pull request <a target="_blank" rel="noopener" href="https://github.com/bahmutov/eleventy-example/pull/6">#6</a> - we will see Vercel&#39;s comment and Cypress&#39; GH comment.</p>
<p><img src="/blog/images/deploy-preview-test/comments.png" alt="Cypress GitHub App comments on the pull requests"></p>
<p>Cypress GH App adds its own status check to the commit.</p>
<p><img src="/blog/images/deploy-preview-test/checks.png" alt="Full set of commit status checks"></p>
<p>Because we have the Cypress GH status check, we could remove our custom test job check implemented using <code>curl</code> commands. I will leave them in for completeness sake.</p>
<h2><span id="more-info">More info</span></h2><p>If you want to test a site deployed to GitHub Pages, read <a href="../triple-tested/">Triple Tested Static Site Deployed to GitHub Pages Using GitHub Actions</a>.</p>
<p>You can test deployed previews using <a href="../gatsby-netlify-circle-and-cypress/">Netlify + CircleCI combination</a></p>
<p>For full confidence, we do recommend adding <a target="_blank" rel="noopener" href="https://on.cypress.io/visual-testing">visual testing</a> using open source or commercial service to your functional end-to-end tests. Visual testing will prevent any CSS or style regressions from creeping into your site.</p>
<p>We also recommend for complex web applications to measure the <a target="_blank" rel="noopener" href="https://on.cypress.io/code-coverage">code coverage</a> to ensure all implemented features are covered by end-to-end tests. E2E tests are extremely effective at covering a lot of code.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
  <p>
    Have a Cypress question? Want me to answer it? Consider supporting me via <a target="_blank" rel="noopener" href="https://github.com/sponsors/bahmutov">GitHub Sponsors</a> or by purchasing my <a target="_blank" rel="noopener" href="https://cypress.tips/courses">Cypress courses</a>.
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/develop-preview-test/" data-id="cl409bhqw004zzqvg8tpw9q3q" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/develop-preview-test/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/11ty/" rel="tag">11ty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/ci/" rel="tag">ci</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/" rel="tag">cypress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/github/" rel="tag">github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/vercel/" rel="tag">vercel</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../it-is-ok-to-get-stuck/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          It Is OK to Get Stuck Sometimes
        
      </div>
    </a>
  
  
    <a href="../test-the-interface/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Test The Interface Not The Implementation</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">148</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">476</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">210</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">139</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.8px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.8px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.2px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16.8px;">ci</a> <a href="../tags/circle/" style="font-size: 14px;">circle</a> <a href="../tags/climate/" style="font-size: 14.8px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 15.2px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14.4px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.8px;">db</a> <a href="../tags/docker/" style="font-size: 14.4px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.8px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 15.2px;">git</a> <a href="../tags/github/" style="font-size: 16px;">github</a> <a href="../tags/graphql/" style="font-size: 11.6px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.2px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.6px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 14px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.4px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.2px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.4px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.4px;">ramda</a> <a href="../tags/react/" style="font-size: 12.4px;">react</a> <a href="../tags/react-native/" style="font-size: 11.2px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.4px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 14px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.2px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.6px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.4px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.6px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/06/">June 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/05/">May 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/04/">April 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/03/">March 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../run-all-specs-cypress-v10/">Run All Specs in Cypress v10</a>
          </li>
        
          <li>
            <a href="../mobile-tests/">How We Run The Mobile Web Browser Tests at Mercari US</a>
          </li>
        
          <li>
            <a href="../pass-reference/">Pass The Reference</a>
          </li>
        
          <li>
            <a href="../check-more-things/">Check More Things Before Clicking</a>
          </li>
        
          <li>
            <a href="../secrets-to-env/">Set All Cypress Env Values Using A Single GitHub Actions Secret</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/develop-preview-test/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
