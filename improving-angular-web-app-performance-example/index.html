<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Improving Angular web app performance example. | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="TL;DR AngularJS performance lessons.
Once your Angular application has the features you need, the next step is usually focused on
improving its performance. Initial load time, responsiveness to user&amp;a">
<meta property="og:type" content="article">
<meta property="og:title" content="Improving Angular web app performance example.">
<meta property="og:url" content="http://glebbahmutov.com/blog/improving-angular-web-app-performance-example/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="TL;DR AngularJS performance lessons.
Once your Angular application has the features you need, the next step is usually focused on
improving its performance. Initial load time, responsiveness to user&amp;a">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/primes.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-scope-method.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-chart.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-heavy.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/removed-try-catch.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/reuse-found-primes.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/checking-less-than-square-root.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/idle-digest-cycle.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/find-expensive-digest.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/each-row-linked.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/in-code-table-generation.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/fast-first-batch.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/small-batches-profile.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/after-dom-update-using-timeout.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/small-batches-timeline.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/appending-separate-tables.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/web-worker-cpu-profile.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/web-worker-timeline.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/memory-dynamically-allocated.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/memory-preallocated.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-heap-allocations.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/primes-array.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-web-worker-heap.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/inspect-web-worker-heap.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/infinite-scroll.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/deep-copy-profile.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-vs-repeat.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/angular-vs-repeat-cpu-profile.png">
<meta property="og:image" content="https://raw.githubusercontent.com/bahmutov/primes/master/images/angular-vs-repeat-timeline.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Improving Angular web app performance example.">
<meta name="twitter:description" content="TL;DR AngularJS performance lessons.
Once your Angular application has the features you need, the next step is usually focused on
improving its performance. Initial load time, responsiveness to user&amp;a">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/style.css" type="text/css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="..//" id="logo">Better world by better software</a>
      </h1>
      <!--
      
        <h2 id="subtitle-wrap">
          <a href="..//" id="subtitle">Software advice from Dr. Gleb Bahmutov PhD</a>
        </h2>
      
      -->
      <h2 id="subtitle-wrap">
        <span class="subtitle"><span class="no-mobile">Software advice from</span>
        <a id="subtitle" href="http://glebbahmutov.com">Dr. Gleb Bahmutov PhD</a></span>
      </h2>
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="..//">Home</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://glebbahmutov.com/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-improving-angular-web-app-performance-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2014-10-22T04:00:00.000Z" itemprop="datePublished">Oct 22 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/process/">process</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Improving Angular web app performance example.
    </h1>

    <h2 class="article-title" itemprop="name">
      Profiling and speeding up AngularJs application step by step using Chrome DevTools code snippets
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>TL;DR</strong> <a href="../angularjs-performance-lessons/">AngularJS performance lessons</a>.</p>
<p>Once your Angular application has the features you need, the next step is usually focused on
improving its performance. Initial load time, responsiveness to user&apos;s commands - the application
has to execute quickly in order to be useful. There are general guides to improve an
angular application&apos;s speed by order of 2 magnitudes.
For example <a href="https://www.scalyr.com/" target="_blank" rel="external">Scalyr</a>
blog <a href="http://blog.scalyr.com/2013/10/angularjs-1200ms-to-35ms/" target="_blank" rel="external">post</a> suggests the following:</p>
<ul>
<li>Cache DOM elements</li>
<li>Use fewer watchers</li>
<li>Defer element creation</li>
<li>Skip watchers for hidden elements</li>
</ul>
<p>I find these suggestions valid, but too difficult to implement right away.
Instead I suggest the following steps to optimize Angular web app&apos;s performance.</p>
<ul>
<li>Profile individual actions<ul>
<li>Optimize obvious JavaScript (non-Angular code) bottlenecks</li>
</ul>
</li>
<li>Measure and optimize the idle digest cycle<ul>
<li>Simplify watched expressions by removing filters</li>
<li>Remove unnecessary watchers by replacing two- with one-way data binding</li>
</ul>
</li>
<li>Analyze the model update / DOM repaint cycle to identify bottlenecks<ul>
<li>Large work can be split into batches</li>
<li>Some work can be potentially moved to the web workers</li>
</ul>
</li>
<li>Minimize garbage collection events<ul>
<li>Reuse memory instead of continuously allocating new space.</li>
</ul>
</li>
</ul>
<p>This step by step example shows practical scripts to run when you need to speed up an Angular
application. The scripts will be run repeatedly to diagnose bottlenecks, so it is helpful to
add them to Chrome DevTools as code snippets. I described how to use code snippets in
several blog posts <a href="../chrome-dev-tools-code-snippets/">1</a>,
<a href="../performance-profiling-using-devtools-code-snippets/">2</a>.
The scripts used in this article can be found in
<a href="https://github.com/bahmutov/code-snippets" target="_blank" rel="external">bahmutov/code-snippets</a> repo.</p>
<p>The example uses Angular 1.2, but the techniques for profiling the application and
finding bottlenecks should be applicable to future versions too.</p>
<h2 id="example-application">Example application</h2><p>I wrote a small Angular application to be a runnable example. You can follow along by
cloning <a href="https://github.com/bahmutov/primes" target="_blank" rel="external">bahmutov/primes</a> and trying the application itself
at different commits. The entire example is a single <em>index.html</em> file that can be loaded in Chrome without
needing a webserver. The application computes and prints first N primes. We will start with a very
inefficient implementation and will improve it in several steps.</p>
<pre><code>git clone git@github.com:bahmutov/primes.git
cd primes
bower <span class="operator"><span class="keyword">install</span> angular-bindonce jquery angular-vs-<span class="keyword">repeat</span> <span class="comment">--force</span>
git checkout step-<span class="number">0</span>
<span class="keyword">open</span> <span class="keyword">index</span>.html</span>
</code></pre><p>The page is very simple: user enters number of primes to find, then clicks &quot;Find&quot; button.
The numbers are computed and displayed in the table.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-controller</span>=<span class="value">&quot;primesController&quot;</span> <span class="attribute">ng-cloak</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">&quot;find&quot;</span> <span class="attribute">ng-click</span>=<span class="value">&quot;find()&quot;</span>&gt;</span>Find<span class="tag">&lt;/<span class="title">button</span>&gt;</span> <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">&quot;n&quot;</span> /&gt;</span> primes.</span><br><span class="line">  <span class="tag">&lt;<span class="title">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;prime in primes | orderBy:$index &quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ &quot;index&quot; | lowercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ $index + 1 | number:0 | uppercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ &quot;prime number&quot; | lowercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ prime | number:0 | uppercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>is prime? {{ prime | isPrime }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The table has filters and sorting order just to show common performance problems.
First 5 prime numbers look like this:</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/primes.png" alt="first 5 primes"></p>
<h2 id="initial-performance">Initial performance</h2><p>The first version (tag <a href="https://github.com/bahmutov/primes/releases/tag/step-0" target="_blank" rel="external">step-0</a>)
finds first 10 or even 100 primes very quickly. But when the user tries to find 1000 primes,
there is an obvious pause while the browser is doing the computation. Why is it taking so long?</p>
<p>The angular application code is very simple</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPrime</span>(<span class="params"></span>) </span>{ ... }</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPrime</span>(<span class="params"></span>) </span>{ ... }</span><br><span class="line">angular.module(<span class="string">&apos;Primes&apos;</span>, [])</span><br><span class="line">  .filter(<span class="string">&apos;isPrime&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> isPrime;</span><br><span class="line">  })</span><br><span class="line">  .controller(<span class="string">&apos;primesController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope</span>) </span>{</span><br><span class="line">    $scope.n = <span class="number">10</span>;</span><br><span class="line">    $scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&apos;computing first&apos;</span>, $scope.n, <span class="string">&apos;primes&apos;</span>);</span><br><span class="line">      $scope.primes = [];</span><br><span class="line">      <span class="keyword">var</span> k;</span><br><span class="line">      <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; $scope.n; k += <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">var</span> prime = findPrime(k + <span class="number">2</span>);</span><br><span class="line">        $scope.primes.push(prime);</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p><code>$scope.find</code> takes too long for larger values of <code>$scope.n</code>.
Usually we start by profiling JavaScript like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&apos;computing first&apos;</span>, $scope.n, <span class="string">&apos;primes&apos;</span>);</span><br><span class="line">  <span class="keyword">var</span> started = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="comment">// computation</span></span><br><span class="line">  <span class="keyword">var</span> finished = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&apos;find took&apos;</span>, finished - started, <span class="string">&apos;ms&apos;</span>);</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>I prefer to use <a href="https://developer.chrome.com/devtools/docs/console-api#consoletimelabel" target="_blank" rel="external">console.time</a>
call to profile - it needs fewer variables and provides sub-millisecond resolution.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&apos;computing first&apos;</span>, $scope.n, <span class="string">&apos;primes&apos;</span>);</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">&apos;computing primes&apos;</span>);</span><br><span class="line">  <span class="comment">// computation</span></span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">&apos;computing primes&apos;</span>);</span><br><span class="line">};</span><br><span class="line"><span class="comment">// output &quot;computing primes: 7648.381ms&quot;</span></span><br></pre></td></tr></table></figure>
<p>Computing first 1000 numbers takes almost 8 seconds!</p>
<h2 id="profiling-using-code-snippet">Profiling using code snippet</h2><p>Instead of modifying code and inserting time commands, I use my
<a href="https://github.com/bahmutov/code-snippets/blob/master/ng-profile-scope-method.js" target="_blank" rel="external">ng-profile-scope-method</a>
code snippet. I create new code snippet in DevTools, copy the source code and modify the selector
and scope method name to match my application (my button has id <code>find</code> and scope method is also <code>find</code>).</p>
<p>I first run the code snippet to instrument the method <code>$scope.find</code>. Then I click &quot;find&quot; button.
The browser console shows timing messages</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-scope-method.png" alt="profile scope method"></p>
<p>When the method finishes running, the instrumentation is removed. The DevTools now has CPU profile taken
during the method&apos;s run. I first look at the chart view of the CPU profile</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-chart.png" alt="chart"></p>
<p>Notice that the pyramid of calls is pretty simple: event handler function runs the entire 8 seconds,
same as <code>$apply</code>, <code>$eval</code>, all the way to <code>scope.find</code> method. Inside our find method, we see multiple
calls to <code>findPrime</code> function. Let us see if <code>findPrime</code> is the performance bottleneck. Switch from
&quot;chart&quot; to &quot;Heavy&quot; view. This shows functions arranged from taking the longest aggregate time (self execution time)
to shortest (on the bottom).</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-heavy.png" alt="heavy"></p>
<p>The top 2 functions are <code>isPrime</code> and <code>findPrime</code> that take almost the entire execution time. Notice
a small yellow rectangle next to <code>isPrime</code>. If you hover over it, Chrome DevTools will show why this
function <em>cannot be optimized</em> by the Just-In-Time compiler. In this case it is due to <code>try - catch</code>
statement inside the function. I have written about v8 performance optimizations
before in this blog <a href="../detecting-function-optimizations-in-v8/">post</a></p>
<ul>
<li>some language constructs are hard to optimize correctly, and the runtime engine just gives up.
For example, modifying <code>arguments</code> structure or using <code>for-in</code> statement will disqualify your
function from optimizations and forever put it in a &quot;slow lane&quot;.</li>
</ul>
<p>In our case, <code>isPrime</code> does not need <code>try-catch</code> block at all</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPrime</span>(<span class="params">n</span>) </span>{</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">var</span> k;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">2</span>; k &lt; n; k += <span class="number">1</span>) {</span><br><span class="line">      <span class="keyword">if</span> (n % k === <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>I removed <code>try-catch</code> and reran the profile code snippet, see tag
<a href="https://github.com/bahmutov/primes/releases/tag/step-1" target="_blank" rel="external">step-1</a>.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/removed-try-catch.png" alt="removed-try-catch"></p>
<p><code>isPrime</code> dropped from 4.5 seconds to 23 <em>milliseconds</em>, while the total time to find 1000 primes
dropped from 7.5 seconds to 3.5 seconds. Notice that if you run <code>ng-profile-scope-method</code> script,
it saved CPU profiles separately so you can compare code&apos;s performance between runs.</p>
<p><code>findPrime</code> function is the new bottleneck. Let us look at its source</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPrime</span>(<span class="params">n</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> foundPrimes = [];</span><br><span class="line">  <span class="keyword">while</span> (foundPrimes.length &lt; n) {</span><br><span class="line">    <span class="keyword">if</span> (isPrime(k)) {</span><br><span class="line">      foundPrimes.push(k);</span><br><span class="line">    }</span><br><span class="line">    k += <span class="number">1</span>;</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> foundPrimes[foundPrimes.length - <span class="number">1</span>];</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>It finds Nth prime by computing <em>every prime</em> from first to Nth and return the last one.
Notice that if we ask for N + 1st prime, we still redo <em>everything again</em>. Let us
reuse the previously found primes by moving <code>foundPrimes</code> array outside the function to
avoid restarting from scratch. We will also start search from the last found prime + 1.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foundPrimes = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPrime</span>(<span class="params">n</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="keyword">if</span> (foundPrimes.length) {</span><br><span class="line">    k = foundPrimes[foundPrimes.length - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    k = <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">while</span> (foundPrimes.length &lt; n) {</span><br><span class="line">    <span class="keyword">if</span> (isPrime(k)) {</span><br><span class="line">      foundPrimes.push(k);</span><br><span class="line">    }</span><br><span class="line">    k += <span class="number">1</span>;</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> foundPrimes[n - <span class="number">1</span>];</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>This change is available at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-2" target="_blank" rel="external">step-2</a>
and leads to huge performance improvement</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/reuse-found-primes.png" alt="reuse-found-primes"></p>
<p>The entire <code>$scope.find</code> method now takes 45 milliseconds, which is 100x speed up compared to our initial
code.</p>
<p>We can do one more easy optimization to remove the current bottleneck (function <code>isPrime</code> again).
When checking if a number N is a prime, we do not need to check <em>every</em> number smaller if it divides
it without a remainder. It is enough to check every number smaller than a square root of N.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPrime</span>(<span class="params">n</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="keyword">var</span> limit = <span class="built_in">Math</span>.sqrt(n);</span><br><span class="line">  <span class="keyword">for</span> (k = <span class="number">2</span>; k &lt;= limit; k += <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">if</span> (n % k === <span class="number">0</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>This code version is available at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-3" target="_blank" rel="external">step-3</a>.
Profiling <code>scope.find</code> shows that we have removed every obvious bottleneck from our code.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/checking-less-than-square-root.png" alt="checking fewer divisors"></p>
<h2 id="optimizing-digest-cycle">Optimizing digest cycle</h2><p>We have removed obvious bottlenecks from our application code by profiling a method
invoked on a scope object. Let us improve the application&apos;s performance even further by looking how
it handles large data sets.</p>
<p>First, I will change 1 tiny detail - I will add another two-way binding to show the number N
of primes</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">&quot;find&quot;</span> <span class="attribute">ng-click</span>=<span class="value">&quot;find()&quot;</span>&gt;</span>Find<span class="tag">&lt;/<span class="title">button</span>&gt;</span> <span class="tag">&lt;<span class="title">input</span> <span class="attribute">ng-model</span>=<span class="value">&quot;n&quot;</span> /&gt;</span> primes.</span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span>AngularJs application that finds first {{ n }} prime numbers<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The code is available at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-4" target="_blank" rel="external">step-4</a></p>
<p>Let us generate 100k prime numbers. This will take a few seconds (DOM updates). Once 100k
prime numbers are displayed, set focus on the input text field and try changing the number,
for example by deleting &apos;0&apos;. Notice there is a noticeable delay between the button press
and updating numbers. We are not modifying any model data, except for a single number. The
table should not be updating, so why the pause?</p>
<p>To debug this problem, let us use another code snippet
<a href="https://github.com/bahmutov/code-snippets/blob/master/ng-idle-apply-timing.js" target="_blank" rel="external">ng-idle-apply-timing</a>.
It just runs the digest cycle without modifying any data and collects the CPU profile. This measures
how long the dirty checking every piece of data in our application takes. Each two-way binding,
each <code>$watch</code> expression adds to the digest cycle duration. A quick look at idle digest cycle using
the code snippet reveals the following bottleneck:</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/idle-digest-cycle.png" alt="idle digest"></p>
<p>A single idle digest cycle takes 1 second! We need to speed things up. The surest way to speed up
a digest cycle is to have Angular do less work by removing unnecessary watch expressions.</p>
<p>First we can try to pin point which element on the page has slowest watchers attached to its
or its children scopes. See <a href="../local-angular-scopes/">Local Angular Scopes</a>
for details. In this case we can measure using
<a href="https://github.com/bahmutov/code-snippets/blob/master/ng-find-expensive-digest.js" target="_blank" rel="external">ng-find-expensive-digest.js</a>
the table and input elements
(which overlap in scope) to see the result, showing the table being the element with slowest watchers.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/find-expensive-digest.png" alt="find expensive"></p>
<p>We can get an idea how many watch expressions are evaluated by running another
code snippet <a href="https://github.com/bahmutov/code-snippets/blob/master/ng-count-watchers.js" target="_blank" rel="external">ng-count-watchers</a>.
It goes through every element&apos;s scope and sums total number of found angular watchers. When we have 100k
prime numbers in the table, the code snippet shows 500,003 watchers! There are 3 watchers that observe
the <code>ng-repeat</code> directive, entered text and template expression `{{ n }}`.
The rest (500k watchers) are watching the cells in the primes table.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;prime in primes | orderBy:$index &quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ &quot;index&quot; | lowercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ $index + 1 | number:0 | uppercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ &quot;prime number&quot; | lowercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ prime | number:0 | uppercase }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>is prime? {{ prime | isPrime }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Notice that we have a lot of unnecessary overhead for each row. For example, the template expression
<code>&quot;index&quot; | lowercase</code> is static text that will never change. Angular evaluates it over and over,
but the result never changes for a cell, even when number of rows changes. Let us remove the template,
including the <code>lowercase</code>, <code>uppercase</code>, <code>isPrime</code> filters - they do nothing.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;prime in primes | orderBy:$index &quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>index<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ $index + 1 | number:0 }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>prime number<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ prime | number:0 }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>is prime? true<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The updated application has only 200,003 watchers for 100k prime numbers, with idle digest
cycle running twice faster.</p>
<p>The code is available at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-5" target="_blank" rel="external">step-5</a>.</p>
<h2 id="use-bind-once">Use bind-once</h2><p>We have cut the pause when typing in half by removing unnecessary templates and filters.
There is still room for improvements. Notice that while the table does not change, we still evaluate
two watchers for <em>every</em> row whenever we type into the input text box (which triggers application&apos;s
digest cycle). The data does not change, so we should not reevaluate the expressions. Angular 1.3
introduces <a href="https://docs.angularjs.org/guide/expression" target="_blank" rel="external">one-time binding</a> using <code>::prime</code> syntax.
When using angular 1.2 that does not have this feature, I suggest using <a href="https://github.com/Pasvaz/bindonce" target="_blank" rel="external">bindonce</a>
library. The changes required to change from two-way to one-way binding are trivial.
The filter syntax is supported too:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;prime in primes | orderBy:$index &quot;</span> <span class="attribute">bindonce</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>index<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span> <span class="attribute">bo-text</span>=<span class="value">&quot;$index + 1 | number:0&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>prime number<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span> <span class="attribute">bo-text</span>=<span class="value">&quot;prime | number:0&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">td</span>&gt;</span>is prime? true<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The updated application has only 3 watchers despite showing 100k primes, and the idle digest
loop takes 5ms, leading to very responsive user interface.</p>
<p>The code is available at <a href="https://github.com/bahmutov/primes/releases/tag/step-6" target="_blank" rel="external">step-6</a>.</p>
<h2 id="in-code-markup-generation">In-code markup generation</h2><p>When profiling the table generation, I noticed a weird pattern: seems every row / cell generation
caused several function calls. This takes 10 seconds when generating table with 100k primes.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/each-row-linked.png" alt="separate"></p>
<p>To further improve this part of the application, I tried generating markup string manually
and then setting the entire table in a single call using <code>innerHTML</code> property. The new markup
is an empty table <code>&lt;table&gt;&lt;/table&gt;</code> without any Angular templates. The markup is generated in
code instead</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use AngularJs built-in filter</span></span><br><span class="line"><span class="keyword">var</span> number = $filter(<span class="string">&apos;number&apos;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateTableRows</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">&apos;&apos;</span>;</span><br><span class="line">  <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; $scope.n; k += <span class="number">1</span>) {</span><br><span class="line">    str += <span class="string">&apos;&lt;tr&gt;&lt;td&gt;index&lt;/td&gt;&apos;</span>;</span><br><span class="line">    str += <span class="string">&apos;&lt;td&gt;&apos;</span> + number(k + <span class="number">1</span>, <span class="number">0</span>) + <span class="string">&apos;&lt;/td&gt;&apos;</span>;</span><br><span class="line">    str += <span class="string">&apos;&lt;td&gt;prime number&lt;/td&gt;&apos;</span>;</span><br><span class="line">    str += <span class="string">&apos;&lt;td&gt;&apos;</span> + number($scope.primes[k], <span class="number">0</span>) + <span class="string">&apos;&lt;/td&gt;&apos;</span>;</span><br><span class="line">    str += <span class="string">&apos;&lt;td&gt;is prime? true&lt;/td&gt;&lt;/tr&gt;&apos;</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">document</span>.getElementsByTagName(<span class="string">&apos;table&apos;</span>)[<span class="number">0</span>].innerHTML = str;</span><br><span class="line">}</span><br><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="comment">// generate primes list as before</span></span><br><span class="line">  generateTableRows();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The code is available at <a href="https://github.com/bahmutov/primes/releases/tag/step-7" target="_blank" rel="external">step-7</a>.</p>
<p>This markup generation is much faster than individual cell binding. In my case, it was 10 times faster.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/in-code-table-generation.png" alt="code"></p>
<p>Of course, this gives up the flexibility of the angular model binding, and this substitution is
only appropriate when the application&apos;s design and data flow are not going to change.</p>
<h2 id="improving-initial-rendering-time">Improving initial rendering time</h2><p>Let us approach the problem from a different view point. When a computation takes a long time,
we can show the initial results very quickly. The user can see the initial results, while the
rest of the computation finishes. In our example, we can compute and render
the first 100 primes very very quickly ( &lt; 30ms). I split the computation in two batches,
and used <code>$timeout</code> service to schedule the second batch to start after DOM have been updated
and the browser repaints the table with first 100 rows.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="comment">// code as before</span></span><br><span class="line">  <span class="keyword">var</span> firstBatchN = <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; firstBatchN; k += <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">var</span> prime = findPrime(k + <span class="number">2</span>);</span><br><span class="line">    $scope.primes.push(prime);</span><br><span class="line">  }</span><br><span class="line">  generateTableRows(<span class="number">0</span>, firstBatchN);</span><br><span class="line">  <span class="comment">// start second batch via event loop to let browser repaint</span></span><br><span class="line">  <span class="comment">// return promise to allow timing this action</span></span><br><span class="line">  <span class="keyword">return</span> $timeout(<span class="function"><span class="keyword">function</span> <span class="title">computeSecondBatch</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">for</span> (k = firstBatchN; k &lt; $scope.n; k += <span class="number">1</span>) {</span><br><span class="line">      <span class="keyword">var</span> prime = findPrime(k + <span class="number">2</span>);</span><br><span class="line">      $scope.primes.push(prime);</span><br><span class="line">    }</span><br><span class="line">    generateTableRows(firstBatchN, $scope.n);</span><br><span class="line">  }, <span class="number">0</span>);</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>This code is available at <a href="https://github.com/bahmutov/primes/releases/tag/step-8" target="_blank" rel="external">step-8</a>.</p>
<p>Timeline for this the two-step <code>$scope.find</code> method shows two actions very clearly. The first
repaint finishes after 20 ms after clicking <code>find</code> button. The user cannot interact with the
table though, because the second batch completely freezes the browser while computing
the rest of the primes and computing the layout again for the entire table.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/fast-first-batch.png" alt="two batches"></p>
<h2 id="working-in-batches">Working in batches</h2><p>When computing and showing these results, the browser performs 4 operations:</p>
<ul>
<li>JavaScript client (application) code execution</li>
<li>Layout computation (position and size of each DOM element)</li>
<li>Rendering each component into separate buffer</li>
<li>Painting the buffers and showing the result</li>
</ul>
<p>These actions all occur using a single thread. Conceptually simple, this might present a
performance problem when one part takes too long. For example, complex CSS styles lead to
longer layout and rendering times, blocking the client code from running again. Each iteration
with these 4 steps should take less than 33 ms if we want to achieve 30 fps, or less
than 16 ms if we target 60 fps.</p>
<p>We split our application into two batches in the previous step: a small initial batch that
quickly shows first 100 primes and the remaining very large batch that shows after a long delay.
Because the second batch takes long time to compute and render, the browser was completely
frozen, not letting the user to look at the results from the first step.</p>
<p>Let us split the entire computation into lots of small batches. Each batch will compute and display
only 50 primes. The entire loop (code execution, dom updates and rendering) should take less than 30 ms,
allowing user input to go through (for example to scroll).</p>
<p>To schedule code to run <em>after</em> the browser layout / rendering / painting actions,
I will use <code>$timeout</code> service call after calls to the DOM.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computePrimes</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="keyword">for</span> (k = first; k &lt; last; k += <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">var</span> prime = findPrime(k + <span class="number">2</span>);</span><br><span class="line">    $scope.primes.push(prime);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateTableRows</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">  <span class="comment">// generate new rows HTML markup into variable str</span></span><br><span class="line">  <span class="built_in">document</span>.getElementsByTagName(<span class="string">&apos;tbody&apos;</span>)[<span class="number">0</span>].innerHTML += str;</span><br><span class="line">  <span class="built_in">console</span>.timeStamp(<span class="string">&apos;updated tbody &apos;</span> + first + <span class="string">&apos; to &apos;</span> + last);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeAndRenderBatch</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">  computePrimes(first, last);</span><br><span class="line">  generateTableRows(first, last);</span><br><span class="line">  <span class="comment">// returns a promise that will be resolved</span></span><br><span class="line">  <span class="comment">// AFTER DOM updates, layout, rendering and painting!</span></span><br><span class="line">  <span class="keyword">return</span> $timeout(angular.noop, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The main computation method <code>$scope.find</code> now creates a giant chain of promises, that will run
one after the other. (Read <a href="../chaining-promises/">Chaining promises</a> for more
examples how to connect steps into promise chain).
Each step will compute 50 primes, generate new rows markup, then will add the new markup to the DOM
and will let browser repaint itself.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> batchSize = <span class="number">50</span>;</span><br><span class="line">  <span class="keyword">var</span> k;</span><br><span class="line">  <span class="comment">// start computation with dummy step</span></span><br><span class="line">  <span class="keyword">var</span> computeAndLetUiRender = $q.when();</span><br><span class="line">  <span class="keyword">var</span> computeNextBatch;</span><br><span class="line">  <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; $scope.n; k += batchSize) {</span><br><span class="line">    computeNextBatch = angular.bind(<span class="literal">null</span>, computeAndRenderBatch,</span><br><span class="line">      k, <span class="built_in">Math</span>.min(k + batchSize, $scope.n));</span><br><span class="line">    computeAndLetUiRender = computeAndLetUiRender.then(computeNextBatch);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// return promise to let timing code snippet know when we are done</span></span><br><span class="line">  <span class="keyword">return</span> computeAndLetUiRender;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>The result profile shows a nice sequence of computations and dom updates</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/small-batches-profile.png" alt="small batches"></p>
<p>The code is available at the tag <a href="https://github.com/bahmutov/primes/releases/tag/step-9" target="_blank" rel="external">step-9</a>.</p>
<p>We can look at each batch in the timeline individually to confirm that our actions execute
one after another</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/after-dom-update-using-timeout.png" alt="batch action"></p>
<p>But we can also see how the updates slow down after a while. The violet bar (rendering) is becoming
longer and longer with each batch.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/small-batches-timeline.png" alt="rendering takes longer"></p>
<p>The problem is how we place new rows&apos; markup into the table. We append the new text to the existing
on, forcing the browser to compute layout and re-render the entire table!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateTableRows</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">  <span class="comment">// generate new rows HTML markup into variable str</span></span><br><span class="line">  <span class="built_in">document</span>.getElementsByTagName(<span class="string">&apos;tbody&apos;</span>)[<span class="number">0</span>].innerHTML += str;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>Instead of replacing the entire table&apos;s HTML, we can create new table and append it to the document&apos;s body.
We could also append another tbody element to the single table instead, but I have not measured that case.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateTableRows</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> k, txt = angular.bind(<span class="built_in">document</span>, <span class="built_in">document</span>.createTextNode);</span><br><span class="line">  <span class="keyword">var</span> table = <span class="built_in">document</span>.createElement(<span class="string">&apos;table&apos;</span>);</span><br><span class="line">  <span class="keyword">for</span>(k = first; k &lt; last; k += <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">var</span> row = table.insertRow();</span><br><span class="line">    row.insertCell().appendChild(txt(<span class="string">&apos;index&apos;</span>));</span><br><span class="line">    row.insertCell().appendChild(txt(k + <span class="number">1</span>));</span><br><span class="line">    row.insertCell().appendChild(txt(<span class="string">&apos;prime number&apos;</span>));</span><br><span class="line">    row.insertCell().appendChild(txt($scope.primes[k]));</span><br><span class="line">    row.insertCell().appendChild(txt(<span class="string">&apos;is prime? true&apos;</span>));</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// schedule DOM update by attaching new table element to the body</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(table);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>The modified application shows 30 fps behavior. You can freely scroll why the new numbers are being generated.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/appending-separate-tables.png" alt="30 fps"></p>
<p>The code is available at the tag <a href="https://github.com/bahmutov/primes/releases/tag/step-10" target="_blank" rel="external">step-10</a>.</p>
<h2 id="offloading-computation-to-web-worker">Offloading computation to web worker</h2><p>Finally, I decided to parallelize the computation by computing the primes in separate web worker thread.
I moved <code>isPrime</code> and <code>findPrime</code> functions into <code>primes.js</code> file. It communicates with the main code
via messages</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// primes.js</span></span><br><span class="line">onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> first = e.data.first;</span><br><span class="line">  <span class="keyword">var</span> last = e.data.last;</span><br><span class="line">  <span class="keyword">var</span> k, primes = [];</span><br><span class="line">  <span class="keyword">for</span> (k = first; k &lt; last; k += <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">var</span> prime = findPrime(k + <span class="number">2</span>);</span><br><span class="line">    primes.push(prime);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// send found numbers back</span></span><br><span class="line">  postMessage(primes);</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>To simplify main code to web worker requests, I created a service</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;Primes&apos;</span>, [])</span><br><span class="line">  .factory(<span class="string">&apos;PrimeWorker&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$q</span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> worker = <span class="keyword">new</span> Worker(<span class="string">&apos;./primes.js&apos;</span>);</span><br><span class="line">    <span class="keyword">var</span> defer;</span><br><span class="line">    worker.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">      defer.resolve(e.data);</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      computePrimes: <span class="function"><span class="keyword">function</span> (<span class="params">first, last</span>) </span>{</span><br><span class="line">        defer = $q.defer();</span><br><span class="line">        worker.postMessage({</span><br><span class="line">          first: first,</span><br><span class="line">          last: last</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> defer.promise;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  });</span><br></pre></td></tr></table></figure>
<p>The <code>$scope.find</code> method has to handle computation asynchronously, becoming</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.controller(<span class="string">&apos;primesController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope, $filter, $timeout, $q, PrimeWorker</span>) </span>{</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">computePrimes</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> PrimeWorker.computePrimes(first, last).then(<span class="function"><span class="keyword">function</span> (<span class="params">numbers</span>) </span>{</span><br><span class="line">      <span class="comment">// copy results into our list</span></span><br><span class="line">      <span class="keyword">var</span> k, n = numbers.length;</span><br><span class="line">      <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; n; k += <span class="number">1</span>) {</span><br><span class="line">        $scope.primes.push(numbers[k]);</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">computeAndRenderBatch</span>(<span class="params">first, last</span>) </span>{</span><br><span class="line">    <span class="comment">// results will be available via promise</span></span><br><span class="line">    <span class="keyword">return</span> computePrimes(first, last).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      generateTableRows(first, last);</span><br><span class="line">      <span class="keyword">return</span> $timeout(angular.noop, <span class="number">0</span>);</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// the rest of the code unchanged</span></span><br></pre></td></tr></table></figure>
<p>This code is available at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-11" target="_blank" rel="external">step-11</a>. In order
to load the web worker script, you need to run a web server in the main folder. I often use
<a href="https://github.com/nodeapps/http-server" target="_blank" rel="external">http-server</a> for lightweight testing.</p>
<p>The CPU profile now shows nice narrow spikes for the main code</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/web-worker-cpu-profile.png" alt="web worker cpu"></p>
<p>The timeline shows shorter computation bars, and majority of batches coming under 60 fps target.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/web-worker-timeline.png" alt="web worker timeline"></p>
<h2 id="optimize-memory-allocation">Optimize memory allocation</h2><p>If our application allocates and frees a lot of memory, the browser has to pause periodically to
collect free memory. The garbage collection pauses are unpredictable and can be long. To find these
&quot;GC events&quot;, look at the timeline and enter &quot;gc&quot; in the filter input box. In our case, we have significant
garbage collection delays: several megabytes are freed at a time, and it is taking more than 100 ms at a time.
(I am generating total of 150k primes in batches of 10k). You can easily see different memory allocation
events by enabling memory view in the timeline.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/memory-dynamically-allocated.png" alt="memory"></p>
<p>In our example the prime candidate for freed memory is the <code>$scope.primes</code> array. Notice that it is growing
dynamically because it starts with length 0, and we keep pushing new prime numbers into the array one by one.</p>
<pre><code>// <span class="keyword">copy</span> results into our list
var k, n = numbers.length;
<span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; n; k += <span class="number">1</span>) {
  <span class="variable">$scope</span>.primes.push(numbers[k]);
}
</code></pre><p>This is very inefficient from memory allocation standpoint - when the a new element is added to
the array that is full, the runtime has to allocate a new array, usually twice the size of the current one,
copy numbers and collect the memory from the first array.
I changed the code to pre-allocate the array to be the final length, keeping a number
of computed primes instead.</p>
<pre><code>// initialize the <span class="keyword">array</span> length
<span class="variable">$scope</span>.primes = new Array(<span class="variable">$scope</span>.n);
<span class="variable">$scope</span>.computedN = <span class="number">0</span>;
// <span class="keyword">copy</span> numbers
var k, n = numbers.length;
<span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; n; k += <span class="number">1</span>) {
  <span class="variable">$scope</span>.primes[<span class="variable">$scope</span>.computedN] = numbers[k];
  <span class="variable">$scope</span>.computedN += <span class="number">1</span>;
}
</code></pre><p>The timeline now shows much smaller GC events. I had to reload the page and close / open the DevTools again
to actually reset the profiler in order to see this change, seems like the bug in DevTools.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/memory-preallocated.png" alt="memory preallocated"></p>
<p>You can find this code at tag <a href="https://github.com/bahmutov/primes/releases/tag/step-12" target="_blank" rel="external">step-12</a>.</p>
<h2 id="memory-profile-in-isolation">Memory profile in isolation</h2><p>We are preallocating found primes in the main JavaScript code. To better see the memory allocation,
let us isolate individual steps. First, let us turn off DOM generation - it is generating a lot of noise
when allocating elements.</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">computeAndRenderBatch</span><span class="params">(first, last)</span> </span>{
  <span class="keyword">return</span> computePrimes(first, last).then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{
    <span class="comment">// generateTableRows(first, last);</span>
    <span class="keyword">return</span> <span class="variable">$timeout</span>(angular.noop, <span class="number">0</span>);
  });
}
</code></pre><p>Now we can run heap profiler in DevTools instead of CPU profiler. I turn the profiler
manually, then click &quot;Find&quot; button</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-heap-allocations.png" alt="heap profiler"></p>
<p>We can now see the large primes array allocated right at the beginning. Notice that we can hover
over it to see the final values. We can also notice that it contains 150k items, and its total memory
size is 600,008 bytes. V8 engine notices that we only are pushing integers into this array, and it
only uses 4 bytes per item. Arrays also have <code>length</code> property, that is extra 8 bytes.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/primes-array.png" alt="heap"></p>
<p>This profile gives us a picture of the heap allocation from the main code, but it does NOT show
memory allocations in the web worker. To see where we are &quot;leaking&quot; memory in the web worker,
select &quot;primes.js&quot; target below the heap profile radio button.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/profile-web-worker-heap.png" alt="profile web worker"></p>
<p>The collected web worker heap profile is much shorter, because its sandbox environment is much more limited.
We can clearly see the growing memory allocations. We can again hover and find the <code>foundPrimes</code> array.
We can hover over the array, and we can also hover over the code to see the function allocating it.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/inspect-web-worker-heap.png" alt="web worker heap profile"></p>
<p>We can now preallocate a large <code>foundPrimes</code> array to avoid dynamic growing and garbage collection.</p>
<h2 id="on-demand-computation">On-demand computation</h2><p>Let us change the way the application generates data. Instead of pre-computing thousands of prime numbers,
let us generate a small batch of numbers and render a table. If the user scrolls to the bottom of the table,
looking for more numbers, we will generate more numbers and append them to the DOM. We can easily
enable on scroll generation using <a href="http://binarymuse.github.io/ngInfiniteScroll/index.html" target="_blank" rel="external">ngInfiniteScroll</a>
directive. I used ngInfiniteScroll before to show
<a href="../infinite-slow-fake-data-on-scroll-using-angularjs/">lots of fake data</a>.
We need to include jQuery and infinite scroll script</p>
<pre><code><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;bower_components/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;bower_components/angular/angular.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">&quot;bower_components/ngInfiniteScroll/build/ng-infinite-scroll.min.js&quot;</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</code></pre><p>For simplicity, I will switch to using <code>ng-repeat</code> again. We will run <code>$scope.find</code> method
whenever the table&apos;s body approaches the bottom of the window client area. We will force
first <code>$scope.find</code> execution on start using <code>infinite-scroll-immediate-check</code> attribute.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">table</span> <span class="attribute">id</span>=<span class="value">&quot;table&quot;</span> <span class="attribute">width</span>=<span class="value">&quot;500&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">tbody</span> <span class="attribute">infinite-scroll</span>=<span class="value">&quot;find()&quot;</span></span><br><span class="line">    <span class="attribute">infinite-scroll-distance</span>=<span class="value">&quot;3&quot;</span></span><br><span class="line">    <span class="attribute">infinite-scroll-immediate-check</span>=<span class="value">&quot;true&quot;</span></span><br><span class="line">    <span class="attribute">infinite-scroll-disabled</span>=<span class="value">&quot;computing&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">tr</span> <span class="attribute">ng-repeat</span>=<span class="value">&quot;prime in primes&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>index<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ $index + 1 | number:0 }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>prime number<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>{{ prime | number:0 }}<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">td</span>&gt;</span>is prime? true<span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>I removed manual table rendering code, leaving only number computation (still through a separate web worker)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  $scope.computing = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> computePrimes($scope.primes.length, $scope.primes.length + batchSize)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&apos;computed&apos;</span>, $scope.primes.length, <span class="string">&apos;primes&apos;</span>);</span><br><span class="line">    $scope.computing = <span class="literal">false</span>;</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>The page now shows first 100 numbers right away. If I scroll to the bottom, the new numbers are computed
and appended to the page. The generation is fast enough to not generate a pause during scrolling.
I can see the 3 spikes in the timeline when generating first 400 numbers (the first 100 numbers are
generated before I start the profiling).</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/infinite-scroll.png" alt="infinite scroll"></p>
<p>The code is at the tag <a href="https://github.com/bahmutov/primes/releases/tag/step-13" target="_blank" rel="external">step-13</a>.</p>
<h2 id="minimize-objects-returned-from-watchers">Minimize objects returned from watchers</h2><p>Another non-obvious source of slow performance specific to AngularJS are values returned from watcher functions.
Each watched expression could be an expression against the scope object, or a function returning
a value. The two watchers in the code below are equivalent.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">&apos;Primes&apos;</span>, [])</span><br><span class="line">  .controller(<span class="string">&apos;primesController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope</span>) </span>{</span><br><span class="line">    $scope.primes = ...</span><br><span class="line">    $scope.$watch(<span class="string">&apos;primes&apos;</span>, ...);</span><br><span class="line">    <span class="comment">// OR</span></span><br><span class="line">    $scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">      <span class="keyword">return</span> $scope.primes;</span><br><span class="line">    }, ...);</span><br></pre></td></tr></table></figure>
<p>AngularJs does dirty checking - during each digest cycle, every watcher function is evaluated, and
the returned value is compared against the last known value. This means that the last known value is
stored with the watcher function. If you watch using deep equality (inspect the returned value,
rather than just compare reference), then angular has to deep copy the value returned by the watcher to store it.
This could be very expensive. For example an array with objects:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$scope.n = <span class="number">10000</span>;</span><br><span class="line">$scope.primes = <span class="keyword">new</span> <span class="built_in">Array</span>($scope.n);</span><br><span class="line"><span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; $scope.n; k += <span class="number">1</span>) {</span><br><span class="line">  $scope.primes[k] = { foo: { bar: <span class="string">&apos;baz&apos;</span> } };</span><br><span class="line">}</span><br><span class="line">$scope.$watch(<span class="function"><span class="keyword">function</span> <span class="title">primesWatcher</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $scope.primes;</span><br><span class="line">}, angular.noop, <span class="literal">true</span>); <span class="comment">// do nothing on value change</span></span><br></pre></td></tr></table></figure>
<p>The code is at the tag <a href="https://github.com/bahmutov/primes/releases/tag/step-14" target="_blank" rel="external">step-14</a>.</p>
<p>Initial application load is delayed by 500ms because the object returned from <code>primesWatcher</code> is
copied for future comparisons. The application will pay the same penalty whenever the <code>primes</code> object
changes and the new value needs to be stored in the watcher for next comparison.</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/deep-copy-profile.png" alt="deep copy"></p>
<p>An important note: deep copy takes a LOT longer than deep equality comparison. Thus the performance
delay it introduces is not applied during idle digests, but only when something has changed. In practice
this means sluggish response to the user&apos;s input when the watcher&apos;s result is copied.</p>
<p>Several suggestions to fight expensive deep copying in watchers</p>
<ul>
<li>Prefer reference comparisons to deep equality in watchers (3rd boolean parameter)</li>
<li>Reuse single watcher for multiple actions</li>
</ul>
<p>For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instead of individual actions for same watcher</span></span><br><span class="line">$scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $scope.primes;</span><br><span class="line">}, foo, <span class="literal">true</span>);</span><br><span class="line">$scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $scope.primes;</span><br><span class="line">}, bar, <span class="literal">true</span>);</span><br><span class="line">$scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $scope.primes;</span><br><span class="line">}, baz, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">// use single watcher and fire off multiple actions</span></span><br><span class="line">$scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> $scope.primes;</span><br><span class="line">}, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  foo();</span><br><span class="line">  bar();</span><br><span class="line">  baz();</span><br><span class="line">}, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>Use your own logic to compute <code>dirty</code> state</li>
</ul>
<p>The <code>primes</code> object changes every time we add a found prime number to it</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.controller(<span class="string">&apos;primesController&apos;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> primesChanged = <span class="number">0</span>;</span><br><span class="line">  $scope.find = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    $scopes.primes.push(findNextPrime());</span><br><span class="line">    primesChanged += <span class="number">1</span>;</span><br><span class="line">  };</span><br><span class="line">  $scope.$watch(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> primesChanged;</span><br><span class="line">  }, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{ ... });</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>Here I am using a counter to make sure watcher always fires new value when things have changed.
If I just returned a boolean value, the digest cycle would not see the change, since it is the
difference with last value that matters, not the actual value returned by the watcher function.</p>
<h2 id="conclusions-and-further-readings">Conclusions and further readings</h2><p>Improving any application&apos;s performance is an iterative process.</p>
<ol>
<li>Profile to identify true bottleneck</li>
<li>Remove the bottleneck</li>
<li>Repeat steps 1-2</li>
</ol>
<p>I find it useful to remove the longest running bottleneck first, before looking at the
other potential problems. First, removing the slowest code makes the greatest impact.
Second, its removal might change the order of the other bottlenecks.</p>
<p>Usually, my application&apos;s JavaScript code has an obvious initial bottleneck.
Once the client code has been optimized, I turn to profiling and optimizing Angular&apos;s features,
mostly by removing unnecessary work the engine does often.
After this, I turn my attention to code execution vs browser rendering, hoping to split
larger blocks of work into small batches.</p>
<p>Successful performance optimization requires knowledge of the JavaScript language,
runtime engine optimizations, browser rendering pipeline and your application&apos;s framework&apos;s specifics.
Most importantly it requires matching the application&apos;s performance profile to your user&apos;s expectations
and use cases. Angular has certain performance bottlenecks, like dirty checking during the digest
cycle. Still, it is very flexible framework, as you can see from the above examples. I have been
able to rip parts of the pipeline, replace steps, rearrange units of work, yet it is still an Angular
application. It used only very simple services (<code>$q</code>, <code>$timeout</code>, <code>ng-repeat</code>)
and basic building blocks (<code>controller</code>, <code>factory</code>). We could improve the performance of specific parts of the
application without sacrificing its flexibility and simplicity.</p>
<p>For more information, read these articles</p>
<ul>
<li><a href="https://developer.chrome.com/devtools/docs/cpu-profiling" target="_blank" rel="external">Profiling JavaScript Performance</a></li>
<li><a href="https://github.com/petkaantonov/bluebird/wiki/Optimization-killers" target="_blank" rel="external">Optimization killers</a> and
<a href="http://www.html5rocks.com/en/tutorials/speed/v8/" target="_blank" rel="external">Performance Tips for JavaScript in V8</a></li>
<li><a href="http://tech.small-improvements.com/2013/09/10/angularjs-performance-with-large-lists/" target="_blank" rel="external">AngularJS Performance Tuning for Long Lists</a></li>
<li><a href="http://www.binpress.com/tutorial/speeding-up-angular-js-with-simple-optimizations/135" target="_blank" rel="external">Speeding up AngularJS apps with simple optimizations</a></li>
<li><a href="http://angular-tips.com/blog/2013/08/removing-the-unneeded-watches/" target="_blank" rel="external">Removing the Unneeded Watches</a></li>
<li><a href="http://www.williambrownstreet.net/blog/2013/07/angularjs-my-solution-to-the-ng-repeat-performance-problem/" target="_blank" rel="external">Solution to ng-repeat performance problem</a></li>
<li><a href="https://www.youtube.com/watch?v=LaxbdIyBkL0" target="_blank" rel="external">Memory Management Masterclass with Addy Osmani</a></li>
</ul>
<h2 id="update-1">Update 1</h2><p>I have explored additional methods to improve Angular application&apos;s performance. See separate blog posts on:</p>
<ul>
<li><a href="../local-angular-scopes/">Limiting the digest cycle</a> to run on a particular scope and its children.</li>
<li><a href="../run-angular-digest-cycle-in-web-worker/">Running digest cycle in web worker</a>.</li>
<li>Keep only visible DOM elements in the scrollable container using
<a href="https://github.com/kamilkp/angular-vs-repeat" target="_blank" rel="external">angular-vs-repeat</a>. Even if the list attached
to the scope is huge, this directive only keeps visible DOM elements in the document, speeding
up the initial rendering and scroll tremendously. Also works nicely with bind-once directive.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/bahmutov/talks/master/images/angular-vs-repeat.png" alt="angular vs repeat"></p>
<h2 id="update-2">Update 2</h2><p>I have extended <em>primes</em> git repo with angular-vs-repeat feature, available under tag
<a href="https://github.com/bahmutov/primes/releases/tag/step-15" target="_blank" rel="external">step-15</a>
The scroll CPU profile shows very little activity, since only a few items are visible at a time</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/angular-vs-repeat-cpu-profile.png" alt="vs-repeat cpu"></p>
<p>The timeline also shows very light load and high frames per second</p>
<p><img src="https://raw.githubusercontent.com/bahmutov/primes/master/images/angular-vs-repeat-timeline.png" alt="vs timeline"></p>
<h2 id="update-3">Update 3</h2><p>All previous steps have used AngularJS 1.2, with <code>step-4</code> idle digest cycle taking 850ms. I tried
the same code using AngularJS 1.3.13 and the same code runs the digest cycle much faster - taking ony 250ms.
If you have not upgraded to 1.3, you should. You can find my upgrade code at <code>step-16</code> -
compare it with the identical <code>step-4</code> code.</p>
<h2 id="update-4">Update 4</h2><p>I compared setting <code>ng-class</code> properties myself for valid / invalid data vs using AngularJS form
validation (<code>ng-valid, ng-invalid</code>, etc. See <a href="https://code.angularjs.org/1.3.10/docs/guide/forms" target="_blank" rel="external">forms</a> page.) For every row in the primes
table I set class for a single cell (the found prime value).</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">&quot;number&quot;</span></span><br><span class="line">    <span class="attribute">ng-model</span>=<span class="value">&quot;prime&quot;</span> <span class="attribute">name</span>=<span class="value">&quot;primeNumber&quot;</span> <span class="attribute">required</span>=<span class="value">&quot;&quot;</span></span><br><span class="line">    <span class="attribute">ng-class</span>=<span class="value">&quot;{ &apos;small&apos;: prime &lt; 10, &apos;exact&apos;: prime == 10, &apos;large&apos;: prime &gt; 10 }&quot;</span></span><br><span class="line">    /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The goal was to mark numbers larger than 10 as invalid. Each cell had an additional watch
expression, total went up by 33% (from 30k to 40k watchers total). The digest cycle went
up by 50% from 20ms to 30ms.</p>
<p>Then I tried the same logic using built-in validators.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">&quot;number&quot;</span> <span class="attribute">max</span>=<span class="value">&quot;10&quot;</span></span><br><span class="line">    <span class="attribute">ng-model</span>=<span class="value">&quot;prime&quot;</span> <span class="attribute">name</span>=<span class="value">&quot;primeNumber&quot;</span> <span class="attribute">required</span>=<span class="value">&quot;&quot;</span></span><br><span class="line">    /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>I also had CSS class <code>ng-valid</code> and <code>ng-invalid</code> to replace <code>small</code> and <code>large</code> classes.
There were no more watchers and the idle digest cycle remained at 20ms, despite validating
the cell values.</p>
<p>If you need to style valid / invalid values, use the built-in AngularJS validation features,
instead of <code>ng-class</code> logic.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="http://glebbahmutov.com">glebbahmutov.com</a>
</footer>

    

    <footer class="article-footer">
      <a data-url="http://glebbahmutov.com/blog/improving-angular-web-app-performance-example/" data-id="cijdoswqw00l8yyurxp2w8puw" class="article-share-link">Share</a>
      
        <a href="http://glebbahmutov.com/blog/improving-angular-web-app-performance-example/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/advice/">advice</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/angularjs/">angularjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/performance/">performance</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../run-angular-digest-cycle-in-web-worker/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Run Angular digest cycle in web worker
        
      </div>
    </a>
  
  
    <a href="../chrome-dev-tools-code-snippets/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Chrome DevTools Code Snippets</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">71</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">192</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/">advice</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/">angularjs</a><span class="tag-list-count">54</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/">assertions</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/">boilerplate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/">browser</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/">ci</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/">db</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/">es6</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/">functional</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/">git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/">immutable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/">javascript</a><span class="tag-list-count">146</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/">modular development</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/">nodejs</a><span class="tag-list-count">55</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/">performance</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/">promises</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/">reactive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/">reactjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/">security</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/">sentry</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/">testing</a><span class="tag-list-count">44</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/">tutorial</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/">ui</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/">web workers</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/QUnit/" style="font-size: 12.35px;">QUnit</a><a href="../tags/advice/" style="font-size: 19.41px;">advice</a><a href="../tags/angular/" style="font-size: 10px;">angular</a><a href="../tags/angularjs/" style="font-size: 18.24px;">angularjs</a><a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a><a href="../tags/assertions/" style="font-size: 13.53px;">assertions</a><a href="../tags/boilerplate/" style="font-size: 15.29px;">boilerplate</a><a href="../tags/browser/" style="font-size: 14.71px;">browser</a><a href="../tags/ci/" style="font-size: 11.18px;">ci</a><a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a><a href="../tags/d3/" style="font-size: 11.18px;">d3</a><a href="../tags/database/" style="font-size: 10px;">database</a><a href="../tags/db/" style="font-size: 12.35px;">db</a><a href="../tags/es6/" style="font-size: 14.12px;">es6</a><a href="../tags/es7/" style="font-size: 10px;">es7</a><a href="../tags/functional/" style="font-size: 17.06px;">functional</a><a href="../tags/generators/" style="font-size: 12.35px;">generators</a><a href="../tags/git/" style="font-size: 13.53px;">git</a><a href="../tags/grunt/" style="font-size: 13.53px;">grunt</a><a href="../tags/gulp/" style="font-size: 11.18px;">gulp</a><a href="../tags/immutable/" style="font-size: 10px;">immutable</a><a href="../tags/interview/" style="font-size: 11.18px;">interview</a><a href="../tags/jade/" style="font-size: 11.76px;">jade</a><a href="../tags/javascript/" style="font-size: 20px;">javascript</a><a href="../tags/jshint/" style="font-size: 11.18px;">jshint</a><a href="../tags/modular-development/" style="font-size: 15.29px;">modular development</a><a href="../tags/nodejs/" style="font-size: 18.82px;">nodejs</a><a href="../tags/performance/" style="font-size: 15.88px;">performance</a><a href="../tags/promises/" style="font-size: 16.47px;">promises</a><a href="../tags/proposal/" style="font-size: 10.59px;">proposal</a><a href="../tags/reactive/" style="font-size: 10.59px;">reactive</a><a href="../tags/reactjs/" style="font-size: 10.59px;">reactjs</a><a href="../tags/security/" style="font-size: 11.76px;">security</a><a href="../tags/sentry/" style="font-size: 13.53px;">sentry</a><a href="../tags/testing/" style="font-size: 17.65px;">testing</a><a href="../tags/tutorial/" style="font-size: 12.94px;">tutorial</a><a href="../tags/ui/" style="font-size: 10px;">ui</a><a href="../tags/web-workers/" style="font-size: 12.35px;">web workers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../i-write-3-types-of-software/">I write 3 types of software</a>
          </li>
        
          <li>
            <a href="../run-express-server-in-your-browser/">Run Express server in your browser</a>
          </li>
        
          <li>
            <a href="../using-webpack/">Using webpack</a>
          </li>
        
          <li>
            <a href="../the-senior-engineer-role/">The senior engineer role</a>
          </li>
        
          <li>
            <a href="../instant-web-application/">Instant Web Application</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="..//" class="mobile-nav-link">Home</a>
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'http://glebbahmutov.com/blog/improving-angular-web-app-performance-example/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../fancybox/jquery.fancybox.css" type="text/css">
  <script src="../fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="../js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>