<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Kliesli composition | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Please read Kliesli Compositions in JavaScript by Luis Atencio first. This blog post is just a refactoring of the code for clarity. While Luis does an admirable job showing the composition (a complim">
<meta property="og:type" content="article">
<meta property="og:title" content="Kliesli composition">
<meta property="og:url" content="https://glebbahmutov.com/blog/kleisli/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Please read Kliesli Compositions in JavaScript by Luis Atencio first. This blog post is just a refactoring of the code for clarity. While Luis does an admirable job showing the composition (a complim">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/kleisli/power-cable.jpeg">
<meta property="article:published_time" content="2017-08-15T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.301Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="functional">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/kleisli/power-cable.jpeg">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-kleisli" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2017-08-15T04:00:00.000Z" itemprop="datePublished">Aug 15 2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Kliesli composition
    </h1>

    <h2 class="article-title" itemprop="name">
      Connecting Kliesli compositions or the advantages of good pipe insulation.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/blog/images/kleisli/power-cable.jpeg" alt="Cable inside a cable"></p>
<p>Please read <a target="_blank" rel="noopener" href="https://medium.com/@luijar/kliesli-compositions-in-javascript-7e1a7218f0c4">Kliesli Compositions in JavaScript</a>
by <a target="_blank" rel="noopener" href="https://medium.com/@luijar">Luis Atencio</a> first. This blog post is just
a refactoring of the code for clarity. While Luis does an admirable job showing
the composition (a compliment), the final code is not as clear as it could be.
We can even say that the code by putting type unwrapping and wrapping inside
each composed function strays away from the functional principles of
simplicity and composability. See last part for comparison, but hope you read
my derivation before jumping to the end.</p>
<h2><span id="the-example">The example</span></h2><p>Imagine you have a text file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat text.txt</span><br><span class="line">word word another word</span><br></pre></td></tr></table></figure>
<p>Imagine you want to count words in this single line text file. Do not handle
any errors while coding it. Instead concentrate on making the program
from small easy to understand functions. You might write a function to read the file,
then another function to decode it, then another function to split text into
words. Final function could count the words and return a number, which the
program can print. In code this is simple:</p>
<figure class="highlight js"><figcaption><span>happy-path.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> read = <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">  fs.readFileSync(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.length &gt; <span class="number">0</span> ? buffer : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  text.split(<span class="string">&#x27; &#x27;</span>).length</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processFile = <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">  count(decode(<span class="string">&#x27;utf8&#x27;</span>)(check(read(path))))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(processFile(<span class="string">&#x27;./text.txt&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>When we run this program with an existing, non-empty file, things are great</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat text.txt</span><br><span class="line">word word another word</span><br><span class="line">$ node happy-path.js</span><br><span class="line">4</span><br></pre></td></tr></table></figure>
<p>Yet, this program is extremely brittle. It does not handle any errors that
might happen in the real world. The file might not exist or it might be empty.
This program is also less than performant because it reads the file in blocking
manner using <code>fs.readFileSync</code> instead of using a callback. But if we used a
callback, we could not easily perform composition <code>check(read(path))</code>.</p>
<h2><span id="composition-of-functions">Composition of functions</span></h2><p>Let us start with an observation that the function <code>processFile</code> is really
a seriest of nested function calls. The only variable in the function is
<code>path</code> and that goes inside the &quot;deepest&quot; nested call <code>read(path)</code>. We could
draw what happens to the data in <code>processFile</code> as a data processing pipeline</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processFile = <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">  count(decode(<span class="string">&#x27;utf8&#x27;</span>)(check(read(path))))</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// string =&gt; buffer =&gt; buffer|null =&gt; string =&gt; number</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      read      check         decode     count</span></span><br></pre></td></tr></table></figure>
<p>Note the flow of data goes from the most nested function <code>read</code> that executes
first all the way to <code>count</code> that executes last.  Each function expected a
single argument and returns a single result. Well,
except for <code>decode</code>, but that one due to being split into a function returning
a function is really making a function we really want on the fly:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> decodeUtf8 = decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> processFile = <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">  count(decodeUtf8(check(read(path))))</span><br></pre></td></tr></table></figure>
<p>Function <code>read</code> takes a string argument, and function <code>count</code> returns a number.
Thus the composed function <code>processFile</code> expects a string and returns a number.</p>
<p>We wrote <code>processFile</code> but really is is just a series of function calls,
each grabbing the result of the previous step and calling the next function
in the list. People have been writing functions to do this for us for a long
time. <a target="_blank" rel="noopener" href="http://ramdajs.com/">Ramda</a> for example has <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#compose">R.compose</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> R = <span class="built_in">require</span>(<span class="string">&#x27;ramda&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> processFile = R.compose(</span><br><span class="line">  count,</span><br><span class="line">  decode(<span class="string">&#x27;utf8&#x27;</span>),</span><br><span class="line">  check,</span><br><span class="line">  read</span><br><span class="line">)</span><br><span class="line"><span class="built_in">console</span>.log(processFile(<span class="string">&#x27;./text.txt&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>Note that we have constructed <code>processFile</code> without even defining the
variable <code>path</code> (this is called <a href="../point-free-programming-is-not-pointless/">pointfree style</a>).
I personally prefer the <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#pipe">R.pipe</a> function that reverses the
order of composed functions. I think it reads more naturally top to bottom.
In addition, we can write type of the result at each step; types usually
start with an upper case letter.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processFile = R.pipe(</span><br><span class="line">  read,            <span class="comment">// String -&gt; Buffer</span></span><br><span class="line">  check,           <span class="comment">// Buffer -&gt; Buffer | Null</span></span><br><span class="line">  decode(<span class="string">&#x27;utf8&#x27;</span>),  <span class="comment">// Buffer -&gt; String</span></span><br><span class="line">  count            <span class="comment">// String -&gt; Number</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>By taking the input to first step <code>read</code> (that is <code>string</code>) and output of
the last step <code>count</code> (that is of type <code>number</code>) we can write the input and
output types for the composed function <code>processFile</code>. We could write it like
this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processFile :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> processFile = ...</span><br></pre></td></tr></table></figure>
<p>Ok we can create the program function out of small building blocks on the
fly, but the program really cannot handle any errors! It will crash and burn
badly in a very common case - if the input file does not exist.</p>
<h2><span id="task">Task</span></h2><p>Let us kill two birds with one stone. Let us make the program asynchronous
by reading a file using a callback, and let us handle any errors reading the
file. Instead of passing &quot;plain&quot; values from one function to another, the
<code>read</code> will return the contents of the file, but stored inside a &quot;Task&quot;
object. I will use <a target="_blank" rel="noopener" href="https://github.com/folktale/data.task#readme">data.task</a> for this. Almost verbatim from the
<a target="_blank" rel="noopener" href="https://github.com/folktale/data.task#example">data.task example</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read :: String -&gt; Task(Error, Buffer)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, resolve</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error)  reject(error)</span><br><span class="line">      <span class="keyword">else</span>        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Calling <code>read</code> with a string returns you a &quot;Task&quot;. And that &quot;Task&quot; later
will have either an Error or a Buffer. Due to its asynchronous nature, we
can no longer run <code>check</code> or <code>decode</code> or even print the file contents right
away. Instead we need to attach actions we want to executes as callbacks
to the Task object.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read :: String -&gt; Task(Error, Buffer)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, resolve</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error)  reject(error)</span><br><span class="line">      <span class="keyword">else</span>        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// note double error; decode is a function returning a function</span></span><br><span class="line"><span class="comment">// decode :: String -&gt; Buffer -&gt; String</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line"></span><br><span class="line">read(<span class="string">&#x27;./text.txt&#x27;</span>)</span><br><span class="line">  .map(decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">  .fork(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error)</span><br><span class="line"><span class="comment">// word word another word</span></span><br></pre></td></tr></table></figure>
<p>This is kind of interesting: <code>Task.map</code> expects a function that <em>knows nothing
about working with a Task</em>. Instead the callback function to <code>Task.map</code>
receives the value from inside Task (whenever it becomes available).
The &quot;plain&quot; value returned by the callback function <code>decode(&#39;utf8&#39;)</code> is
automatically placed <em>back into a Task object</em>.</p>
<p>The result of <code>Task.map(...)</code> is another Task. We can keep &quot;mapping&quot; over
previous result.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read :: String -&gt; Task(Error, Buffer)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, resolve</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error)  reject(error)</span><br><span class="line">      <span class="keyword">else</span>        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decode :: String -&gt; Buffer -&gt; String</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line"></span><br><span class="line"><span class="comment">// check :: Buffer -&gt; Buffer | Null</span></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.length &gt; <span class="number">0</span> ? buffer : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// count :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  text.split(<span class="string">&#x27; &#x27;</span>).length</span><br><span class="line"></span><br><span class="line">read(<span class="string">&#x27;./text.txt&#x27;</span>)</span><br><span class="line">  .map(decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">  .map(check)</span><br><span class="line">  .map(count)</span><br><span class="line">  .fork(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>
<p>Here is a cool thing about a Task. As you might have guessed each <code>Task.map</code>
method call returns another Task instance, but <em>nothing is executed</em> until
<code>Task.fork</code> is called.</p>
<p>We can demonstrate this by interspersing log statements with mapping calls</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> t1 = read(<span class="string">&#x27;./text.txt&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;t1&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> t2 = t1.map(decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;t2&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> t3 = t2.map(check)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;t3&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> t4 = t3.map(count)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;t4&#x27;</span>)</span><br><span class="line">t4.fork(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">t1</span></span><br><span class="line"><span class="comment">t2</span></span><br><span class="line"><span class="comment">t3</span></span><br><span class="line"><span class="comment">t4</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>And we can demonstrate that no Tasks are executed by commenting out <code>.fork()</code>
call and adding a log statement to <code>read</code> function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read :: String -&gt; Task(Error, Buffer)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, resolve</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;read task&#x27;</span>)</span><br><span class="line">    fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error)  reject(error)</span><br><span class="line">      <span class="keyword">else</span>        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;t4&#x27;</span>)</span><br><span class="line"><span class="comment">// t4.fork(console.log, console.error)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">t1</span></span><br><span class="line"><span class="comment">t2</span></span><br><span class="line"><span class="comment">t3</span></span><br><span class="line"><span class="comment">t4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>Delayed execution is the main benefit of Tasks - you can keep adding more
computations until you are happy with the chain, and only then call <code>Task.fork</code>
to actually run it. Promises on the other hand are eager - as soon as you
have created a Promise <a href="../difference-between-promise-and-task/">it starts running</a>.</p>
<h2><span id="composing-task-with-plain-functions">Composing Task with plain functions</span></h2><p>Now that we got our very first function <code>read</code> returning a Task, but we lost the
ability to compose functions using <code>R.compose</code> or <code>R.pipe</code>. How can we compose
a Task - it is no longer a &quot;plain&quot; value we can pass to the next function in
the chain. Luckily, Ramda has a composition function just for this case.
If every function in the chain expects a &quot;plain&quot; input but returns a Task,
all functions can be composed again using a library utility
<a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#composeK">R.composeK</a> or <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#pipeK">R.pipeK</a> (the K stands for
Kliesli composition, but I am not linking a reference url because the Wikipedia
article will scare you away for good). Think of this as a composition for
functions that all return same wrapped type like Task.</p>
<p>To compose, each individual function in the chain <em>must</em> return result of
type Task. The simplest case to wrap a &quot;plain&quot; value in a Task is to call
<code>Task.of(x)</code> factory function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decode :: String -&gt; Buffer -&gt; Task(String)</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  Task.of(buffer.toString(encoding))</span><br><span class="line"></span><br><span class="line"><span class="comment">// check :: Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  Task.of(buffer.length &gt; <span class="number">0</span> ? buffer : <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// count :: String -&gt; Task(Number)</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  Task.of(text.split(<span class="string">&#x27; &#x27;</span>).length)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,           <span class="comment">// String -&gt; Task(Error, Buffer)</span></span><br><span class="line">  check,          <span class="comment">// Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line">  decode(<span class="string">&#x27;utf8&#x27;</span>), <span class="comment">// Buffer -&gt; Task(String)</span></span><br><span class="line">  count           <span class="comment">// String -&gt; Task(Number)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">processFile(<span class="string">&#x27;./text.txt&#x27;</span>)</span><br><span class="line">  .fork(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>
<p>If we decide to draw pipeline <code>processFile</code>, I would visualize it as
a series of pipe segments. Each segment that we write expected &quot;plain&quot; value
but outputs <code>Task</code> object. Yet except for <code>read</code> no other function we wrote
deals with or needs an actual Task object! No other function is asynchronous,
so hard-coding <code>Task.of(result)</code> inside each function is short sighed. It
makes a function harder to read and harder to test. We only returned a Task
from each so we could use these functions with <code>R.pipeK</code>.</p>
<p>I prefer <em>adapting</em> a function to each particular case, rather than changing
it (see my <a href="../my-favorite-functional-adaptors/">favorite adaptors</a>). Thus I
will change the <code>check</code>, <code>decode(&#39;utf8&#39;)</code> and <code>count</code> functions back to their
original &quot;simple&quot; form, and will convert the result into a Task on the fly.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decode :: String -&gt; Buffer -&gt; String</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line"></span><br><span class="line"><span class="comment">// check :: Buffer -&gt; Buffer | Null</span></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.length &gt; <span class="number">0</span> ? buffer : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// count :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  text.split(<span class="string">&#x27; &#x27;</span>).length</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,                            <span class="comment">// String -&gt; Task(Error, Buffer)</span></span><br><span class="line">  x =&gt; Task.of(check(x)),          <span class="comment">// Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line">  x =&gt; Task.of(decode(<span class="string">&#x27;utf8&#x27;</span>)(x)), <span class="comment">// Buffer -&gt; Task(String)</span></span><br><span class="line">  x =&gt; Task.of(count(x))           <span class="comment">// String -&gt; Task(Number)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Individual functions <code>decode</code>, <code>check</code> and <code>count</code> are simple again, but
our pipeline is a little heavy. We notice that <code>x =&gt; Task.of(check(x))</code> for
example is functional composition itself!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,                               <span class="comment">// String -&gt; Task(Error, Buffer)</span></span><br><span class="line">  R.compose(Task.of, check),          <span class="comment">// Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line">  R.compose(Task.of, decode(<span class="string">&#x27;utf8&#x27;</span>)), <span class="comment">// Buffer -&gt; Task(String)</span></span><br><span class="line">  R.compose(Task.of, count)           <span class="comment">// String -&gt; Task(Number)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Notice the repeated <code>R.compose(Task.of, _)</code> syntax. We could partially apply
the first argument here to shorten it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asTask = R.partial(R.compose, [Task.of])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,                   <span class="comment">// String -&gt; Task(Error, Buffer)</span></span><br><span class="line">  asTask(check),          <span class="comment">// Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line">  asTask(decode(<span class="string">&#x27;utf8&#x27;</span>)), <span class="comment">// Buffer -&gt; Task(String)</span></span><br><span class="line">  asTask(count)           <span class="comment">// String -&gt; Task(Number)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>We could avoid even using <code>R.partial</code> if <code>R.compose</code> were curried, but it
is hard to curry a function with unknown number of arguments. Luckily, Ramda
includes <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#o">R.o</a> which is a curried compose! That is the function that
makes our code tiny in this case.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asTask = R.o(Task.of)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,                   <span class="comment">// String -&gt; Task(Error, Buffer)</span></span><br><span class="line">  asTask(check),          <span class="comment">// Buffer -&gt; Task(Buffer | Null)</span></span><br><span class="line">  asTask(decode(<span class="string">&#x27;utf8&#x27;</span>)), <span class="comment">// Buffer -&gt; Task(String)</span></span><br><span class="line">  asTask(count)           <span class="comment">// String -&gt; Task(Number)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Perfect. We are composing functions, some of which return an actual Task, but
most do not, and we are adapting the return value on the fly so the pipe line
holds. The actual &quot;flow&quot; is still, aside from the <code>read</code> function, just
&quot;plain&quot; values along the &quot;happy&quot; path.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------</span><br><span class="line">                  Task &quot;pipe&quot;</span><br><span class="line"></span><br><span class="line">read -&gt; check -&gt; decode -&gt; count       happy path &quot;pipe&quot;  -&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>What happens if there is a file read error? In that case, the control flow
will skip the &quot;happy path pipe&quot;, and will go directly to the error callback
function in the <code>.fork(onError, onSuccess)</code> execution.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------</span><br><span class="line">                  Task &quot;pipe&quot;</span><br><span class="line"></span><br><span class="line">read -&gt; check -&gt; decode -&gt; count       happy path &quot;pipe&quot;   -&gt; onSuccess</span><br><span class="line">     \</span><br><span class="line">      -&gt;   ~~~~~~ to the error callback ~~~~~~~~~~~~~~~~~~ -&gt; onError</span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>I like thinking of Task / Promises / Either making little railway tracks,
and the data moving along the tracks like box cars. Sometimes due to an error,
the box car jumps to an error track where it will keep rolling until someone
handles the lost car. Watch
<a target="_blank" rel="noopener" href="https://vimeo.com/113588389">Functional programming design patterns by Scott Wlaschin</a>
for a good talk using this analogy.</p>
<p>Notice that <code>check</code>, <code>decode</code> and <code>count</code> do not take advantage of the full
Task pipeline, unlike <code>read</code>. Also, they probably should not - they are
synchronous functions and their problem is a different one. Take <code>check</code>
for example: it returns <code>null</code> value to indicate an empty file. But what if
the <code>null</code> value was a legitimate one? Would it return <code>-1</code> or some magic
constant to indicate a problem? Or would it throw an Error? And how could we
compose these functions safely in that case?</p>
<h2><span id="either-pipeline">Either pipeline</span></h2><p>Let us take a look at <code>check</code> function. Again, just like <code>read</code>, it should not
return a &quot;plain&quot; special value to indicate a problem. Instead it should return
an object that, just like Task, allows mapping over the inner value.
This wrapper is called <code>Either</code>, it is commonly used to replace multiple
<a href="../if-else-vs-either-monad-vs-frp/">if-else</a> branches
and there many libraries that implement it.
I will use <a target="_blank" rel="noopener" href="https://github.com/folktale/data.either#readme">data.either</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Either = <span class="built_in">require</span>(<span class="string">&#x27;data.either&#x27;</span>)</span><br><span class="line"><span class="comment">// check : Buffer -&gt; Either(Buffer)</span></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.length &gt; <span class="number">0</span></span><br><span class="line">    ? Either.Right(buffer)         <span class="comment">// success ‚úÖ</span></span><br><span class="line">    : Either.Left(<span class="string">&#x27;File is empty&#x27;</span>) <span class="comment">// failure ‚ò¢Ô∏è</span></span><br></pre></td></tr></table></figure>
<p>Great, what about <code>decode</code> and <code>count</code>? They too could just return <code>Either</code>,
and we could compose all 3 functions into single pipeline using <code>R.pipeK</code>,
only this time the result would be an <code>Either(...)</code> object.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; decode : String -&gt; Buffer -&gt; Either(String)</span><br><span class="line">const decode &#x3D; encoding &#x3D;&gt; buffer &#x3D;&gt; Either.of(</span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; count :: String -&gt; Either(Number)</span><br><span class="line">const count &#x3D; text &#x3D;&gt; Either.of(</span><br><span class="line">  text.split(&#39; &#39;).length</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; processBuffer :: Buffer -&gt; Either(Number)</span><br><span class="line">const processBuffer &#x3D; R.pipeK(</span><br><span class="line">  check,          &#x2F;&#x2F; Either(Buffer)</span><br><span class="line">  decode(&#39;utf8&#39;), &#x2F;&#x2F; Either(String)</span><br><span class="line">  count           &#x2F;&#x2F; Either(Number)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>The way to get the value from <code>Either</code> is to NOT ignore possible errors, and
for example provide default value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  processBuffer(Buffer.from(<span class="string">&#x27;foo bar&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    .getOrElse(<span class="string">&#x27;Hmm, an error&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p>An <code>Either</code> is especially useful here, because a function like <code>decode</code> might
receive an invalid encoding; <code>Either</code> allows us to avoid crashing.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decode : String -&gt; Buffer -&gt; Either(String)</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Either.Right(buffer.toString(encoding))</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> Either.Left(<span class="string">&#x27;Could not decode using &#x27;</span> + encoding)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// processBuffer :: Buffer -&gt; Either(Number)</span></span><br><span class="line"><span class="keyword">const</span> processBuffer = R.pipeK(</span><br><span class="line">  check,          <span class="comment">// Either(Buffer)</span></span><br><span class="line">  decode(<span class="string">&#x27;ffff&#x27;</span>), <span class="comment">// Either(String)</span></span><br><span class="line">  count           <span class="comment">// Either(Number)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  processBuffer(Buffer.from(<span class="string">&#x27;foo bar&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    .getOrElse(<span class="string">&#x27;Hmm, an error&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"><span class="comment">// Hmm, an error</span></span><br></pre></td></tr></table></figure>
<p>We could do the same trick and NOT hard code returned <code>Either</code> type in <code>count</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  text.split(<span class="string">&#x27; &#x27;</span>).length</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asEither = R.o(Either.of)</span><br><span class="line"></span><br><span class="line"><span class="comment">// processBuffer :: Buffer -&gt; Either(Number)</span></span><br><span class="line"><span class="keyword">const</span> processBuffer = R.pipeK(</span><br><span class="line">  check,          <span class="comment">// Either(Buffer)</span></span><br><span class="line">  decode(<span class="string">&#x27;utf8&#x27;</span>), <span class="comment">// Either(String)</span></span><br><span class="line">  asEither(count) <span class="comment">// Either(Number)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(</span><br><span class="line">  processBuffer(Buffer.from(<span class="string">&#x27;foo bar&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    .getOrElse(<span class="string">&#x27;Hmm, an error&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>In a sense we have constructed a pipeline where each function (well, except
<code>count</code> but that only gets called with a valid string input) is safe.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">            Either &quot;pipe&quot;</span><br><span class="line">check -&gt; decode -&gt; count</span><br><span class="line"></span><br><span class="line">-----------------------------------------</span><br></pre></td></tr></table></figure>
<p>From <code>check</code> and from <code>decode</code>, if there is an error, the control will &quot;jump&quot;
to the error track.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">            Either &quot;pipe&quot;</span><br><span class="line">check -&gt; decode -&gt; count  -&gt; Right(n)</span><br><span class="line">    \      \</span><br><span class="line">     \-&gt; ~~~&gt; ~~~~~~~~~~~ -&gt; Left(error)</span><br><span class="line">-----------------------------------------</span><br></pre></td></tr></table></figure>
<p>Do you like my ASCII drawing skills?!</p>
<h2><span id="combining-pipes">Combining pipes</span></h2><p>Finally, let us connect the two pipelines we have composed.
We cannot combine Task and Either segments of the pipeline sequentially
unfortunately.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">------------=====-----------------</span><br><span class="line">            ----&gt;            ----&gt;</span><br><span class="line">   Task        |     Either</span><br><span class="line">            ~~~~&gt;            ~~~~&gt;</span><br><span class="line">------------=====-----------------</span><br></pre></td></tr></table></figure>
<p>To see why, think about when you are going to call <code>Task.fork</code> - is before
creating the first Either? No, that cannot be right, we want the final object
to be a Task, so we can call <code>Task.fork</code> on it when we are ready to use it.
The opposite is not true - we could convert an Either into a Task, see
<a target="_blank" rel="noopener" href="https://egghead.io/lessons/javascript-applying-natural-transformations-in-everyday-work">Natural Transformation video</a> for example.</p>
<p>Ok, back to our code.</p>
<p>We have to stick the Either pipeline <strong>inside</strong> the Task pipeline.
The <code>read</code> function will start the outer Task pipe. The result of <code>read</code>
will be passed to the inner Either pipe <code>check -&gt; decode -&gt; count</code>.
The output of the outer Task pipe that <code>Task.fork</code> will pass to the callback
function will be an <code>Either</code> object returned by the Either pipe. As a diagram
it would look like this</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------</span><br><span class="line">                   Task &quot;pipe&quot;</span><br><span class="line">         ------------------------------------------------</span><br><span class="line">read -&gt;   check -&gt; decode -&gt; count ---- success Number -&gt;</span><br><span class="line">  \           \      \                Either &quot;pipe&quot;</span><br><span class="line">   \           \-&gt; ~~~&gt; ~~~~~~~ buffer error ~~~~~~~~~ -&gt;</span><br><span class="line">    \    ------------------------------------------------</span><br><span class="line">     -&gt; ~~~~~~~~~~~~~~ file read error ~~~~~~~~~~~~~~~ -&gt;</span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>The Either pipeline is the same as before (<code>decode</code> does not check the encoding
here).</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check : Buffer -&gt; Either(Buffer)</span></span><br><span class="line"><span class="keyword">const</span> check = <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.length &gt; <span class="number">0</span></span><br><span class="line">    ? Either.Right(buffer)         <span class="comment">// success!</span></span><br><span class="line">    : Either.Left(<span class="string">&#x27;File is empty&#x27;</span>) <span class="comment">// failure</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// decode : String -&gt; Buffer -&gt; String</span></span><br><span class="line"><span class="keyword">const</span> decode = <span class="function"><span class="params">encoding</span> =&gt;</span> <span class="function"><span class="params">buffer</span> =&gt;</span></span><br><span class="line">  buffer.toString(encoding)</span><br><span class="line"></span><br><span class="line"><span class="comment">// count :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span></span><br><span class="line">  text.split(<span class="string">&#x27; &#x27;</span>).length</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asEither = R.o(Either.of)</span><br><span class="line"></span><br><span class="line"><span class="comment">// processBuffer :: Buffer -&gt; Either(Number)</span></span><br><span class="line"><span class="keyword">const</span> processBuffer = R.pipeK(</span><br><span class="line">  check,                    <span class="comment">// Either(Buffer)</span></span><br><span class="line">  asEither(decode(<span class="string">&#x27;utf8&#x27;</span>)), <span class="comment">// Either(String)</span></span><br><span class="line">  asEither(count)           <span class="comment">// Either(Number)</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Now we need to combine <code>read</code> and <code>processBuffer</code> as a Task-returning
functions, and we can use the same <code>asTask</code> approach, because <code>processBuffer</code>
is a &quot;regular&quot; function we can adapt.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read : String -&gt; Task(Error, Buffer)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Task(<span class="function"><span class="keyword">function</span>(<span class="params">reject, resolve</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error)  reject(error)</span><br><span class="line">      <span class="keyword">else</span>        resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asTask = R.o(Task.of)</span><br><span class="line"></span><br><span class="line"><span class="comment">// processFile :: String -&gt; Task(Either(Number))</span></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,                  <span class="comment">// Task(Error, Buffer)</span></span><br><span class="line">  asTask(processBuffer)  <span class="comment">// Task(Either(Number))</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>How do we get result from the output of <code>processFile</code> which is
<code>Task(Either(Number))</code>? In two steps: first calling <code>.fork</code> then <code>.getOrElse</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">processFile(<span class="string">&#x27;./text.txt&#x27;</span>)</span><br><span class="line">  .fork(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err),</span><br><span class="line">    e =&gt; <span class="built_in">console</span>.log(e.getOrElse(<span class="number">0</span>))</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>The double-pipe insulation handles missing file, access errors, empty file
and could be easily extended to cover invalid encodings and other errors.
All we need is to return an <code>Either</code> - we are already making this the
function&#39;s return type anyway in preparation for <code>R.pipeK</code> anyway.</p>
<h2><span id="comparison-to-the-original-blog-post-example">Comparison to the original blog post example</span></h2><p>To finish this blog post I want to go back to the Luis Atencio and his example.
Because Luis only uses single composition to make the Task pipe, it looks
deceptively simple (I will switch <code>compose</code> to <code>pipe</code> for easier comparison)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processFile :: String -&gt; Task(Error, Either)</span></span><br><span class="line"><span class="keyword">const</span> processFile = R.pipeK(</span><br><span class="line">  read,</span><br><span class="line">  check,</span><br><span class="line">  decode(<span class="string">&#x27;utf8&#x27;</span>),</span><br><span class="line">  count</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Yet, and this is a big one - this forces each function <code>check</code>, <code>decode</code>
and <code>count</code> to receive what an <code>Either</code> as argument, and return <code>Task</code> result.
This makes the code inside the <code>count</code> function for example
<em>unwrap the argument</em> to get to the plain string value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count :: String -&gt; Task(_, String)</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span> Task.of(text.map(<span class="function"><span class="params">t</span> =&gt;</span> t.split(<span class="string">&#x27; &#x27;</span>).length))</span><br></pre></td></tr></table></figure>
<p>Note the type signature - it is incorrect, the function <code>count</code> receives
a <code>Either(String)</code>, not <code>String</code>. That is why it has to do <code>text.map</code> to get
the actual string <code>t</code>. Similarly there is no reason (other than forcing the
function to be compatible with a Task pipeline) for <code>count</code> to return a Task!</p>
<p>Let us compare the <code>count</code> that fits into a Task pipe with our version of
the same function that goes into Either pipe, but adapts the return value
type externally using <code>asEither</code> composition. I will keep the same variable
names for honest comparison.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// count :: Either(String) -&gt; Task(_, String)</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">text</span> =&gt;</span> Task.of(text.map(<span class="function"><span class="params">t</span> =&gt;</span> t.split(<span class="string">&#x27; &#x27;</span>).length))</span><br><span class="line"><span class="comment">// count :: String -&gt; Number</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="function"><span class="params">t</span> =&gt;</span> t.split(<span class="string">&#x27; &#x27;</span>).length</span><br></pre></td></tr></table></figure>
<p>First version has 65 characters, second has 38. We saved almost 50% of code
(and a lot of complexity) by keeping <code>count</code> focused on what it should
<em>actually</em> do - split a string into an array and return its length. Leave
the marshaling of arguments and returns to others.</p>
<h2><span id="final-thoughts">Final thoughts</span></h2><p>Thanks to Luis Atencio for great examples. Go buy his book
<a target="_blank" rel="noopener" href="https://www.manning.com/books/functional-programming-in-javascript">Functional Programming in JavaScript</a> - it is excellent and practical.</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/kleisli/" data-id="ckue36b2t01tdunvgap43f8ye" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/kleisli/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/functional/" rel="tag">functional</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../slow-updates/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Slow updates
        
      </div>
    </a>
  
  
    <a href="../releasing-for-old-node/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Releasing for old Node</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">138</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">421</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">109</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">147</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">165</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">130</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.38px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.54px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.77px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.85px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.38px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.69px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.08px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.69px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.77px;">browser</a> <a href="../tags/ci/" style="font-size: 16.54px;">ci</a> <a href="../tags/circle/" style="font-size: 13.08px;">circle</a> <a href="../tags/climate/" style="font-size: 14.62px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 13.46px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.31px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 19.62px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 13.85px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.77px;">d3</a> <a href="../tags/db/" style="font-size: 14.62px;">db</a> <a href="../tags/docker/" style="font-size: 14.23px;">docker</a> <a href="../tags/documentation/" style="font-size: 11.92px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.62px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18.08px;">functional</a> <a href="../tags/generators/" style="font-size: 11.54px;">generators</a> <a href="../tags/git/" style="font-size: 15px;">git</a> <a href="../tags/github/" style="font-size: 15.38px;">github</a> <a href="../tags/graphql/" style="font-size: 11.54px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.31px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.77px;">gulp</a> <a href="../tags/hiring/" style="font-size: 10.77px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.31px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.54px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.77px;">interview</a> <a href="../tags/jade/" style="font-size: 11.15px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.77px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.85px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.92px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.15px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.46px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.15px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.31px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.31px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.38px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/react/" style="font-size: 11.54px;">react</a> <a href="../tags/react-native/" style="font-size: 11.15px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.23px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.15px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.54px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.08px;">security</a> <a href="../tags/sentry/" style="font-size: 13.85px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 11.92px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.23px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.77px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 11.92px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.38px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.08px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.15px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.54px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 11.92px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.77px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../faster-ci-feedback-on-circleci/">Get Faster Feedback From Your Cypress Tests Running On CircleCI</a>
          </li>
        
          <li>
            <a href="../faster-ci-feedback/">Get Faster Feedback From Your Cypress Tests Running On GitHub Actions</a>
          </li>
        
          <li>
            <a href="../request-graphql/">Make GraphQL Calls From Cypress Tests</a>
          </li>
        
          <li>
            <a href="../dynamic-tests-from-fixture/">Dynamic Tests From Cypress Fixture</a>
          </li>
        
          <li>
            <a href="../what-i-do-after-a-conference/">What I Do After A Conference</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/kleisli/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
