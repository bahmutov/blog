<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cypress cy.intercept Problems | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Note: I am using code from testing-workshop-cypress to demonstrate these cy.intercept gotchas.  The intercept was registered too late cy.wait uses the intercept Cached response Multiple matchers No ov">
<meta property="og:type" content="article">
<meta property="og:title" content="Cypress cy.intercept Problems">
<meta property="og:url" content="https://glebbahmutov.com/blog/cypress-intercept-problems/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="Note: I am using code from testing-workshop-cypress to demonstrate these cy.intercept gotchas.  The intercept was registered too late cy.wait uses the intercept Cached response Multiple matchers No ov">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/did-not-intercept.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/count.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/before.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/too-late.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/get-null.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/route-get.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/wait-should.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/cached-response.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/pass.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/caching.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/headers.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/body.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/post-todo.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/works.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/add-todo.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/badge.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/stub.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/get-stub.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/zero.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/no-overwrite.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/separate.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/writefile.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/reload.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/different-responses.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/http.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/http2.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/single-use-intercept.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/intercept-once.gif">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/alias-count.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/four.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/dynamic-alias.png">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/intercept-problems/multiple.png">
<meta property="article:published_time" content="2020-12-09T05:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.258Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="testing">
<meta property="article:tag" content="cypress">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/intercept-problems/did-not-intercept.gif">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-cypress-intercept-problems" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2020-12-09T05:00:00.000Z" itemprop="datePublished">Dec 9 2020</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cypress cy.intercept Problems
    </h1>

    <h2 class="article-title" itemprop="name">
      A few common cy.intercept gotchas and how to avoid them
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Note: I am using code from <a target="_blank" rel="noopener" href="https://github.com/cypress-io/testing-workshop-cypress">testing-workshop-cypress</a> to demonstrate these <a target="_blank" rel="noopener" href="https://on.cypress.io/intercept">cy.intercept</a> gotchas.</p>
<ul>
<li><a href="#the-intercept-was-registered-too-late">The intercept was registered too late</a></li>
<li><a href="#cywait-uses-the-intercept"><code>cy.wait</code> uses the intercept</a></li>
<li><a href="#cached-response">Cached response</a></li>
<li><a href="#multiple-matchers">Multiple matchers</a></li>
<li><a href="#no-overwriting-interceptors">No overwriting interceptors</a></li>
<li><a href="#avoid-cypress-commands-inside-the-interceptor">Avoid Cypress commands inside the interceptor</a></li>
<li><a href="#sending-different-responses">Sending different responses</a></li>
<li><a href="#no-overwriting-interceptors-again">No overwriting interceptors (again)</a></li>
<li><a href="#single-use-intercept">Single use intercept</a></li>
<li><a href="#get-number-of-times-an-intercept-was-matched">Get the number of times an intercept was matched</a></li>
<li><a href="#count-intercepts-again">Count intercepts (again)</a></li>
<li><a href="#set-an-alias-dynamically">Set an alias dynamically</a></li>
<li><strong>new üåü</strong> <a href="#simulate-network-error">Simulate network error</a></li>
<li><strong>new üåü</strong> <a href="#force404">Force 404</a></li>
<li><a href="#more-info">More info</a></li>
</ul>
<h2><span id="the-intercept-was-registered-too-late">The intercept was registered too late</span></h2><h3><span id="the-problem">The problem</span></h3><p>Let&#39;s say the application is making <code>GET /todos</code> call to load its data. We might write a test like this to spy on this call:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&#x27;intercept&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  it(<span class="string">&#x27;is registered too late&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">    cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>It looks reasonable, it even shows the call in the Command Log - but does NOT pass.</p>
<p><img src="/blog/images/intercept-problems/did-not-intercept.gif" alt="The intercept times out waiting"></p>
<p>You can see the XHR call in the command log - and it looks like it should work, right? But if you open the &quot;Routes&quot; section, notice that our intercept was never counted.</p>
<p><img src="/blog/images/intercept-problems/count.gif" alt="The intercept was never counted"></p>
<h3><span id="the-root-cause">The root cause</span></h3><p>The application is making the call to load the data <em>right on startup</em>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.$store.dispatch(<span class="string">&#x27;loadTodos&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Thus, it makes the call right at the end of <code>cy.visit</code> command. By the time <code>cy.intercept</code> runs, the call <em>is already in progress</em>, and thus not intercepted. Cypress shows XHR calls by default in its Command Log, thus it has nothing to do with our intercept. I always thought NOT showing when <code>cy.intercept</code> happens in the Command Log was a user experience failure.</p>
<h3><span id="the-solution">The solution</span></h3><p>Make sure the network intercept is registered before the application makes the call.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;is registered too late&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>In our case, we need to register the intercept before visiting the page. Once the page is loaded, the application fetches the todo items, and everything is working as expected.</p>
<p><img src="/blog/images/intercept-problems/before.png" alt="The intercept works correctly"></p>
<h3><span id="the-bonus-solution">The bonus solution</span></h3><p>You can <a target="_blank" rel="noopener" href="https://on.cypress.io/custom-commands">overwrite Cypress commands</a> and log a message to the Command Log. Unfortunately overwriting <code>cy.intercept</code> has a <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9580">bug with aliases #9580</a>, and thus we cannot always show when the intercept is registered. We can still do it case by case.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;is registered too late&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.log(<span class="string">&#x27;adding /todos intercept&#x27;</span>)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The above test clearly shows that the intercept is registered too late.</p>
<p><img src="/blog/images/intercept-problems/too-late.png" alt="The log message shows the intercept is registered AFTER the application makes the call"></p>
<p><strong>Update:</strong> the alias bug <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9580">#9580</a> has been fixed and released in Cypress v6.2.0</p>
<h2><span id="cywait-uses-the-intercept">cy.wait uses the intercept</span></h2><h3><span id="the-problem">The problem</span></h3><p>If you first wait on the intercept and then separately try to <code>cy.get</code> it to validate - well, the <code>cy.get</code> always resolves with <code>null</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;is taken by the wait&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;@todos&#x27;</span>).should(<span class="string">&#x27;not.be.null&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/get-null.png" alt="cy.get always yields null after cy.wait"></p>
<p>This is different behavior from <a target="_blank" rel="noopener" href="https://on.cypress.io/route">cy.route</a> where we could wait on the interception, and the get it separately.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;is taken by the wait (unlike cy.route)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.server()</span><br><span class="line">  cy.route(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;@todos&#x27;</span>).should(<span class="string">&#x27;not.be.null&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/route-get.png" alt="cy.wait plus cy.get works for cy.route"></p>
<h3><span id="the-workaround">The workaround</span></h3><p>Honestly, I feel this is a bug <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9306">#9306</a> that we should fix shortly. But for now you can validate the interception immediately using the value yielded by <code>cy.wait</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;should use wait value&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>).should(<span class="string">&#x27;include.all.keys&#x27;</span>, [<span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;response&#x27;</span>])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/wait-should.png" alt="You can validate the interception yielded by cy.wait"></p>
<p>If you want to use multiple assertions over the interception, use the <code>.should(cb)</code> or <code>.then(cb)</code> assertions. The <code>.then(cb)</code> makes more sense here, since the interception value would never change after completing.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;verifies the waited interception via .then(cb)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>).then(<span class="function"><span class="params">interception</span> =&gt;</span> &#123;</span><br><span class="line">    expect(interception).to.be.an(<span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">    expect(interception.request.url).to.match(<span class="regexp">/\/todos$/</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>Update:</strong> the bug <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9306">#9306</a> has been fixed and released in Cypress v6.2.0</p>
<h2><span id="cached-response">Cached response</span></h2><h3><span id="the-problem">The problem</span></h3><p>Let&#39;s inspect the interception object yielded by the <code>cy.wait</code> command.</p>
<p><img src="/blog/images/intercept-problems/cached-response.gif" alt="The interception does not the response because the server replied that the data was not modified"></p>
<p>We cannot validate the data sent by the server, because there is no data in the response. Instead the server tells the browser that the data loaded <em>previously</em> is still valid and has not been modified. Hmm, but we are not the browser - the <code>cy.intercept</code> runs in the proxy outside the browser. Thus we have nothing to test.</p>
<p>We can check the caching by using the following test:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;does not have response&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">    .its(<span class="string">&#x27;response&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;deep.include&#x27;</span>, &#123;</span><br><span class="line">      statusCode: <span class="number">304</span>,</span><br><span class="line">      statusMessage: <span class="string">&#x27;Not Modified&#x27;</span>,</span><br><span class="line">      body: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/pass.png" alt="The response is cached"></p>
<p>This is where it gets a little tricky - since this caching depends on the DevTools setting. If for example, you set the browser DevTools Network tab to disable caching you get the test that passes when the DevTools is closed, and fails when the DevTools is open.</p>
<p><img src="/blog/images/intercept-problems/caching.gif" alt="Caching makes the test pass or fail"></p>
<h3><span id="the-solution">The solution</span></h3><p>The server will always return the actual data if the server cannot determine what the client has already. The server determines the data &quot;cache key&quot; in this case by looking at the <code>if-none-match</code> request header sent by the web application.</p>
<p><img src="/blog/images/intercept-problems/headers.png" alt="The request headers sent by the client"></p>
<p>We need to delete this header on the outgoing request. Let&#39;s do it using our <code>cy.intercept</code>. Now we can extend the test to validate the response.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;always gets the new data&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">delete</span> req.headers[<span class="string">&#x27;if-none-match&#x27;</span>]</span><br><span class="line">  &#125;).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">    .its(<span class="string">&#x27;response&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;deep.include&#x27;</span>, &#123;</span><br><span class="line">      statusCode: <span class="number">200</span>,</span><br><span class="line">      statusMessage: <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .and(<span class="string">&#x27;have.property&#x27;</span>, <span class="string">&#x27;body&#x27;</span>) <span class="comment">// yields the &quot;response.body&quot;</span></span><br><span class="line">    .then(<span class="function"><span class="params">body</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// since we do not know the number of items</span></span><br><span class="line">      <span class="comment">// just check if it is an array</span></span><br><span class="line">      expect(body).to.be.an(<span class="string">&#x27;array&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/body.png" alt="The client always receives fresh copy of the server data"></p>
<h2><span id="multiple-matchers">Multiple matchers</span></h2><h3><span id="the-problem">The problem</span></h3><p>The command <code>cy.intercept</code> can match requests using a substring, a minimatch, or a regular expression. By default, it intercepts requests matching any HTTP method. Thus when you define several intercepts, it is easy to get into the situation when <em>multiple</em> intercepts apply. In that case the first <code>cy.wait(alias)</code> &quot;uses up&quot; the intercept&#39;s response.</p>
<p>Consider the following test that adds a new todo.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(resetDatabase)</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;enters 1 todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;Write a test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>We probably want to make sure the new todo sent to the server has the title &quot;Write a test&quot;. Let&#39;s set up an intercept and validate the sent data.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(resetDatabase)</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;enters 1 todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;todos&#x27;</span>).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;Write a test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>If we inspect the value yielded by <code>cy.wait(&#39;@post&#39;)</code> it shows the object sent in the request</p>
<p><img src="/blog/images/intercept-problems/post-todo.png" alt="The new item sent to the server"></p>
<p>Great, let&#39;s validate the new item. Since we do not control the random ID generation (of course we can control it, see the <a target="_blank" rel="noopener" href="https://github.com/cypress-io/testing-workshop-cypress">Cypress testing workshop</a> how), we can just validate the <code>title</code> and <code>completed</code> properties.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;enters 1 todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;todos&#x27;</span>).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;Write a test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line">    .its(<span class="string">&#x27;request.body&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;deep.include&#x27;</span>, &#123;</span><br><span class="line">      title: <span class="string">&#x27;Write a test&#x27;</span>,</span><br><span class="line">      completed: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/works.png" alt="Validating the item sent to the server"></p>
<p>Great, everything works, what&#39;s the problem?</p>
<p>Imagine someone else comes along and changes the <code>cy.visit</code> and adds a wait for todo items to load - just like we did before. They do this to guarantee the application has loaded before adding new items.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(resetDatabase)</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;enters 1 todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;Write a test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line">    .its(<span class="string">&#x27;request.body&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;deep.include&#x27;</span>, &#123;</span><br><span class="line">      title: <span class="string">&#x27;Write a test&#x27;</span>,</span><br><span class="line">      completed: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>So far so good. The test passes.</p>
<p><img src="/blog/images/intercept-problems/add-todo.gif" alt="Waiting on the todos and validating the sent item"></p>
<p>Notice a curious thing in the Command Log though - the XHR request to post the new item to the server has <code>todos(2)</code> badge.</p>
<p><img src="/blog/images/intercept-problems/badge.png" alt="The network request matches two intercepts"></p>
<p>The <code>POST /todos</code> network call the application has made matches two intercepts, but the Command Log only prints the <em>first</em> intercept&#39;s alias.</p>
<p>In our test both intercepts only <em>spied</em> on the request. Now someone comes along and asks why do we need to reset the database before each test using <code>resetDatabase</code> utility method. It would be so simple to <em>stub</em> the initial <code>GET /todos</code> call and return an empty list of items.</p>
<p>The changed test is below - it simply uses <code>cy.intercept(&#39;/todos&#39;, []).as(&#39;todos&#39;)</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/todos&#x27;</span>, []).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;enters 1 todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;Write a test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line">    .its(<span class="string">&#x27;request.body&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;deep.include&#x27;</span>, &#123;</span><br><span class="line">      title: <span class="string">&#x27;Write a test&#x27;</span>,</span><br><span class="line">      completed: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The test fails.</p>
<p><img src="/blog/images/intercept-problems/stub.png" alt="The test now fails"></p>
<h3><span id="the-root-cause">The root cause</span></h3><p>If there are multiple matching interceptors, the first intercept that <em>stubs</em> the request stops any further processing. Thus our <code>POST /todos</code> network request gets intercepted by overly broad first <code>* /todos</code> intercept.</p>
<h3><span id="the-solution">The solution</span></h3><p>Use specific intercepts and make sure the stubs are not &quot;breaking&quot; any listeners defined afterwards. Change the first intercept to only work with <code>GET /todos</code> call.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []).as(<span class="string">&#x27;todos&#x27;</span>) <span class="comment">// stub</span></span><br><span class="line">...</span><br><span class="line">cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>).as(<span class="string">&#x27;post&#x27;</span>) <span class="comment">// spy</span></span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/get-stub.png" alt="The test using specific intercepts works"></p>
<p>Update: I have opened issue <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9588">#9588</a> to provide better labels to the intercepted requests.</p>
<h2><span id="no-overwriting-interceptors">No overwriting interceptors</span></h2><p>Let&#39;s imagine the most common scenario - every test starts with zero items. We stab the <code>GET /todos</code> request and visit the site in a <code>beforeEach</code> hook.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []) <span class="comment">// start with zero todos</span></span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;adds a todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;completes todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>)</span><br><span class="line">    .should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    .first()</span><br><span class="line">    .find(<span class="string">&#x27;.toggle&#x27;</span>)</span><br><span class="line">    .click()</span><br><span class="line">  cy.contains(<span class="string">&#x27;.todo&#x27;</span>, <span class="string">&#x27;write test&#x27;</span>).should(<span class="string">&#x27;have.class&#x27;</span>, <span class="string">&#x27;completed&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/zero.png" alt="Several tests that start with zero items using network stub"></p>
<p>Now you want to confirm the application displays the initial list of todos correctly. Hmm, you would like to stub the initial <code>GET /todos</code> call in the new test:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []) <span class="comment">// start with zero todos</span></span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;adds a todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;completes todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;shows the initial todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// hmm overwrite the intercept?</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;two-items.json&#x27;</span> &#125;)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/no-overwrite.png" alt="Attempting to overwrite the intercept fails"></p>
<p>Unfortunately the test fails. The first intercept <code>cy.intercept(&#39;GET&#39;, &#39;/todos&#39;, [])</code> still executes, our the second intercept never has a chance.</p>
<p>We have a tracker issue <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress/issues/9302">#9302</a> to solve this problem somehow. It is complex - changing an intercept from stub to spy, or from spy to stub is tricky.</p>
<h3><span id="the-solution">The solution</span></h3><p>Separate the suites of tests to avoid using the <code>beforeEach</code> hook that sets up the unwanted intercept.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">&#x27;start with zero todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, [])</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;adds a todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;completes todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>)</span><br><span class="line">      .should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">      .first()</span><br><span class="line">      .find(<span class="string">&#x27;.toggle&#x27;</span>)</span><br><span class="line">      .click()</span><br><span class="line">    cy.contains(<span class="string">&#x27;.todo&#x27;</span>, <span class="string">&#x27;write test&#x27;</span>).should(<span class="string">&#x27;have.class&#x27;</span>, <span class="string">&#x27;completed&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">context(<span class="string">&#x27;start with two items&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  it(<span class="string">&#x27;shows the initial todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// hmm overwrite the intercept?</span></span><br><span class="line">    cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;two-items.json&#x27;</span> &#125;)</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>We have completely separated the suite of tests that should all start with zero items from the suite of tests that should start with two items. Now the intercepts never &quot;compete&quot;. After all - this is just JavaScript and you can compose the test commands and the hooks in any way you want.</p>
<p><img src="/blog/images/intercept-problems/separate.png" alt="Separate suites of tests to avoid competing intercepts"></p>
<h3><span id="avoid-cypress-commands-inside-the-interceptor">Avoid Cypress commands inside the interceptor</span></h3><p>You cannot use Cypress commands inside the interceptor callback, since it breaks the deterministic command chaining. The following test fails</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;tries to use cy.writeFile&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;POST /todo&#x27;</span>, req)</span><br><span class="line">    cy.writeFile(<span class="string">&#x27;posted.json&#x27;</span>, <span class="built_in">JSON</span>.stringify(req.body, <span class="literal">null</span>, <span class="number">2</span>))</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;an example&#123;enter&#125;&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/writefile.png" alt="Calling cy.writeFile inside the interceptor"></p>
<h3><span id="the-root-cause">The root cause</span></h3><p>The interceptor is triggered by the application&#39;s code, while other Cypress commands are already running. Cypress has no idea how to chain the <code>cy.writeFile</code> command - should it be after the currently running command? Or later? This leads to non-deterministic and unpredictable tests. Thus this is disallowed.</p>
<h3><span id="the-solution">The solution</span></h3><p>Instead save the body of the request in a variable, wait for the network call to happen, and then write the data to a file.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;saves it later&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> body</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;POST /todo&#x27;</span>, req)</span><br><span class="line">    body = req.body</span><br><span class="line">  &#125;).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>)</span><br><span class="line">    .type(<span class="string">&#x27;an example&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    .wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// this callback executes AFTER the &quot;cy.wait&quot; command above</span></span><br><span class="line">      <span class="comment">// thus by now the &quot;body&quot; variable has been set and we can</span></span><br><span class="line">      <span class="comment">// write the contents to the file</span></span><br><span class="line">      cy.writeFile(<span class="string">&#x27;posted.json&#x27;</span>, <span class="built_in">JSON</span>.stringify(body, <span class="literal">null</span>, <span class="number">2</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Watch the video below for details</p>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3uQpeyBlw3w" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</center>

<h2><span id="sending-different-responses">Sending different responses</span></h2><p>Imagine we stub the loading items from the server. Initially the server returns two items. Then the user adds another item (we stub the POST request too), and when the page reloads, we should receive three items. How would we return different responses for the same <code>GET /todos</code> call? At first we could try to overwrite the intercept</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;returns list with more items on page reload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// we start with 2 items in the list</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, twoItems)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now we add the third item</span></span><br><span class="line">  <span class="keyword">const</span> item = &#123;</span><br><span class="line">    title: <span class="string">&#x27;Third item&#x27;</span>,</span><br><span class="line">    completed: <span class="literal">false</span>,</span><br><span class="line">    id: <span class="number">101</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// the server replies with the posted item</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, item).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(item.title + <span class="string">&#x27;&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// when the page reloads we expect the server to send 3 items</span></span><br><span class="line">  <span class="keyword">const</span> threeItems = Cypress._.cloneDeep(twoItems).concat(item)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, threeItems)</span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>But of course this does not work - because as I have shown in the previous section, you cannot overwrite an intercept (yet).</p>
<p><img src="/blog/images/intercept-problems/reload.png" alt="The first intercept still returns the two items"></p>
<h3><span id="the-root-cause">The root cause</span></h3><p>The first interceptor responds to both <code>GET /todos</code> calls. The <code>cy.intercept(&#39;GET&#39;, &#39;/todos&#39;, threeItems)</code> intercept was never called, as I highlighted in the screenshot.</p>
<h3><span id="the-solution">The solution</span></h3><p>Use JavaScript code to return different responses from a single <code>GET /todos</code> intercept. For example, you can place all prepared responses into an array, and then use <code>Array.prototype.shift</code> to return and remove the first item.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;returns list with more items on page reload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> item = &#123;</span><br><span class="line">    title: <span class="string">&#x27;Third item&#x27;</span>,</span><br><span class="line">    completed: <span class="literal">false</span>,</span><br><span class="line">    id: <span class="number">101</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// we start with 2 items in the list</span></span><br><span class="line">  <span class="comment">// when the page reloads we expect the server to send 3 items</span></span><br><span class="line">  <span class="keyword">const</span> threeItems = Cypress._.cloneDeep(twoItems).concat(item)</span><br><span class="line">  <span class="keyword">const</span> replies = [twoItems, threeItems]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// return a different response from the same intercept</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, <span class="function"><span class="params">req</span> =&gt;</span> req.reply(replies.shift()))</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the server replies with the posted item</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, item).as(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(item.title + <span class="string">&#x27;&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@post&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/different-responses.png" alt="The same intercept returning different responses"></p>
<h2><span id="no-overwriting-interceptors-again">No overwriting interceptors (again)</span></h2><p>Let&#39;s get back to overwriting the interceptors again. We want to overwrite the <code>GET /todos</code> response from a particular test.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">&#x27;overwrite interceptors&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;adds a todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    ...</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;completes todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    ...</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DOES NOT WORK</span></span><br><span class="line">  it(<span class="string">&#x27;shows the initial todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// overwrite the previous response with the new one</span></span><br><span class="line">    cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;two-items.json&#x27;</span> &#125;)</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The last test &quot;shows the initial todos&quot; fails, because its intercept is never executed. See the previous section <a href="#no-overwriting-interceptors">No overwriting interceptors</a> for the details and a solution.</p>
<h3><span id="the-solution">The solution</span></h3><p>We cannot replace the intercept again, but we can extend the logic in setting the intercept to use JavaScript code to implement the overwrite. Let&#39;s create a new Cypress command <code>cy.http</code> that will stub the network call with a response, but that response will come from an object of intercepts. Any test that wants to return something else should just replace the value in that object.</p>
<p><strong>Tip:</strong> I will store the object with intercepts in <code>Cypress.config()</code> object and will reset it before every test.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function"><span class="keyword">function</span> <span class="title">resetIntercepts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  Cypress.config(<span class="string">&#x27;intercepts&#x27;</span>, &#123;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Cypress.Commands.add(<span class="string">&#x27;http&#x27;</span>, <span class="function">(<span class="params">alias, method, url, response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;alias&#125;</span>-<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;url&#125;</span>`</span></span><br><span class="line">  <span class="keyword">const</span> intercepts = Cypress.config(<span class="string">&#x27;intercepts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> intercepts) &#123;</span><br><span class="line">    intercepts[key] = response</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    intercepts[key] = response</span><br><span class="line">    cy.intercept(method, url, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> req.reply(intercepts[key])</span><br><span class="line">    &#125;).as(alias)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The main logic is inside the <code>cy.intercept</code> call</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cy.intercept(method, url, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> req.reply(intercepts[key])</span><br><span class="line">&#125;).as(alias)</span><br></pre></td></tr></table></figure>
<p>Notice the value is not hard-coded. Here is how we use <code>cy.http</code> from our tests</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">&#x27;overwrite interceptors&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> <span class="title">resetIntercepts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Cypress.config(<span class="string">&#x27;intercepts&#x27;</span>, &#123;&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  Cypress.Commands.add(<span class="string">&#x27;http&#x27;</span>, <span class="function">(<span class="params">alias, method, url, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;alias&#125;</span>-<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;url&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> intercepts = Cypress.config(<span class="string">&#x27;intercepts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key <span class="keyword">in</span> intercepts) &#123;</span><br><span class="line">      intercepts[key] = response</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      intercepts[key] = response</span><br><span class="line">      cy.intercept(method, url, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> req.reply(intercepts[key])</span><br><span class="line">      &#125;).as(alias)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.http(<span class="string">&#x27;todos&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, [])</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;adds a todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;completes todo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;write test&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>)</span><br><span class="line">      .should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">      .first()</span><br><span class="line">      .find(<span class="string">&#x27;.toggle&#x27;</span>)</span><br><span class="line">      .click()</span><br><span class="line">    cy.contains(<span class="string">&#x27;.todo&#x27;</span>, <span class="string">&#x27;write test&#x27;</span>).should(<span class="string">&#x27;have.class&#x27;</span>, <span class="string">&#x27;completed&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;shows the initial todos&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// overwrite the previous response with the new one</span></span><br><span class="line">    cy.http(<span class="string">&#x27;todos&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;two-items.json&#x27;</span> &#125;)</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The tests work</p>
<p><img src="/blog/images/intercept-problems/http.png" alt="Changing the response in the same intercept"></p>
<p>Notice we still have to call the <code>cy.http</code> before the <code>cy.visit</code>, thus <code>cy.visit</code> cannot be placed in the <code>beforeEach</code> hook. Still, overwriting is very convenient for tests that expect different responses, like adding an item.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;adds a todo to the initial ones&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// the application starts with two items</span></span><br><span class="line">  cy.http(<span class="string">&#x27;todos&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;two-items.json&#x27;</span> &#125;)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;third item&#123;enter&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now the server should return 3 items</span></span><br><span class="line">  cy.http(<span class="string">&#x27;todos&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, &#123; <span class="attr">fixture</span>: <span class="string">&#x27;three-items.json&#x27;</span> &#125;)</span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>Tip:</strong> add a log message to our <code>cy.http</code> command for better experience.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(<span class="string">&#x27;http&#x27;</span>, <span class="function">(<span class="params">alias, method, url, response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">`<span class="subst">$&#123;alias&#125;</span>-<span class="subst">$&#123;method&#125;</span>-<span class="subst">$&#123;url&#125;</span>`</span></span><br><span class="line">  cy.log(<span class="string">`HTTP <span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/http2.png" alt="Changing the response in the same intercept in the same test"></p>
<h2><span id="single-use-intercept">Single use intercept</span></h2><p>This is similar to overwriting interceptors. Imagine you want to stub a network call once, but then allow other calls to go through to the server. Just intercepting with a static response would not work, as that intercept would work forever.</p>
<p>Here is the test that does not work.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">context(<span class="string">&#x27;single use intercept&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// let&#x27;s reset the server to always have 2 todos</span></span><br><span class="line">    resetDatabaseTo(<span class="string">&#x27;two-items.json&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;stubs the first load (does not work)&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this test wants to have no todos at first</span></span><br><span class="line">    cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">    cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.todo-list li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    cy.log(<span class="string">&#x27;adding an item&#x27;</span>)</span><br><span class="line">    cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;new todo&#123;enter&#125;&#x27;</span>)</span><br><span class="line">    cy.contains(<span class="string">&#x27;li.todo&#x27;</span>, <span class="string">&#x27;new todo&#x27;</span>).should(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reload and expect to see the new todo again</span></span><br><span class="line">    cy.reload()</span><br><span class="line">    cy.contains(<span class="string">&#x27;li.todo&#x27;</span>, <span class="string">&#x27;new todo&#x27;</span>).should(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/single-use-intercept.gif" alt="The item disappears on reload"></p>
<p>Notice how the new item appears in the UI, we also see it being sent to the server using <code>POST /todos</code> call. Yet, the intercept &quot;todos&quot; again returns the empty list of todos on page reload.</p>
<h3><span id="the-solution">The solution</span></h3><p>We want to intercept only once. We do not need to even write a <a href="/blog/writing-custom-cypress-command/" title="custom command">custom command</a>, a simple function would do:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Intercept the first matching request and send the response object.</span></span><br><span class="line"><span class="comment">* Do nothing on the second and other requests.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>method HTTP method to intercept</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>url URL to intercept</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param <span class="type">&#123;any&#125;</span> </span>response Response to send back on the first request</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> interceptOnce = <span class="function">(<span class="params">method, url, response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// I am using &quot;count&quot; to show how easy you can implement</span></span><br><span class="line">  <span class="comment">// different responses for different interceptors</span></span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> cy.intercept(method, url, <span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      req.reply(response)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Let&#39;s see the test</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// let&#x27;s reset the server to always have 2 todos</span></span><br><span class="line">  resetDatabaseTo(<span class="string">&#x27;two-items.json&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;stubs the first load and does nothing after that&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// this test wants to have no todos at first</span></span><br><span class="line">  interceptOnce(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/todos&#x27;</span>, []).as(<span class="string">&#x27;todos&#x27;</span>)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.wait(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-list li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  cy.log(<span class="string">&#x27;adding an item&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;.new-todo&#x27;</span>).type(<span class="string">&#x27;new todo&#123;enter&#125;&#x27;</span>)</span><br><span class="line">  cy.contains(<span class="string">&#x27;li.todo&#x27;</span>, <span class="string">&#x27;new todo&#x27;</span>).should(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reload and expect to see the new todo again</span></span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.contains(<span class="string">&#x27;li.todo&#x27;</span>, <span class="string">&#x27;new todo&#x27;</span>).should(<span class="string">&#x27;be.visible&#x27;</span>)</span><br><span class="line">  <span class="comment">// since we reset the database with 2 todos, plus entered a new todo</span></span><br><span class="line">  <span class="comment">// thus the total number of items should be 3</span></span><br><span class="line">  cy.get(<span class="string">&#x27;.todo-list li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Nice! And since the intercept continues spying on the requests, even if it does not stub them, we can get the last call and confirm other details.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tip: you can still spy on &quot;todos&quot; intercept</span></span><br><span class="line"><span class="comment">// for example let&#x27;s validate the server response has the new item</span></span><br><span class="line"><span class="comment">// at index 2 and it has the title and completed properties</span></span><br><span class="line">cy.get(<span class="string">&#x27;@todos&#x27;</span>)</span><br><span class="line">  .its(<span class="string">&#x27;response.body&#x27;</span>)</span><br><span class="line">  .should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">  .its(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  .should(<span class="string">&#x27;include&#x27;</span>, &#123;</span><br><span class="line">    title: <span class="string">&#x27;new todo&#x27;</span>,</span><br><span class="line">    completed: <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/intercept-once.gif" alt="The intercept once in action"></p>
<h2><span id="get-number-of-times-an-intercept-was-matched">Get number of times an intercept was matched</span></h2><p>Sometimes you want to know / assert the number of times an intercept was matched. You can see this information in the &quot;Routes&quot; table in the Command Log, how can you confirm it from the test?</p>
<p><strong>Note:</strong> for now, using <code>cy.state(&#39;routes&#39;)</code> is an implementation detail, and might change in the future, but you could do the following:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getAliasCount = <span class="function">(<span class="params">alias</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// implementation details, use at your own risk</span></span><br><span class="line">  <span class="keyword">const</span> testRoutes = cy.state(<span class="string">&#x27;routes&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> aliasRoute = Cypress._.find(testRoutes, &#123; alias &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!aliasRoute) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Cypress._.keys(aliasRoute.requests || &#123;&#125;).length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;confirms the number of times an intercept was called&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/users?_limit=3&#x27;</span>).as(<span class="string">&#x27;users3&#x27;</span>)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;/users?_limit=5&#x27;</span>).as(<span class="string">&#x27;users5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">&#x27;#load-users&#x27;</span>).click().click()</span><br><span class="line">  cy.wait(<span class="string">&#x27;@users3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// to avoid clicking too quickly, add small pauses</span></span><br><span class="line">  cy.get(<span class="string">&#x27;#load-five-users&#x27;</span>).click()</span><br><span class="line">  .wait(<span class="number">20</span>).click()</span><br><span class="line">  .wait(<span class="number">20</span>).click()</span><br><span class="line">  .wait(<span class="number">20</span>).click()</span><br><span class="line"></span><br><span class="line">  cy.wait(<span class="string">&#x27;@users5&#x27;</span>)</span><br><span class="line">  .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> users3 = getAliasCount(<span class="string">&#x27;users3&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> users5 = getAliasCount(<span class="string">&#x27;users5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cy.wrap(&#123;</span><br><span class="line">      users3,</span><br><span class="line">      users5,</span><br><span class="line">    &#125;).should(<span class="string">&#x27;deep.equal&#x27;</span>, &#123;</span><br><span class="line">      users3: <span class="number">2</span>,</span><br><span class="line">      users5: <span class="number">4</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/intercept-problems/alias-count.png" alt="Asserting the number of times an intercept was used"></p>
<h2><span id="count-intercepts-again">Count intercepts (again)</span></h2><p>We can count the number of times the intercept was called</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;makes 3 calls&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;/favorite-fruits&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// we are not changing the request or response here</span></span><br><span class="line">    <span class="comment">// just counting the matched calls</span></span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">  cy.visit(<span class="string">&#x27;/fruits.html&#x27;</span>)</span><br><span class="line">  <span class="comment">// ensure the fruits are loaded</span></span><br><span class="line">  cy.get(<span class="string">&#x27;.favorite-fruits li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.get(<span class="string">&#x27;.favorite-fruits li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">  cy.reload()</span><br><span class="line">  cy.get(<span class="string">&#x27;.favorite-fruits li&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">5</span>)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// by now the count should have been updated</span></span><br><span class="line">      expect(count, <span class="string">&#x27;network calls to fetch fruits&#x27;</span>).to.equal(<span class="number">3</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>If you are stubbing the network calls, use <code>req.reply</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">cy.intercept(<span class="string">&#x27;/favorite-fruits&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">  count += <span class="number">1</span></span><br><span class="line">  req.reply(&#123; <span class="attr">fixture</span>: <span class="string">&#x27;fruits.json&#x27;</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>There is an alternative approach to getting the number of times a network intercept was invoked - by using <a target="_blank" rel="noopener" href="https://on.cypress.io/spy">cy.spy</a>. If we pass a created spy as route handler, it allows the network call to continue unchanged, yet we can get the count from that spy later</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// spy on the network calls</span></span><br><span class="line">cy.intercept(<span class="string">&#x27;...&#x27;</span>, cy.spy().as(<span class="string">&#x27;net&#x27;</span>))</span><br><span class="line"><span class="comment">// some time later</span></span><br><span class="line">cy.get(<span class="string">&#x27;@net&#x27;</span>).should(<span class="string">&#x27;have.been.calledOnce&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Here is an application that fetches a list of fruits every 30 seconds. We can use a synthetic clock to speed up the test, as described in <a target="_blank" rel="noopener" href="https://www.cypress.io/blog/2021/02/23/cy-intercept-and-cy-clock/">Testing periodic network requests with cy.intercept and cy.clock combination</a> blog post. We can count the number of times the spy was called.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;fetches every 30 seconds&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.clock()</span><br><span class="line">  <span class="comment">// create a cy.spy() that will be called</span></span><br><span class="line">  <span class="comment">// by the intercept. we later can use that spy</span></span><br><span class="line">  <span class="comment">// to check the number of times it was called</span></span><br><span class="line">  cy.intercept(<span class="string">&#x27;/favorite-fruits&#x27;</span>, cy.spy().as(<span class="string">&#x27;reqForFruits&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  cy.visit(<span class="string">&#x27;/fruits.html&#x27;</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;@reqForFruits&#x27;</span>).should(<span class="string">&#x27;have.been.calledOnce&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// application fetches fruits again 30 seconds later</span></span><br><span class="line">  cy.tick(<span class="number">30000</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;@reqForFruits&#x27;</span>).should(<span class="string">&#x27;have.been.calledTwice&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.tick(<span class="number">30000</span>)</span><br><span class="line">  cy.get(<span class="string">&#x27;@reqForFruits&#x27;</span>).should(<span class="string">&#x27;have.been.calledThrice&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.tick(<span class="number">30000</span>)</span><br><span class="line">  <span class="comment">// after that we should retrieve the call count property</span></span><br><span class="line">  cy.get(<span class="string">&#x27;@reqForFruits&#x27;</span>).its(<span class="string">&#x27;callCount&#x27;</span>).should(<span class="string">&#x27;equal&#x27;</span>, <span class="number">4</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The Command Log shows the result - there were 4 times the intercept was matched, and 4 times the spy was called.</p>
<p><img src="/blog/images/intercept-problems/four.png" alt="Counting intercepts using spies"></p>
<p>For stubbing, you can use the Sinon&#39;s <code>callsFake</code> method and invoke the <code>req.reply</code> from there</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cy.intercept(<span class="string">&#x27;/favorite-fruits&#x27;</span>,</span><br><span class="line">  cy.stub()</span><br><span class="line">    .callsFake(<span class="function"><span class="params">req</span> =&gt;</span> req.reply(&#123; <span class="attr">fixture</span>: <span class="string">&#x27;fruits.json&#x27;</span> &#125;))</span><br><span class="line">    .as(<span class="string">&#x27;stubFruits&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2><span id="set-an-alias-dynamically">Set an alias dynamically</span></h2><p>In case of GraphQL, all requests go through a single endpoint. Thus it is important for the intercept to inspect the request first, before deciding what to do. A convenient way to deal with such requests is to set the alias dynamically. For example, let&#39;s inspect all <code>GET /users</code> requests, and set an alias for the request that limits the number of users to 5:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;can set an alias depending on the request&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.intercept(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.url.endsWith(<span class="string">&#x27;/users?_limit=5&#x27;</span>)) &#123;</span><br><span class="line">      req.alias = <span class="string">&quot;load5&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">&#x27;#load-users&#x27;</span>).click()</span><br><span class="line">  cy.get(<span class="string">&#x27;#load-five-users&#x27;</span>).click()</span><br><span class="line">  cy.wait(<span class="string">&#x27;@load5&#x27;</span>) <span class="comment">// the second request created this alias dynamically</span></span><br><span class="line">    .its(<span class="string">&#x27;response.body&#x27;</span>).should(<span class="string">&#x27;have.length&#x27;</span>, <span class="number">5</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The test runs, and an alias is created. The test can wait on that alias:</p>
<p><img src="/blog/images/intercept-problems/dynamic-alias.png" alt="Waiting for dynamically created alias"></p>
<h2><span id="simulate-network-error">Simulate network error</span></h2><h3><span id="the-problem">The problem</span></h3><p>Imagine you are trying to check how your application handles a network communication error. Internet is unreliable, servers go down and come back up all the time. You want to make sure your web application does not blow up. You might try stubbing network request with <code>forceNetworkError: true</code> response.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;fails because the API is not ready&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  cy.visit(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  cy.intercept(&#123;</span><br><span class="line">    pathname: <span class="string">&#x27;/greeting&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    forceNetworkError: <span class="literal">true</span>,</span><br><span class="line">  &#125;).as(<span class="string">&#x27;greeting&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  cy.get(<span class="string">&#x27;#get-api-response&#x27;</span>).click()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Hmm, a curious thing happens - you see multiple intercept messages in the Command Log!</p>
<p><img src="/blog/images/intercept-problems/multiple.png" alt="Double intercept"></p>
<p>Sometimes you see the intercept matched twice, some times even three times - but it was supposed to be a single Ajax call!</p>
<h3><span id="the-root-cause">The root cause</span></h3><p>This is the browser trying to be robust and retrying a failed network request. The browser sees a network error coming back from the Cypress proxy and retries the same request 1-2 times before giving up.</p>
<h3><span id="the-solution">The solution</span></h3><p>I prefer replying with a specific HTTP network status code rather than <code>forceNetworkError: true</code> in most situations. Thus I test how the application handles 404 or 500 errors rather than a generic &quot;Server is not responding&quot; network error.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when the app tries to load items</span></span><br><span class="line"><span class="comment">// set it up to fail</span></span><br><span class="line">cy.intercept(</span><br><span class="line">  &#123;</span><br><span class="line">    method: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    pathname: <span class="string">&#x27;/todos&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    body: <span class="string">&#x27;test does not allow it&#x27;</span>,</span><br><span class="line">    statusCode: <span class="number">404</span>,</span><br><span class="line">    delayMs: <span class="number">2000</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>The browser will not retry such call, since technically the server has responded. It is up to the application to retry on 404 status code.</p>
<h2><span id="force404">force404</span></h2><h3><span id="the-problem">The problem</span></h3><p>The deprecated <code>cy.server</code> had an option to block all non-stubbed routes, returning 404 status code instead. How do we recreate the same behavior using <code>cy.intercept</code>? If we do <code>cy.intercept(&#39;*&#39;, &#123; statusCode: 404 &#125;)</code> we will break <em>all</em> network requests.</p>
<h2><span id="the-solution">The solution</span></h2><p>The original <code>cy.server</code> and <code>cy.route</code> only dealt with XMLHttpRequest objects, thus we could limit ourselves to recreating the same behavior of JSON Ajax requests. Assuming your application&#39;s code is well-behaved and sets the correct <code>accept</code> header, we can define the last stub to catch all Ajax calls.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define &quot;regular&quot; intercept stubs, make sure they respond</span></span><br><span class="line"><span class="comment">// now let&#x27;s stop all other Ajax application/json requests</span></span><br><span class="line">cy.intercept(&#123;</span><br><span class="line">  headers: &#123;</span><br><span class="line">    accept: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  statusCode: <span class="number">404</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// let&#x27;s try non-stubbed network call - it should fail</span></span><br><span class="line">cy.get(<span class="string">&#x27;#load-users&#x27;</span>).click()</span><br><span class="line">cy.contains(<span class="string">&#x27;#users&#x27;</span>, <span class="string">&#x27;Not Found&#x27;</span>).should(<span class="string">&#x27;be.visible&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>If you really need some calls to go through, write the route matching logic yourself</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// similar to the deprecated cy.server(&#123; force:404 &#125;)</span></span><br><span class="line"><span class="comment">// we want to stub all Ajax calls but GET /favorite-fruits</span></span><br><span class="line"><span class="comment">// now let&#x27;s stop all other Ajax application/json requests</span></span><br><span class="line">cy.intercept(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.method === <span class="string">&#x27;GET&#x27;</span> &amp;&amp; req.url.endsWith(<span class="string">&#x27;/favorite-fruits&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">// let the request go to the server</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (req.headers.accept === <span class="string">&#x27;application/json&#x27;</span>) &#123;</span><br><span class="line">    req.reply(&#123;</span><br><span class="line">      statusCode: <span class="number">404</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>With the full access to the request inside the route matcher function you can decide how to proceed.</p>
<h2><span id="more-info">More info</span></h2><ul>
<li>blog post <a target="_blank" rel="noopener" href="https://filiphric.com/migrating-route-to-intercept-in-cypress">Migrating .route() to .intercept() in Cypress</a></li>
<li>blog post <a href="/blog/cy-route-vs-route2/" title="Difference between cy.route and cy.route2">Difference between cy.route and cy.route2</a></li>
<li><strong>Highly recommended:</strong> the <a target="_blank" rel="noopener" href="https://github.com/cypress-io/cypress-example-recipes#stubbing-and-spying"><code>cy.intercept</code> recipe</a> has a lot of examples<ul>
<li>spying on requests</li>
<li>stubbing any request</li>
<li>changing the response from the server</li>
<li>intercepting static resources like HTML and CSS</li>
<li>redirecting requests</li>
<li>replying with different responses</li>
</ul>
</li>
<li>blog post <a href="/blog/smart-graphql-stubbing/" title="Smart GraphQL Stubbing in Cypress">Smart GraphQL Stubbing in Cypress</a></li>
<li><a target="_blank" rel="noopener" href="https://on.cypress.io/intercept"><code>cy.intercept</code> documentation page</a></li>
<li>The blog post <a target="_blank" rel="noopener" href="https://blog.dai.codes/cypress-loading-state-tests/">Testing loading spinner states with Cypress</a> shows another way to control the network to assert the loading element.</li>
<li>see how to implement &quot;wait for network idle&quot; in <a href="/blog/cypress-tips-and-tricks/" title="Cypress Tips and Tricks">Cypress Tips and Tricks</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
  see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
  watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
  browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/cypress-intercept-problems/" data-id="ckq85dshs01w2s8vg8mf78d69" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/cypress-intercept-problems/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/cypress/" rel="tag">cypress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/" rel="tag">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../split-spec/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Make Cypress Run Faster by Splitting Specs
        
      </div>
    </a>
  
  
    <a href="../cypress-timings/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Cypress Timings</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">147</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">392</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">109</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">118</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">68</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">165</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">123</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15.2px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16px;">ci</a> <a href="../tags/circle/" style="font-size: 12px;">circle</a> <a href="../tags/climate/" style="font-size: 14.8px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 13.6px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 19.2px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 14px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.4px;">db</a> <a href="../tags/docker/" style="font-size: 14.4px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.8px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 15.2px;">git</a> <a href="../tags/github/" style="font-size: 14.8px;">github</a> <a href="../tags/graphql/" style="font-size: 11.2px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 10.8px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 20px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 14px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.8px;">modular development</a> <a href="../tags/netlify/" style="font-size: 10.8px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16.4px;">performance</a> <a href="../tags/presentation/" style="font-size: 12px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 10px;">ramda</a> <a href="../tags/react/" style="font-size: 11.6px;">react</a> <a href="../tags/react-native/" style="font-size: 10.8px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.4px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 14px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.6px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.6px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 12.4px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../testing-rn-todo-app/">Testing React Native Todo Application Using Cypress</a>
          </li>
        
          <li>
            <a href="../stubbing-the-non-configurable/">Stubbing The Non-configurable</a>
          </li>
        
          <li>
            <a href="../testing-react-native-app-using-cypress/">The Complete Guide to Testing React Native App Using Cypress</a>
          </li>
        
          <li>
            <a href="../run-two-cypress-runners/">Run Two Cypress Test Runners At The Same Time</a>
          </li>
        
          <li>
            <a href="../cypress-vs-other-test-runners/">Cypress vs Other Test Runners</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/cypress-intercept-problems/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
