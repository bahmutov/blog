<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>How To Draw An Owl | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="IntroI like simple code. I consider functional code simpler than OO code. Yet, I am not an advanced practitioner of functional programming; and I easily get lost when people throw words like &quot;com">
<meta property="og:type" content="article">
<meta property="og:title" content="How To Draw An Owl">
<meta property="og:url" content="https://glebbahmutov.com/blog/how-to-draw-an-owl/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="IntroI like simple code. I consider functional code simpler than OO code. Yet, I am not an advanced practitioner of functional programming; and I easily get lost when people throw words like &quot;com">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/how-to-draw-fp-owl/how-to-draw-an-owl.jpg">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/how-to-draw-fp-owl/how-to-really-draw-an-owl.jpg">
<meta property="article:published_time" content="2017-06-05T04:00:00.000Z">
<meta property="article:modified_time" content="2021-12-01T15:22:29.629Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="functional">
<meta property="article:tag" content="ramda">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/how-to-draw-fp-owl/how-to-draw-an-owl.jpg">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-how-to-draw-an-owl" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2017-06-05T04:00:00.000Z" itemprop="datePublished">Jun 5 2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/process/">process</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      How To Draw An Owl
    </h1>

    <h2 class="article-title" itemprop="name">
      Refactor code using functional approach (Maybe, immutable).
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2><span id="intro">Intro</span></h2><p>I like simple code. I consider functional code simpler than OO code. Yet, I
am not an advanced practitioner of functional programming; and I easily get
lost when people throw words like &quot;comonads&quot; around. After writing
[a lot of blog posts][../tags/functional/]
about functional way of writing JavaScript, I only scratch a surface of
<em>actually using</em> the full power of FP in JS.</p>
<p>In fact, using a little bit of functional programming in JavaScript is super
easy - just take advantage of built-in Array callbacks! Yet mastering an
advanced topic like combining several Monad types together is much much harder.
See if you can read <a target="_blank" rel="noopener" href="https://medium.com/@drboolean/free-er-monads-in-js-f5a59e7abc82">this explanation</a> of Freer Monad and be ready to use
it in your code!</p>
<p>A lot of FP explanations seems to start with basics and then immediately
switch to controlling side effects via Abstract Data Types (like Functor,
Monad). Meanwhile I am sitting there reading about it and feeling like I am
learning to draw an owl:</p>
<p><img src="/blog/images/how-to-draw-fp-owl/how-to-draw-an-owl.jpg" alt="How to draw an owl: simplified version"></p>
<p>In this blog post I will try to refactor a piece of my code applying
the following functional principles:</p>
<ul>
<li>pure functions</li>
<li>object lenses</li>
<li>immutable data structure</li>
<li>Maybe monad</li>
</ul>
<p>and I will also do it slowly, explaining each code transformation. Hopefully,
I will better understand the FP myself, and fill in the details on how to
draw an owl.</p>
<p><img src="/blog/images/how-to-draw-fp-owl/how-to-really-draw-an-owl.jpg" alt="How to really draw an owl"></p>
<h2><span id="initial-code">Initial code</span></h2><p>As an example, I will use a little utility I wrote some time ago called
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/rocha">Rocha</a> - it is a wrapper around super
popular unit testing framework <a target="_blank" rel="noopener" href="https://mochajs.org/">Mocha</a> that
randomizes the order of unit tests before running them. This comes in handy
when flashing dependencies between tests. If the tests pass - great, and next
time they will run in new order. But if the tests fail, the running order is
saved as a JSON file, and the next test run will try the
<em>same failing test order</em>. Thus you can work on finding and fixing the
test dependencies, making them truly independent.</p>
<p>The code fragment we are going to look at is the shuffling code. Each Mocha
test file can have blocks of tests called <code>suites</code>. The <code>suites</code> can be nested,
and each <code>suite</code> can have additional tests. The <code>suite</code> is defined by
<code>describe</code> function and each test by <code>it</code> function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typical spec file</span></span><br><span class="line">it(<span class="string">&#x27;has a test&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">describe(<span class="string">&#x27;a suite&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  it(<span class="string">&#x27;a test inside a suite&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">  it(<span class="string">&#x27;second&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">  it(<span class="string">&#x27;third&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">  describe(<span class="string">&#x27;nested suite&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    it(<span class="string">&#x27;has another test&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  describe(<span class="string">&#x27;second nested suite&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    it(<span class="string">&#x27;yet another test&#x27;</span>, <span class="function">() =&gt;</span> &#123;...&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Our Rocha wrapper looks at the previous run results, and if there is no
previously saved failing test run order, shuffles the top level <code>suite</code> object.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mocha.suite.beforeAll(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> cachedOrder = cache.load()</span><br><span class="line">  <span class="keyword">if</span> (cachedOrder) &#123;</span><br><span class="line">    log(<span class="string">&#x27;reordering specs like last time&#x27;</span>)</span><br><span class="line">    order.set(mocha.suite, cachedOrder)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    order.shuffle(mocha.suite)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The initial implementation of <code>order.shuffle</code> is in
function <code>shuffleDescribes</code> that you can see <a target="_blank" rel="noopener" href="https://github.com/bahmutov/rocha/blob/233e99d20aaa70324085913f081ee42cd9a56ae3/src/order-of-tests.js#L6">here</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (suite.suites &amp;&amp; suite.suites.length) &#123;</span><br><span class="line">    log(<span class="string">&#x27;shuffling %d describe blocks in &quot;%s&quot;&#x27;</span>,</span><br><span class="line">      suite.suites.length, suite.title)</span><br><span class="line">    suite.suites = _.shuffle(suite.suites)</span><br><span class="line">    shuffleTests(suite)</span><br><span class="line">    suite.suites.forEach(shuffleDescribes)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before we refactor, we must write unit tests. I quickly wrote a few sanity
checks using <a target="_blank" rel="noopener" href="https://github.com/bahmutov/snap-shot">snap-shot</a> utility
to add snapshot testing to Mocha framework. For sanity, I added returning
the <code>suite</code> reference from <code>shuffleDescribes</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> suite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>the unit tests are very simple. I am using <code>la</code> assertion function from
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/lazy-ass">lazy-ass</a> - which just checks predicate
and throws an exception formed from all arguments passed to it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> la = <span class="built_in">require</span>(<span class="string">&#x27;lazy-ass&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> is = <span class="built_in">require</span>(<span class="string">&#x27;check-more-types&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>)</span><br><span class="line">describe.only(<span class="string">&#x27;shuffle&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  it(<span class="string">&#x27;is a function&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    la(is.fn(shuffle), shuffle)</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;does not shuffle undefined&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    la(_.isUndefined(shuffle()))</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;does not shuffle empty&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    la(snapshot(shuffle(&#123;&#125;)))</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;does not shuffle empty suites&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = &#123;</span><br><span class="line">      suites: []</span><br><span class="line">    &#125;</span><br><span class="line">    la(snapshot(shuffle(s)))</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;returns shuffled suites&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = &#123;</span><br><span class="line">      suites: R.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> shuffled = shuffle(s)</span><br><span class="line">    la(!_.isEqual(shuffled.suites, s.suites),</span><br><span class="line">      <span class="string">&#x27;shuffled suites are the same&#x27;</span>, shuffled.suites)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Note in the last test we are getting shuffled test, but because we are mutating
the <code>s.suites</code> array directly, our initial object <code>s</code> does NOT hold the original
list of items from 1 to 100.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = &#123;</span><br><span class="line">  suites: R.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> shuffled = shuffle(s)</span><br><span class="line">la(_.isEqual(shuffled.suites, s.suites),</span><br><span class="line">  <span class="string">&#x27;shuffled suites are the same&#x27;</span>, shuffled.suites)</span><br></pre></td></tr></table></figure>
<p>This is the major downside to mutable data - the original reference all of the
sudden has changed data; this is very unexpected and hurts our test! We will
take care of this later, but for now we are going to add an explicit check
to compare object reference returned from the transformation - for now the
returned object is going to be the same as the input one.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = &#123;</span><br><span class="line">  suites: R.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> shuffled = shuffle(s)</span><br><span class="line">la(shuffled === s, <span class="string">&#x27;returns same reference&#x27;</span>)</span><br><span class="line">la(_.isEqual(shuffled.suites, s.suites),</span><br><span class="line">  <span class="string">&#x27;shuffled suites are the same&#x27;</span>, shuffled.suites)</span><br></pre></td></tr></table></figure>
<h2><span id="comment-the-code">Comment the code</span></h2><p>Two quick notes on refactoring: we need to have unit tests, and we need to
understand what is going on (to the best of our abilities) before changing
any code. To better understand, I usually write a few comments to see if
I understand the coded algorithm. Isn&#39;t this what we do every day: read and
understand what the code does (and then change it to <em>really</em> do what it
claims to do?)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// if the `suite` has nested suites</span></span><br><span class="line">  <span class="keyword">if</span> (suite.suites &amp;&amp; suite.suites.length) &#123;</span><br><span class="line">    <span class="comment">// side-effect: print log message</span></span><br><span class="line">    log(<span class="string">&#x27;shuffling %d describe blocks in &quot;%s&quot;&#x27;</span>,</span><br><span class="line">      suite.suites.length, suite.title)</span><br><span class="line">    <span class="comment">// shuffle sub-suites</span></span><br><span class="line">    suite.suites = _.shuffle(suite.suites)</span><br><span class="line">    <span class="comment">// shuffle tests inside this suite</span></span><br><span class="line">    shuffleTests(suite)</span><br><span class="line">    <span class="comment">// recursive call: shuffle each suite inside</span></span><br><span class="line">    suite.suites.forEach(shuffleDescribes)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that we already found a problem. A suite can have just tests, and no
nested suites; but our <code>shuffleDescribes</code> only calls <code>shuffleTests(suite)</code>
if there are nested suites! This is a common occurrence; reading the code
and trying to document each step finds flaws in the coded logic.</p>
<p>Before we begin refactoring, I must say that I usually have both
Lodash docs <a target="_blank" rel="noopener" href="https://lodash.com/docs/">https://lodash.com/docs/</a> and
Ramda docs <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/">http://ramdajs.com/docs/</a> open in my
browser as I program day to day. We are going to use a lot of little
functions from these libraries. Whenever I need a function that operates on
a collection for example, I look through each set of docs;
they both have split all available functions into categories:
<code>Function</code>, <code>Logic</code>, <code>List</code>, <code>Objects</code>, etc, making the search easy.</p>
<h2><span id="refactoring-the-condition">Refactoring the condition</span></h2><p>Let us start with the guard condition at the start of the function
<code>shuffleDescribes</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (suite.suites &amp;&amp; suite.suites.length) &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The condition checks if the object <code>suite</code> has a <code>suites</code> property, and if
the value is non-empty. Yet, the check is not very robust. For example, it
assumes that the argument <code>suite</code> is a valid object. It also does not
check if the <code>suite.suites</code> is an Array - only that its length property is
truthy; this allows <code>suite.suites</code> to be a string, invoking recursive shuffle!</p>
<p>The condition is just <code>AND</code> of several predicates. I have shown how to refactor
this case in <a href="../simplify-filtering-conditions/">this blog post</a>. We just
need to clearly express each check and then use
<a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#allPass">R.allPass</a> to combine them.</p>
<p><strong>step 1</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> R = <span class="built_in">require</span>(<span class="string">&#x27;ramda&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> positive = R.lt(<span class="number">0</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isValidSuite</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p1 = R.is(<span class="built_in">Object</span>)</span><br><span class="line">  <span class="keyword">const</span> p2 = R.has(<span class="string">&#x27;suites&#x27;</span>),</span><br><span class="line">  <span class="keyword">const</span> p3 = R.pathSatisfies(positive, [<span class="string">&#x27;suites&#x27;</span>, <span class="string">&#x27;length&#x27;</span>])</span><br><span class="line">  <span class="keyword">return</span> p1(suite) &amp;&amp; p2(suite) &amp;&amp; p3(suite)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isValidSuite(suite)) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> suite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The last predicate <code>p3</code> is unusual - it makes use of
<a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#pathSatisfies">Ramda.pathSatisfies</a> function that can check if a value in an
object at the path satisfies a given predicate function,
in this case the predicate itself
is a function we derive using <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#lt">Ramda.lt</a> function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> positive = R.lt(<span class="number">0</span>)</span><br><span class="line">positive(<span class="number">0</span>)   <span class="comment">// false</span></span><br><span class="line">positive(<span class="number">100</span>) <span class="comment">// true</span></span><br><span class="line"><span class="keyword">const</span> p3 = R.pathSatisfies(positive, [<span class="string">&#x27;suites&#x27;</span>, <span class="string">&#x27;length&#x27;</span>])</span><br><span class="line">p3(&#123;<span class="attr">suites</span>: []&#125;)        <span class="comment">// false</span></span><br><span class="line">p3(&#123;<span class="attr">suites</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p><strong>step 2</strong></p>
<p>Let us replace <code>p1(suite) &amp;&amp; p2(suite) &amp;&amp; p3(suite)</code> with a single call - and
we can do this because all predicate functions are unary and applied to the
same object <code>suite</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> R = <span class="built_in">require</span>(<span class="string">&#x27;ramda&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> positive = R.lt(<span class="number">0</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isValidSuite</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p1 = R.is(<span class="built_in">Object</span>)</span><br><span class="line">  <span class="keyword">const</span> p2 = R.has(<span class="string">&#x27;suites&#x27;</span>),</span><br><span class="line">  <span class="keyword">const</span> p3 = R.pathSatisfies(positive, [<span class="string">&#x27;suites&#x27;</span>, <span class="string">&#x27;length&#x27;</span>])</span><br><span class="line">  <span class="keyword">const</span> isValid = R.allPass([p1, p2, p3])</span><br><span class="line">  <span class="keyword">return</span> isValid(suite)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now the trick to get rid of the extra function. Notice that our predicates
<code>p1</code>, <code>p2</code> and <code>p3</code> no longer use the argument <code>suite</code>. Even
<a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#allPass">allPass</a> does not need it right away - it is curried after all.
Thus the function <code>isValid</code> and <code>isValidSuite</code> is really the same function
and we can &quot;collapse&quot; the condition into a single call</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> positive = R.lt(<span class="number">0</span>)</span><br><span class="line"><span class="comment">// isValidSuite :: suite -&gt; bool (depending on the suites object)</span></span><br><span class="line"><span class="keyword">const</span> isValidSuite = R.allPass([</span><br><span class="line">  R.is(<span class="built_in">Object</span>),</span><br><span class="line">  R.has(<span class="string">&#x27;suites&#x27;</span>),</span><br><span class="line">  R.pathSatisfies(positive, [<span class="string">&#x27;suites&#x27;</span>, <span class="string">&#x27;length&#x27;</span>])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>The rest of the code stays unchanged. Function <code>isValidSuite</code> is waiting
(patiently) for an object <code>suite</code> to inspect.</p>
<h2><span id="refactoring-imperative-code">Refactoring imperative code</span></h2><p>Now that we have a clean self-explaining and robust condition function,
let us see how to write better code in its <code>if/else</code> branches. Our current
code required comments in order to be clear (otherwise a logical error we just
found would be tough to hide). One good way to avoid using comments, is to
split the code in small functions. Each function should be so small
that it should have a single purpose and good descriptive name.
Then the code would not require a lot of comments, because
function names would explain what is happening step by step.</p>
<p>We have 3 new candidate functions to write looking at the code. Just look at
each line with a comment!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isValidSuite(suite)) &#123;</span><br><span class="line">    <span class="comment">// side-effect: print log message</span></span><br><span class="line">    log(<span class="string">&#x27;shuffling %d describe blocks in &quot;%s&quot;&#x27;</span>,</span><br><span class="line">      suite.suites.length, suite.title)</span><br><span class="line">    <span class="comment">// shuffle sub-suites</span></span><br><span class="line">    suite.suites = _.shuffle(suite.suites)</span><br><span class="line">    shuffleTests(suite)</span><br><span class="line">    <span class="comment">// recursive call: shuffle each suite inside</span></span><br><span class="line">    suite.suites.forEach(shuffleDescribes)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> suite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Functio <code>shuffleTests</code> already exists, so we only need new functions to
log debug message, shuffle suites order and recursively shuffle each suite.
Moving each line into its own function makes the code self-documenting</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logShuffle = <span class="function">(<span class="params">s</span>) =&gt;</span></span><br><span class="line">  log(<span class="string">&#x27;shuffling %d describe blocks in &quot;%s&quot;&#x27;</span>,</span><br><span class="line">    s.suites.length, s.title)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> shuffleSuites = <span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">  s.suites = _.shuffle(s.suites)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleNestedSuites</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s.suites.forEach(shuffleDescribes)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isValidSuite(suite)) &#123;</span><br><span class="line">    logShuffle(suite)</span><br><span class="line">    suite = shuffleSuites(suite)</span><br><span class="line">    suite = shuffleTests(suite)</span><br><span class="line">    suite = shuffleNestedSuites(suite)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> suite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Great; each function has a single purpose and is simple to read and understand.
Every function (except for logging one) is closer to being <em>pure</em>. The
functions still mutate the input object, but at least they do not access
outside variables, except for <code>logShuffle</code>.</p>
<h2><span id="use-object-lens-to-modified-properties">Use object lens to modified properties</span></h2><p>Look at the function that shuffles <code>s.suites</code> array. It operates on the parent
object <code>s</code> (which is our <code>suite</code>), reaches in, grabs the value of the property
<code>s.suites</code>, modifies it and then sets it back.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shuffleSuites = <span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">  s.suites = _.shuffle(s.suites)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Is there a functional way to read a property, run a function to modified it
(in this case by calling <code>_.shuffle</code>) and then write the value back into the
object? There is and it is called <em>lenses</em> - and Ramda includes functions
to do so. Watch this Egghead lesson
<a target="_blank" rel="noopener" href="https://egghead.io/lessons/javascript-change-object-properties-with-ramda-lenses">https://egghead.io/lessons/javascript-change-object-properties-with-ramda-lenses</a>
to get a taste of them. In our case, we are reading and writing the same
property, which has a Ramda shortcut called <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#lensProp">R.lensProp</a> - it is a
<em>lens focused on an object&#39;s property</em>. We can create a lens and then
specify a function to transform the value and then write it back - using
<a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#over">R.over</a> function.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> suitesLens = R.lensProp(<span class="string">&#x27;suites&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> shuffleSuites = R.over(suitesLens, _.shuffle)</span><br><span class="line"><span class="comment">// call shuffleSuites just like before</span></span><br><span class="line"><span class="comment">// suite = shuffleSuites(suite)</span></span><br></pre></td></tr></table></figure>
<p>Hmm, on of our unit tests fails!</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shuffle returns shuffled suites:</span><br><span class="line">  Error: returns same reference</span><br></pre></td></tr></table></figure>
<p>Turns out Ramda lenses, <em>clone</em> the given object when setting the property.
It plays right into our hands and gives us data immutability at this particular
step.</p>
<p>We can update our tests and move on.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">&#x27;returns different object&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> s = &#123;</span><br><span class="line">    suites: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> shuffled = shuffle(s)</span><br><span class="line">  la(shuffled !== s, <span class="string">&#x27;returns new object&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;returns shuffled suites&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> s = &#123;</span><br><span class="line">    suites: R.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> shuffled = shuffle(s)</span><br><span class="line">  la(!_.isEqual(shuffled.suites, s.suites),</span><br><span class="line">    <span class="string">&#x27;shuffled suites are the same&#x27;</span>,</span><br><span class="line">    shuffled.suites, <span class="string">&#x27;initial&#x27;</span>, s.suites)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>But there are other places were we can use lenses. For example shuffling
each child suite. Our current code does this in &quot;side-effecty&quot; way using
<code>Array.forEach</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleNestedSuites</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s.suites.forEach(shuffleDescribes)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can first refactor this code to be pure and use <code>Array.map</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleNestedSuites</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s.suites = s.suites.map(shuffleDescribes)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>s.suites = s.suites.map(...)</code> looks almost like a property lens, yet instead of
a transformation function the code calls a method on the array. Not going to
work. Luckily, Ramda provides the <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#map">map</a> function we can use instead, passing
the array.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use Ramda.map</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleNestedSuites</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s.suites = R.map(shuffleDescribes, s.suites)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// use Ramda.map partially applied for clarity</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleNestedSuites</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s.suites = R.map(shuffleDescribes)(s.suites)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above code can now be rewritten using a lens - and we can even reuse the
same property lens, because we are operating on the property name <code>suites</code>!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> suitesLens = R.lensProp(<span class="string">&#x27;suites&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> shuffleSuites = R.over(suitesLens, _.shuffle)</span><br><span class="line"><span class="keyword">const</span> shuffleNestedSuites = R.over(suitesLens, R.map(shuffleDescribes))</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> sometimes I use <code>R.</code> prefix in my code to make clear that <code>lensProp</code>
is coming from Ramda library. Usually I prefer destructuring assignment to
import only the desired properties from the library to make code more readable.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;lensProp, over, map&#125; = <span class="built_in">require</span>(<span class="string">&#x27;ramda&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> suitesLens = lensProp(<span class="string">&#x27;suites&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> shuffleSuites = over(suitesLens, _.shuffle)</span><br><span class="line"><span class="keyword">const</span> shuffleNestedSuites = over(suitesLens, map(shuffleDescribes))</span><br></pre></td></tr></table></figure>
<p>Beautiful, lenses can really focus on object&#39;s properties.
Sigh, it is a bad pun.</p>
<h2><span id="maybe">Maybe</span></h2><p>The last refactoring I am going to use is to replace the imperative <code>if/else</code>
statement with a <a href="../call-me-maybe/">Maybe monad</a>. Our code currently evaluates
a condition and then proceeds to call series of functions, passing an argument.
The code also receives the result from each function and passes it to the next
one - <strong>super ugly</strong>!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isValidSuite(suite)) &#123;</span><br><span class="line">    logShuffle(suite)</span><br><span class="line">    suite = shuffleSuites(suite)</span><br><span class="line">    suite = shuffleTests(suite)</span><br><span class="line">    suite = shuffleNestedSuites(suite)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> suite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What we are describing is a computation that starts with a value. Then, if
the value passes the condition <code>isValidSuite</code> it <em>transforms</em> this
value through several transformation functions. If the value does not pass
<code>isValidSuite</code> condition, all these transformations are skipped.
We do not have to reinvent
the wheel and code it ourselves - this pattern has been implemented before
(many times). Here is how it would look in principle.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">  wrap(suite)  <span class="comment">// &lt;-- predicate goes here</span></span><br><span class="line">    .map(logShuffle)    <span class="comment">// ok, just believe me</span></span><br><span class="line">    .map(shuffleSuites) <span class="comment">// puts shuffleSuites(s) result back</span></span><br><span class="line">    .map(shuffleTests)  <span class="comment">// into the &quot;wrapper object&quot;</span></span><br><span class="line">    .map(shuffleNestedSuites)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ramda itself does not implement this wrapper type, but a companion library
<a target="_blank" rel="noopener" href="https://github.com/ramda/ramda-fantasy">ramda-fantasy</a> does. In case we are going to use the
<a target="_blank" rel="noopener" href="https://github.com/ramda/ramda-fantasy/blob/master/docs/Maybe.md">Maybe</a> type which represents a value that might or might not be there.</p>
<p><strong>step 1</strong></p>
<p>How do we create a <code>Maybe</code>? We don&#39;t. We create one of the subtypes - if the
value is invalid / does not exist we will create <code>Maybe.Nothing</code>, and if the
value is valid we are going to create <code>Maybe.Just(x)</code> passing actual value
as <code>x</code> argument. Here is our condition code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;Just, Nothing&#125; = <span class="built_in">require</span>(<span class="string">&#x27;ramda-fantasy&#x27;</span>).Maybe</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">maybeSuites</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isValidSuite(suite) ? Just(suite) : Nothing()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> maybeSuites(suite)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// we need the actual value?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>See how we stick <code>suites</code> value into <code>Maybe</code>? Now we can map over it, passing
our transform functions. But first, we need to decide what to do <em>at the end</em>.
Function <code>shuffleDescribes</code> does not return the <code>Maybe[suites]</code> - it returns
just <code>suites</code> reference. Thus we need to extract the value before returning it.
At the end the value <code>Maybe[suites]</code> could be <code>Just[something]</code> or <code>Nothing()</code>.
We must handle both cases. Ramda-fantasy supplies a good method
<a target="_blank" rel="noopener" href="https://github.com/ramda/ramda-fantasy/blob/master/docs/Maybe.md#maybegetorelse">maybe.getOrElse</a> to extract
the value <code>something</code> from the <code>Just[something]</code> case, or a default if the
value is <code>Nothing()</code>. In our case, the <code>else</code> branch of the imperative code
just returned the <code>suites</code> argument - and we can do the same.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> maybeSuites(suite)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  .getOrElse(suite)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Perfect, we are conforming to the function&#39;s API. We are constructing
a <code>Maybe[suites]</code> value and we are getting value back before returning from the
function <code>shuffleDescribes</code>.</p>
<p><strong>step 2</strong></p>
<p>We are shuffling suites inside the top level suite. Before we were just
calling a function and mutated the variable <code>suites</code>. When we use a
<code>Maybe</code> it has a method <code>.map</code> just like a JavaScript array has; supply a
transform function and the <code>Maybe</code> will receive and store updated value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  suite = shuffleSuites(suite)</span></span><br><span class="line"><span class="comment">  suite = shuffleTests(suite)</span></span><br><span class="line"><span class="comment">  suite = shuffleNestedSuites(suite)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// after switching to Maybe</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> maybeSuites(suite)</span><br><span class="line">    .map(shuffleSuites)</span><br><span class="line">    .map(shuffleTests)</span><br><span class="line">    .map(shuffleNestedSuites)</span><br><span class="line">    .getOrElse(suite)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nice, the imperative logic &quot;call function F and store result;
call function G and store result ...&quot; has been replaced with
<code>.map(F).map(G)...</code> fluent interface. But we have one function that does NOT
return <code>suites</code> - the log function. It returns nothing (which is a red flag
that the function is not pure). We cannot put <code>logShuffle</code> into our <code>Maybe</code>
chain as a callback because it will overwrite <code>suites</code> value with <code>undefined</code>.
We could modify <code>logShuffle</code> to return the argument it receives:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logShuffle = <span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">  log(<span class="string">&#x27;shuffling %d describe blocks in &quot;%s&quot;&#x27;</span>,</span><br><span class="line">    s.suites.length, s.title)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That&#39;s ugly, and it is easy to forget to return the argument <code>s</code>. Thus
we better use <a target="_blank" rel="noopener" href="http://ramdajs.com/docs/#tap">Ramda.tap</a> to wrap a function and always return the
input argument. Tap is one of my favorite and most often used
<a href="../my-favorite-functional-adaptors/">function adaptors</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffleDescribes</span> (<span class="params">suite</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> maybeSuites(suite)</span><br><span class="line">    .map(tap(logShuffle))</span><br><span class="line">    .map(shuffleSuites)</span><br><span class="line">    .map(shuffleTests)</span><br><span class="line">    .map(shuffleNestedSuites)</span><br><span class="line">    .getOrElse(suite)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Is this really better than imperative code? I would argue yes.</p>
<ul>
<li>We had to explicitly deal with invalid <code>suite</code> data.</li>
<li>Each step is a pure function, operating on an immutable data object.</li>
<li>We only used a few &quot;primitive&quot; functions: map, lens, etc. With fewer
moving parts, we did not really have to write new code; our code is just
a series of data transforms.</li>
</ul>
<p>And that is how you draw an owl.</p>
<h2><span id="more-info">More info</span></h2><p>More writings on refactoring and writing code functional style</p>
<ul>
<li><a href="../getting-good-at-fp/">Getting good at FP advice</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tomharding.me/2016/12/31/yippee-ki-yay-other-functors/">Maybe functor</a></li>
<li><a href="../refactoring-to-compose/">Refactor to compose</a></li>
<li><a href="../from-callbacks-to-tasks/">From callbacks to Tasks</a></li>
<li><a href="../refactoring-or/">Refactoring OR</a></li>
<li><a href="../simplify-filtering-conditions/">Simplify filtering conditions</a></li>
</ul>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/how-to-draw-an-owl/" data-id="ckxqk5nx800ltqdvg0ks016vs" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/how-to-draw-an-owl/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/functional/" rel="tag">functional</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/ramda/" rel="tag">ramda</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../vp-of-success/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          VP of Success
        
      </div>
    </a>
  
  
    <a href="../docker-user/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Docker User</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">138</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">443</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">109</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">169</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">165</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">134</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.8px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.4px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 14.8px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16.4px;">ci</a> <a href="../tags/circle/" style="font-size: 13.6px;">circle</a> <a href="../tags/climate/" style="font-size: 14.4px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 14.4px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 13.6px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.4px;">db</a> <a href="../tags/docker/" style="font-size: 14px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.4px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 14.8px;">git</a> <a href="../tags/github/" style="font-size: 15.2px;">github</a> <a href="../tags/graphql/" style="font-size: 11.6px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 10.8px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.6px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.6px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.8px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.2px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.4px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.8px;">ramda</a> <a href="../tags/react/" style="font-size: 11.6px;">react</a> <a href="../tags/react-native/" style="font-size: 11.2px;">react native</a> <a href="../tags/reactive/" style="font-size: 14px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 13.6px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.2px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.2px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.4px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.2px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../browser-filesystem-api/">Test Web Apps That Use The Browser FileSystem API</a>
          </li>
        
          <li>
            <a href="../cyclope-intro/">Save The Page On Test Failure</a>
          </li>
        
          <li>
            <a href="../cypress-hosts-option/">Cypress Hosts Option</a>
          </li>
        
          <li>
            <a href="../check-for-duplicates/">Check Items For Duplicates</a>
          </li>
        
          <li>
            <a href="../cy-now-and-state/">Cypress internal commands cy.now and cy.state</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/how-to-draw-an-owl/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
