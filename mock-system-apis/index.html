<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Mock system APIs | Better world by better software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="When you write your module (let&#39;s say a Node JavaScript one), you often expose public API, but internally your code accesses the outside world via own code. Testing the public API is the best, but">
<meta property="og:type" content="article">
<meta property="og:title" content="Mock system APIs">
<meta property="og:url" content="https://glebbahmutov.com/blog/mock-system-apis/index.html">
<meta property="og:site_name" content="Better world by better software">
<meta property="og:description" content="When you write your module (let&#39;s say a Node JavaScript one), you often expose public API, but internally your code accesses the outside world via own code. Testing the public API is the best, but">
<meta property="og:locale">
<meta property="og:image" content="https://glebbahmutov.com/blog/images/mock-system-apis/tractor-pull.jpg">
<meta property="article:published_time" content="2017-07-13T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-15T13:13:30.309Z">
<meta property="article:author" content="Gleb Bahmutov">
<meta property="article:tag" content="testing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://glebbahmutov.com/blog/images/mock-system-apis/tractor-pull.jpg">
<meta name="twitter:creator" content="@bahmutov">
  
    <link rel="alternative" href="/blog/atom.xml" title="Better world by better software" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="preload" href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" as="style">
  
<link rel="stylesheet" href="../css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59999353-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-titles">
      <div id="header-title" class="inner">
        <h1 id="logo-wrap">
          <a href="../index.html" id="logo">Better world by better software</a>
        </h1>
        <!--
        
        -->
        <!-- <span class="no-mobile">Software advice from</span> -->
        <h2 id="subtitle-wrap">
          <span class="subtitle">
            <a id="subtitle" href="https://glebbahmutov.com">Gleb Bahmutov PhD</a>
            <a id="nav-house-link" class="nav-icon" href="/" title="Home"></a>
            
              <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
            <div id="search-form-wrap">
              <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://glebbahmutov.com/blog"></form>
            </div>
          </span>
        </h2>

      </div>
    </div>
    <div id="climate-crisis">
      <h2>Our planet üåè is in danger</h2>
      <h3>Act today: <a href="/blog/climate-emergency/">what you can do</a></h3>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-mock-system-apis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="" class="article-date">
  <time datetime="2017-07-13T04:00:00.000Z" itemprop="datePublished">Jul 13 2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="../categories/process/">process</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Mock system APIs
    </h1>

    <h2 class="article-title" itemprop="name">
      Do not mock your internal modules, mock system APIs instead!
    </h2>

  


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When you write your module (let&#39;s say a Node JavaScript one), you often
expose public API, but internally your code accesses the outside world
via own code. Testing the public API is the best, but often it is hard,
since your code interacts with the file system, user or network.</p>
<p>How do you test the exposed API when you need to mock the rest of the
system? I think it is preferable to NOT mock your own code modules, but
to mock the interface to the external world.</p>
<p>In principle, if your public API calls two internal functions <code>fn1</code>
and <code>fn2</code>, which in turn call Node system libraries (like <code>fs</code> or <code>http</code>),
then you probably should stub the <em>Node system libraries</em> and NOT
the internal functions <code>fn1</code> and <code>fn2</code>.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   public API     &lt;-----------------------+ Testing public API</span><br><span class="line">        ^                                      (preferred)</span><br><span class="line">+-------|-----------------------+</span><br><span class="line">|       |                       |</span><br><span class="line">|       +                       |</span><br><span class="line">|                               |</span><br><span class="line">|     Your top level code       |</span><br><span class="line">|                               |</span><br><span class="line">|                               |</span><br><span class="line">+------------------+------------+ &lt;-------+ Mocking internal modules</span><br><span class="line">|                  |            |             (hard, can change)</span><br><span class="line">|                  |            |</span><br><span class="line">|     Your fn1     |  Your fn2  |</span><br><span class="line">|                  |            |</span><br><span class="line">|        +         |     +      |</span><br><span class="line">+--------|---------+-----|------+</span><br><span class="line">         |               |</span><br><span class="line">+--------|---------------|------+ &lt;-------+ Mocking system APIs</span><br><span class="line">|        +               +      |           (surprisingly easy,</span><br><span class="line">|  OS / Node stable public API  |            do not change often)</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure>
<p><strong>hint</strong> the above diagram was created using <a target="_blank" rel="noopener" href="http://www.asciidraw.com/">AsciiDraw</a></p>
<h2><span id="example">Example</span></h2><p>My examples comes from my own library wrapping the Git tool
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/ggit">ggit</a>. The library has many public functions
in its public API, methods like <code>blame</code> and <code>commits</code>. A typical use
case is someone writing a Node program showing history for each line of a
tracked file</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blame = <span class="built_in">require</span>(<span class="string">&#x27;ggit&#x27;</span>).blame</span><br><span class="line">blame(filename, lineNumber).then(<span class="function"><span class="keyword">function</span> (<span class="params">info</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    info is an object with fields like</span></span><br><span class="line"><span class="comment">    &#123; commit: &#x27;6e65f8ec5ed63cac92ed130b1246d9c23223c04e&#x27;,</span></span><br><span class="line"><span class="comment">      author: &#x27;Gleb Bahmutov&#x27;,</span></span><br><span class="line"><span class="comment">      committer: &#x27;Gleb Bahmutov&#x27;,</span></span><br><span class="line"><span class="comment">      summary: &#x27;adding blame feature&#x27;,</span></span><br><span class="line"><span class="comment">      filename: &#x27;test/blame.js&#x27;,</span></span><br><span class="line"><span class="comment">      line: &#x27;var blame = require(\&#x27;../index\&#x27;).blame;&#x27; &#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>How can we test this public function from <code>ggit</code>? Well, <code>src/blame.js</code> makes
use of two calls internally - one is to internal module <code>./exec.js</code> which
routes to Node&#39;s built-in <code>child_process.exec</code>, and another directly
to Node&#39;s built-in <code>fs.existsSync</code> function. Do we somehow overwrite
calls to <code>./exec.js</code> with stubs controlled from the tests? That is difficult,
and requires exposing <code>./exec.js</code> module and being able to overwrite it
on the fly. One can use helpers that clear Node module cache and then force
loading <code>./exec.js</code> again, but substituting the stubbed version. One
could use <a target="_blank" rel="noopener" href="https://github.com/thlorenz/proxyquire">proxyquire</a> or <a target="_blank" rel="noopener" href="https://github.com/bahmutov/really-need">really-need</a> to do this,
and the test would look like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reallyNeed = <span class="built_in">require</span>(<span class="string">&#x27;really-need&#x27;</span>)</span><br><span class="line">describe(<span class="string">&#x27;blame&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filename = <span class="string">&#x27;foo.txt&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> line = <span class="number">10</span></span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// need to clear &#x27;./blame.js&#x27; from module cache</span></span><br><span class="line">    <span class="comment">// need to clear &#x27;./exec.js&#x27; from module cache</span></span><br><span class="line">    <span class="comment">// load mocked version of &#x27;./exec.js&#x27;</span></span><br><span class="line">    <span class="comment">// somehow mock function that calls `fs.existsSync` inside ./blame.js</span></span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;returns blame information for given line&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blame(filename, line)</span><br><span class="line">      .then(<span class="function"><span class="params">info</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// check info object</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Painful, isn&#39;t it? This mocking targets immediate dependencies of the
module under test, but their are <em>internal modules</em> that should be replaceable
easily. Yet now, the test makes it hard to test <code>./exec.js</code> or replacing
it with a different, better module, like <a target="_blank" rel="noopener" href="https://github.com/sindresorhus/execa">execa</a>. It is hard, because
changing it requires reworking lots and lots of complicated tests
<em>that mostly setup mocks of our unstable code</em>!
The person doing the refactoring has to update tests and make sure the
Node module cache is used correctly, and the modules under test are
loaded in the right order. I often feel like pulling so much dead weight
when refactoring tests, just like this tractor.</p>
<p><img src="/blog/images/mock-system-apis/tractor-pull.jpg" alt="Updating tests often feels like pulling heavy weight"></p>
<h2><span id="mocking-system-libraries">Mocking system libraries</span></h2><p>Instead of mocking (or stubbing) the immediate internal modules around the
module under test, let us mock the <em>system APIs</em> our code is expected to
use. For example, instead of mocking <code>./exec.js</code> function, we can mock
the <code>child_process.exec</code> that <strong>will be called at some point</strong> in order
for our module to work.</p>
<h3><span id="mocking-a-simple-method">Mocking a simple method</span></h3><p>First, let me show the simple stubbing of system dependency - overwriting
<code>fs.existsSync</code> call. We can use the excellent <a target="_blank" rel="noopener" href="http://sinonjs.org/">Sinon</a> library to
do this quickly.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">&#x27;sinon&#x27;</span>)</span><br><span class="line"><span class="comment">// we need access to &quot;fs&quot; object</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">describe(<span class="string">&#x27;blame&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filename = <span class="string">&#x27;foo.txt&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> line = <span class="number">10</span></span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    sinon.stub(fs, <span class="string">&#x27;existsSync&#x27;</span>).withArgs(filename).returns(<span class="literal">true</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  afterEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// remove sinon&#x27;s stubs</span></span><br><span class="line">    fs.existsSync.restore()</span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;returns blame information for given line&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blame(filename, line)</span><br><span class="line">      .then(<span class="function"><span class="params">info</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// check info object</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>All we have do to make sure the call <code>fs.existsSync(&#39;foo.txt&#39;)</code> returns true
for fake file <code>foo.txt</code> is to stub it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sinon.stub(fs, <span class="string">&#x27;existsSync&#x27;</span>).withArgs(filename).returns(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>Of course after we are done with a test we should restore the original
<code>fs.existsSync</code> method. Or we can only stub the first call - but we should
still cleanup the stub after the test</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sinon.stub(fs, <span class="string">&#x27;existsSync&#x27;</span>)</span><br><span class="line">  .withArgs(filename)</span><br><span class="line">  .onFirstCall()</span><br><span class="line">  .returns(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>Similarly, we can stub a property or promise-returning method</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sinon.stub(object, <span class="string">&quot;propertyName&quot;</span>, newValue)        <span class="comment">// mock property value</span></span><br><span class="line">sinon.stub(object, <span class="string">&quot;methodName&quot;</span>)</span><br><span class="line">  .resolves(newValue) <span class="comment">// mock promise-returning method</span></span><br></pre></td></tr></table></figure>
<p>For full documentation see <a target="_blank" rel="noopener" href="http://sinonjs.org/releases/v2.3.8/stubs/">sinon stubs</a></p>
<h3><span id="mocking-event-emitter">Mocking event emitter</span></h3><p>Mocking Node&#39;s <code>child_process.spawn</code> method is slightly more complex, because
it returns a <code>ChildProcess</code> event emitter. But I have written a utility
that does exactly that - stubs <code>spawn</code> or <code>exec</code> system functions.
I even made <a target="_blank" rel="noopener" href="https://github.com/bahmutov/stub-spawn-once">stub-spawn-once</a> testing-friendly because it
automatically cleans up each stub after using it once.</p>
<p>For example, the <code>./blame.js</code> calls <code>./exec.js</code> with the following command
(assuming &quot;foo.txt&quot; filename and line number 10)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame --porcelain -L 10,10 foo.txt</span><br></pre></td></tr></table></figure>
<p>Then <code>git blame</code> command produces something that looks like this</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">6f272d6aef8a1d19e559792d9493d07d4218ea09 10 10 1</span><br><span class="line">author Gleb Bahmutov</span><br><span class="line">author-mail &lt;gleb.bahmutov@gmail.com&gt;</span><br><span class="line">author-time 1499625750</span><br><span class="line">author-tz -0400</span><br><span class="line">committer Gleb Bahmutov</span><br><span class="line">committer-mail &lt;gleb.bahmutov@gmail.com&gt;</span><br><span class="line">committer-time 1499625750</span><br><span class="line">committer-tz -0400</span><br><span class="line">summary this is initial commit</span><br><span class="line">boundary</span><br><span class="line">filename foo.txt</span><br></pre></td></tr></table></figure>
<p>Our test then can mock both <code>fs.existsSync</code> and <code>child_process.exec</code> Node
built-in API functions like this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">&#x27;sinon&#x27;</span>)</span><br><span class="line"><span class="comment">// we need access to &quot;fs&quot; object</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;stubExecOnce&#125; = <span class="built_in">require</span>(<span class="string">&#x27;stub-spawn-once&#x27;</span>)</span><br><span class="line"><span class="comment">// common-tags is a great library for dealing with whitespace</span></span><br><span class="line"><span class="comment">// in ES6 template literals</span></span><br><span class="line"><span class="keyword">const</span> &#123;stripIndent&#125; = <span class="built_in">require</span>(<span class="string">&#x27;common-tags&#x27;</span>)</span><br><span class="line">describe(<span class="string">&#x27;blame&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filename = <span class="string">&#x27;foo.txt&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> line = <span class="number">10</span></span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    sinon.stub(fs, <span class="string">&#x27;existsSync&#x27;</span>).withArgs(filename).returns(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> cmd = <span class="string">&#x27;git blame --porcelain -L 10,10 foo.txt&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> blameOutput = stripIndent<span class="string">`</span></span><br><span class="line"><span class="string">      // the mock output shown above</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    stubExecOnce(cmd, blameOutput)</span><br><span class="line">  &#125;)</span><br><span class="line">  afterEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// remove sinon&#x27;s stubs</span></span><br><span class="line">    fs.existsSync.restore()</span><br><span class="line">    <span class="comment">// stubExecOnce removes itself after single use</span></span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;returns blame information for given line&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blame(filename, line)</span><br><span class="line">      .then(<span class="function"><span class="params">info</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// check info object</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Note that we no longer care or depend on our internal modules. Instead we
only care about interacting with the operating system. This is much easier
to maintain. Think about a developer updating a test for <code>./blame.js</code>,
he or she can see the expected Git command, and its mock output, and can even
run the command in the terminal!</p>
<p>And if we change the internal <code>./exec.js</code> code or even replace it
with another library for running shell scripts, our tests still going to
execute the same operating system calls, and should be able to parse the same
command output. Truly the <code>./blame.js</code> test is now testing only a single
source file and not several.</p>
<h2><span id="examples">Examples</span></h2><p>Take a look at these spec files showing mocking stable Node API calls, rather
than internal modules.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/bahmutov/ggit/blob/159c3764365be53f9894db6b55aa6dd4dbffd4de/spec/blame-spec.js#L49">ggit/blame-spec.js</a></p>
<p>The above example with snap- and schema-shot testing (see the &quot;Bonus&quot; section below)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/cypress-io/env-or-json-file/blob/ef205312ba73f2fd6404947005b1a401cb6dd305/src/env-or-json-file-spec.js#L43">cypress-io/env-or-json-file</a></p>
<p>Stubs file load like</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sinon.stub(fs, <span class="string">&#x27;existsSync&#x27;</span>).withArgs(fullPath).returns(<span class="literal">true</span>)</span><br><span class="line">sinon</span><br><span class="line">  .stub(fs, <span class="string">&#x27;readFileSync&#x27;</span>)</span><br><span class="line">  .withArgs(fullPath, <span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">  .returns(configString)</span><br></pre></td></tr></table></figure>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/bahmutov/generator-node-bahmutov/blob/6a915689e6de991491d16181dfc6a8bddd0da1ea/app/github-description-spec.js#L30">generator-node-bahmutov</a></p>
<p>Shows how easy it is to stub HTTP(s) requests using <a target="_blank" rel="noopener" href="https://github.com/node-nock/nock">nock</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nock = <span class="built_in">require</span>(<span class="string">&#x27;nock&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> description = <span class="string">&#x27;cool project, bro&#x27;</span></span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  nock(<span class="string">&#x27;https://api.github.com&#x27;</span>)</span><br><span class="line">    .get(<span class="string">&#x27;/repos/no-such-user/does-not-exist&#x27;</span>)</span><br><span class="line">    .reply(<span class="number">200</span>, &#123; description &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(<span class="string">&#x27;can mock non-existent repo&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">&#x27;git@github.com:no-such-user/does-not-exist.git&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> repoDescription(url).then(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">    la(description === text, <span class="string">&#x27;wrong description returned&#x27;</span>, text)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Every <code>nock</code> intercept is automatically removed after single use, so
nothing needs to be cleaned up.</p>
</li>
</ul>
<p>and lots more examples in their own repo
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/node-mock-examples">node-mock-examples</a>.</p>
<p><strong>hint</strong> if you do not know what HTTP requests are actually happening, run
the tests with <code>DEBUG=nock.* ...</code> or just <code>DEBUG=nock.interceptor ...</code>
environment variables to see Nock&#39;s messages.</p>
<h2><span id="final-thoughts">Final thoughts</span></h2><ul>
<li>Mocking your own internal modules is hard: they are cached by the Node
module system, unstable, often undocumented.</li>
<li>Mocking OS calls is easier; API is stable and well documented</li>
<li>Libs like <code>sinon</code> and <code>stub-spawn-once</code> make stubbing API methods a breeze</li>
</ul>
<h2><span id="bonus">Bonus</span></h2><p>I love using <a href="../picking-snapshot-library/">snapshot testing</a> to quickly assert everything
about received result. Just wrap the promise returned from the call
<code>blame(filename, line)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> snapshot = <span class="built_in">require</span>(<span class="string">&#x27;snap-shot&#x27;</span>)</span><br><span class="line">describe(<span class="string">&#x27;blame&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">  it(<span class="string">&#x27;returns blame information for given line&#x27;</span>, <span class="function">() =&gt;</span></span><br><span class="line">    snapshot(blame(filename, line))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Similarly, we can skip mocking even OS results by using
<a target="_blank" rel="noopener" href="https://github.com/bahmutov/schema-shot">schema snapshots</a> in this case. We are interested in the
<em>schema of the result</em>, rather than exact values.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schemaShot = <span class="built_in">require</span>(<span class="string">&#x27;schema-shot&#x27;</span>)</span><br><span class="line">describe(<span class="string">&#x27;blame&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// no setup is necessary!</span></span><br><span class="line">  it(<span class="string">&#x27;returns blame information for this file&#x27;</span>, <span class="function">() =&gt;</span></span><br><span class="line">    schemaShot(blame(__filename, <span class="number">1</span>))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">saves schema:</span></span><br><span class="line"><span class="comment">$ cat __snapshots__/blame-spec.js.schema-shot</span></span><br><span class="line"><span class="comment">exports[&#x27;gets blame for 1 line of this file 1&#x27;] = &#123;</span></span><br><span class="line"><span class="comment">  &quot;$schema&quot;: &quot;http://json-schema.org/draft-04/schema#&quot;,</span></span><br><span class="line"><span class="comment">  &quot;type&quot;: &quot;object&quot;,</span></span><br><span class="line"><span class="comment">  &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;commit&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &quot;author&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &quot;committer&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &quot;summary&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &quot;filename&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &quot;line&quot;: &#123;</span></span><br><span class="line"><span class="comment">      &quot;type&quot;: &quot;string&quot;,</span></span><br><span class="line"><span class="comment">      &quot;required&quot;: true</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  &quot;additionalProperties&quot;: false,</span></span><br><span class="line"><span class="comment">  &quot;list&quot;: false,</span></span><br><span class="line"><span class="comment">  &quot;example&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;commit&quot;: &quot;adfb30d5888bb1eb9bad1f482248edec2947dab6&quot;,</span></span><br><span class="line"><span class="comment">    &quot;author&quot;: &quot;Gleb Bahmutov&quot;,</span></span><br><span class="line"><span class="comment">    &quot;committer&quot;: &quot;Gleb Bahmutov&quot;,</span></span><br><span class="line"><span class="comment">    &quot;summary&quot;: &quot;move blame test&quot;,</span></span><br><span class="line"><span class="comment">    &quot;filename&quot;: &quot;spec/blame-spec.js&quot;,</span></span><br><span class="line"><span class="comment">    &quot;line&quot;: &quot;\tconst la = require(&#x27;lazy-ass&#x27;);&quot;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>Happy testing!</strong></p>

      
    </div>

    
      <footer class="article-footer personal-links">
  <p>
    Follow Gleb Bahmutov <a target="_blank" rel="noopener" href="https://twitter.com/bahmutov">@bahmutov</a>,
    see his projects at <a href="https://glebbahmutov.com">glebbahmutov.com</a>,
    watch his Cypress <a target="_blank" rel="noopener" href="https://www.youtube.com/c/glebbahmutov/videos">videos</a>,
    browse his <a target="_blank" rel="noopener" href="https://slides.com/bahmutov">presentations</a>
  </p>
  <p>
    Want to know more about Cypress? Check out <a href="https://cypress.tips" target="_blank">cypress.tips</a>
  </p>
</footer>
<script src="https://rawgit.com/toddmotto/linkjuice/702066a37124081e7ad1a972844a9a91115be05a/dist/linkjuice.js"></script>
<script>
function contentFn (node, icon) {
  const s = '<a href="#' + node.id + '" class="linkjuice">' +
    node.innerHTML + ' ' + icon + '</a>\n'
  return s
}
linkjuice.init('.article-entry', {
  selectors: ['h2 span'],
  icon: '<span class="link-symbol">#</span>',
  contentFn: contentFn
});
</script>

    

    <footer class="article-footer">
      <a data-url="https://glebbahmutov.com/blog/mock-system-apis/" data-id="ckymeryx800swtkvgbxrv4n9o" class="article-share-link">Share</a>
      
        <a href="https://glebbahmutov.com/blog/mock-system-apis/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../tags/testing/" rel="tag">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../mocking-vs-refactoring/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Mocking vs Refactoring
        
      </div>
    </a>
  
  
    <a href="../quick-solid-module/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Quick Solid NPM Module</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    <style>
#carbonads {
  display: block;
  overflow: hidden;
  font-size: 11px;
  font-family: Verdana, "Helvetica Neue", Helvetica, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: #258fb8;
  text-decoration: none;
}

#carbonads a:hover {
  text-decoration: underline;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  float: left;
  margin-right: 1em;
}

.carbon-img img { display: block; }

.carbon-text {
  display: block;
  float: left;
  text-align: left;
  margin-top: 0.5em;
}
@media screen and (min-width: 1024px) {
  .carbon-text {
    max-width: calc(100% - 130px - 1em);
  }
}

.carbon-poweredby {
  /*position: absolute;
  right: 0;
  bottom: 0;*/
  float: right;
  display: block;
  font-size: 11px;
}
</style>
<div class="widget-wrap">
  <div class="widget-title">&nbsp;</div>
  <div class="widget">
    <!-- Carbon Ads -->
    <script async type="text/javascript"
      src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=glebbahmutovcom"
      id="_carbonads_js"></script>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../categories/book-review/">book review</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/climate/">climate</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/people/">people</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/process/">process</a><span class="category-list-count">140</span></li><li class="category-list-item"><a class="category-list-link" href="../categories/products/">products</a><span class="category-list-count">446</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../tags/11ty/" rel="tag">11ty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/QUnit/" rel="tag">QUnit</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/a11y/" rel="tag">a11y</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/advice/" rel="tag">advice</a><span class="tag-list-count">111</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/algolia/" rel="tag">algolia</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">58</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/angularjs2/" rel="tag">angularjs2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/assertions/" rel="tag">assertions</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ast/" rel="tag">ast</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/boilerplate/" rel="tag">boilerplate</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/browser/" rel="tag">browser</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ci/" rel="tag">ci</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/circle/" rel="tag">circle</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/climate/" rel="tag">climate</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/code-coverage/" rel="tag">code coverage</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/concurrency/" rel="tag">concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cyclejs/" rel="tag">cyclejs</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress/" rel="tag">cypress</a><span class="tag-list-count">173</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/cypress-dashboard/" rel="tag">cypress dashboard</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/d3/" rel="tag">d3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/db/" rel="tag">db</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/docker/" rel="tag">docker</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/documentation/" rel="tag">documentation</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es6/" rel="tag">es6</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/es7/" rel="tag">es7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/functional/" rel="tag">functional</a><span class="tag-list-count">70</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/generators/" rel="tag">generators</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/git/" rel="tag">git</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/github/" rel="tag">github</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/graphql/" rel="tag">graphql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/grunt/" rel="tag">grunt</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/gulp/" rel="tag">gulp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hiring/" rel="tag">hiring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/hyperapp/" rel="tag">hyperapp</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/immutable/" rel="tag">immutable</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/interview/" rel="tag">interview</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jade/" rel="tag">jade</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">166</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/jshint/" rel="tag">jshint</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/model-based-testing/" rel="tag">model-based testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/modular-development/" rel="tag">modular development</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/netlify/" rel="tag">netlify</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">84</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/performance/" rel="tag">performance</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/presentation/" rel="tag">presentation</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/promises/" rel="tag">promises</a><span class="tag-list-count">31</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/proposal/" rel="tag">proposal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ramda/" rel="tag">ramda</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react/" rel="tag">react</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/react-native/" rel="tag">react native</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/reactjs/" rel="tag">reactjs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/renovate/" rel="tag">renovate</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/screencast/" rel="tag">screencast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/security/" rel="tag">security</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/sentry/" rel="tag">sentry</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/service-workers/" rel="tag">service workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/state-machine/" rel="tag">state machine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/testing/" rel="tag">testing</a><span class="tag-list-count">134</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/tutorial/" rel="tag">tutorial</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/ui/" rel="tag">ui</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vercel/" rel="tag">vercel</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/visual-testing/" rel="tag">visual testing</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/vuejs/" rel="tag">vuejs</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/web-workers/" rel="tag">web workers</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="../tags/11ty/" style="font-size: 10.4px;">11ty</a> <a href="../tags/QUnit/" style="font-size: 11.6px;">QUnit</a> <a href="../tags/a11y/" style="font-size: 10.8px;">a11y</a> <a href="../tags/advice/" style="font-size: 18.8px;">advice</a> <a href="../tags/algolia/" style="font-size: 10.4px;">algolia</a> <a href="../tags/angularjs/" style="font-size: 17.6px;">angularjs</a> <a href="../tags/angularjs2/" style="font-size: 10px;">angularjs2</a> <a href="../tags/assertions/" style="font-size: 13.2px;">assertions</a> <a href="../tags/ast/" style="font-size: 12.8px;">ast</a> <a href="../tags/boilerplate/" style="font-size: 14.8px;">boilerplate</a> <a href="../tags/browser/" style="font-size: 15.6px;">browser</a> <a href="../tags/ci/" style="font-size: 16.4px;">ci</a> <a href="../tags/circle/" style="font-size: 13.6px;">circle</a> <a href="../tags/climate/" style="font-size: 14.4px;">climate</a> <a href="../tags/code-coverage/" style="font-size: 14.4px;">code coverage</a> <a href="../tags/concurrency/" style="font-size: 10px;">concurrency</a> <a href="../tags/cyclejs/" style="font-size: 12.4px;">cyclejs</a> <a href="../tags/cypress/" style="font-size: 20px;">cypress</a> <a href="../tags/cypress-dashboard/" style="font-size: 13.6px;">cypress dashboard</a> <a href="../tags/d3/" style="font-size: 10.8px;">d3</a> <a href="../tags/db/" style="font-size: 14.4px;">db</a> <a href="../tags/docker/" style="font-size: 14px;">docker</a> <a href="../tags/documentation/" style="font-size: 12px;">documentation</a> <a href="../tags/es6/" style="font-size: 14.4px;">es6</a> <a href="../tags/es7/" style="font-size: 10px;">es7</a> <a href="../tags/functional/" style="font-size: 18px;">functional</a> <a href="../tags/generators/" style="font-size: 11.6px;">generators</a> <a href="../tags/git/" style="font-size: 14.8px;">git</a> <a href="../tags/github/" style="font-size: 15.2px;">github</a> <a href="../tags/graphql/" style="font-size: 11.6px;">graphql</a> <a href="../tags/grunt/" style="font-size: 12.4px;">grunt</a> <a href="../tags/gulp/" style="font-size: 10.8px;">gulp</a> <a href="../tags/hiring/" style="font-size: 11.2px;">hiring</a> <a href="../tags/hyperapp/" style="font-size: 12.4px;">hyperapp</a> <a href="../tags/immutable/" style="font-size: 11.6px;">immutable</a> <a href="../tags/interview/" style="font-size: 10.8px;">interview</a> <a href="../tags/jade/" style="font-size: 11.2px;">jade</a> <a href="../tags/javascript/" style="font-size: 19.6px;">javascript</a> <a href="../tags/jshint/" style="font-size: 10.8px;">jshint</a> <a href="../tags/markdown/" style="font-size: 13.6px;">markdown</a> <a href="../tags/model-based-testing/" style="font-size: 10px;">model-based testing</a> <a href="../tags/modular-development/" style="font-size: 16.8px;">modular development</a> <a href="../tags/netlify/" style="font-size: 11.2px;">netlify</a> <a href="../tags/nodejs/" style="font-size: 18.4px;">nodejs</a> <a href="../tags/performance/" style="font-size: 16px;">performance</a> <a href="../tags/presentation/" style="font-size: 12.4px;">presentation</a> <a href="../tags/promises/" style="font-size: 17.2px;">promises</a> <a href="../tags/proposal/" style="font-size: 10.4px;">proposal</a> <a href="../tags/ramda/" style="font-size: 16.8px;">ramda</a> <a href="../tags/react/" style="font-size: 11.6px;">react</a> <a href="../tags/react-native/" style="font-size: 11.2px;">react native</a> <a href="../tags/reactive/" style="font-size: 14px;">reactive</a> <a href="../tags/reactjs/" style="font-size: 11.2px;">reactjs</a> <a href="../tags/renovate/" style="font-size: 11.6px;">renovate</a> <a href="../tags/screencast/" style="font-size: 10px;">screencast</a> <a href="../tags/security/" style="font-size: 13.2px;">security</a> <a href="../tags/sentry/" style="font-size: 13.6px;">sentry</a> <a href="../tags/service-workers/" style="font-size: 12px;">service workers</a> <a href="../tags/state-machine/" style="font-size: 10px;">state machine</a> <a href="../tags/testing/" style="font-size: 19.2px;">testing</a> <a href="../tags/tutorial/" style="font-size: 15.6px;">tutorial</a> <a href="../tags/typescript/" style="font-size: 12.4px;">typescript</a> <a href="../tags/ui/" style="font-size: 10.4px;">ui</a> <a href="../tags/vercel/" style="font-size: 13.2px;">vercel</a> <a href="../tags/visual-testing/" style="font-size: 11.2px;">visual testing</a> <a href="../tags/vuejs/" style="font-size: 11.6px;">vuejs</a> <a href="../tags/web-workers/" style="font-size: 12px;">web workers</a> <a href="../tags/webpack/" style="font-size: 10.8px;">webpack</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../archives/2022/01/">January 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/12/">December 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/11/">November 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/10/">October 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/09/">September 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/08/">August 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/07/">July 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/06/">June 2021</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/05/">May 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/04/">April 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/03/">March 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/02/">February 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2021/01/">January 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/12/">December 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/11/">November 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/10/">October 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/09/">September 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/08/">August 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/06/">June 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/05/">May 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/03/">March 2020</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/10/">October 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/09/">September 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/08/">August 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/05/">May 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/04/">April 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/03/">March 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2019/01/">January 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/08/">August 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/06/">June 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/03/">March 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/08/">August 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/07/">July 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/06/">June 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/04/">April 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/03/">March 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2017/01/">January 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/08/">August 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/06/">June 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/05/">May 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/04/">April 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/03/">March 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2016/01/">January 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/12/">December 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/11/">November 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/08/">August 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/07/">July 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/06/">June 2015</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/05/">May 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/04/">April 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/03/">March 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/02/">February 2015</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2015/01/">January 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/12/">December 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/11/">November 2014</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/10/">October 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/09/">September 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/08/">August 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/07/">July 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/06/">June 2014</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/05/">May 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/04/">April 2014</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/03/">March 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/02/">February 2014</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2014/01/">January 2014</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/12/">December 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/11/">November 2013</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/10/">October 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="../archives/2013/09/">September 2013</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../know-your-tests/">Know Your Tests</a>
          </li>
        
          <li>
            <a href="../tag-tests/">How To Tag And Run End-to-End Tests</a>
          </li>
        
          <li>
            <a href="../find-the-number/">How To Solve A Simple Numeric Problem Using Computers and JavaScript</a>
          </li>
        
          <li>
            <a href="../crawl-using-cypress/">Crawl Local Pages Using Cypress</a>
          </li>
        
          <li>
            <a href="../json-test-results/">Cypress JSON Test Results</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Gleb Bahmutov<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
</nav>
    
<script>
  var disqus_shortname = 'betterworldbybettersoftware';
  
  var disqus_url = 'https://glebbahmutov.com/blog/mock-system-apis/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="../fancybox/jquery.fancybox.css">

  
<script src="../fancybox/jquery.fancybox.pack.js"></script>




<script src="../js/script.js"></script>


  </div>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
(function centerMainOnAsideScroll () {
  // when aside side bar scrolls outside the view
  // it centers the main content.
  const main = document.querySelector('#main')
  const aside = document.querySelector('aside#sidebar')
  console.assert(main, 'could not get #main')
  console.assert(aside, 'could not get aside')
  // initially the aside sidebar is visible
  let asideVisible = true

  function centerMain () {
    console.log('adding class center-main')
    main.classList.add('center-main')
  }
  function leftMain () {
    main.classList.remove('center-main')
  }

  function callWhenAsideScrollsUp (becameInvisible, becameVisible) {
    return function () {
      const border = 50
      const rect = aside.getBoundingClientRect()
      if (asideVisible && rect.bottom < -border) {
        asideVisible = false
        becameInvisible()
      }

      if (!asideVisible && window.scrollY < border) {
        asideVisible = true
        becameVisible()
      }
    }
  }
  const throttleWaitMs = 250
  const onScroll = _.throttle(
    callWhenAsideScrollsUp(centerMain, leftMain),
    throttleWaitMs
  )
  window.addEventListener('scroll', onScroll)
}())
</script>

</body>
</html>
